YUI.add("moodle-assignfeedback_editpdf-editor",function(g,t){var e,i,n,s,a,o,r,d,h,c,l,u,p,f,_,m,b,w,y,k,v,x,S,N,A,T,D,I,C,q=M.cfg.wwwroot+"/mod/assign/feedback/editpdf/ajax.php",E=M.cfg.wwwroot+"/mod/assign/feedback/editpdf/ajax_progress.php",Y="assignfeedback_editpdf_widget",z=".navigate-previous-button",R=" .navigate-next-button",X=".searchcommentsbutton",L=".expcolcommentsbutton",O=".assignfeedback_editpdf_commentsearch input",B=".assignfeedback_editpdf_commentsearch ul",P=".navigate-page-select",j=".loading",H=".progress-info.progress-striped",F=".drawingregion",J=".drawingcanvas",W=".commentcolourbutton",$=".annotationcolourbutton",V=".warningmessages",G=".infoicon",K='input[name="assignfeedback_editpdf_haschanges"]',Q=".currentstampbutton",U='[data-region="user-info"]',Z=".rotateleftbutton",tt=".rotaterightbutton",et=".htmleditorbutton",it="rgba(200, 200, 255, 0.9)",nt="rgba(200, 200, 255, 0.5)",st="rgb(51, 51, 51)",at={white:"rgb(255,255,255)",yellow:"rgb(255,236,174)",red:"rgb(249,181,179)",green:"rgb(214,234,178)",blue:"rgb(203,217,237)",clear:"rgba(255,255,255, 0)"},ot={white:"rgb(255,255,255)",yellow:"rgb(255,207,53)",red:"rgb(239,69,64)",green:"rgb(152,202,62)",blue:"rgb(125,159,211)",black:"rgb(51,51,51)"},rt=300,dt={comment:".commentbutton",pen:".penbutton",line:".linebutton",rectangle:".rectanglebutton",oval:".ovalbutton",stamp:".stampbutton",select:".selectbutton",drag:".dragbutton",highlight:".highlightbutton",htmleditor:".htmleditorbutton"},ht=4,ct=function(t,e){this.x=parseInt(t,10),this.y=parseInt(e,10),this.clip=function(t){return this.x<t.x&&(this.x=t.x),this.x>t.x+t.width&&(this.x=t.x+t.width),this.y<t.y&&(this.y=t.y),this.y>t.y+t.height&&(this.y=t.y+t.height),this}};M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.point=ct,e=function(t,e,i,n){this.x=t,this.y=e,this.width=i,this.height=n,this.bound=function(t){var e,i=0,n=0,s=0,a=0,o=0;for(o=0;o<t.length;o++)((e=t[o]).x<i||0===o)&&(i=e.x),(e.x>n||0===o)&&(n=e.x),(e.y<s||0===o)&&(s=e.y),(e.y>a||0===o)&&(a=e.y);return this.x=i,this.y=s,this.width=n-i,this.height=a-s,this},this.has_min_width=function(){return 5<=this.width},this.has_min_height=function(){return 5<=this.height},this.set_min_width=function(){this.width=5},this.set_min_height=function(){this.height=5}},M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.rect=e,i=function(){this.start=!1,this.end=!1,this.starttime=0,this.annotationstart=!1,this.tool="drag",this.commentcolour="yellow",this.annotationcolour="red",this.stamp="",this.path=[]},M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.edit=i,n=function(t){this.editor=t,this.shapes=[],this.nodes=[],this.erase=function(){if(this.shapes)for(;0<this.shapes.length;)this.editor.graphic.removeShape(this.shapes.pop());if(this.nodes)for(;0<this.nodes.length;)this.nodes.pop().remove()},this.scroll_update=function(t,e){var i,n,s;for(i=0;i<this.nodes.length;i++)n=this.nodes[i].getData("x"),s=this.nodes[i].getData("y"),n!==undefined&&s!==undefined&&(this.nodes[i].setX(parseInt(n,10)-t),this.nodes[i].setY(parseInt(s,10)-e))},this.store_position=function(t,e,i){var n,s,a;n=this.editor.get_dialogue_element(F),s=parseInt(n.get("scrollLeft"),10),a=parseInt(n.get("scrollTop"),10),t.setData("x",e+s),t.setData("y",i+a)}},M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.drawable=n,(s=function(t){s.superclass.constructor.apply(this,[t])}).NAME="annotation",s.ATTRS={},g.extend(s,g.Base,{editor:null,gradeid:0,pageno:0,x:0,y:0,endx:0,endy:0,path:"",type:"rect",colour:"red",drawable:!1,initializer:function(t){this.editor=t.editor||null,this.gradeid=parseInt(t.gradeid,10)||0,this.pageno=parseInt(t.pageno,10)||0,this.x=parseInt(t.x,10)||0,this.y=parseInt(t.y,10)||0,this.endx=parseInt(t.endx,10)||0,this.endy=parseInt(t.endy,10)||0,this.path=t.path||"",this.type=t.type||"rect",this.colour=t.colour||"red",this.drawable=!1},clean:function(){return{gradeid:this.gradeid,x:parseInt(this.x,10),y:parseInt(this.y,10),endx:parseInt(this.endx,10),endy:parseInt(this.endy,10),type:this.type,path:this.path,pageno:this.pageno,colour:this.colour}},draw_highlight:function(){var t,e,i,n,s=this.editor.get_dialogue_element(F),a=this.editor.get_dialogue_element(J).getXY();return this.editor.currentannotation===this&&((t=new M.assignfeedback_editpdf.rect).bound([new M.assignfeedback_editpdf.point(this.x,this.y),new M.assignfeedback_editpdf.point(this.endx,this.endy)]),e=this.editor.graphic.addShape({type:g.Rect,width:t.width,height:t.height,stroke:{weight:ht,color:it},fill:{color:nt},x:t.x,y:t.y}),this.drawable.shapes.push(e),i=g.Node.create('<img src="'+M.util.image_url("trash","assignfeedback_editpdf")+'"/>'),n=g.Node.create('<a href="#" role="button"></a>'),i.setAttrs({alt:M.util.get_string("deleteannotation","assignfeedback_editpdf")}),i.setStyles({backgroundColor:"white"}),n.addClass("deleteannotationbutton"),n.append(i),s.append(n),n.setData("annotation",this),n.on("click",this.remove,this),n.on("key",this.remove,"space,enter",this),n.setX(a[0]+t.x+t.width-18),n.setY(a[1]+t.y+6),this.drawable.nodes.push(n)),this.drawable},draw:function(){return this.draw_highlight(),this.drawable},remove:function(t){var e,i;for(t.preventDefault(),e=this.editor.pages[this.editor.currentpage].annotations,i=0;i<e.length;i++)if(e[i]===this)return e.splice(i,1),this.drawable&&this.drawable.erase(),this.editor.currentannotation=!1,void this.editor.save_current_page()},move:function(t,e){var i,n,s,a,o,r=t-this.x,d=e-this.y;this.x+=r,this.y+=d,this.endx+=r,this.endy+=d,this.path&&(i=[],n=this.path.split(":"),g.each(n,function(t){s=t.split(","),a=parseInt(s[0],10),o=parseInt(s[1],10),i.push(a+r+","+(o+d))}),this.path=i.join(":")),this.drawable&&this.drawable.erase(),this.editor.drawables.push(this.draw())},draw_current_edit:function(t){return t&&!1},init_from_edit:function(t){var e=new M.assignfeedback_editpdf.rect;return e.bound([t.start,t.end]),
this.gradeid=this.editor.get("gradeid"),this.pageno=this.editor.currentpage,this.x=e.x,this.y=e.y,this.endx=e.x+e.width,this.endy=e.y+e.height,this.colour=t.annotationcolour,this.path="",e.has_min_width()&&e.has_min_height()}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.annotation=s,(a=function(t){a.superclass.constructor.apply(this,[t])}).NAME="annotationline",a.ATTRS={},g.extend(a,M.assignfeedback_editpdf.annotation,{draw:function(){var t,e;return t=new M.assignfeedback_editpdf.drawable(this.editor),(e=this.editor.graphic.addShape({type:g.Path,fill:!1,stroke:{weight:ht,color:ot[this.colour]}})).moveTo(this.x,this.y),e.lineTo(this.endx,this.endy),e.end(),t.shapes.push(e),this.drawable=t,a.superclass.draw.apply(this)},draw_current_edit:function(t){var e,i=new M.assignfeedback_editpdf.drawable(this.editor);return(e=this.editor.graphic.addShape({type:g.Path,fill:!1,stroke:{weight:ht,color:ot[t.annotationcolour]}})).moveTo(t.start.x,t.start.y),e.lineTo(t.end.x,t.end.y),e.end(),i.shapes.push(e),i},init_from_edit:function(t){return this.gradeid=this.editor.get("gradeid"),this.pageno=this.editor.currentpage,this.x=t.start.x,this.y=t.start.y,this.endx=t.end.x,this.endy=t.end.y,this.colour=t.annotationcolour,this.path="",!(this.endx-this.x==0&&this.endy-this.y==0)}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.annotationline=a,(o=function(t){o.superclass.constructor.apply(this,[t])}).NAME="annotationrectangle",o.ATTRS={},g.extend(o,M.assignfeedback_editpdf.annotation,{draw:function(){var t,e,i;return t=new M.assignfeedback_editpdf.drawable(this.editor),(e=new M.assignfeedback_editpdf.rect).bound([new M.assignfeedback_editpdf.point(this.x,this.y),new M.assignfeedback_editpdf.point(this.endx,this.endy)]),i=this.editor.graphic.addShape({type:g.Rect,width:e.width,height:e.height,stroke:{weight:ht,color:ot[this.colour]},x:e.x,y:e.y}),t.shapes.push(i),this.drawable=t,o.superclass.draw.apply(this)},draw_current_edit:function(t){var e,i,n=new M.assignfeedback_editpdf.drawable(this.editor);return(i=new M.assignfeedback_editpdf.rect).bound([new M.assignfeedback_editpdf.point(t.start.x,t.start.y),new M.assignfeedback_editpdf.point(t.end.x,t.end.y)]),i.has_min_width()||i.set_min_width(),i.has_min_height()||i.set_min_height(),e=this.editor.graphic.addShape({type:g.Rect,width:i.width,height:i.height,stroke:{weight:ht,color:ot[t.annotationcolour]},x:i.x,y:i.y}),n.shapes.push(e),n}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.annotationrectangle=o,(r=function(t){r.superclass.constructor.apply(this,[t])}).NAME="annotationoval",r.ATTRS={},g.extend(r,M.assignfeedback_editpdf.annotation,{draw:function(){var t,e,i;return t=new M.assignfeedback_editpdf.drawable(this.editor),(e=new M.assignfeedback_editpdf.rect).bound([new M.assignfeedback_editpdf.point(this.x,this.y),new M.assignfeedback_editpdf.point(this.endx,this.endy)]),i=this.editor.graphic.addShape({type:g.Ellipse,width:e.width,height:e.height,stroke:{weight:ht,color:ot[this.colour]},x:e.x,y:e.y}),t.shapes.push(i),this.drawable=t,r.superclass.draw.apply(this)},draw_current_edit:function(t){var e,i,n=new M.assignfeedback_editpdf.drawable(this.editor);return(i=new M.assignfeedback_editpdf.rect).bound([new M.assignfeedback_editpdf.point(t.start.x,t.start.y),new M.assignfeedback_editpdf.point(t.end.x,t.end.y)]),i.has_min_width()||i.set_min_width(),i.has_min_height()||i.set_min_height(),e=this.editor.graphic.addShape({type:g.Ellipse,width:i.width,height:i.height,stroke:{weight:ht,color:ot[t.annotationcolour]},x:i.x,y:i.y}),n.shapes.push(e),n}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.annotationoval=r,(d=function(t){d.superclass.constructor.apply(this,[t])}).NAME="annotationpen",d.ATTRS={},g.extend(d,M.assignfeedback_editpdf.annotation,{draw:function(){var t,e,i,n,s;return t=new M.assignfeedback_editpdf.drawable(this.editor),e=this.editor.graphic.addShape({type:g.Path,fill:!1,stroke:{weight:ht,color:ot[this.colour]}}),i=!0,n=this.path.split(":"),g.each(n,function(t){s=t.split(","),i?(e.moveTo(s[0],s[1]),i=!1):e.lineTo(s[0],s[1])},this),e.end(),t.shapes.push(e),this.drawable=t,d.superclass.draw.apply(this)},draw_current_edit:function(t){var e,i,n=new M.assignfeedback_editpdf.drawable(this.editor);return e=this.editor.graphic.addShape({type:g.Path,fill:!1,stroke:{weight:ht,color:ot[t.annotationcolour]}}),i=!0,g.each(t.path,function(t){i?(e.moveTo(t.x,t.y),i=!1):e.lineTo(t.x,t.y)},this),e.end(),n.shapes.push(e),n},init_from_edit:function(t){var e=new M.assignfeedback_editpdf.rect,i=[],n=0;for(e.bound(t.path),n=0;n<t.path.length;n++)i.push(parseInt(t.path[n].x,10)+","+parseInt(t.path[n].y,10));return this.gradeid=this.editor.get("gradeid"),this.pageno=this.editor.currentpage,this.x=e.x,this.y=e.y,this.endx=e.x+e.width,this.endy=e.y+e.height,this.colour=t.annotationcolour,this.path=i.join(":"),e.has_min_width()||e.has_min_height()}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.annotationpen=d,(h=function(t){h.superclass.constructor.apply(this,[t])}).NAME="annotationhighlight",h.ATTRS={},g.extend(h,M.assignfeedback_editpdf.annotation,{draw:function(){var t,e,i,n;return t=new M.assignfeedback_editpdf.drawable(this.editor),(i=new M.assignfeedback_editpdf.rect).bound([new M.assignfeedback_editpdf.point(this.x,this.y),new M.assignfeedback_editpdf.point(this.endx,this.endy)]),n=(n=(n=ot[this.colour]).replace("rgb","rgba")).replace(")",",0.5)"),e=this.editor.graphic.addShape({type:g.Rect,width:i.width,height:i.height,stroke:!1,fill:{color:n},x:i.x,y:i.y}),t.shapes.push(e),this.drawable=t,h.superclass.draw.apply(this)},draw_current_edit:function(t){var e,i,n,s=new M.assignfeedback_editpdf.drawable(this.editor);return(i=new M.assignfeedback_editpdf.rect).bound([new M.assignfeedback_editpdf.point(t.start.x,t.start.y),new M.assignfeedback_editpdf.point(t.end.x,t.end.y)]),i.has_min_width(
)||i.set_min_width(),n=(n=(n=ot[t.annotationcolour]).replace("rgb","rgba")).replace(")",",0.5)"),e=this.editor.graphic.addShape({type:g.Rect,width:i.width,height:20,stroke:!1,fill:{color:n},x:i.x,y:t.start.y-10}),s.shapes.push(e),s},init_from_edit:function(t){var e=new M.assignfeedback_editpdf.rect;return e.bound([t.start,t.end]),this.gradeid=this.editor.get("gradeid"),this.pageno=this.editor.currentpage,this.x=e.x,this.y=t.start.y-10,this.endx=e.x+e.width,this.endy=t.start.y+10,this.colour=t.annotationcolour,this.page="",e.has_min_width()}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.annotationhighlight=h,(c=function(t){c.superclass.constructor.apply(this,[t])}).NAME="annotationstamp",c.ATTRS={},g.extend(c,M.assignfeedback_editpdf.annotation,{draw:function(){var t,e,i=new M.assignfeedback_editpdf.drawable(this.editor),n=this.editor.get_dialogue_element(J);return e=this.editor.get_window_coordinates(new M.assignfeedback_editpdf.point(this.x,this.y)),(t=g.Node.create("<div/>")).addClass("annotation"),t.addClass("stamp"),t.setStyles({position:"absolute",display:"inline-block",backgroundImage:"url("+this.editor.get_stamp_image_url(this.path)+")",width:this.endx-this.x,height:this.endy-this.y,backgroundSize:"100% 100%"}),n.append(t),t.setX(e.x),t.setY(e.y),i.store_position(t,e.x,e.y),this.editor.get("readonly")||(t.on("gesturemovestart",this.editor.edit_start,null,this.editor),t.on("gesturemove",this.editor.edit_move,null,this.editor),t.on("gesturemoveend",this.editor.edit_end,null,this.editor)),i.nodes.push(t),this.drawable=i,c.superclass.draw.apply(this)},draw_current_edit:function(t){var e,i,n=new M.assignfeedback_editpdf.rect,s=new M.assignfeedback_editpdf.drawable(this.editor),a=this.editor.get_dialogue_element(F);return n.bound([t.start,t.end]),i=this.editor.get_window_coordinates(new M.assignfeedback_editpdf.point(n.x,n.y)),(e=g.Node.create("<div/>")).addClass("annotation"),e.addClass("stamp"),e.setStyles({position:"absolute",display:"inline-block",backgroundImage:"url("+this.editor.get_stamp_image_url(t.stamp)+")",width:n.width,height:n.height,backgroundSize:"100% 100%"}),a.append(e),e.setX(i.x),e.setY(i.y),s.store_position(e,i.x,i.y),s.nodes.push(e),s},init_from_edit:function(t){var e=new M.assignfeedback_editpdf.rect;return e.bound([t.start,t.end]),e.width<40&&(e.width=40),e.height<40&&(e.height=40),this.gradeid=this.editor.get("gradeid"),this.pageno=this.editor.currentpage,this.x=e.x,this.y=e.y,this.endx=e.x+e.width,this.endy=e.y+e.height,this.colour=t.annotationcolour,this.path=t.stamp,!0},move:function(t,e){var i=t-this.x,n=e-this.y;this.x+=i,this.y+=n,this.endx+=i,this.endy+=n,this.drawable&&this.drawable.erase(),this.editor.drawables.push(this.draw())}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.annotationstamp=c,l="Dropdown menu",u=function(t){t.draggable=!1,t.centered=!1,t.width="auto",t.visible=!1,t.footerContent="",u.superclass.constructor.apply(this,[t])},g.extend(u,M.core.dialogue,{initializer:function(t){var e,i,n;u.superclass.initializer.call(this,t),this.get("boundingBox").addClass("assignfeedback_editpdf_dropdown"),e=this.get("buttonNode"),i=this.bodyNode,(n=g.Node.create("<h3/>")).addClass("accesshide"),n.setHTML(this.get("headerText")),i.prepend(n),i.on("clickoutside",function(t){this.get("visible")&&t.target.get("id")!==e.get("id")&&t.target.ancestor().get("id")!==e.get("id")&&(t.preventDefault(),this.hide())},this),e.on("click",function(t){t.preventDefault(),this.show()},this),e.on("key",this.show,"enter,space",this)},show:function(){var t=this.get("buttonNode"),e=u.superclass.show.call(this);return this.align(t,[g.WidgetPositionAlign.TL,g.WidgetPositionAlign.BL]),e}},{NAME:l,ATTRS:{headerText:{value:""},buttonNode:{value:null}}}),g.Base.modifyAttrs(u,{modal:{getter:function(){return!1}}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.dropdown=u,p="Colourpicker",f=function(t){f.superclass.constructor.apply(this,[t])},g.extend(f,M.assignfeedback_editpdf.dropdown,{initializer:function(t){var e,r=g.Node.create('<ul role="menu" class="assignfeedback_editpdf_menu"/>');g.each(this.get("colours"),function(t,e){var i,n,s,a,o;s=M.util.get_string(e,"assignfeedback_editpdf"),o=this.get("iconprefix")+e,a=M.util.image_url(o,"assignfeedback_editpdf"),(i=g.Node.create('<button><img alt="'+s+'" src="'+a+'"/></button>')).setAttribute("data-colour",e),i.setAttribute("data-rgb",t),i.setStyle("backgroundImage","none"),(n=g.Node.create("<li/>")).append(i),r.append(n)},this),e=g.Node.create("<div/>"),r.delegate("click",this.callback_handler,"button",this),r.delegate("key",this.callback_handler,"down:13","button",this),this.set("headerText",M.util.get_string("colourpicker","assignfeedback_editpdf")),e.append(r),this.set("bodyContent",e),f.superclass.initializer.call(this,t)},callback_handler:function(t){t.preventDefault();var e=this.get("callback"),i=this.get("context");this.hide(),g.bind(e,i,t)()}},{NAME:p,ATTRS:{colours:{value:{}},callback:{value:null},context:{value:null},iconprefix:{value:"colour_"}}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.colourpicker=f,_="Colourpicker",m=function(t){m.superclass.constructor.apply(this,[t])},g.extend(m,M.assignfeedback_editpdf.dropdown,{initializer:function(t){var s=g.Node.create('<ul role="menu" class="assignfeedback_editpdf_menu"/>');g.each(this.get("stamps"),function(t){var e,i,n;n=M.util.get_string("stamp","assignfeedback_editpdf"),(e=g.Node.create('<button><img height="16" width="16" alt="'+n+'" src="'+t+'"/></button>')).setAttribute("data-stamp",t),e.setStyle("backgroundImage","none"),(i=g.Node.create("<li/>")).append(e),s.append(i)},this),s.delegate("click",this.callback_handler,"button",this),s.delegate("key",this.callback_handler,"down:13","button",this),this.set("headerText",M.util.get_string("stamppicker","assignfeedback_editpdf")),this.set("bodyContent",s),m.superclass.initializer.call(this,
t)},callback_handler:function(t){t.preventDefault();var e=this.get("callback"),i=this.get("context");this.hide(),g.bind(e,i,t)()}},{NAME:_,ATTRS:{stamps:{value:[]},callback:{value:null},context:{value:null}}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.stamppicker=m,b="Commentmenu",w=function(t){w.superclass.constructor.apply(this,[t])},g.extend(w,M.assignfeedback_editpdf.dropdown,{initializer:function(t){var e,i,n,s;s=this.get("comment"),e=g.Node.create('<ul role="menu" class="assignfeedback_editpdf_menu"/>'),(i=g.Node.create('<li><a tabindex="-1" href="#">'+M.util.get_string("addtoquicklist","assignfeedback_editpdf")+"</a></li>")).on("click",s.add_to_quicklist,s),i.on("key",s.add_to_quicklist,"enter,space",s),e.append(i),(i=g.Node.create('<li><a tabindex="-1" href="#">'+M.util.get_string("deletecomment","assignfeedback_editpdf")+"</a></li>")).on("click",function(t){t.preventDefault(),this.menu.hide(),this.remove()},s),i.on("key",function(){s.menu.hide(),s.remove()},"enter,space",s),e.append(i),i=g.Node.create("<li><hr/></li>"),e.append(i),this.set("headerText",M.util.get_string("commentcontextmenu","assignfeedback_editpdf")),(n=g.Node.create("<div/>")).append(e),this.set("bodyContent",n),w.superclass.initializer.call(this,t)},show:function(){var s,a=this.get("boundingBox").one("ul");a.all(".quicklist_comment").remove(!0),(s=this.get("comment")).deleteme=!1,g.each(s.editor.quicklist.comments,function(t){var e=g.Node.create('<li class="quicklist_comment"></li>'),i=g.Node.create('<a href="#" tabindex="-1">'+t.rawtext+"</a>"),n=g.Node.create('<a href="#" tabindex="-1" class="delete_quicklist_comment"><img src="'+M.util.image_url("t/delete","core")+'" alt="'+M.util.get_string("deletecomment","assignfeedback_editpdf")+'"/></a>');i.setAttribute("title",t.rawtext),e.append(i),e.append(n),a.append(e),e.on("click",s.set_from_quick_comment,s,t),e.on("key",s.set_from_quick_comment,"space,enter",s,t),n.on("click",s.remove_from_quicklist,s,t),n.on("key",s.remove_from_quicklist,"space,enter",s,t)},this),w.superclass.show.call(this)}},{NAME:b,ATTRS:{comment:{value:null}}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.commentmenu=w,y="commentsearch",k=function(t){t.draggable=!1,t.centered=!0,t.width="400px",t.visible=!1,t.headerContent=M.util.get_string("searchcomments","assignfeedback_editpdf"),t.footerContent="",k.superclass.constructor.apply(this,[t])},g.extend(k,M.core.dialogue,{initializer:function(t){var e,i,n,s;this.get("boundingBox").addClass("assignfeedback_editpdf_commentsearch"),this.get("editor"),e=g.Node.create("<div/>"),i=M.util.get_string("filter","assignfeedback_editpdf"),n=g.Node.create('<input type="text" size="20" placeholder="'+i+'"/>'),e.append(n),s=g.Node.create('<ul role="menu" class="assignfeedback_editpdf_search"/>'),e.append(s),n.on("keyup",this.filter_search_comments,this),s.delegate("click",this.focus_on_comment,"a",this),s.delegate("key",this.focus_on_comment,"enter,space","a",this),this.set("bodyContent",e),k.superclass.initializer.call(this,t)},filter_search_comments:function(){var t,e,i,n;n=this.get("id"),t=g.one("#"+n+O),e=g.one("#"+n+B),i=t.get("value"),e.all("li").each(function(t){-1!==t.get("text").indexOf(i)?t.show():t.hide()})},focus_on_comment:function(t){t.preventDefault();var e=t.target.ancestor("li").getData("comment"),i=this.get("editor");this.hide(),e.pageno=e.clean().pageno,e.pageno!==i.currentpage&&(i.currentpage=e.pageno,i.change_page()),e.node=e.drawable.nodes[0].one("textarea"),e.node.ancestor("div").removeClass("commentcollapsed"),e.node.focus()},show:function(){var i=this.get("boundingBox").one("ul"),t=this.get("editor");i.all("li").remove(!0),g.each(t.pages,function(t){g.each(t.comments,function(t){var e=g.Node.create('<li><a href="#" tabindex="-1"><pre>'+t.rawtext+"</pre></a></li>");i.append(e),e.setData("comment",t)},this)},this),this.centerDialogue(),k.superclass.show.call(this)}},{NAME:y,ATTRS:{editor:{value:null}}}),g.Base.modifyAttrs(k,{modal:{getter:function(){return!0}}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.commentsearch=k,v=function(c,t,e,i,n,s,a,o){this.editor=c,this.gradeid=t||0,this.x=parseInt(i,10)||0,this.y=parseInt(n,10)||0,this.width=parseInt(s,10)||0,this.rawtext=o||"",this.pageno=e||0,this.colour=a||"yellow",this.drawable=!1,this.deleteme=!1,this.menulink=null,this.menu=null,this.clean=function(){return{gradeid:this.gradeid,x:parseInt(this.x,10),y:parseInt(this.y,10),width:parseInt(this.width,10),rawtext:this.rawtext,pageno:parseInt(this.pageno,10),colour:this.colour}},this.draw=function(t){var e,i,n,s,a,o,r,d=new M.assignfeedback_editpdf.drawable(this.editor),h=this.editor.get_dialogue_element(J);return e=g.Node.create("<textarea/>"),i=g.Node.create('<div class="commentdrawable"/>'),n=g.Node.create("<label/>"),s=g.Node.create('<svg xmlns="http://www.w3.org/2000/svg" viewBox="-0.5 -0.5 13 13" preserveAspectRatio="xMinYMin meet"><path d="M11 0H1C.4 0 0 .4 0 1v6c0 .6.4 1 1 1h1v4l4-4h5c.6 0 1-.4 1-1V1c0-.6-.4-1-1-1z" fill="currentColor" opacity="0.9" stroke="rgb(153, 153, 153)" stroke-width="0.5"/></svg>'),a=g.Node.create('<a href="#"><img src="'+M.util.image_url("t/contextmenu","core")+'"/></a>'),this.menulink=a,i.append(n),n.append(e),i.append(s),i.setAttribute("tabindex","-1"),n.setAttribute("tabindex","0"),e.setAttribute("tabindex","-1"),a.setAttribute("tabindex","0"),this.editor.get("readonly")?e.setAttribute("readonly","readonly"):i.append(a),this.width<100&&(this.width=100),o=this.editor.get_window_coordinates(new M.assignfeedback_editpdf.point(this.x,this.y)),e.setStyles({width:this.width+"px",backgroundColor:at[this.colour],color:st}),h.append(i),i.setStyle("position","absolute"),i.setX(o.x),i.setY(o.y),d.store_position(i,o.x,o.y),d.nodes.push(i),e.set("value",this.rawtext),r=e.get("scrollHeight"),e.setStyles({height:r+"px",overflow:"hidden"}),s.setStyle("color",at[this.colour]),this.attach_events(e,a),t?e.focus(
):c.collapsecomments&&i.addClass("commentcollapsed"),this.drawable=d},this.delete_comment_later=function(){this.deleteme&&this.remove()},this.attach_events=function(o,e){var r=o.ancestor("div"),t=o.ancestor("label"),i=t.next("svg");o.collapse=function(t){o.collapse.delay=g.later(t,o,function(){c.collapsecomments&&r.addClass("commentcollapsed")})},o.expand=function(){!0!==o.getData("dragging")&&(o.collapse.delay&&o.collapse.delay.cancel(),r.removeClass("commentcollapsed"))},r.on("mouseenter",function(){"comment"!==c.currentedit.tool&&"select"!==c.currentedit.tool&&!this.editor.get("readonly")||o.expand()},this),r.on("click|tap",function(){o.expand(),o.focus()},this),o.on("keyup",function(t){9===t.keyCode&&t.shiftKey&&"0"===e.getAttribute("tabindex")&&e.focus(),e.setAttribute("tabindex","0")},this),e.on("keydown",function(t){9===t.keyCode&&t.shiftKey&&e.setAttribute("tabindex","-1")},this),t.on("focus",function(){o.active=!0,o.collapse.delay&&o.collapse.delay.cancel(),o.setAttribute("tabindex","0"),o.expand(),o.focus(),t.setAttribute("tabindex","-1")},this),e.on("focus",function(){o.active=!0,o.collapse.delay&&o.collapse.delay.cancel(),this.deleteme=!1,t.setAttribute("tabindex","0")},this),o.on("blur",function(){o.setAttribute("tabindex","-1")},this),t.on("blur",function(){t.setAttribute("tabindex","0")},this),r.on("mouseleave",function(){c.collapsecomments&&!0!==o.active&&o.collapse(400)},this),r.on("blur",function(){o.active=!1,o.collapse(800)},this),this.editor.get("readonly")||(o.on("blur",function(){this.rawtext=o.get("value"),this.width=parseInt(o.getStyle("width"),10),""===this.rawtext.replace(/^\s+|\s+$/g,"")&&(this.deleteme=!0,g.later(400,this,this.delete_comment_later)),this.editor.save_current_page(),this.editor.editingcomment=!1},this),e.setData("comment",this),o.on("keyup",function(){o.setStyle("height","auto");var t=o.get("scrollHeight");t===parseInt(o.getStyle("height"),10)+8&&(t-=8),o.setStyle("height",t+"px")}),o.on("gesturemovestart",function(t){"select"===c.currentedit.tool&&(t.preventDefault(),c.collapsecomments?(o.setData("offsetx",8),o.setData("offsety",8)):(o.setData("offsetx",t.clientX-r.getX()),o.setData("offsety",t.clientY-r.getY())))}),o.on("gesturemove",function(t){if("select"===c.currentedit.tool){var e,i,n,s=t.clientX-o.getData("offsetx"),a=t.clientY-o.getData("offsety");!0!==o.getData("dragging")&&(o.collapse(0),o.setData("dragging",!0)),e=this.editor.get_canvas_coordinates(new M.assignfeedback_editpdf.point(s,a)),(n=this.editor.get_canvas_bounds(!0)).x=0,n.y=0,n.width-=24,n.height-=24,e.clip(n),this.x=e.x,this.y=e.y,i=this.editor.get_window_coordinates(e),r.setX(i.x),r.setY(i.y),this.drawable.store_position(r,i.x,i.y)}},null,this),o.on("gesturemoveend",function(){"select"===c.currentedit.tool&&(!0===o.getData("dragging")&&o.setData("dragging",!1),this.editor.save_current_page())},null,this),i.on("gesturemovestart",function(t){"select"===c.currentedit.tool&&(t.preventDefault(),o.setData("offsetx",t.clientX-r.getX()),o.setData("offsety",t.clientY-r.getY()),o.expand())}),i.on("gesturemove",function(t){if("select"===c.currentedit.tool){var e,i,n,s=t.clientX-o.getData("offsetx"),a=t.clientY-o.getData("offsety");!0!==o.getData("dragging")&&(o.collapse(100),o.setData("dragging",!0)),e=this.editor.get_canvas_coordinates(new M.assignfeedback_editpdf.point(s,a)),(n=this.editor.get_canvas_bounds(!0)).x=0,n.y=0,n.width-=24,n.height-=24,e.clip(n),this.x=e.x,this.y=e.y,i=this.editor.get_window_coordinates(e),r.setX(i.x),r.setY(i.y),this.drawable.store_position(r,i.x,i.y)}},null,this),i.on("gesturemoveend",function(){"select"===c.currentedit.tool&&(!0===o.getData("dragging")&&o.setData("dragging",!1),this.editor.save_current_page())},null,this),this.menu=new M.assignfeedback_editpdf.commentmenu({buttonNode:this.menulink,comment:this}))},this.remove=function(){var t=0,e=this.editor.pages[this.editor.currentpage].comments;for(t=0;t<e.length;t++)if(e[t]===this)return e.splice(t,1),this.drawable.erase(),void this.editor.save_current_page()},this.remove_from_quicklist=function(t,e){t.preventDefault(),t.stopPropagation(),this.menu.hide(),this.editor.quicklist.remove(e)},this.set_from_quick_comment=function(t,e){t.preventDefault(),this.menu.hide(),this.deleteme=!1,this.rawtext=e.rawtext,this.width=e.width,this.colour=e.colour,this.editor.save_current_page(),this.editor.redraw(),this.node=this.drawable.nodes[0].one("textarea"),this.node.ancestor("div").removeClass("commentcollapsed"),this.node.focus()},this.add_to_quicklist=function(t){t.preventDefault(),this.menu.hide(),this.editor.quicklist.add(this)},this.draw_current_edit=function(t){var e,i,n=new M.assignfeedback_editpdf.drawable(this.editor);return(i=new M.assignfeedback_editpdf.rect).bound([t.start,t.end]),e=this.editor.graphic.addShape({type:g.Rect,width:i.width,height:i.height,fill:{color:at[t.commentcolour]},x:i.x,y:i.y}),n.shapes.push(e),n},this.init_from_edit=function(t){var e=new M.assignfeedback_editpdf.rect;return e.bound([t.start,t.end]),e.width<100&&(e.width=100),this.gradeid=this.editor.get("gradeid"),this.pageno=this.editor.currentpage,this.x=e.x,this.y=e.y,this.width=e.width,this.colour=t.commentcolour,this.rawtext="",e.has_min_width()&&e.has_min_height()},this.updatePosition=function(){var t=this.drawable.nodes[0].one("textarea"),e=t.ancestor("div"),i=new M.assignfeedback_editpdf.point(this.x,this.y),n=this.editor.get_window_coordinates(i);e.setX(n.x),e.setY(n.y),this.drawable.store_position(e,n.x,n.y)}},M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.comment=v,x=function(t,e,i,n){this.rawtext=e||"",this.id=t||0,this.width=i||100,this.colour=n||"yellow"},M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.quickcomment=x,S=function(t){this.editor=t,this.comments=[],this.add=function(t){var e,i=q;""!==t.rawtext&&(e={method:"post",context:this,sync:!1,data:{sesskey:M.cfg.sesskey,action:"addtoquicklist",userid:this.editor.get("userid"),
commenttext:t.rawtext,width:t.width,colour:t.colour,attemptnumber:this.editor.get("attemptnumber"),assignmentid:this.editor.get("assignmentid")},on:{success:function(t,e){var i,n;try{if((i=g.JSON.parse(e.responseText)).error)return new M.core.ajaxException(i);n=new M.assignfeedback_editpdf.quickcomment(i.id,i.rawtext,i.width,i.colour),this.comments.push(n),this.comments.sort(function(t,e){return t.rawtext.localeCompare(e.rawtext)})}catch(s){return new M.core.exception(s)}},failure:function(t,e){return M.core.exception(e.responseText)}}},g.io(i,e))},this.remove=function(e){var t,i=q;e&&(t={method:"post",context:this,sync:!1,data:{sesskey:M.cfg.sesskey,action:"removefromquicklist",userid:this.editor.get("userid"),commentid:e.id,attemptnumber:this.editor.get("attemptnumber"),assignmentid:this.editor.get("assignmentid")},on:{success:function(){var t;0<=(t=this.comments.indexOf(e))&&this.comments.splice(t,1)},failure:function(t,e){return M.core.exception(e.responseText)}}},g.io(i,t))},this.load=function(){var t,e=q;t={method:"get",context:this,sync:!1,data:{sesskey:M.cfg.sesskey,action:"loadquicklist",userid:this.editor.get("userid"),attemptnumber:this.editor.get("attemptnumber"),assignmentid:this.editor.get("assignmentid")},on:{success:function(t,e){var i;try{if((i=g.JSON.parse(e.responseText)).error)return new M.core.ajaxException(i);g.each(i,function(t){var e=new M.assignfeedback_editpdf.quickcomment(t.id,t.rawtext,t.width,t.colour);this.comments.push(e)},this),this.comments.sort(function(t,e){return t.rawtext.localeCompare(e.rawtext)})}catch(n){return new M.core.exception(n)}},failure:function(t,e){return M.core.exception(e.responseText)}}},g.io(e,t)}},M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.quickcommentlist=S,(N=function(){N.superclass.constructor.apply(this,arguments)}).prototype={oldannotationcoordinates:null,dialogue:null,panel:null,pagecount:0,currentpage:0,pages:[],documentstatus:0,loadingicon:null,pageimage:null,graphic:null,currentedit:new M.assignfeedback_editpdf.edit,currentdrawable:!1,drawables:[],currentcomment:null,currentannotation:null,lastannotation:null,lastannotationtool:"pen",quicklist:null,searchcommentswindow:null,htmleditorwindow:null,currentstamp:null,stamps:[],editingcomment:!1,editinghtmlcomment:!1,collapsecomments:!0,initializer:function(){var n;(n=g.one("#"+this.get("linkid")))&&(n.on("click",this.link_handler,this),n.on("key",this.link_handler,"down:13",this),require(["mod_assign/grading_review_panel"],function(t){var e=new t,i=e.getReviewPanel("assignfeedback_editpdf");i&&((i=g.one(i)).empty(),n.ancestor(".fitem").hide(),this.open_in_panel(i)),this.currentedit.start=!1,this.currentedit.end=!1,this.get("readonly")||(this.quicklist=new M.assignfeedback_editpdf.quickcommentlist(this))}.bind(this)))},refresh_button_state:function(){var t,e,i,n,s;switch(t=this.get_dialogue_element(W),i=M.util.image_url("background_colour_"+this.currentedit.commentcolour,"assignfeedback_editpdf"),t.one("img").setAttribute("src",i),"clear"===this.currentedit.commentcolour?t.one("img").setStyle("borderStyle","dashed"):t.one("img").setStyle("borderStyle","solid"),t=this.get_dialogue_element($),i=M.util.image_url("colour_"+this.currentedit.annotationcolour,"assignfeedback_editpdf"),t.one("img").setAttribute("src",i),(e=this.get_dialogue_element(dt[this.currentedit.tool])).addClass("assignfeedback_editpdf_selectedbutton"),e.setAttribute("aria-pressed","true"),this.get_dialogue_element(F).setAttribute("data-currenttool",this.currentedit.tool),t=this.get_dialogue_element(Q),n=this.get_stamp_image_url(this.currentedit.stamp),t.one("img").setAttrs({src:n,height:"16",width:"16"}),s=this.get_dialogue_element(J),this.currentedit.tool){case"drag":s.setStyle("cursor","move");break;case"highlight":s.setStyle("cursor","text");break;case"select":s.setStyle("cursor","default");break;case"stamp":s.setStyle("cursor","url("+n+"), crosshair");break;default:s.setStyle("cursor","crosshair")}},get_canvas_bounds:function(){var t=this.get_dialogue_element(J),e=t.getXY(),i=e[0],n=e[1],s=parseInt(t.getStyle("width"),10),a=parseInt(t.getStyle("height"),10);return new M.assignfeedback_editpdf.rect(i,n,s,a)},get_canvas_coordinates:function(t){var e=this.get_canvas_bounds(),i=new M.assignfeedback_editpdf.point(t.x-e.x,t.y-e.y);return e.x=e.y=0,i.clip(e),i},get_window_coordinates:function(t){var e=this.get_canvas_bounds();return new M.assignfeedback_editpdf.point(t.x+e.x,t.y+e.y)},open_in_panel:function(t){var e;(this.panel=t).append(this.get("body")),t.addClass(Y),this.loadingicon=this.get_dialogue_element(j),e=this.get_dialogue_element(J),this.graphic=new g.Graphic({render:e}),this.get("readonly")||(e.on("gesturemovestart",this.edit_start,null,this),e.on("gesturemove",this.edit_move,null,this),e.on("gesturemoveend",this.edit_end,null,this),this.refresh_button_state()),this.start_generation()},link_handler:function(t){var e,i=!0;t.preventDefault(),this.dialogue||(this.dialogue=new M.core.dialogue({headerContent:this.get("header"),bodyContent:this.get("body"),footerContent:this.get("footer"),modal:!0,width:"840px",visible:!1,draggable:!0}),this.dialogue.get("boundingBox").addClass(Y),this.loadingicon=this.get_dialogue_element(j),e=this.get_dialogue_element(J),this.graphic=new g.Graphic({render:e}),this.get("readonly")||(e.on("gesturemovestart",this.edit_start,null,this),e.on("gesturemove",this.edit_move,null,this),e.on("gesturemoveend",this.edit_end,null,this),this.refresh_button_state()),this.start_generation(),e.on("windowresize",this.resize,this),i=!1),this.dialogue.centerDialogue(),this.dialogue.show(),this.dialogue.dd.on("drag:end",this.redraw,this),i&&this.resize()},start_generation:function(){this.poll_document_conversion_status()},poll_document_conversion_status:function(){var o=this.get("userid");g.io(q,{method:"get",context:this,sync:!1,data:{sesskey:M.cfg.sesskey,action:"pollconversions",userid:this.get("userid"),attemptnumber:this.get("attemptnumber"),
assignmentid:this.get("assignmentid"),readonly:this.get("readonly")?1:0},on:{success:function(t,e){var i,n,s,a=g.one(U);a&&(i=a.getAttribute("data-userid"))&&i!=o||(s=!1,(n=this.handle_response_data(e))&&(this.documentstatus=n.status,0===n.status||1===n.status||3===n.status?s=!0:2!==n.status&&-1!==n.status||(this.pagecount=n.pagecount,n.pageready==n.pagecount?this.prepare_pages_for_display(n):(this.update_page_load_progress(),this.start_document_to_image_conversion())),s&&g.later(1e3,this,this.poll_document_conversion_status)))},failure:function(t,e){return new M.core.exception(e.responseText)}}})},start_document_to_image_conversion:function(){g.io(q,{method:"get",context:this,sync:!1,data:{sesskey:M.cfg.sesskey,action:"pollconversions",userid:this.get("userid"),attemptnumber:this.get("attemptnumber"),assignmentid:this.get("assignmentid"),readonly:this.get("readonly")?1:0},on:{success:function(t,e){var i=this.handle_response_data(e);i&&(this.documentstatus=i.status,2===i.status&&this.prepare_pages_for_display(i))},failure:function(t,e){return new M.core.exception(e.responseText)}}})},warning:function(t,e){var i,n=this.get_dialogue_element(G),s=this.get_dialogue_element(V),a=15,o=1,r="assignfeedback_editpdf_warningmessages alert alert-warning";e&&(a=4,r="assignfeedback_editpdf_warningmessages alert alert-info"),(i=g.Node.create('<div class="'+r+'" role="alert"></div>')).append(n.one("*").cloneNode()),i.append(t),s.prepend(i),i.transition({duration:o,delay:a,opacity:0},function(){i.remove()})},prepare_pages_for_display:function(t){var e,i,n,s,a;if(!t.pagecount)return this.dialogue&&this.dialogue.hide(),void new M.core.alert({message:M.util.get_string("cannotopenpdf","assignfeedback_editpdf")}).show();for(this.pages=t.pages,e=0;e<this.pages.length;e++){for(i=0;i<this.pages[e].comments.length;i++)n=this.pages[e].comments[i],this.pages[e].comments[i]=new M.assignfeedback_editpdf.comment(this,n.gradeid,n.pageno,n.x,n.y,n.width,n.colour,n.rawtext);for(i=0;i<this.pages[e].htmlcomments.length;i++)s=this.pages[e].htmlcomments[i],this.pages[e].htmlcomments[i]=new M.assignfeedback_editpdf.htmlcomment(this,s.gradeid,s.pageno,s.x,s.y,s.width,s.colour,s.rawtext);for(i=0;i<this.pages[e].annotations.length;i++)a=this.pages[e].annotations[i],this.pages[e].annotations[i]=this.create_annotation(a.type,a)}!this.get("readonly")&&t.partial&&this.warning(M.util.get_string("partialwarning","assignfeedback_editpdf"),!1),this.quicklist&&this.quicklist.load(),this.setup_navigation(),this.setup_toolbar(),this.change_page()},update_page_load_progress:function(){var s,a=0;this.get_dialogue_element(H+" .bar")&&(s={method:"get",context:this,sync:!1,data:{sesskey:M.cfg.sesskey,action:"conversionstatus",userid:this.get("userid"),attemptnumber:this.get("attemptnumber"),assignmentid:this.get("assignmentid")},on:{success:function(t,e){var i,n;i=a=0,(n=this.get_dialogue_element(H+" .bar"))&&(i=e.response/this.pagecount*100,n.setStyle("width",i+"%"),n.ancestor(H).setAttribute("aria-valuenow",i),i<100&&(M.util.js_pending("checkconversionstatus"),g.later(1e3,this,function(){M.util.js_complete("checkconversionstatus"),g.io(E,s)})))},failure:function(t,e){return a+=1,0===this.pagecount&&a<5&&(M.util.js_pending("checkconversionstatus"),g.later(1e3,this,function(){M.util.js_complete("checkconversionstatus"),g.io(E,s)})),new M.core.exception(e.responseText)}}},M.util.js_pending("checkconversionstatus"),g.later(1e3,this,function(){a=0,M.util.js_complete("checkconversionstatus"),g.io(E,s)}))},handle_response_data:function(t){var e;try{if(!(e=g.JSON.parse(t.responseText)).error)return e;this.dialogue&&this.dialogue.hide(),new M.core.alert({message:M.util.get_string("cannotopenpdf","assignfeedback_editpdf"),visible:!0})}catch(i){this.dialogue&&this.dialogue.hide(),new M.core.alert({title:M.util.get_string("cannotopenpdf","assignfeedback_editpdf"),visible:!0})}},get_stamp_image_url:function(e){var t=this.get("stampfiles"),i="";return g.Array.each(t,function(t){0<t.indexOf(e)&&(i=t)},this),i},setup_toolbar:function(){var i,t,e,n,s,a,o,r,d,h,c;null!==(c=this.get_dialogue_element(et))&&"unknown"!==c&&(c.on("click",this.open_htmleditor,this),c.on("key",this.open_htmleditor,"down:13",this)),(n=this.get_dialogue_element(X)).on("click",this.open_search_comments,this),n.on("key",this.open_search_comments,"down:13",this),(s=this.get_dialogue_element(L)).on("click",this.expandCollapseComments,this),s.on("key",this.expandCollapseComments,"down:13",this),this.get("readonly")||((a=this.get_dialogue_element(Z)).on("click",this.rotatePDF,this,!0),a.on("key",this.rotatePDF,"down:13",this,!0),(o=this.get_dialogue_element(tt)).on("click",this.rotatePDF,this,!1),o.on("key",this.rotatePDF,"down:13",this,!1),this.disable_touch_scroll(),g.each(dt,function(t,e){(i=this.get_dialogue_element(t)).on("click",this.handle_tool_button,this,e),i.on("key",this.handle_tool_button,"down:13",this,e),i.setAttribute("aria-pressed","false")},this),t=this.get_dialogue_element(W),new M.assignfeedback_editpdf.colourpicker({buttonNode:t,colours:at,iconprefix:"background_colour_",callback:function(t){var e=t.target.getAttribute("data-colour");e=e||t.target.ancestor().getAttribute("data-colour"),this.currentedit.commentcolour=e,this.handle_tool_button(t,"comment")},context:this}),e=this.get_dialogue_element($),new M.assignfeedback_editpdf.colourpicker({buttonNode:e,iconprefix:"colour_",colours:ot,callback:function(t){var e=t.target.getAttribute("data-colour");e=e||t.target.ancestor().getAttribute("data-colour"),this.currentedit.annotationcolour=e,this.lastannotationtool?this.handle_tool_button(t,this.lastannotationtool):this.handle_tool_button(t,"pen")},context:this}),(d=this.get("stampfiles")).length<=0?this.get_dialogue_element(dt.stamp).ancestor().hide():(h=d[0].substr(d[0].lastIndexOf("/")+1),this.currentedit.stamp=h,r=this.get_dialogue_element(Q),new M.assignfeedback_editpdf.stamppicker({buttonNode:r,stamps:d,callback:function(t){var e,i=t.target.getAttribute("data-stamp");e=(
i=i||t.target.ancestor().getAttribute("data-stamp")).substr(i.lastIndexOf("/")),this.currentedit.stamp=e,this.handle_tool_button(t,"stamp")},context:this}),this.refresh_button_state()))},handle_tool_button:function(t,e){var i;t.preventDefault(),(i=this.get_dialogue_element(dt[this.currentedit.tool])).removeClass("assignfeedback_editpdf_selectedbutton"),i.setAttribute("aria-pressed","false"),"htmleditor"!==(this.currentedit.tool=e)&&"comment"!==e&&"select"!==e&&"drag"!==e&&"stamp"!==e&&(this.lastannotationtool=e),this.refresh_button_state()},stringify_current_page:function(){var t,e=[],i=[],n=[],s=0;for(s=0;s<this.pages[this.currentpage].htmlcomments.length;s++)i[s]=this.pages[this.currentpage].htmlcomments[s].clean();for(s=0;s<this.pages[this.currentpage].comments.length;s++)e[s]=this.pages[this.currentpage].comments[s].clean();for(s=0;s<this.pages[this.currentpage].annotations.length;s++)n[s]=this.pages[this.currentpage].annotations[s].clean();return t={comments:e,annotations:n,htmlcomments:i},g.JSON.stringify(t)},get_current_drawable:function(){var t,e=!1;return!(!this.currentedit.start||!this.currentedit.end)&&("comment"===this.currentedit.tool?e=new M.assignfeedback_editpdf.comment(this).draw_current_edit(this.currentedit):"htmleditor"===this.currentedit.tool?e=new M.assignfeedback_editpdf.htmlcomment(this).draw_current_edit(this.currentedit):(t=this.create_annotation(this.currentedit.tool,{}))&&(e=t.draw_current_edit(this.currentedit)),e)},get_dialogue_element:function(t){return this.panel?this.panel.one(t):this.dialogue.get("boundingBox").one(t)},redraw_current_edit:function(){this.currentdrawable&&this.currentdrawable.erase(),this.currentdrawable=this.get_current_drawable()},edit_start:function(t){var e,i,n,s=this.get_dialogue_element(J),a=s.getXY(),o=s.get("docScrollY"),r=s.get("docScrollX"),d={x:t.clientX-a[0]+r,y:t.clientY-a[1]+o},h=!1;3!==t.button&&(this.currentedit.starttime||this.editingcomment||this.editinghtmlcomment||(this.currentedit.starttime=(new Date).getTime(),this.currentedit.start=d,this.currentedit.end={x:d.x,y:d.y},"select"===this.currentedit.tool&&(e=this.currentedit.end.x,i=this.currentedit.end.y,n=this.pages[this.currentpage].annotations,g.each(n,function(t){(e-t.x)*(e-t.endx)<=0&&(i-t.y)*(i-t.endy)<=0&&(h=t)}),h?(this.lastannotation=this.currentannotation,this.currentannotation=h,this.lastannotation&&this.lastannotation!==h&&this.lastannotation.drawable&&(this.lastannotation.drawable.erase(),this.drawables.push(this.lastannotation.draw())),this.currentannotation.drawable&&this.currentannotation.drawable.erase(),this.drawables.push(this.currentannotation.draw())):(this.lastannotation=this.currentannotation,this.currentannotation=null,this.lastannotation&&this.lastannotation.drawable&&(this.lastannotation.drawable.erase(),this.drawables.push(this.lastannotation.draw())))),this.currentannotation&&(this.currentedit.annotationstart={x:this.currentannotation.x,y:this.currentannotation.y})))},edit_move:function(t){var e,i,n=this.get_canvas_bounds(),s=this.get_dialogue_element(J),a=this.get_dialogue_element(F),o=new M.assignfeedback_editpdf.point(t.clientX+s.get("docScrollX"),t.clientY+s.get("docScrollY")),r=this.get_canvas_coordinates(o);"textarea"!==document.activeElement.type&&(t.preventDefault(),r.x<0||r.x>n.width||r.y<0||r.y>n.height||("pen"===this.currentedit.tool&&this.currentedit.path.push(r),"select"===this.currentedit.tool?this.currentannotation&&this.currentedit&&this.currentannotation.move(this.currentedit.annotationstart.x+r.x-this.currentedit.start.x,this.currentedit.annotationstart.y+r.y-this.currentedit.start.y):"drag"===this.currentedit.tool?(e=r.x-this.currentedit.start.x,i=r.y-this.currentedit.start.y,a.getDOMNode().scrollLeft-=e,a.getDOMNode().scrollTop-=i):this.currentedit.start&&(this.currentedit.end=r,this.redraw_current_edit())))},edit_end:function(){var t,e,i;(new Date).getTime()-this.currentedit.start<rt||!1===this.currentedit.start||("htmleditor"===this.currentedit.tool?(this.currentdrawable&&this.currentdrawable.erase(),this.currentdrawable=!1,(e=new M.assignfeedback_editpdf.htmlcomment(this)).init_from_edit(this.currentedit)&&(this.pages[this.currentpage].htmlcomments.push(e),this.drawables.push(e.draw()))):"comment"===this.currentedit.tool?(this.currentdrawable&&this.currentdrawable.erase(),this.currentdrawable=!1,(t=new M.assignfeedback_editpdf.comment(this)).init_from_edit(this.currentedit)&&(this.pages[this.currentpage].comments.push(t),this.drawables.push(t.draw(!0)),this.editingcomment=!0)):(i=this.create_annotation(this.currentedit.tool,{}))&&(this.currentdrawable&&this.currentdrawable.erase(),this.currentdrawable=!1,i.init_from_edit(this.currentedit)&&(this.pages[this.currentpage].annotations.push(i),this.drawables.push(i.draw()))),this.save_current_page(),this.currentedit.starttime=0,this.currentedit.start=!1,this.currentedit.end=!1,this.currentedit.path=[])},resize:function(){var t,e;if(this.dialogue){if(!this.dialogue.get("visible"))return;this.dialogue.centerDialogue()}return(e=g.one("body").get("winHeight")-120)<100&&(e=100),t=this.get_dialogue_element(F),this.dialogue&&t.setStyle("maxHeight",e+"px"),this.redraw(),!0},create_annotation:function(t,e){return e.type=t,e.editor=this,"line"===t?new M.assignfeedback_editpdf.annotationline(e):"rectangle"===t?new M.assignfeedback_editpdf.annotationrectangle(e):"oval"===t?new M.assignfeedback_editpdf.annotationoval(e):"pen"===t?new M.assignfeedback_editpdf.annotationpen(e):"highlight"===t?new M.assignfeedback_editpdf.annotationhighlight(e):"stamp"===t?new M.assignfeedback_editpdf.annotationstamp(e):"htmleditor"===t&&new M.assignfeedback_editpdf.htmlcomment(e)},save_current_page:function(){this.clear_warnings(!1);var t,e=q;t={method:"post",context:this,sync:!1,data:{sesskey:M.cfg.sesskey,action:"savepage",index:this.currentpage,userid:this.get("userid"),attemptnumber:this.get("attemptnumber"),assignmentid:this.get("assignmentid"),page:this.stringify_current_page()},on:{
success:function(t,e){var i;try{if((i=g.JSON.parse(e.responseText)).error)return new M.core.ajaxException(i);g.one(K).set("value","true"),this.warning(M.util.get_string("draftchangessaved","assignfeedback_editpdf"),!0)}catch(n){return new M.core.exception(n)}},failure:function(t,e){return new M.core.exception(e.responseText)}}},g.io(e,t)},open_search_comments:function(t){this.searchcommentswindow||(this.searchcommentswindow=new M.assignfeedback_editpdf.commentsearch({editor:this})),this.searchcommentswindow.show(),t.preventDefault()},open_htmleditor:function(t){this.htmleditorwindow||(this.htmleditorwindow=new M.assignfeedback_editpdf.htmleditor({editor:this})),this.htmleditorwindow.show(),t.preventDefault()},expandCollapseComments:function(){var t=g.all(".commentdrawable");this.collapsecomments?(this.collapsecomments=!1,t.removeClass("commentcollapsed")):(this.collapsecomments=!0,t.addClass("commentcollapsed"))},redraw:function(){var t,e;if((e=this.pages[this.currentpage])!==undefined){for(;0<this.drawables.length;)this.drawables.pop().erase();for(t=0;t<e.annotations.length;t++)this.drawables.push(e.annotations[t].draw());for(t=0;t<e.comments.length;t++)this.drawables.push(e.comments[t].draw(!1));for(t=0;t<e.htmlcomments.length;t++)this.drawables.push(e.htmlcomments[t].draw())}},clear_warnings:function(t){var e=this.get_dialogue_element(V);t?e.empty():e.all(".alert-info").remove(!0)},change_page:function(){var t,e,i,n=this.get_dialogue_element(J);e=this.get_dialogue_element(z),i=this.get_dialogue_element(R),0<this.currentpage?e.removeAttribute("disabled"):e.setAttribute("disabled","true"),this.currentpage<this.pagecount-1?i.removeAttribute("disabled"):i.setAttribute("disabled","true"),t=this.pages[this.currentpage],this.loadingicon&&this.loadingicon.hide(),n.setStyle("backgroundImage",'url("'+t.url+'")'),n.setStyle("width",t.width+"px"),n.setStyle("height",t.height+"px"),n.scrollIntoView(),this.get_dialogue_element(P).set("selectedIndex",this.currentpage),this.resize()},setup_navigation:function(){var t,e,i,n,s,a=this.get_dialogue_element(P),o=a.all("option");if(o.size()<=1)for(t=0;t<this.pages.length;t++)(i=g.Node.create("<option/>")).setAttribute("value",t),e={page:t+1,total:this.pages.length},i.setHTML(M.util.get_string("pagexofy","assignfeedback_editpdf",e)),a.append(i);a.removeAttribute("disabled"),a.on("change",function(){this.currentpage=a.get("value"),this.clear_warnings(!1),this.change_page()},this),n=this.get_dialogue_element(z),s=this.get_dialogue_element(R),n.on("click",this.previous_page,this),n.on("key",this.previous_page,"down:13",this),s.on("click",this.next_page,this),s.on("key",this.next_page,"down:13",this)},previous_page:function(t){t.preventDefault(),this.currentpage--,this.currentpage<0&&(this.currentpage=0),this.clear_warnings(!1),this.change_page()},next_page:function(t){t.preventDefault(),this.currentpage++,this.currentpage>=this.pages.length&&(this.currentpage=this.pages.length-1),this.clear_warnings(!1),this.change_page()},move_canvas:function(){var t,e,i,n;for(t=this.get_dialogue_element(F),e=parseInt(t.get("scrollLeft"),10),i=parseInt(t.get("scrollTop"),10),n=0;n<this.drawables.length;n++)this.drawables[n].scroll_update(e,i)},rotatePDF:function(l,t){var u,e,i,n,s,a;if(l.preventDefault(),!this.get("destroyed")){for((u=this).oldannotationcoordinates=[],i=this.pages[this.currentpage].annotations,e=0;e<i.length;e++)n=i[e],this.oldannotationcoordinates.push([n.x,n.y]);s=q,a={method:"post",context:this,sync:!1,data:{sesskey:M.cfg.sesskey,action:"rotatepage",index:this.currentpage,userid:this.get("userid"),attemptnumber:this.get("attemptnumber"),assignmentid:this.get("assignmentid"),rotateleft:t},on:{success:function(t,e){var i,n,s,a,o,r,d,h,c;try{for(i=g.JSON.parse(e.responseText),(n=u.pages[u.currentpage]).url=i.page.url,n.width=i.page.width,n.height=i.page.height,u.loadingicon.hide(),(s=u.get_dialogue_element(J)).setStyle("backgroundImage",'url("'+n.url+'")'),s.setStyle("width",n.width+"px"),s.setStyle("height",n.height+"px"),o=n.annotations,a=0;a<o.length;a++)u.oldannotationcoordinates&&u.oldannotationcoordinates[a]&&(r=u.oldannotationcoordinates[a][0],d=u.oldannotationcoordinates[a][1],o[a].move(r,d));for(h=n.comments,a=0;a<h.length;a++)h[a].updatePosition();for(c=n.htmlcomments,a=0;a<c.length;a++)c[a].updatePosition();return u.save_current_page()}catch(l){return new M.core.exception(l)}},failure:function(t,e){return new M.core.exception(e.responseText)}}},g.io(s,a)}},event_listener_options_supported:function(){var t,e=!1,i="testpassiveeventoptions";try{t=Object.defineProperty({},"passive",{get:function(){e=!0}}),document.addEventListener(i,t,t),document.removeEventListener(i,t,t)}catch(n){e=!1}return e},disable_touch_scroll:function(){this.event_listener_options_supported()&&document.addEventListener("touchmove",this.stop_touch_scroll.bind(this),{passive:!1})},stop_touch_scroll:function(t){this.get_dialogue_element(F).contains(t.target)&&(t.stopPropagation(),t.preventDefault())}},g.extend(N,g.Base,N.prototype,{NAME:"moodle-assignfeedback_editpdf-editor",ATTRS:{userid:{validator:g.Lang.isInteger,value:0},assignmentid:{validator:g.Lang.isInteger,value:0},attemptnumber:{validator:g.Lang.isInteger,value:0},header:{validator:g.Lang.isString,value:""},body:{validator:g.Lang.isString,value:""},footer:{validator:g.Lang.isString,value:""},linkid:{validator:g.Lang.isString,value:""},deletelinkid:{validator:g.Lang.isString,value:""},readonly:{validator:g.Lang.isBoolean,value:!0},stampfiles:{validator:g.Lang.isArray,value:""}}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.editor=M.assignfeedback_editpdf.editor||{},M.assignfeedback_editpdf.editor.init=M.assignfeedback_editpdf.editor.init||function(t){return M.assignfeedback_editpdf.instance=new N(t),M.assignfeedback_editpdf.instance},A=function(t){t.draggable=!0,t.centered=!0,t.width="auto",t.visible=!1,t.headerContent=M.util.get_string("htmleditor","assignfeedback_editpdf"),
t.footerContent="",t.closeButton=!1,A.superclass.constructor.apply(this,[t])},T="htmleditor",g.extend(A,M.core.dialogue,{editor:null,initializer:function(t){var e,i;this.editor=t.editor||null,this.get("boundingBox").addClass("assignfeedback_editpdf_htmleditor"),this.get("editor"),e=g.Node.create("<div/>"),(i=g.one("#editorcontainer")).removeClass("hidden"),e.append(i),g.one('[name="savechanges"]').on("click",this.removeeditor),g.one('[name="saveandshownext"]').on("click",this.removeeditor),this.set("bodyContent",e),A.superclass.initializer.call(this,t),this.addButton({name:"confirm",label:M.util.get_string("confirm","moodle"),action:function(t){t.preventDefault(),this.hide()},classNames:"btn btn-primary",section:g.WidgetStdMod.FOOTER}),this.addButton({name:"cancel",label:M.util.get_string("cancel","moodle"),action:function(t){t.preventDefault(),g.one("#html_editor").set("value"," "),this.hide()},classNames:"btn btn-secondary",section:g.WidgetStdMod.FOOTER})},removeeditor:function(){g.one(".assignfeedback_editpdf_htmleditor")&&g.one(".assignfeedback_editpdf_htmleditor").remove()}},{NAME:T,ATTRS:{editor:{value:null}}}),g.Base.modifyAttrs(A,{modal:{getter:function(){return!0}}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.htmleditor=A,D=function(d,t,e,i,n,s,a,o){this.editor=d,this.gradeid=t||0,this.x=parseInt(i,10)||0,this.y=parseInt(n,10)||0,this.width=parseInt(s,10)||0,this.rawtext=o||"",this.pageno=e||0,this.colour=a||"yellow",this.drawable=!1,this.deleteme=!1,this.menulink=null,this.menu=null,this.clean=function(){return{gradeid:this.gradeid,x:parseInt(this.x,10),y:parseInt(this.y,10),width:parseInt(this.width,10),rawtext:this.rawtext,pageno:parseInt(this.pageno,10),colour:this.colour}},this.draw=function(t){var e,i,n,s,a,o,r=new M.assignfeedback_editpdf.drawable(this.editor),d=this.editor.get_dialogue_element(J);return n=g.Node.create('<a href="#"><img src="'+M.util.image_url("t/contextmenu","core")+'"/></a>'),(i=t||g.Node.create("<div/>")).addClass("htmlcomment"),e=g.Node.create('<div class="htmlcommentdrawable"/>'),this.menulink=n,""===this.rawtext.replace(/^\s+|\s+$/g,"")&&(o=g.one("#html_editor"),this.rawtext=o.get("value")),n.setAttribute("tabindex","0"),this.editor.get("readonly")?i.setAttribute("readonly","readonly"):e.append(n),this.width<100&&(this.width=100),i.set("innerHTML",this.rawtext),g.use("mathjax",function(){window.MathJax.Hub.Queue(["Typeset",window.MathJax.Hub,i.getDOMNode()])}),a=i.get("scrollHeight"),i.setStyles({height:a+"px"}),s=this.editor.get_window_coordinates(new M.assignfeedback_editpdf.point(this.x,this.y)),i.setStyles({width:this.width+"px"}),e.append(i),d.append(e),e.setStyle("position","absolute"),e.setX(s.x),e.setY(s.y),r.store_position(e,s.x,s.y),this.editor.get("readonly")||(i.on("gesturemovestart",this.editor.edit_start,null,this.editor),i.on("gesturemove",this.editor.edit_move,null,this.editor),i.on("gesturemoveend",this.editor.edit_end,null,this.editor)),r.nodes.push(e),this.attach_events(i,n),this.drawable=r,i.focus(),this.width=parseInt(i.getStyle("width"),10),""===this.rawtext.replace(/^\s+|\s+$/g,"")&&(this.deleteme=!0,g.later(400,this,this.delete_htmlcomment_later),0!==document.getElementsByClassName("dir-rtl").length?g.one("#html_editoreditable").set("innerHTML",'<p dir="rtl" style="text-align: right;"><br></p>'):g.one("#html_editoreditable").set("innerHTML",'<p dir="ltr" style="text-align: left;"><br></p>'),this.editor.htmleditorwindow||(this.editor.htmleditorwindow=new M.assignfeedback_editpdf.htmleditor({editor:this}))),i.active=!1,""!==this.rawtext.replace(/^\s+|\s+$/g,"")&&(this.editor.save_current_page(),this.drawable=r,o&&(o.set("value"," "),0!==document.getElementsByClassName("dir-rtl").length?g.one("#html_editoreditable").set("innerHTML",'<p dir="rtl" style="text-align: right;"><br></p>'):g.one("#html_editoreditable").set("innerHTML",'<p dir="ltr" style="text-align: left;"><br></p>'))),r},this.delete_htmlcomment_later=function(){this.deleteme&&this.remove()},this.attach_events=function(o,t){var r=o.ancestor("div");this.editor.get("readonly")||(t.setData("htmlcomment",this),o.on("gesturemovestart",function(t){"select"===d.currentedit.tool&&(t.preventDefault(),o.setData("offsetx",t.clientX-r.getX()),o.setData("offsety",t.clientY-r.getY()))}),o.on("gesturemove",function(t){if("select"===d.currentedit.tool){var e,i,n,s=t.clientX-o.getData("offsetx"),a=t.clientY-o.getData("offsety");!0!==o.getData("clicking")&&o.setData("clicking",!0),e=this.editor.get_canvas_coordinates(new M.assignfeedback_editpdf.point(s,a)),(n=this.editor.get_canvas_bounds(!0)).x=0,n.y=0,n.width-=24,n.height-=24,e.clip(n),this.x=e.x,this.y=e.y,i=this.editor.get_window_coordinates(e),r.setX(i.x),r.setY(i.y),this.drawable.store_position(r,i.x,i.y)}},null,this),this.menu=new M.assignfeedback_editpdf.htmlcommentmenu({buttonNode:this.menulink,htmlcomment:this}))},this.remove=function(){var t=0,e=this.editor.pages[this.editor.currentpage].htmlcomments;for(t=0;t<e.length;t++)if(e[t]===this)return e.splice(t,1),this.drawable.erase(),void this.editor.save_current_page()},this.draw_current_edit=function(t){var e,i,n=new M.assignfeedback_editpdf.rect,s=new M.assignfeedback_editpdf.drawable(this.editor),a=this.editor.get_dialogue_element(F);return n.bound([t.start,t.end]),i=this.editor.get_window_coordinates(new M.assignfeedback_editpdf.point(n.x,n.y)),(e=g.Node.create("<div/>")).setStyles({position:"absolute",display:"inline-block",width:n.width,height:n.height,backgroundSize:"100% 100%"}),a.append(e),e.setX(i.x),e.setY(i.y),s.store_position(e,i.x,i.y),s.nodes.push(e),s},this.init_from_edit=function(t){var e=new M.assignfeedback_editpdf.rect;return e.bound([t.start,t.end]),e.width<40&&(e.width=40),e.height<40&&(e.height=40),this.gradeid=this.editor.get("gradeid"),this.pageno=this.editor.currentpage,this.x=e.x,this.y=e.y,this.endx=e.x+e.width,this.endy=e.y+e.height,!(this.rawtext="")},this.updatePosition=function(){
var t=this.drawable.nodes[0].one("div"),e=t.ancestor("div"),i=new M.assignfeedback_editpdf.point(this.x,this.y),n=this.editor.get_window_coordinates(i);e.setX(n.x),e.setY(n.y),this.drawable.store_position(e,n.x,n.y)},this.edit_htmlcomment=function(t){var e,i,n,s;t.preventDefault(),this.menu.hide(),n=this.drawable.nodes[0].one("div"),e=g.one("#html_editoreditable"),i=this.rawtext,e.set("innerHTML",this.rawtext),this.editor.htmleditorwindow||(this.editor.htmleditorwindow=new M.assignfeedback_editpdf.htmleditor({editor:this})),(s=this.editor.htmleditorwindow).getButton("cancel",g.WidgetStdMod.FOOTER).on("click",function(t){t.preventDefault(),this.rawtext=i,s.hide()},this),s.getButton("confirm",g.WidgetStdMod.FOOTER).on("click",function(){var t=g.one("#html_editor");this.rawtext=t.get("value"),this.draw(n),s.hide()},this),s.show()}},M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.htmlcomment=D,I="Htmlcommentmenu",C=function(t){C.superclass.constructor.apply(this,[t])},g.extend(C,M.assignfeedback_editpdf.dropdown,{initializer:function(t){var e,i,n,s;s=this.get("htmlcomment"),e=g.Node.create('<ul role="menu" class="assignfeedback_editpdf_menu"/>'),(i=g.Node.create('<li><a tabindex="-1" href="#">'+M.util.get_string("edithtml","assignfeedback_editpdf")+"</a></li>")).on("click",s.edit_htmlcomment,s),i.on("key",s.edit_htmlcomment,"enter,space",s),e.append(i),(i=g.Node.create('<li><a tabindex="-1" href="#">'+M.util.get_string("deletecomment","assignfeedback_editpdf")+"</a></li>")).on("click",function(t){t.preventDefault(),this.menu.hide(),this.remove()},s),i.on("key",function(){s.menu.hide(),s.remove()},"enter,space",s),e.append(i),i=g.Node.create("<li><hr/></li>"),e.append(i),this.set("headerText",M.util.get_string("commentcontextmenu","assignfeedback_editpdf")),(n=g.Node.create("<div/>")).append(e),this.set("bodyContent",n),C.superclass.initializer.call(this,t)}},{NAME:I,ATTRS:{htmlcomment:{value:null}}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.htmlcommentmenu=C},"@VERSION@",{requires:["base","event","node","io","graphics","json","event-move","event-resize","transition","querystring-stringify-simple","moodle-core-notification-dialog","moodle-core-notification-alert","moodle-core-notification-warning","moodle-core-notification-exception","moodle-core-notification-ajaxexception"]});