Index: lib/editor/atto/plugins/wiris/core.js
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/lib/editor/atto/plugins/wiris/core.js b/lib/editor/atto/plugins/wiris/core.js
--- a/lib/editor/atto/plugins/wiris/core.js	(revision 2729694d4d56ca2c88bb180aee3f254f8be906cf)
+++ b/lib/editor/atto/plugins/wiris/core.js	(revision 0b9764ed79311babea3acc01b01be2b999f9ec4f)
@@ -1,3 +1,3 @@
-!function(e){var t={};function n(i){if(t[i])return t[i].exports;var o=t[i]={i:i,l:!1,exports:{}};return e[i].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(i,o,function(t){return e[t]}.bind(null,o));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=7)}([function(e){e.exports=JSON.parse('{"ar":{"latex":"LaTeX","cancel":"إلغاء","accept":"موا�?ق","manual":"الدليل","insert_math":"إدراج صيغة رياضية - MathType","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"ca":{"latex":"LaTeX","cancel":"Cancel·lar","accept":"Acceptar","manual":"Manual","insert_math":"Inserir fórmula matemàtica - MathType","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"cs":{"latex":"LaTeX","cancel":"Storno","accept":"OK","manual":"Příru�?ka","insert_math":"Vložit matematický vzorec - MathType","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"da":{"latex":"LaTeX","cancel":"Annuller","accept":"OK","manual":"Brugervejledning","insert_math":"Indsæt matematisk formel - MathType","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"de":{"latex":"LaTeX","cancel":"Abbrechen","accept":"OK","manual":"Handbuch","insert_math":"Mathematische Formel einfügen - MathType","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"en":{"latex":"LaTeX","cancel":"Cancel","accept":"OK","manual":"Manual","insert_math":"Insert a math equation - MathType","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"es":{"latex":"LaTeX","cancel":"Cancelar","accept":"Aceptar","manual":"Manual","insert_math":"Insertar fórmula matemática - MathType","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"et":{"latex":"LaTeX","cancel":"Loobu","accept":"OK","manual":"Käsiraamat","insert_math":"Lisa matemaatiline valem – WIRIS","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"eu":{"latex":"LaTeX","cancel":"Ezeztatu","accept":"Onartu","manual":"Gida","insert_math":"Txertatu matematikako formula - MathType","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"fi":{"latex":"LaTeX","cancel":"Peruuta","accept":"OK","manual":"Manual","insert_math":"Liitä matemaattinen kaava - MathType","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"fr":{"latex":"LaTeX","cancel":"Annuler","accept":"OK","manual":"Manuel","insert_math":"Insérer une formule mathématique - MathType","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"gl":{"latex":"LaTeX","cancel":"Cancelar","accept":"Aceptar","manual":"Manual","insert_math":"Inserir fórmula matemática - MathType","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"he":{"latex":"LaTeX","cancel":"ביטול","accept":"�?ישור","manual":"מדריך","insert_math":"הוסף נוסחה מתמטית - MathType","insert_chem":"הוספת כתיבה כימית - ChemType","minimize":"מזערי","maximize":"מרבי","fullscreen":"מסך מל�?","exit_fullscreen":"יצי�?ה ממצב מסך מל�?","close":"סגירה","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"ה�?�? לצ�?ת? שינויי�? �?שר בוצעו ימחקו.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" �?יננה פונקציה","exception_invalid_date_format":"תסדיר ת�?ריך �?ינו תקין : ","exception_casting":"ל�? ניתן להמיר ","exception_casting_to":" ל "},"hr":{"latex":"LaTeX","cancel":"Poništi","accept":"U redu","manual":"Priru�?nik","insert_math":"Umetnite matemati�?ku formulu - MathType","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"hu":{"latex":"LaTeX","cancel":"Mégsem","accept":"OK","manual":"Kézikönyv","insert_math":"Matematikai képlet beszúrása - MathType","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"it":{"latex":"LaTeX","cancel":"Annulla","accept":"Accetta","manual":"Manuale","insert_math":"Inserisci una formula matematica - MathType","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"ja":{"latex":"LaTeX","cancel":"キャンセル","accept":"OK","manual":"マニュアル","insert_math":"数�?を挿入 - MathType","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"ko":{"latex":"LaTeX","cancel":"취소","accept":"승�?�","manual":"설명서","insert_math":"수학 공�? 삽입 - MathType","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"nl":{"latex":"LaTeX","cancel":"Annuleren","accept":"OK","manual":"Handleiding","insert_math":"Wiskundige formule invoegen - MathType","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"no":{"latex":"LaTeX","cancel":"Avbryt","accept":"OK","manual":"Håndbok","insert_math":"Sett inn matematikkformel - MathType","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"pl":{"latex":"LaTeX","cancel":"Anuluj","accept":"OK","manual":"Instrukcja","insert_math":"Wstaw formułę matematyczną - MathType","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"pt":{"latex":"LaTeX","cancel":"Cancelar","accept":"OK","manual":"Manual","insert_math":"Inserir fórmula matemática - MathType","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"pt_br":{"latex":"LaTeX","cancel":"Cancelar","accept":"OK","manual":"Manual","insert_math":"Inserir fórmula matemática - MathType","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"ru":{"latex":"LaTeX","cancel":"отмена","accept":"OK","manual":"вручную","insert_math":"В�?тавить математиче�?кую формулу: WIRIS","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"sv":{"latex":"LaTeX","cancel":"Avbryt","accept":"OK","manual":"Bruksanvisning","insert_math":"Infoga matematisk formel - MathType","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"tr":{"latex":"LaTeX","cancel":"Vazgeç","accept":"Tamam","manual":"Kılavuz","insert_math":"Matematik formülü ekle - MathType","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"zh":{"latex":"LaTeX","cancel":"�?�消","accept":"确定","manual":"手册","insert_math":"�?�入数学公�? - MathType","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"el":{"latex":"LaTeX","cancel":"Άκυ�?ο","accept":"ΟΚ","manual":"Χει�?οκίνητα","insert_math":"Εισαγωγή μαθηματικο�? τ�?που - MathType","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"":{}}')},function(module,__webpack_exports__,__webpack_require__){"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var md5,_unused_webpack_default_export=md5;!function(){var HxOverrides=function(){};HxOverrides.__name__=!0,HxOverrides.dateStr=function(e){var t=e.getMonth()+1,n=e.getDate(),i=e.getHours(),o=e.getMinutes(),r=e.getSeconds();return e.getFullYear()+"-"+(t<10?"0"+t:""+t)+"-"+(n<10?"0"+n:""+n)+" "+(i<10?"0"+i:""+i)+":"+(o<10?"0"+o:""+o)+":"+(r<10?"0"+r:""+r)},HxOverrides.strDate=function(e){switch(e.length){case 8:var t=e.split(":"),n=new Date;return n.setTime(0),n.setUTCHours(t[0]),n.setUTCMinutes(t[1]),n.setUTCSeconds(t[2]),n;case 10:t=e.split("-");return new Date(t[0],t[1]-1,t[2],0,0,0);case 19:var i=(t=e.split(" "))[0].split("-"),o=t[1].split(":");return new Date(i[0],i[1]-1,i[2],o[0],o[1],o[2]);default:throw"Invalid date format : "+e}},HxOverrides.cca=function(e,t){var n=e.charCodeAt(t);if(n==n)return n},HxOverrides.substr=function(e,t,n){return null!=t&&0!=t&&null!=n&&n<0?"":(null==n&&(n=e.length),t<0?(t=e.length+t)<0&&(t=0):n<0&&(n=e.length+n-t),e.substr(t,n))},HxOverrides.remove=function(e,t){for(var n=0,i=e.length;n<i;){if(e[n]==t)return e.splice(n,1),!0;n++}return!1},HxOverrides.iter=function(e){return{cur:0,arr:e,hasNext:function(){return this.cur<this.arr.length},next:function(){return this.arr[this.cur++]}}};var IntIter=function(e,t){this.min=e,this.max=t};IntIter.__name__=!0,IntIter.prototype={next:function(){return this.min++},hasNext:function(){return this.min<this.max},__class__:IntIter};var Std=function(){};Std.__name__=!0,Std.is=function(e,t){return js.Boot.__instanceof(e,t)},Std.string=function(e){return js.Boot.__string_rec(e,"")},Std.int=function(e){return 0|e},Std.parseInt=function(e){var t=parseInt(e,10);return 0!=t||120!=HxOverrides.cca(e,1)&&88!=HxOverrides.cca(e,1)||(t=parseInt(e)),isNaN(t)?null:t},Std.parseFloat=function(e){return parseFloat(e)},Std.random=function(e){return Math.floor(Math.random()*e)};var com=com||{};com.wiris||(com.wiris={}),com.wiris.js||(com.wiris.js={}),com.wiris.js.JsPluginTools=function(){this.tryReady()},com.wiris.js.JsPluginTools.__name__=!0,com.wiris.js.JsPluginTools.main=function(){var e;e=com.wiris.js.JsPluginTools.getInstance(),haxe.Timer.delay($bind(e,e.tryReady),100)},com.wiris.js.JsPluginTools.getInstance=function(){return null==com.wiris.js.JsPluginTools.instance&&(com.wiris.js.JsPluginTools.instance=new com.wiris.js.JsPluginTools),com.wiris.js.JsPluginTools.instance},com.wiris.js.JsPluginTools.bypassEncapsulation=function(){null==window.com&&(window.com={}),null==window.com.wiris&&(window.com.wiris={}),null==window.com.wiris.js&&(window.com.wiris.js={}),null==window.com.wiris.js.JsPluginTools&&(window.com.wiris.js.JsPluginTools=com.wiris.js.JsPluginTools.getInstance())},com.wiris.js.JsPluginTools.prototype={md5encode:function(e){return haxe.Md5.encode(e)},doLoad:function(){this.ready=!0,com.wiris.js.JsPluginTools.instance=this,com.wiris.js.JsPluginTools.bypassEncapsulation()},tryReady:function(){this.ready=!1,js.Lib.document.readyState&&(this.doLoad(),this.ready=!0),this.ready||haxe.Timer.delay($bind(this,this.tryReady),100)},__class__:com.wiris.js.JsPluginTools};var haxe=haxe||{};haxe.Log=function(){},haxe.Log.__name__=!0,haxe.Log.trace=function(e,t){js.Boot.__trace(e,t)},haxe.Log.clear=function(){js.Boot.__clear_trace()},haxe.Md5=function(){},haxe.Md5.__name__=!0,haxe.Md5.encode=function(e){return(new haxe.Md5).doEncode(e)},haxe.Md5.prototype={doEncode:function(e){for(var t=this.str2blks(e),n=1732584193,i=-271733879,o=-1732584194,r=271733878,a=0;a<t.length;){var s=n,l=i,c=o,u=r;0,n=this.ff(n,i,o,r,t[a],7,-680876936),r=this.ff(r,n,i,o,t[a+1],12,-389564586),o=this.ff(o,r,n,i,t[a+2],17,606105819),i=this.ff(i,o,r,n,t[a+3],22,-1044525330),n=this.ff(n,i,o,r,t[a+4],7,-176418897),r=this.ff(r,n,i,o,t[a+5],12,1200080426),o=this.ff(o,r,n,i,t[a+6],17,-1473231341),i=this.ff(i,o,r,n,t[a+7],22,-45705983),n=this.ff(n,i,o,r,t[a+8],7,1770035416),r=this.ff(r,n,i,o,t[a+9],12,-1958414417),o=this.ff(o,r,n,i,t[a+10],17,-42063),i=this.ff(i,o,r,n,t[a+11],22,-1990404162),n=this.ff(n,i,o,r,t[a+12],7,1804603682),r=this.ff(r,n,i,o,t[a+13],12,-40341101),o=this.ff(o,r,n,i,t[a+14],17,-1502002290),i=this.ff(i,o,r,n,t[a+15],22,1236535329),n=this.gg(n,i,o,r,t[a+1],5,-165796510),r=this.gg(r,n,i,o,t[a+6],9,-1069501632),o=this.gg(o,r,n,i,t[a+11],14,643717713),i=this.gg(i,o,r,n,t[a],20,-373897302),n=this.gg(n,i,o,r,t[a+5],5,-701558691),r=this.gg(r,n,i,o,t[a+10],9,38016083),o=this.gg(o,r,n,i,t[a+15],14,-660478335),i=this.gg(i,o,r,n,t[a+4],20,-405537848),n=this.gg(n,i,o,r,t[a+9],5,568446438),r=this.gg(r,n,i,o,t[a+14],9,-1019803690),o=this.gg(o,r,n,i,t[a+3],14,-187363961),i=this.gg(i,o,r,n,t[a+8],20,1163531501),n=this.gg(n,i,o,r,t[a+13],5,-1444681467),r=this.gg(r,n,i,o,t[a+2],9,-51403784),o=this.gg(o,r,n,i,t[a+7],14,1735328473),i=this.gg(i,o,r,n,t[a+12],20,-1926607734),n=this.hh(n,i,o,r,t[a+5],4,-378558),r=this.hh(r,n,i,o,t[a+8],11,-2022574463),o=this.hh(o,r,n,i,t[a+11],16,1839030562),i=this.hh(i,o,r,n,t[a+14],23,-35309556),n=this.hh(n,i,o,r,t[a+1],4,-1530992060),r=this.hh(r,n,i,o,t[a+4],11,1272893353),o=this.hh(o,r,n,i,t[a+7],16,-155497632),i=this.hh(i,o,r,n,t[a+10],23,-1094730640),n=this.hh(n,i,o,r,t[a+13],4,681279174),r=this.hh(r,n,i,o,t[a],11,-358537222),o=this.hh(o,r,n,i,t[a+3],16,-722521979),i=this.hh(i,o,r,n,t[a+6],23,76029189),n=this.hh(n,i,o,r,t[a+9],4,-640364487),r=this.hh(r,n,i,o,t[a+12],11,-421815835),o=this.hh(o,r,n,i,t[a+15],16,530742520),i=this.hh(i,o,r,n,t[a+2],23,-995338651),n=this.ii(n,i,o,r,t[a],6,-198630844),r=this.ii(r,n,i,o,t[a+7],10,1126891415),o=this.ii(o,r,n,i,t[a+14],15,-1416354905),i=this.ii(i,o,r,n,t[a+5],21,-57434055),n=this.ii(n,i,o,r,t[a+12],6,1700485571),r=this.ii(r,n,i,o,t[a+3],10,-1894986606),o=this.ii(o,r,n,i,t[a+10],15,-1051523),i=this.ii(i,o,r,n,t[a+1],21,-2054922799),n=this.ii(n,i,o,r,t[a+8],6,1873313359),r=this.ii(r,n,i,o,t[a+15],10,-30611744),o=this.ii(o,r,n,i,t[a+6],15,-1560198380),i=this.ii(i,o,r,n,t[a+13],21,1309151649),n=this.ii(n,i,o,r,t[a+4],6,-145523070),r=this.ii(r,n,i,o,t[a+11],10,-1120210379),o=this.ii(o,r,n,i,t[a+2],15,718787259),i=this.ii(i,o,r,n,t[a+9],21,-343485551),n=this.addme(n,s),i=this.addme(i,l),o=this.addme(o,c),r=this.addme(r,u),a+=16}return this.rhex(n)+this.rhex(i)+this.rhex(o)+this.rhex(r)},ii:function(e,t,n,i,o,r,a){return this.cmn(this.bitXOR(n,this.bitOR(t,~i)),e,t,o,r,a)},hh:function(e,t,n,i,o,r,a){return this.cmn(this.bitXOR(this.bitXOR(t,n),i),e,t,o,r,a)},gg:function(e,t,n,i,o,r,a){return this.cmn(this.bitOR(this.bitAND(t,i),this.bitAND(n,~i)),e,t,o,r,a)},ff:function(e,t,n,i,o,r,a){return this.cmn(this.bitOR(this.bitAND(t,n),this.bitAND(~t,i)),e,t,o,r,a)},cmn:function(e,t,n,i,o,r){return this.addme(this.rol(this.addme(this.addme(t,e),this.addme(i,r)),o),n)},rol:function(e,t){return e<<t|e>>>32-t},str2blks:function(e){for(var t=1+(e.length+8>>6),n=new Array,i=0,o=16*t;i<o;){n[r=i++]=0}for(var r=0;r<e.length;)n[r>>2]|=HxOverrides.cca(e,r)<<(8*e.length+r)%4*8,r++;n[r>>2]|=128<<(8*e.length+r)%4*8;var a=8*e.length,s=16*t-2;return n[s]=255&a,n[s]|=(a>>>8&255)<<8,n[s]|=(a>>>16&255)<<16,n[s]|=(a>>>24&255)<<24,n},rhex:function(e){for(var t="",n=0;n<4;){var i=n++;t+="0123456789abcdef".charAt(e>>8*i+4&15)+"0123456789abcdef".charAt(e>>8*i&15)}return t},addme:function(e,t){var n=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(n>>16)<<16|65535&n},bitAND:function(e,t){return(e>>>1&t>>>1)<<1|1&e&t},bitXOR:function(e,t){return(e>>>1^t>>>1)<<1|1&e^1&t},bitOR:function(e,t){return(e>>>1|t>>>1)<<1|(1&e|1&t)},__class__:haxe.Md5},haxe.Timer=function(e){var t=this;this.id=window.setInterval(function(){t.run()},e)},haxe.Timer.__name__=!0,haxe.Timer.delay=function(e,t){var n=new haxe.Timer(t);return n.run=function(){n.stop(),e()},n},haxe.Timer.measure=function(e,t){var n=haxe.Timer.stamp(),i=e();return haxe.Log.trace(haxe.Timer.stamp()-n+"s",t),i},haxe.Timer.stamp=function(){return(new Date).getTime()/1e3},haxe.Timer.prototype={run:function(){},stop:function(){null!=this.id&&(window.clearInterval(this.id),this.id=null)},__class__:haxe.Timer};var js=js||{},$_;function $bind(e,t){var n=function e(){return e.method.apply(e.scope,arguments)};return n.scope=e,n.method=t,n}js.Boot=function(){},js.Boot.__name__=!0,js.Boot.__unhtml=function(e){return e.split("&").join("&amp;").split("<").join("&lt;").split(">").join("&gt;")},js.Boot.__trace=function(e,t){var n,i=null!=t?t.fileName+":"+t.lineNumber+": ":"";i+=js.Boot.__string_rec(e,""),"undefined"!=typeof document&&null!=(n=document.getElementById("haxe:trace"))?n.innerHTML+=js.Boot.__unhtml(i)+"<br/>":"undefined"!=typeof console&&null!=console.log&&console.log(i)},js.Boot.__clear_trace=function(){var e=document.getElementById("haxe:trace");null!=e&&(e.innerHTML="")},js.Boot.isClass=function(e){return e.__name__},js.Boot.isEnum=function(e){return e.__ename__},js.Boot.getClass=function(e){return e.__class__},js.Boot.__string_rec=function(e,t){if(null==e)return"null";if(t.length>=5)return"<...>";var n=_typeof(e);switch("function"==n&&(e.__name__||e.__ename__)&&(n="object"),n){case"object":if(e instanceof Array){if(e.__enum__){if(2==e.length)return e[0];var i=e[0]+"(";t+="\t";for(var o=2,r=e.length;o<r;){i+=2!=(a=o++)?","+js.Boot.__string_rec(e[a],t):js.Boot.__string_rec(e[a],t)}return i+")"}var a,s=e.length;i="[";t+="\t";for(r=0;r<s;){var l=r++;i+=(l>0?",":"")+js.Boot.__string_rec(e[l],t)}return i+="]"}var c;try{c=e.toString}catch(e){return"???"}if(null!=c&&c!=Object.toString){var u=e.toString();if("[object Object]"!=u)return u}var d=null;i="{\n";t+="\t";var h=null!=e.hasOwnProperty;for(var d in e)h&&!e.hasOwnProperty(d)||"prototype"!=d&&"__class__"!=d&&"__super__"!=d&&"__interfaces__"!=d&&"__properties__"!=d&&(2!=i.length&&(i+=", \n"),i+=t+d+" : "+js.Boot.__string_rec(e[d],t));return i+="\n"+(t=t.substring(1))+"}";case"function":return"<function>";case"string":return e;default:return String(e)}},js.Boot.__interfLoop=function(e,t){if(null==e)return!1;if(e==t)return!0;var n=e.__interfaces__;if(null!=n)for(var i=0,o=n.length;i<o;){var r=n[i++];if(r==t||js.Boot.__interfLoop(r,t))return!0}return js.Boot.__interfLoop(e.__super__,t)},js.Boot.__instanceof=function(e,t){try{if(e instanceof t)return t!=Array||null==e.__enum__;if(js.Boot.__interfLoop(e.__class__,t))return!0}catch(e){if(null==t)return!1}switch(t){case Int:return Math.ceil(e%2147483648)===e;case Float:return"number"==typeof e;case Bool:return!0===e||!1===e;case String:return"string"==typeof e;case Dynamic:return!0;default:return null!=e&&(t==Class&&null!=e.__name__||(t==Enum&&null!=e.__ename__||e.__enum__==t))}},js.Boot.__cast=function(e,t){if(js.Boot.__instanceof(e,t))return e;throw"Cannot cast "+Std.string(e)+" to "+Std.string(t)},js.Lib=function(){},js.Lib.__name__=!0,js.Lib.debug=function(){},js.Lib.alert=function(e){alert(js.Boot.__string_rec(e,""))},js.Lib.eval=function(code){return eval(code)},js.Lib.setErrorHandler=function(e){js.Lib.onerror=e},Array.prototype.indexOf&&(HxOverrides.remove=function(e,t){var n=e.indexOf(t);return-1!=n&&(e.splice(n,1),!0)}),Math.__name__=["Math"],Math.NaN=Number.NaN,Math.NEGATIVE_INFINITY=Number.NEGATIVE_INFINITY,Math.POSITIVE_INFINITY=Number.POSITIVE_INFINITY,Math.isFinite=function(e){return isFinite(e)},Math.isNaN=function(e){return isNaN(e)},String.prototype.__class__=String,String.__name__=!0,Array.prototype.__class__=Array,Array.__name__=!0,Date.prototype.__class__=Date,Date.__name__=["Date"];var Int={__name__:["Int"]},Dynamic={__name__:["Dynamic"]},Float=Number;Float.__name__=["Float"];var Bool=Boolean;Bool.__ename__=["Bool"];var Class={__name__:["Class"]},Enum={},Void={__ename__:["Void"]};"undefined"!=typeof document&&(js.Lib.document=document),"undefined"!=typeof window&&(js.Lib.window=window,js.Lib.window.onerror=function(e,t,n){var i=js.Lib.onerror;return null!=i&&i(e,[t+":"+n])}),com.wiris.js.JsPluginTools.main(),delete Array.prototype.__class__}(),function(){var HxOverrides=function(){};HxOverrides.__name__=!0,HxOverrides.dateStr=function(e){var t=e.getMonth()+1,n=e.getDate(),i=e.getHours(),o=e.getMinutes(),r=e.getSeconds();return e.getFullYear()+"-"+(t<10?"0"+t:""+t)+"-"+(n<10?"0"+n:""+n)+" "+(i<10?"0"+i:""+i)+":"+(o<10?"0"+o:""+o)+":"+(r<10?"0"+r:""+r)},HxOverrides.strDate=function(e){switch(e.length){case 8:var t=e.split(":"),n=new Date;return n.setTime(0),n.setUTCHours(t[0]),n.setUTCMinutes(t[1]),n.setUTCSeconds(t[2]),n;case 10:t=e.split("-");return new Date(t[0],t[1]-1,t[2],0,0,0);case 19:var i=(t=e.split(" "))[0].split("-"),o=t[1].split(":");return new Date(i[0],i[1]-1,i[2],o[0],o[1],o[2]);default:throw"Invalid date format : "+e}},HxOverrides.cca=function(e,t){var n=e.charCodeAt(t);if(n==n)return n},HxOverrides.substr=function(e,t,n){return null!=t&&0!=t&&null!=n&&n<0?"":(null==n&&(n=e.length),t<0?(t=e.length+t)<0&&(t=0):n<0&&(n=e.length+n-t),e.substr(t,n))},HxOverrides.remove=function(e,t){for(var n=0,i=e.length;n<i;){if(e[n]==t)return e.splice(n,1),!0;n++}return!1},HxOverrides.iter=function(e){return{cur:0,arr:e,hasNext:function(){return this.cur<this.arr.length},next:function(){return this.arr[this.cur++]}}};var IntIter=function(e,t){this.min=e,this.max=t};IntIter.__name__=!0,IntIter.prototype={next:function(){return this.min++},hasNext:function(){return this.min<this.max},__class__:IntIter};var Std=function(){};Std.__name__=!0,Std.is=function(e,t){return js.Boot.__instanceof(e,t)},Std.string=function(e){return js.Boot.__string_rec(e,"")},Std.int=function(e){return 0|e},Std.parseInt=function(e){var t=parseInt(e,10);return 0!=t||120!=HxOverrides.cca(e,1)&&88!=HxOverrides.cca(e,1)||(t=parseInt(e)),isNaN(t)?null:t},Std.parseFloat=function(e){return parseFloat(e)},Std.random=function(e){return Math.floor(Math.random()*e)};var com=com||{};com.wiris||(com.wiris={}),com.wiris.js||(com.wiris.js={}),com.wiris.js.JsPluginTools=function(){this.tryReady()},com.wiris.js.JsPluginTools.__name__=!0,com.wiris.js.JsPluginTools.main=function(){var e;e=com.wiris.js.JsPluginTools.getInstance(),haxe.Timer.delay($bind(e,e.tryReady),100)},com.wiris.js.JsPluginTools.getInstance=function(){return null==com.wiris.js.JsPluginTools.instance&&(com.wiris.js.JsPluginTools.instance=new com.wiris.js.JsPluginTools),com.wiris.js.JsPluginTools.instance},com.wiris.js.JsPluginTools.bypassEncapsulation=function(){null==window.com&&(window.com={}),null==window.com.wiris&&(window.com.wiris={}),null==window.com.wiris.js&&(window.com.wiris.js={}),null==window.com.wiris.js.JsPluginTools&&(window.com.wiris.js.JsPluginTools=com.wiris.js.JsPluginTools.getInstance())},com.wiris.js.JsPluginTools.prototype={md5encode:function(e){return haxe.Md5.encode(e)},doLoad:function(){this.ready=!0,com.wiris.js.JsPluginTools.instance=this,com.wiris.js.JsPluginTools.bypassEncapsulation()},tryReady:function(){this.ready=!1,js.Lib.document.readyState&&(this.doLoad(),this.ready=!0),this.ready||haxe.Timer.delay($bind(this,this.tryReady),100)},__class__:com.wiris.js.JsPluginTools};var haxe=haxe||{};haxe.Log=function(){},haxe.Log.__name__=!0,haxe.Log.trace=function(e,t){js.Boot.__trace(e,t)},haxe.Log.clear=function(){js.Boot.__clear_trace()},haxe.Md5=function(){},haxe.Md5.__name__=!0,haxe.Md5.encode=function(e){return(new haxe.Md5).doEncode(e)},haxe.Md5.prototype={doEncode:function(e){for(var t=this.str2blks(e),n=1732584193,i=-271733879,o=-1732584194,r=271733878,a=0;a<t.length;){var s=n,l=i,c=o,u=r;0,n=this.ff(n,i,o,r,t[a],7,-680876936),r=this.ff(r,n,i,o,t[a+1],12,-389564586),o=this.ff(o,r,n,i,t[a+2],17,606105819),i=this.ff(i,o,r,n,t[a+3],22,-1044525330),n=this.ff(n,i,o,r,t[a+4],7,-176418897),r=this.ff(r,n,i,o,t[a+5],12,1200080426),o=this.ff(o,r,n,i,t[a+6],17,-1473231341),i=this.ff(i,o,r,n,t[a+7],22,-45705983),n=this.ff(n,i,o,r,t[a+8],7,1770035416),r=this.ff(r,n,i,o,t[a+9],12,-1958414417),o=this.ff(o,r,n,i,t[a+10],17,-42063),i=this.ff(i,o,r,n,t[a+11],22,-1990404162),n=this.ff(n,i,o,r,t[a+12],7,1804603682),r=this.ff(r,n,i,o,t[a+13],12,-40341101),o=this.ff(o,r,n,i,t[a+14],17,-1502002290),i=this.ff(i,o,r,n,t[a+15],22,1236535329),n=this.gg(n,i,o,r,t[a+1],5,-165796510),r=this.gg(r,n,i,o,t[a+6],9,-1069501632),o=this.gg(o,r,n,i,t[a+11],14,643717713),i=this.gg(i,o,r,n,t[a],20,-373897302),n=this.gg(n,i,o,r,t[a+5],5,-701558691),r=this.gg(r,n,i,o,t[a+10],9,38016083),o=this.gg(o,r,n,i,t[a+15],14,-660478335),i=this.gg(i,o,r,n,t[a+4],20,-405537848),n=this.gg(n,i,o,r,t[a+9],5,568446438),r=this.gg(r,n,i,o,t[a+14],9,-1019803690),o=this.gg(o,r,n,i,t[a+3],14,-187363961),i=this.gg(i,o,r,n,t[a+8],20,1163531501),n=this.gg(n,i,o,r,t[a+13],5,-1444681467),r=this.gg(r,n,i,o,t[a+2],9,-51403784),o=this.gg(o,r,n,i,t[a+7],14,1735328473),i=this.gg(i,o,r,n,t[a+12],20,-1926607734),n=this.hh(n,i,o,r,t[a+5],4,-378558),r=this.hh(r,n,i,o,t[a+8],11,-2022574463),o=this.hh(o,r,n,i,t[a+11],16,1839030562),i=this.hh(i,o,r,n,t[a+14],23,-35309556),n=this.hh(n,i,o,r,t[a+1],4,-1530992060),r=this.hh(r,n,i,o,t[a+4],11,1272893353),o=this.hh(o,r,n,i,t[a+7],16,-155497632),i=this.hh(i,o,r,n,t[a+10],23,-1094730640),n=this.hh(n,i,o,r,t[a+13],4,681279174),r=this.hh(r,n,i,o,t[a],11,-358537222),o=this.hh(o,r,n,i,t[a+3],16,-722521979),i=this.hh(i,o,r,n,t[a+6],23,76029189),n=this.hh(n,i,o,r,t[a+9],4,-640364487),r=this.hh(r,n,i,o,t[a+12],11,-421815835),o=this.hh(o,r,n,i,t[a+15],16,530742520),i=this.hh(i,o,r,n,t[a+2],23,-995338651),n=this.ii(n,i,o,r,t[a],6,-198630844),r=this.ii(r,n,i,o,t[a+7],10,1126891415),o=this.ii(o,r,n,i,t[a+14],15,-1416354905),i=this.ii(i,o,r,n,t[a+5],21,-57434055),n=this.ii(n,i,o,r,t[a+12],6,1700485571),r=this.ii(r,n,i,o,t[a+3],10,-1894986606),o=this.ii(o,r,n,i,t[a+10],15,-1051523),i=this.ii(i,o,r,n,t[a+1],21,-2054922799),n=this.ii(n,i,o,r,t[a+8],6,1873313359),r=this.ii(r,n,i,o,t[a+15],10,-30611744),o=this.ii(o,r,n,i,t[a+6],15,-1560198380),i=this.ii(i,o,r,n,t[a+13],21,1309151649),n=this.ii(n,i,o,r,t[a+4],6,-145523070),r=this.ii(r,n,i,o,t[a+11],10,-1120210379),o=this.ii(o,r,n,i,t[a+2],15,718787259),i=this.ii(i,o,r,n,t[a+9],21,-343485551),n=this.addme(n,s),i=this.addme(i,l),o=this.addme(o,c),r=this.addme(r,u),a+=16}return this.rhex(n)+this.rhex(i)+this.rhex(o)+this.rhex(r)},ii:function(e,t,n,i,o,r,a){return this.cmn(this.bitXOR(n,this.bitOR(t,~i)),e,t,o,r,a)},hh:function(e,t,n,i,o,r,a){return this.cmn(this.bitXOR(this.bitXOR(t,n),i),e,t,o,r,a)},gg:function(e,t,n,i,o,r,a){return this.cmn(this.bitOR(this.bitAND(t,i),this.bitAND(n,~i)),e,t,o,r,a)},ff:function(e,t,n,i,o,r,a){return this.cmn(this.bitOR(this.bitAND(t,n),this.bitAND(~t,i)),e,t,o,r,a)},cmn:function(e,t,n,i,o,r){return this.addme(this.rol(this.addme(this.addme(t,e),this.addme(i,r)),o),n)},rol:function(e,t){return e<<t|e>>>32-t},str2blks:function(e){for(var t=1+(e.length+8>>6),n=new Array,i=0,o=16*t;i<o;){n[r=i++]=0}for(var r=0;r<e.length;)n[r>>2]|=HxOverrides.cca(e,r)<<(8*e.length+r)%4*8,r++;n[r>>2]|=128<<(8*e.length+r)%4*8;var a=8*e.length,s=16*t-2;return n[s]=255&a,n[s]|=(a>>>8&255)<<8,n[s]|=(a>>>16&255)<<16,n[s]|=(a>>>24&255)<<24,n},rhex:function(e){for(var t="",n=0;n<4;){var i=n++;t+="0123456789abcdef".charAt(e>>8*i+4&15)+"0123456789abcdef".charAt(e>>8*i&15)}return t},addme:function(e,t){var n=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(n>>16)<<16|65535&n},bitAND:function(e,t){return(e>>>1&t>>>1)<<1|1&e&t},bitXOR:function(e,t){return(e>>>1^t>>>1)<<1|1&e^1&t},bitOR:function(e,t){return(e>>>1|t>>>1)<<1|(1&e|1&t)},__class__:haxe.Md5},haxe.Timer=function(e){var t=this;this.id=window.setInterval(function(){t.run()},e)},haxe.Timer.__name__=!0,haxe.Timer.delay=function(e,t){var n=new haxe.Timer(t);return n.run=function(){n.stop(),e()},n},haxe.Timer.measure=function(e,t){var n=haxe.Timer.stamp(),i=e();return haxe.Log.trace(haxe.Timer.stamp()-n+"s",t),i},haxe.Timer.stamp=function(){return(new Date).getTime()/1e3},haxe.Timer.prototype={run:function(){},stop:function(){null!=this.id&&(window.clearInterval(this.id),this.id=null)},__class__:haxe.Timer};var js=js||{},$_;function $bind(e,t){var n=function e(){return e.method.apply(e.scope,arguments)};return n.scope=e,n.method=t,n}js.Boot=function(){},js.Boot.__name__=!0,js.Boot.__unhtml=function(e){return e.split("&").join("&amp;").split("<").join("&lt;").split(">").join("&gt;")},js.Boot.__trace=function(e,t){var n,i=null!=t?t.fileName+":"+t.lineNumber+": ":"";i+=js.Boot.__string_rec(e,""),"undefined"!=typeof document&&null!=(n=document.getElementById("haxe:trace"))?n.innerHTML+=js.Boot.__unhtml(i)+"<br/>":"undefined"!=typeof console&&null!=console.log&&console.log(i)},js.Boot.__clear_trace=function(){var e=document.getElementById("haxe:trace");null!=e&&(e.innerHTML="")},js.Boot.isClass=function(e){return e.__name__},js.Boot.isEnum=function(e){return e.__ename__},js.Boot.getClass=function(e){return e.__class__},js.Boot.__string_rec=function(e,t){if(null==e)return"null";if(t.length>=5)return"<...>";var n=_typeof(e);switch("function"==n&&(e.__name__||e.__ename__)&&(n="object"),n){case"object":if(e instanceof Array){if(e.__enum__){if(2==e.length)return e[0];var i=e[0]+"(";t+="\t";for(var o=2,r=e.length;o<r;){i+=2!=(a=o++)?","+js.Boot.__string_rec(e[a],t):js.Boot.__string_rec(e[a],t)}return i+")"}var a,s=e.length;i="[";t+="\t";for(r=0;r<s;){var l=r++;i+=(l>0?",":"")+js.Boot.__string_rec(e[l],t)}return i+="]"}var c;try{c=e.toString}catch(e){return"???"}if(null!=c&&c!=Object.toString){var u=e.toString();if("[object Object]"!=u)return u}var d=null;i="{\n";t+="\t";var h=null!=e.hasOwnProperty;for(var d in e)h&&!e.hasOwnProperty(d)||"prototype"!=d&&"__class__"!=d&&"__super__"!=d&&"__interfaces__"!=d&&"__properties__"!=d&&(2!=i.length&&(i+=", \n"),i+=t+d+" : "+js.Boot.__string_rec(e[d],t));return i+="\n"+(t=t.substring(1))+"}";case"function":return"<function>";case"string":return e;default:return String(e)}},js.Boot.__interfLoop=function(e,t){if(null==e)return!1;if(e==t)return!0;var n=e.__interfaces__;if(null!=n)for(var i=0,o=n.length;i<o;){var r=n[i++];if(r==t||js.Boot.__interfLoop(r,t))return!0}return js.Boot.__interfLoop(e.__super__,t)},js.Boot.__instanceof=function(e,t){try{if(e instanceof t)return t!=Array||null==e.__enum__;if(js.Boot.__interfLoop(e.__class__,t))return!0}catch(e){if(null==t)return!1}switch(t){case Int:return Math.ceil(e%2147483648)===e;case Float:return"number"==typeof e;case Bool:return!0===e||!1===e;case String:return"string"==typeof e;case Dynamic:return!0;default:return null!=e&&(t==Class&&null!=e.__name__||(t==Enum&&null!=e.__ename__||e.__enum__==t))}},js.Boot.__cast=function(e,t){if(js.Boot.__instanceof(e,t))return e;throw"Cannot cast "+Std.string(e)+" to "+Std.string(t)},js.Lib=function(){},js.Lib.__name__=!0,js.Lib.debug=function(){},js.Lib.alert=function(e){alert(js.Boot.__string_rec(e,""))},js.Lib.eval=function(code){return eval(code)},js.Lib.setErrorHandler=function(e){js.Lib.onerror=e},Array.prototype.indexOf&&(HxOverrides.remove=function(e,t){var n=e.indexOf(t);return-1!=n&&(e.splice(n,1),!0)}),Math.__name__=["Math"],Math.NaN=Number.NaN,Math.NEGATIVE_INFINITY=Number.NEGATIVE_INFINITY,Math.POSITIVE_INFINITY=Number.POSITIVE_INFINITY,Math.isFinite=function(e){return isFinite(e)},Math.isNaN=function(e){return isNaN(e)},String.prototype.__class__=String,String.__name__=!0,Array.prototype.__class__=Array,Array.__name__=!0,Date.prototype.__class__=Date,Date.__name__=["Date"];var Int={__name__:["Int"]},Dynamic={__name__:["Dynamic"]},Float=Number;Float.__name__=["Float"];var Bool=Boolean;Bool.__ename__=["Bool"];var Class={__name__:["Class"]},Enum={},Void={__ename__:["Void"]};"undefined"!=typeof document&&(js.Lib.document=document),"undefined"!=typeof window&&(js.Lib.window=window,js.Lib.window.onerror=function(e,t,n){var i=js.Lib.onerror;return null!=i&&i(e,[t+":"+n])}),com.wiris.js.JsPluginTools.main()}(),delete Array.prototype.__class__},function(e,t,n){var i=n(3);"string"==typeof i&&(i=[[e.i,i,""]]);var o={hmr:!0,transform:void 0,insertInto:void 0};n(5)(i,o);i.locals&&(e.exports=i.locals)},function(e,t,n){(e.exports=n(4)(!1)).push([e.i,".wrs_modal_overlay {\n    position: fixed;\n    font-family: arial, sans-serif;\n    top: 0;\n    right: 0;\n    left: 0;\n    bottom: 0;\n    background: rgba(0, 0, 0, 0.8);\n    z-index: 999998;\n    opacity: 0.65;\n    pointer-events: auto;\n}\n\n.wrs_modal_overlay.wrs_modal_ios {\n    visibility: hidden;\n    display: none;\n}\n\n.wrs_modal_overlay.wrs_modal_android {\n    visibility: hidden;\n    display: none;\n}\n\n.wrs_modal_overlay.wrs_modal_ios.moodle {\n    position: fixed;\n}\n\n.wrs_modal_overlay.wrs_modal_desktop.wrs_stack {\n    background: rgba(0, 0, 0, 0);\n    display: none;\n}\n\n.wrs_modal_overlay.wrs_modal_desktop.wrs_maximized {\n    background: rgba(0, 0, 0, 0.8);\n}\n\n.wrs_modal_overlay.wrs_modal_desktop.wrs_minimized {\n    background: rgba(0, 0, 0, 0);\n    display: none;\n}\n\n.wrs_modal_overlay.wrs_modal_desktop.wrs_closed {\n    background: rgba(0, 0, 0, 0);\n    display: none;\n}\n\n.wrs_modal_title {\n    color: #fff;\n    padding: 5px 0 5px 10px;\n    -moz-user-select: none;\n    -webkit-user-select: none;\n    -ms-user-select: none;\n    user-select: none;\n    text-align: left;\n}\n\n.wrs_modal_close_button {\n    float: right;\n    cursor: pointer;\n    color: #fff;\n    padding: 5px 10px 5px 0;\n    margin: 10px 7px 0 0;\n    background-repeat: no-repeat;\n}\n\n.wrs_modal_minimize_button {\n    float: right;\n    cursor: pointer;\n    color: #fff;\n    padding: 5px 10px 5px 0;\n    top: inherit;\n    margin: 10px 7px 0 0;\n}\n\n.wrs_modal_stack_button {\n    float: right;\n    cursor: pointer;\n    color: #fff;\n    margin: 10px 7px 0 0;\n    padding: 5px 10px 5px 0;\n    top: inherit;\n}\n\n.wrs_modal_stack_button.wrs_stack {\n    visibility: hidden;\n    margin: 0;\n    padding: 0;\n}\n\n.wrs_modal_stack_button.wrs_minimized {\n    visibility: hidden;\n    margin: 0;\n    padding: 0;\n}\n\n.wrs_modal_maximize_button {\n    float: right;\n    cursor: pointer;\n    color: #fff;\n    margin: 10px 7px 0 0;\n    padding: 5px 10px 5px 0;\n    top: inherit;\n}\n\n.wrs_modal_maximize_button.wrs_maximized {\n    visibility: hidden;\n    margin: 0;\n    padding: 0;\n}\n\n.wrs_modal_wrapper {\n    display: block;\n    margin: 6px;\n}\n\n.wrs_modal_title_bar {\n    display: block;\n    background-color: #778e9a;\n}\n\n.wrs_modal_dialogContainer {\n    border: none;\n    background: #fafafa;\n    z-index: 999999;\n}\n\n.wrs_modal_dialogContainer.wrs_modal_desktop {\n    font-size: 14px;\n}\n\n.wrs_modal_dialogContainer.wrs_modal_desktop.wrs_maximized {\n    position: fixed;\n}\n\n.wrs_modal_dialogContainer.wrs_modal_desktop.wrs_minimized {\n    position: fixed;\n    top: inherit;\n    margin: 0;\n    margin-right: 10px;\n}\n\n.wrs_modal_dialogContainer.wrs_closed {\n    visibility: hidden;\n    display: none;\n    opacity: 0;\n}\n\n\n/* Class that exists but hasn't got css properties defined\n.wrs_modal_dialogContainer.wrs_modal_desktop.wrs_minimized.wrs_drag {} */\n\n.wrs_modal_dialogContainer.wrs_modal_desktop.wrs_stack {\n    position: fixed;\n    bottom: 0;\n    right: 0;\n    box-shadow: rgba(0, 0, 0, 0.5) 0 2px 8px;\n}\n\n.wrs_modal_dialogContainer.wrs_drag {\n    box-shadow: rgba(0, 0, 0, 0.5) 0 2px 8px;\n}\n\n.wrs_modal_dialogContainer.wrs_modal_desktop.wrs_drag {\n    box-shadow: rgba(0, 0, 0, 0.5) 0 2px 8px;\n}\n\n.wrs_modal_dialogContainer.wrs_modal_android {\n    margin: auto;\n    position: fixed;\n    width: 99%;\n    height: 99%;\n    overflow: hidden;\n    transform: translate(50%, -50%);\n    top: 50%;\n    right: 50% !important;\n    position: fixed;\n}\n\n.wrs_modal_dialogContainer.wrs_modal_ios {\n    margin: auto;\n    position: fixed;\n    width: 100%;\n    height: 100%;\n    overflow: hidden;\n    transform: translate(50%, -50%);\n    top: 50%;\n    right: 50% !important;\n    position: fixed;\n}\n\n\n/* Class that exists but hasn't got css properties defined\n.wrs_content_container.wrs_maximized {} */\n\n.wrs_content_container.wrs_minimized {\n    display: none;\n}\n\n/* .wrs_editor {\n    flex-grow: 1;\n} */\n\n.wrs_content_container.wrs_modal_android {\n    width: 100%;\n    flex-grow: 1;\n    display: flex;\n    flex-direction: column;\n}\n\n.wrs_content_container.wrs_modal_android > div:first-child {\n    flex-grow: 1;\n}\n\n.wrs_content_container.wrs_modal_ios > div:first-child {\n    flex-grow: 1;\n}\n\n.wrs_content_container.wrs_modal_desktop > div:first-child {\n    flex-grow: 1;\n}\n\n.wrs_modal_wrapper.wrs_modal_android {\n    margin: auto;\n    display: flex;\n    flex-direction: column;\n    height: 100%;\n    width: 100%;\n}\n\n.wrs_content_container.wrs_modal_desktop {\n    width: 100%;\n    flex-grow: 1;\n    display: flex;\n    flex-direction: column;\n}\n\n.wrs_content_container.wrs_modal_ios {\n    width: 100%;\n    flex-grow: 1;\n    display: flex;\n    flex-direction: column;\n}\n\n.wrs_modal_wrapper.wrs_modal_ios {\n    margin: auto;\n    display: flex;\n    flex-direction: column;\n    height: 100%;\n    width: 100%;\n}\n\n.wrs_virtual_keyboard {\n    height: 100%;\n    width: 100%;\n    top: 0;\n    left: 50%;\n    transform: translate(-50%, 0%);\n}\n\n@media all and (orientation: portrait) {\n    .wrs_modal_dialogContainer.wrs_modal_mobile {\n        width: 100vmin;\n        height: 100vmin;\n        margin: auto;\n        border-width: 0;\n    }\n    .wrs_modal_wrapper.wrs_modal_mobile {\n        width: 100vmin;\n        height: 100vmin;\n        margin: auto;\n    }\n}\n\n@media all and (orientation: landscape) {\n    .wrs_modal_dialogContainer.wrs_modal_mobile {\n        width: 100vmin;\n        height: 100vmin;\n        margin: auto;\n        border-width: 0;\n    }\n    .wrs_modal_wrapper.wrs_modal_mobile {\n        width: 100vmin;\n        height: 100vmin;\n        margin: auto;\n    }\n}\n\n.wrs_modal_dialogContainer.wrs_modal_badStock {\n    width: 100%;\n    height: 280px;\n    margin: 0 auto;\n    border-width: 0;\n}\n\n.wrs_modal_wrapper.wrs_modal_badStock {\n    width: 100%;\n    height: 280px;\n    margin: 0 auto;\n    border-width: 0;\n}\n.wrs_noselect {\n    -moz-user-select: none;\n    -khtml-user-select: none;\n    -webkit-user-select: none;\n    -ms-user-select: none;\n    user-select: none;\n}\n.wrs_bottom_right_resizer {\n    width: 10px;\n    height: 10px;\n    color: #778e9a;\n    position: absolute;\n    right: 4px;\n    bottom: 8px;\n    cursor: se-resize;\n    -moz-user-select: none;\n    -webkit-user-select: none;\n    -ms-user-select: none;\n    user-select: none;\n}\n.wrs_bottom_left_resizer {\n    width: 15px;\n    height: 15px;\n    color: #778e9a;\n    position: absolute;\n    left: 0;\n    top: 0;\n    cursor: se-resize;\n}\n\n.wrs_modal_controls {\n    height: 42px;\n    margin: 3px 0;\n    overflow: hidden;\n    line-height: normal;\n}\n\n.wrs_modal_links {\n    margin: 10px auto;\n    margin-bottom: 0;\n    font-family: arial, sans-serif;\n    padding: 6px;\n    display: inline;\n    float: right;\n    text-align: right;\n}\n\n.wrs_modal_links > a {\n    text-decoration: none;\n    color: #778e9a;\n    font-size: 16px;\n}\n\n.wrs_modal_button_cancel,\n.wrs_modal_button_cancel:hover,\n.wrs_modal_button_cancel:visited,\n.wrs_modal_button_cancel:active,\n.wrs_modal_button_cancel:focus {\n    min-width: 80px;\n    font-size: 14px;\n    border-radius: 3px;\n    border: 1px solid #778e9a;\n    padding: 6px 8px;\n    margin: 10px auto;\n    margin-left: 5px;\n    margin-bottom: 0;\n    cursor: pointer;\n    font-family: arial, sans-serif;\n    background-color: #DDDDDD;\n    height: 32px;\n}\n\n.wrs_modal_button_accept,\n.wrs_modal_button_accept:hover,\n.wrs_modal_button_accept:visited,\n.wrs_modal_button_accept:active,\n.wrs_modal_button_accept:focus {\n    min-width: 80px;\n    font-size: 14px;\n    border-radius: 3px;\n    border: 1px solid #778e9a;\n    padding: 6px 8px;\n    margin: 10px auto;\n    margin-right: 5px;\n    margin-bottom: 0;\n    color: #fff;\n    background: #778e9a;\n    cursor: pointer;\n    font-family: arial, sans-serif;\n    height: 32px;\n}\n\n.wrs_editor_vertical_bar {\n    height: 20px;\n    float: right;\n    background: none;\n    width: 20px;\n    cursor: pointer;\n}\n\n.wrs_modal_buttons_container {\n    display: inline;\n    float: left;\n}\n\n.wrs_modal_buttons_container.wrs_modalAndroid {\n    padding-left: 6px;\n}\n\n.wrs_modal_buttons_container.wrs_modalDesktop {\n    padding-left: 0;\n}\n\n.wrs_modal_buttons_container > button {\n    line-height: normal;\n    background-image: none;\n}\n\n.wrs_modal_wrapper {\n    margin: 6px;\n    display: flex;\n    flex-direction: column;\n}\n\n.wrs_modal_wrapper.wrs_modal_desktop.wrs_minimized {\n    display: none;\n}\n\n@media only screen and (max-device-width: 480px) and (orientation: portrait) {\n    #wrs_modal_wrapper {\n        width: 140%;\n    }\n}\n\n.wrs_popupmessage_overlay_envolture {\n    display: none;\n    width: 100%;\n}\n.wrs_popupmessage_overlay {\n    position: absolute;\n    width: 100%;\n    height: 100%;\n    top: 0;\n    left: 0;\n    right: 0;\n    bottom: 0;\n    background-color: rgba(0, 0, 0, 0.5);\n    z-index: 4;\n    cursor: pointer;\n}\n.wrs_popupmessage_panel {\n    top: 50%;\n    left: 50%;\n    transform: translate(-50%, -50%);\n    position: absolute;\n    background: white;\n    max-width: 500px;\n    width: 75%;\n    border-radius: 2px;\n    padding: 20px;\n    font-family: sans-serif;\n    font-size: 15px;\n    text-align: left;\n    color: #2e2e2e;\n    z-index: 5;\n    max-height: 75%;\n    overflow: auto;\n}\n\n.wrs_popupmessage_button_area {\n    margin: 10px 0 0 0;\n}\n\n.wrs_panelContainer * {\n    border: 0;\n}\n\n.wrs_button_cancel,\n.wrs_button_cancel:hover,\n.wrs_button_cancel:visited,\n.wrs_button_cancel:active,\n.wrs_button_cancel:focus {\n    min-width: 80px;\n    font-size: 14px;\n    border-radius: 3px;\n    border: 1px solid #778e9a;\n    padding: 6px 8px;\n    margin: 10px auto;\n    margin-left: 5px;\n    margin-bottom: 0;\n    cursor: pointer;\n    font-family: arial, sans-serif;\n    background-color: #DDDDDD;\n    background-image: none;\n    height: 32px;\n}\n\n.wrs_button_accept,\n.wrs_button_accept:hover,\n.wrs_button_accept:visited,\n.wrs_button_accept:active,\n.wrs_button_accept:focus {\n    min-width: 80px;\n    font-size: 14px;\n    border-radius: 3px;\n    border: 1px solid #778e9a;\n    padding: 6px 8px;\n    margin: 10px auto;\n    margin-right: 5px;\n    margin-bottom: 0;\n    color: #fff;\n    background: #778e9a;\n    cursor: pointer;\n    font-family: arial, sans-serif;\n    height: 32px;\n}\n\n.wrs_editor button{\n    box-shadow: none;\n}\n\n.wrs_editor .wrs_header button{\n    border-bottom: none;\n    border-bottom-left-radius: 0;\n    border-bottom-right-radius: 0;\n}\n\n.wrs_modal_overlay.wrs_modal_desktop.wrs_stack.wrs_overlay_active {\n    display: block;\n}\n/* Fix selection in drupal style */\n.wrs_toolbar tr:focus{\n    background: none;\n}\n.wrs_toolbar tr:hover{\n    background: none;\n}\n/* End of fix drupal */\n.wrs_modal_rtl .wrs_modal_button_cancel {\n    margin-right: 5px;\n    margin-left: 0;\n}\n.wrs_modal_rtl .wrs_modal_button_accept {\n    margin-right: 0;\n    margin-left: 5px;\n}\n.wrs_modal_rtl .wrs_button_cancel {\n    margin-right: 5px;\n    margin-left: 0;\n}\n.wrs_modal_rtl .wrs_button_accept {\n    margin-right: 0;\n    margin-left: 5px;\n}\n",""])},function(e,t){e.exports=function(e){var t=[];return t.toString=function(){return this.map(function(t){var n=function(e,t){var n=e[1]||"",i=e[3];if(!i)return n;if(t&&"function"==typeof btoa){var o=function(e){return"/*# sourceMappingURL=data:application/json;charset=utf-8;base64,"+btoa(unescape(encodeURIComponent(JSON.stringify(e))))+" */"}(i),r=i.sources.map(function(e){return"/*# sourceURL="+i.sourceRoot+e+" */"});return[n].concat(r).concat([o]).join("\n")}return[n].join("\n")}(t,e);return t[2]?"@media "+t[2]+"{"+n+"}":n}).join("")},t.i=function(e,n){"string"==typeof e&&(e=[[null,e,""]]);for(var i={},o=0;o<this.length;o++){var r=this[o][0];"number"==typeof r&&(i[r]=!0)}for(o=0;o<e.length;o++){var a=e[o];"number"==typeof a[0]&&i[a[0]]||(n&&!a[2]?a[2]=n:n&&(a[2]="("+a[2]+") and ("+n+")"),t.push(a))}},t}},function(e,t,n){var i={},o=function(e){var t;return function(){return void 0===t&&(t=e.apply(this,arguments)),t}}(function(){return window&&document&&document.all&&!window.atob}),r=function(e){var t={};return function(e,n){if("function"==typeof e)return e();if(void 0===t[e]){var i=function(e,t){return t?t.querySelector(e):document.querySelector(e)}.call(this,e,n);if(window.HTMLIFrameElement&&i instanceof window.HTMLIFrameElement)try{i=i.contentDocument.head}catch(e){i=null}t[e]=i}return t[e]}}(),a=null,s=0,l=[],c=n(6);function u(e,t){for(var n=0;n<e.length;n++){var o=e[n],r=i[o.id];if(r){r.refs++;for(var a=0;a<r.parts.length;a++)r.parts[a](o.parts[a]);for(;a<o.parts.length;a++)r.parts.push(p(o.parts[a],t))}else{var s=[];for(a=0;a<o.parts.length;a++)s.push(p(o.parts[a],t));i[o.id]={id:o.id,refs:1,parts:s}}}}function d(e,t){for(var n=[],i={},o=0;o<e.length;o++){var r=e[o],a=t.base?r[0]+t.base:r[0],s={css:r[1],media:r[2],sourceMap:r[3]};i[a]?i[a].parts.push(s):n.push(i[a]={id:a,parts:[s]})}return n}function h(e,t){var n=r(e.insertInto);if(!n)throw new Error("Couldn't find a style target. This probably means that the value for the 'insertInto' parameter is invalid.");var i=l[l.length-1];if("top"===e.insertAt)i?i.nextSibling?n.insertBefore(t,i.nextSibling):n.appendChild(t):n.insertBefore(t,n.firstChild),l.push(t);else if("bottom"===e.insertAt)n.appendChild(t);else{if("object"!=typeof e.insertAt||!e.insertAt.before)throw new Error("[Style Loader]\n\n Invalid value for parameter 'insertAt' ('options.insertAt') found.\n Must be 'top', 'bottom', or Object.\n (https://github.com/webpack-contrib/style-loader#insertat)\n");var o=r(e.insertAt.before,n);n.insertBefore(t,o)}}function m(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e);var t=l.indexOf(e);t>=0&&l.splice(t,1)}function g(e){var t=document.createElement("style");if(void 0===e.attrs.type&&(e.attrs.type="text/css"),void 0===e.attrs.nonce){var i=function(){0;return n.nc}();i&&(e.attrs.nonce=i)}return f(t,e.attrs),h(e,t),t}function f(e,t){Object.keys(t).forEach(function(n){e.setAttribute(n,t[n])})}function p(e,t){var n,i,o,r;if(t.transform&&e.css){if(!(r="function"==typeof t.transform?t.transform(e.css):t.transform.default(e.css)))return function(){};e.css=r}if(t.singleton){var l=s++;n=a||(a=g(t)),i=_.bind(null,n,l,!1),o=_.bind(null,n,l,!0)}else e.sourceMap&&"function"==typeof URL&&"function"==typeof URL.createObjectURL&&"function"==typeof URL.revokeObjectURL&&"function"==typeof Blob&&"function"==typeof btoa?(n=function(e){var t=document.createElement("link");return void 0===e.attrs.type&&(e.attrs.type="text/css"),e.attrs.rel="stylesheet",f(t,e.attrs),h(e,t),t}(t),i=function(e,t,n){var i=n.css,o=n.sourceMap,r=void 0===t.convertToAbsoluteUrls&&o;(t.convertToAbsoluteUrls||r)&&(i=c(i));o&&(i+="\n/*# sourceMappingURL=data:application/json;base64,"+btoa(unescape(encodeURIComponent(JSON.stringify(o))))+" */");var a=new Blob([i],{type:"text/css"}),s=e.href;e.href=URL.createObjectURL(a),s&&URL.revokeObjectURL(s)}.bind(null,n,t),o=function(){m(n),n.href&&URL.revokeObjectURL(n.href)}):(n=g(t),i=function(e,t){var n=t.css,i=t.media;i&&e.setAttribute("media",i);if(e.styleSheet)e.styleSheet.cssText=n;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(n))}}.bind(null,n),o=function(){m(n)});return i(e),function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap)return;i(e=t)}else o()}}e.exports=function(e,t){if("undefined"!=typeof DEBUG&&DEBUG&&"object"!=typeof document)throw new Error("The style-loader cannot be used in a non-browser environment");(t=t||{}).attrs="object"==typeof t.attrs?t.attrs:{},t.singleton||"boolean"==typeof t.singleton||(t.singleton=o()),t.insertInto||(t.insertInto="head"),t.insertAt||(t.insertAt="bottom");var n=d(e,t);return u(n,t),function(e){for(var o=[],r=0;r<n.length;r++){var a=n[r];(s=i[a.id]).refs--,o.push(s)}e&&u(d(e,t),t);for(r=0;r<o.length;r++){var s;if(0===(s=o[r]).refs){for(var l=0;l<s.parts.length;l++)s.parts[l]();delete i[s.id]}}}};var v=function(){var e=[];return function(t,n){return e[t]=n,e.filter(Boolean).join("\n")}}();function _(e,t,n,i){var o=n?"":i.css;if(e.styleSheet)e.styleSheet.cssText=v(t,o);else{var r=document.createTextNode(o),a=e.childNodes;a[t]&&e.removeChild(a[t]),a.length?e.insertBefore(r,a[t]):e.appendChild(r)}}},function(e,t){e.exports=function(e){var t="undefined"!=typeof window&&window.location;if(!t)throw new Error("fixUrls requires window.location");if(!e||"string"!=typeof e)return e;var n=t.protocol+"//"+t.host,i=n+t.pathname.replace(/\/[^\/]*$/,"/");return e.replace(/url\s*\(((?:[^)(]|\((?:[^)(]+|\([^)(]*\))*\))*)\)/gi,function(e,t){var o,r=t.trim().replace(/^"(.*)"$/,function(e,t){return t}).replace(/^'(.*)'$/,function(e,t){return t});return/^(#|data:|http:\/\/|https:\/\/|file:\/\/\/|\s*$)/i.test(r)?e:(o=0===r.indexOf("//")?r:0===r.indexOf("/")?n+r:i+r.replace(/^\.\//,""),"url("+JSON.stringify(o)+")")})}},function(e,t,n){"use strict";function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}n.r(t);var o=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return function(e,t,n){t&&i(e.prototype,t),n&&i(e,n)}(e,null,[{key:"safeXmlCharactersEntities",get:function(){return{tagOpener:"&laquo;",tagCloser:"&raquo;",doubleQuote:"&uml;",realDoubleQuote:"&quot;"}}},{key:"safeBadBlackboardCharacters",get:function(){return{ltElement:"«mo»<«/mo»",gtElement:"«mo»>«/mo»",ampElement:"«mo»&«/mo»"}}},{key:"safeGoodBlackboardCharacters",get:function(){return{ltElement:"«mo»§lt;«/mo»",gtElement:"«mo»§gt;«/mo»",ampElement:"«mo»§amp;«/mo»"}}},{key:"xmlCharacters",get:function(){return{id:"xmlCharacters",tagOpener:"<",tagCloser:">",doubleQuote:'"',ampersand:"&",quote:"'"}}},{key:"safeXmlCharacters",get:function(){return{id:"safeXmlCharacters",tagOpener:"«",tagCloser:"»",doubleQuote:"¨",ampersand:"§",quote:"`",realDoubleQuote:"¨"}}}]),e}();function r(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var a=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return function(e,t,n){t&&r(e.prototype,t),n&&r(e,n)}(e,null,[{key:"isMathmlInAttribute",value:function(e,t){var n="[\\s]*(".concat("\"[^\"]*\"|'[^']*'",")[\\s]*=[\\s]*[\\w-]+[\\s]*"),i="('".concat(n,"')*"),o="^".concat("['\"][\\s]*=[\\s]*[\\w-]+").concat(i,"[\\s]+gmi<"),r=new RegExp(o),a=e.substring(0,t).split("").reverse().join("");return r.test(a)}},{key:"safeXmlDecode",value:function(e){var t=o.safeXmlCharactersEntities.tagOpener,n=o.safeXmlCharactersEntities.tagCloser,i=o.safeXmlCharactersEntities.doubleQuote,r=o.safeXmlCharactersEntities.realDoubleQuote;e=(e=(e=(e=e.split(t).join(o.safeXmlCharacters.tagOpener)).split(n).join(o.safeXmlCharacters.tagCloser)).split(i).join(o.safeXmlCharacters.doubleQuote)).split(r).join(o.safeXmlCharacters.realDoubleQuote);var a=o.safeBadBlackboardCharacters.ltElement,s=o.safeBadBlackboardCharacters.gtElement,l=o.safeBadBlackboardCharacters.ampElement;"_wrs_blackboard"in window&&window._wrs_blackboard&&(e=(e=(e=e.split(a).join(o.safeGoodBlackboardCharacters.ltElement)).split(s).join(o.safeGoodBlackboardCharacters.gtElement)).split(l).join(o.safeGoodBlackboardCharacters.ampElement)),t=o.safeXmlCharacters.tagOpener,n=o.safeXmlCharacters.tagCloser,i=o.safeXmlCharacters.doubleQuote,r=o.safeXmlCharacters.realDoubleQuote;var c=o.safeXmlCharacters.ampersand,u=o.safeXmlCharacters.quote;e=(e=(e=(e=(e=e.split(t).join(o.xmlCharacters.tagOpener)).split(n).join(o.xmlCharacters.tagCloser)).split(i).join(o.xmlCharacters.doubleQuote)).split(c).join(o.xmlCharacters.ampersand)).split(u).join(o.xmlCharacters.quote);for(var d="",h=null,m=0;m<e.length;m+=1){var g=e.charAt(m);null==h?"$"===g?h="":d+=g:";"===g?(d+="&".concat(h),h=null):g.match(/([a-zA-Z0-9#._-] | '-')/)?h+=g:(d+="$".concat(h),h=null,m-=1)}return d}},{key:"safeXmlEncode",value:function(e){var t=o.xmlCharacters.tagOpener,n=o.xmlCharacters.tagCloser,i=o.xmlCharacters.doubleQuote,r=o.xmlCharacters.ampersand,a=o.xmlCharacters.quote;return e=(e=(e=(e=(e=e.split(t).join(o.safeXmlCharacters.tagOpener)).split(n).join(o.safeXmlCharacters.tagCloser)).split(i).join(o.safeXmlCharacters.doubleQuote)).split(r).join(o.safeXmlCharacters.ampersand)).split(a).join(o.safeXmlCharacters.quote)}},{key:"mathMLEntities",value:function(e){for(var t="",n=0;n<e.length;n+=1){var i=e.charAt(n);if(e.codePointAt(n)>128)t+="&#".concat(e.codePointAt(n),";"),e.codePointAt(n)>65535&&(n+=1);else if("&"===i){var o=e.indexOf(";",n+1);if(o>=0){var r=document.createElement("span");r.innerHTML=e.substring(n,o+1),t+="&#".concat(y.fixedCharCodeAt(r.textContent||r.innerText,0),";"),n=o}else t+=i}else t+=i}return t}},{key:"addCustomEditorClassAttribute",value:function(e,t){var n="",i=e.indexOf("<math");if(0===i){var o=e.indexOf(">");if(-1===e.indexOf("class"))return n="".concat(e.substr(i,o),' class="wrs_').concat(t,'">'),n+=e.substr(o+1,e.length)}return e}},{key:"removeCustomEditorClassAttribute",value:function(e,t){return-1===e.indexOf("class")||-1===e.indexOf("wrs_".concat(t))?e:-1!==e.indexOf('class="wrs_'.concat(t,'"'))?e.replace('class="wrs_'.concat(t,'"'),""):e.replace("wrs_".concat(t),"")}},{key:"addAnnotation",value:function(t,n,i){var o="";if(-1!==t.indexOf("<annotation")){var r=t.indexOf("</semantics>");o="".concat(t.substring(0,r),'<annotation encoding="').concat(i,'">').concat(n,"</annotation>").concat(t.substring(r))}else if(e.isEmpty(t)){var a=t.indexOf("/>"),s=t.indexOf(">"),l=s===a?a:s;o="".concat(t.substring(0,l),'><semantics><annotation encoding="').concat(i,'">').concat(n,"</annotation></semantics></math>")}else{var c=t.indexOf(">")+1,u=t.lastIndexOf("</math>"),d=t.substring(c,u);o="".concat(t.substring(0,c),"<semantics>").concat(d,'<annotation encoding="').concat(i,'">').concat(n,"</annotation></semantics></math>")}return o}},{key:"removeAnnotation",value:function(t,n){var i=t,o='<annotation encoding="'.concat(n,'">'),r=t.indexOf(o);if(-1!==r){for(var a=!1,s=t.indexOf("<annotation");-1!==s;)s!==r&&(a=!0),s=t.indexOf("<annotation",s+1);if(a){var l=t.indexOf("</annotation>",r)+"</annotation>".length;i=t.substring(0,r)+t.substring(l)}else i=e.removeSemantics(t)}return i}},{key:"removeSemantics",value:function(e){var t=e,n=e.indexOf("<semantics>");if(-1!==n){var i=e.indexOf("<annotation",n+"<semantics>".length);-1!==i&&(t=e.substring(0,n)+e.substring(n+"<semantics>".length,i)+"</math>")}return t}},{key:"removeSemanticsOcurrences",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:o.xmlCharacters,n="".concat(t.tagOpener,"math"),i="".concat(t.tagOpener,"/math").concat(t.tagCloser),r="/".concat(t.tagCloser),a=t.tagCloser,s="".concat(t.tagOpener,"semantics").concat(t.tagCloser),l="".concat(t.tagOpener,"annotation encoding="),c="",u=e.indexOf(n),d=0;-1!==u;){c+=e.substring(d,u);var h=e.indexOf(i,u),m=e.indexOf(r,u),g=e.indexOf(a,u);-1!==h?d=h:m===g-1&&(d=m);var f=e.indexOf(s,u);if(-1!==f){var p=e.substring(u,f),v=e.indexOf(l,u);if(-1!==v){var _=f+s.length;c+=p+e.substring(_,v)+i,u=e.indexOf(n,u+n.length),d+=i.length}else d=u,u=e.indexOf(n,u+n.length)}else d=u,u=e.indexOf(n,u+n.length)}return c+=e.substring(d,e.length)}},{key:"containClass",value:function(e,t){var n=e.indexOf("class");if(-1===n)return!1;var i=e.indexOf(">",n);return-1!==e.substring(n,i).indexOf(t)}},{key:"isEmpty",value:function(e){var t=e.indexOf(">"),n=e.indexOf("/>"),i=!1;if(-1!==n&&n===t-1&&(i=!0),!i){var o=new RegExp("</(.+:)?math>").exec(e);o&&(i=t+1===o.index)}return i}},{key:"encodeProperties",value:function(e){return e.replace(/\w+=".*?"/g,function(e){var t=e.indexOf('"'),n=e.substring(t+1,e.length-1),i=y.htmlEntities(n);return"".concat(e.substring(0,t+1)).concat(i,'"')})}}]),e}();function s(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var l=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return function(e,t,n){t&&s(e.prototype,t),n&&s(e,n)}(e,null,[{key:"addConfiguration",value:function(t){Object.assign(e.properties,t)}},{key:"get",value:function(t){return Object.prototype.hasOwnProperty.call(e.properties,t)?e.properties[t]:!!Object.prototype.hasOwnProperty.call(e.properties,"_wrs_conf_")&&e.properties["_wrs_conf_".concat(t)]}},{key:"set",value:function(t,n){e.properties[t]=n}},{key:"update",value:function(t,n){if(e.get(t)){var i=Object.assign(e.get(t),n);e.set(t,i)}else e.set(t,n)}},{key:"properties",get:function(){return e._properties},set:function(t){e._properties=t}}]),e}();function c(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}l._properties={};var u=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.cache=[]}return function(e,t,n){t&&c(e.prototype,t),n&&c(e,n)}(e,[{key:"populate",value:function(e,t){this.cache[e]=t}},{key:"get",value:function(e){return!!Object.prototype.hasOwnProperty.call(this.cache,e)&&this.cache[e]}}]),e}();function d(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var h=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.listeners=[]}return function(e,t,n){t&&d(e.prototype,t),n&&d(e,n)}(e,[{key:"add",value:function(e){this.listeners.push(e)}},{key:"fire",value:function(e,t){for(var n=0;n<this.listeners.length&&!t.cancelled;n+=1)this.listeners[n].eventName===e&&this.listeners[n].callback(t);return t.defaultPrevented}}],[{key:"newListener",value:function(e,t){var n={};return n.eventName=e,n.callback=t,n}}]),e}();function m(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var g=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return function(e,t,n){t&&m(e.prototype,t),n&&m(e,n)}(e,null,[{key:"addListener",value:function(t){e.listeners.add(t)}},{key:"fireEvent",value:function(t,n){e.listeners.fire(t,n)}},{key:"setServicePath",value:function(t,n){e.servicePaths[t]=n}},{key:"getServicePath",value:function(t){return e.servicePaths[t]}},{key:"getServerURL",value:function(){var e=window.location.href.split("/");return"".concat(e[0],"//").concat(e[2])}},{key:"init",value:function(t){e.parameters=t;var n=e.createServiceURI("configurationjs"),i=e.createServiceURI("createimage"),o=e.createServiceURI("showimage"),r=e.createServiceURI("getmathml"),a=e.createServiceURI("service");if(0===e.parameters.URI.indexOf("/")){var s=e.getServerURL();n=s+n,o=s+o,i=s+i,r=s+r,a=s+a}e.setServicePath("configurationjs",n),e.setServicePath("showimage",o),e.setServicePath("createimage",i),e.setServicePath("service",a),e.setServicePath("getmathml",r),e.setServicePath("configurationjs",n),e.listeners.fire("onInit",{})}},{key:"getUrl",value:function(e,t){var n=window.location.toString().substr(0,window.location.toString().lastIndexOf("/")+1),i=y.createHttpRequest();return i?(void 0===t||void 0===t?i.open("GET",e,!1):"/"===e.substr(0,1)||"http://"===e.substr(0,7)||"https://"===e.substr(0,8)?i.open("POST",e,!1):i.open("POST",n+e,!1),void 0!==t&&t?(i.setRequestHeader("Content-type","application/x-www-form-urlencoded; charset=UTF-8"),i.send(y.httpBuildQuery(t))):i.send(null),i.responseText):""}},{key:"getService",value:function(t,n,i){var o;if(!0===i){var r="".concat(e.getServicePath(t),"?").concat(n);o=e.getUrl(r)}else{var a=e.getServicePath(t);o=e.getUrl(a,n)}return o}},{key:"getServerLanguageFromService",value:function(e){return-1!==e.indexOf(".php")?"php":-1!==e.indexOf(".aspx")?"aspx":-1!==e.indexOf("wirispluginengine")?"ruby":"java"}},{key:"createServiceURI",value:function(t){var n=e.serverExtension();return y.concatenateUrl(e.parameters.URI,t)+n}},{key:"serverExtension",value:function(){return-1!==e.parameters.server.indexOf("php")?".php":-1!==e.parameters.server.indexOf("aspx")?".aspx":""}},{key:"listeners",get:function(){return e._listeners}},{key:"parameters",get:function(){return e._parameters},set:function(t){e._parameters=t}},{key:"servicePaths",get:function(){return e._servicePaths},set:function(t){e._servicePaths=t}},{key:"integrationPath",get:function(){return e._integrationPath},set:function(t){e._integrationPath=t}}]),e}();function f(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}g._servicePaths={},g._integrationPath="",g._listeners=new h,g._parameters={};var p=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return function(e,t,n){t&&f(e.prototype,t),n&&f(e,n)}(e,null,[{key:"getLatexFromMathML",value:function(t){var n=a.removeSemantics(t),i=e.cache,o={service:"mathml2latex",mml:n},r=JSON.parse(g.getService("service",o)),s="";if("ok"===r.status){s=r.result.text;var l=y.htmlEntities(s),c=a.addAnnotation(t,l,"LaTeX");i.populate(s,c)}return s}},{key:"getMathMLFromLatex",value:function(t,n){var i=e.cache;if(e.cache.get(t))return e.cache.get(t);var o={service:"latex2mathml",latex:t};n&&(o.saveLatex="");var r,s=JSON.parse(g.getService("service",o));if("ok"===s.status){var l=s.result.text;r=-1===(l=l.split("\r").join("").split("\n").join(" ")).indexOf("semantics")&&-1===l.indexOf("annotation")?l=a.addAnnotation(l,t,"LaTeX"):l,i.get(t)||i.populate(t,l)}else r="$$".concat(t,"$$");return r}},{key:"parseMathmlToLatex",value:function(t,n){for(var i,r,s,l="",c="".concat(n.tagOpener,"math"),u="".concat(n.tagOpener,"/math").concat(n.tagCloser),d="".concat(n.tagOpener,"annotation encoding=").concat(n.doubleQuote,"LaTeX").concat(n.doubleQuote).concat(n.tagCloser),h="".concat(n.tagOpener,"/annotation").concat(n.tagCloser),m=t.indexOf(c),g=0;-1!==m;){if(l+=t.substring(g,m),-1===(g=t.indexOf(u,m))?g=t.length-1:g+=u.length,-1!==(r=(i=t.substring(m,g)).indexOf(d))){r+=d.length,s=i.indexOf(h);var f=i.substring(r,s);n===o.safeXmlCharacters&&(f=a.safeXmlDecode(f)),l+="$$".concat(f,"$$"),e.cache.populate(f,i)}else l+=i;m=t.indexOf(c,g)}return l+=t.substring(g,t.length)}},{key:"getLatexFromTextNode",value:function(e,t,n){void 0!==n&&null!=n||(n={open:"$$",close:"$$"});for(var i,o=e;o.previousSibling&&3===o.previousSibling.nodeType;)o=o.previousSibling;function r(e,t,i){for(var o=e.nodeValue.indexOf(i,t);-1===o;){if(!(e=e.nextSibling))return null;o=e.nodeValue?e.nodeValue.indexOf(n.close):-1}return{node:e,position:o}}function a(e,t,n,i){if(e===n)return t<=i;for(;e&&e!==n;)e=e.nextSibling;return e===n}var s,l={node:o,position:0},c=n.open.length;do{if(null==(i=r(l.node,l.position,n.open))||a(e,t,i.node,i.position))return null;if(null==(l=r(i.node,i.position+c,n.close)))return null;l.position+=c}while(a(l.node,l.position,e,t));if(i.node===l.node)s=i.node.nodeValue.substring(i.position+c,l.position-c);else{var u=i.position+c;s=i.node.nodeValue.substring(u,i.node.nodeValue.length);var d=i.node;do{(d=d.nextSibling)===l.node?s+=l.node.nodeValue.substring(0,l.position-c):s+=d.nodeValue?d.nodeValue:""}while(d!==l.node)}return{latex:s,startNode:i.node,startPosition:i.position,endNode:l.node,endPosition:l.position}}},{key:"cache",get:function(){return e._cache},set:function(t){e._cache=t}}]),e}();p._cache=new u;var v=n(0);function _(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var w=function(){function e(){throw function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),new Error("Static class StringManager can not be instantiated.")}return function(e,t,n){t&&_(e.prototype,t),n&&_(e,n)}(e,null,[{key:"get",value:function(e){var t=this.language;return t.length>2&&(t=t.slice(0,2)),this.strings.hasOwnProperty(t)||(console.warn("Unknown language ".concat(t," set in StringManager.")),t="en"),this.strings[t].hasOwnProperty(e)?this.strings[t][e]:(console.warn("Unknown key ".concat(e," for language ").concat(t," in StringManager.")),e)}}]),e}();function b(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}w.strings=v,w.language="en";var y=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return function(e,t,n){t&&b(e.prototype,t),n&&b(e,n)}(e,null,[{key:"fireEvent",value:function(e,t){if(document.createEvent){var n=document.createEvent("HTMLEvents");return n.initEvent(t,!0,!0),!e.dispatchEvent(n)}var i=document.createEventObject();return e.fireEvent("on".concat(t),i)}},{key:"addEvent",value:function(e,t,n){e.addEventListener?e.addEventListener(t,n,!0):e.attachEvent&&e.attachEvent("on".concat(t),n)}},{key:"removeEvent",value:function(e,t,n){e.removeEventListener?e.removeEventListener(t,n,!0):e.detachEvent&&e.detachEvent("on".concat(t),n)}},{key:"addElementEvents",value:function(t,n,i,o){n&&e.addEvent(t,"dblclick",function(e){var t=e||window.event,i=t.srcElement?t.srcElement:t.target;n(i,t)}),i&&e.addEvent(t,"mousedown",function(e){var t=e||window.event,n=t.srcElement?t.srcElement:t.target;i(n,t)}),o&&e.addEvent(t,"mouseup",function(e){var t=e||window.event,n=t.srcElement?t.srcElement:t.target;o(n,t)})}},{key:"addClass",value:function(t,n){e.containsClass(t,n)||(t.className+=" ".concat(n))}},{key:"containsClass",value:function(e,t){if(null==e||!("className"in e))return!1;for(var n=e.className.split(" "),i=n.length-1;i>=0;i-=1)if(n[i]===t)return!0;return!1}},{key:"removeClass",value:function(e,t){for(var n="",i=e.className.split(" "),o=0;o<i.length;o+=1)i[o]!==t&&(n+="".concat(i[o]," "));e.className=n.trim()}},{key:"convertOldXmlinitialtextAttribute",value:function(e){var t="value=",n=e.indexOf("xmlinitialtext"),i=e.indexOf(t,n),o=e.charAt(i+t.length),r=i+t.length+1,a=e.indexOf(o,r),s=e.substring(r,a),l=s.split("«").join("§lt;");return l=(l=(l=l.split("»").join("§gt;")).split("&").join("§")).split("¨").join("§quot;"),e=e.split(s).join(l)}},{key:"createElement",value:function(t,n,i){var o;void 0===n&&(n={}),void 0===i&&(i=document);try{var r="<".concat(t);Object.keys(n).forEach(function(t){r+=" ".concat(t,'="').concat(e.htmlEntities(n[t]),'"')}),r+=">",o=i.createElement(r)}catch(e){o=i.createElement(t),Object.keys(n).forEach(function(e){o.setAttribute(e,n[e])})}return o}},{key:"createObject",value:function(t,n){void 0===n&&(n=document),t=(t=(t=(t=t.split("<applet ").join('<span wirisObject="WirisApplet" ').split("<APPLET ").join('<span wirisObject="WirisApplet" ')).split("</applet>").join("</span>").split("</APPLET>").join("</span>")).split("<param ").join('<br wirisObject="WirisParam" ').split("<PARAM ").join('<br wirisObject="WirisParam" ')).split("</param>").join("</br>").split("</PARAM>").join("</br>");var i=e.createElement("div",{},n);return i.innerHTML=t,function t(i){if(i.getAttribute&&"WirisParam"===i.getAttribute("wirisObject")){for(var o={},r=0;r<i.attributes.length;r+=1)null!==i.attributes[r].nodeValue&&(o[i.attributes[r].nodeName]=i.attributes[r].nodeValue);var a=e.createElement("param",o,n);a.NAME&&(a.name=a.NAME,a.value=a.VALUE),a.removeAttribute("wirisObject"),i.parentNode.replaceChild(a,i)}else if(i.getAttribute&&"WirisApplet"===i.getAttribute("wirisObject")){for(var s={},l=0;l<i.attributes.length;l+=1)null!==i.attributes[l].nodeValue&&(s[i.attributes[l].nodeName]=i.attributes[l].nodeValue);var c=e.createElement("applet",s,n);c.removeAttribute("wirisObject");for(var u=0;u<i.childNodes.length;u+=1)t(i.childNodes[u]),"param"===i.childNodes[u].nodeName.toLowerCase()&&(c.appendChild(i.childNodes[u]),u-=1);i.parentNode.replaceChild(c,i)}else for(var d=0;d<i.childNodes.length;d+=1)t(i.childNodes[d])}(i),i.firstChild}},{key:"createObjectCode",value:function(t){if(void 0===t||null===t)return null;if(1===t.nodeType){for(var n="<".concat(t.tagName),i=0;i<t.attributes.length;i+=1)t.attributes[i].specified&&(n+=" ".concat(t.attributes[i].name,'="').concat(e.htmlEntities(t.attributes[i].value),'"'));if(t.childNodes.length>0){n+=">";for(var o=0;o<t.childNodes.length;o+=1)n+=e.createObject(t.childNodes[o]);n+="</".concat(t.tagName,">")}else"DIV"===t.nodeName||"SCRIPT"===t.nodeName?n+="></".concat(t.tagName,">"):n+="/>";return n}return 3===t.nodeType?e.htmlEntities(t.nodeValue):""}},{key:"concatenateUrl",value:function(e,t){var n="";return e.indexOf("/")!==e.length&&0!==t.indexOf("/")&&(n="/"),(e+n+t).replace(/([^:]\/)\/+/g,"$1")}},{key:"htmlEntities",value:function(e){return e.split("&").join("&amp;").split("<").join("&lt;").split(">").join("&gt;").split('"').join("&quot;")}},{key:"htmlEntitiesDecode",value:function(e){var t=document.createElement("textarea");return t.innerHTML=e,t.value}},{key:"createHttpRequest",value:function(){if("file://"===window.location.toString().substr(0,window.location.toString().lastIndexOf("/")+1).substr(0,7))throw w.get("exception_cross_site");if("undefined"!=typeof XMLHttpRequest)return new XMLHttpRequest;try{return new ActiveXObject("Msxml2.XMLHTTP")}catch(e){try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(e){return null}}}},{key:"httpBuildQuery",value:function(t){var n="";return Object.keys(t).forEach(function(i){null!=t[i]&&(n+="".concat(e.urlEncode(i),"=").concat(e.urlEncode(t[i]),"&"))}),"&"===n.substring(n.length-1)&&(n=n.substring(0,n.length-1)),n}},{key:"propertiesToString",value:function(t){var n=[];Object.keys(t).forEach(function(e){Object.prototype.hasOwnProperty.call(t,e)&&n.push(e)});for(var i=n.length,o=0;o<i;o+=1)for(var r=o+1;r<i;r+=1){var a=n[o],s=n[r];e.compareStrings(a,s)>0&&(n[o]=s,n[r]=a)}for(var l="",c=0;c<i;c+=1){var u=n[c];l+=u,l+="=";var d=t[u];l+=d=(d=(d=(d=d.replace("\\","\\\\")).replace("\n","\\n")).replace("\r","\\r")).replace("\t","\\t"),l+="\n"}return l}},{key:"compareStrings",value:function(t,n){var i,o=t.length,r=n.length,a=o>r?r:o;for(i=0;i<a;i+=1){var s=e.fixedCharCodeAt(t,i)-e.fixedCharCodeAt(n,i);if(0!==s)return s}return t.length-n.length}},{key:"fixedCharCodeAt",value:function(e,t){t=t||0;var n,i,o=e.charCodeAt(t);if(o>=55296&&o<=56319){if(n=o,i=e.charCodeAt(t+1),Number.isNaN(i))throw w.get("exception_high_surrogate");return 1024*(n-55296)+(i-56320)+65536}return!(o>=56320&&o<=57343)&&o}},{key:"urlToAssArray",value:function(e){var t;if((t=e.indexOf("?"))>0){var n=e.substring(t+1).split("&"),i={};for(t=0;t<n.length;t+=1){var o=n[t].split("=");o.length>1&&(i[o[0]]=decodeURIComponent(o[1].replace(/\+/g," ")))}return i}return{}}},{key:"urlEncode",value:function(e){return encodeURIComponent(e)}},{key:"getWIRISImageOutput",value:function(t,n,i){var o=e.createObject(t);if(o&&(o.className===l.get("imageClassName")||o.getAttribute(l.get("imageMathmlAttribute")))){if(!n)return t;var r=o.getAttribute(l.get("imageMathmlAttribute")),s=a.safeXmlDecode(r);return l.get("saveHandTraces")||(s=a.removeAnnotation(s,"application/json")),null==s&&(s=o.getAttribute("alt")),i?a.safeXmlEncode(s):s}return t}},{key:"getNodeLength",value:function(t){if(3===t.nodeType)return t.nodeValue.length;if(1===t.nodeType){var n={IMG:1,BR:1}[t.nodeName.toUpperCase()];void 0===n&&(n=0);for(var i=0;i<t.childNodes.length;i+=1)n+=e.getNodeLength(t.childNodes[i]);return n}return 0}},{key:"getSelectedItem",value:function(t,n,i){var o;if(n?(o=t.contentWindow).focus():(o=window,t.focus()),document.selection&&!i){var r=o.document.selection.createRange();if(r.parentElement){if(r.htmlText.length>0)return 0===r.text.length?e.getSelectedItem(t,n,!0):null;o.document.execCommand("InsertImage",!1,"#");var a,s,l=r.parentElement();return"IMG"!==l.nodeName.toUpperCase()&&(r.pasteHTML('<span id="wrs_openEditorWindow_temporalObject"></span>'),l=o.document.getElementById("wrs_openEditorWindow_temporalObject")),l.nextSibling&&3===l.nextSibling.nodeType?(a=l.nextSibling,s=0):l.previousSibling&&3===l.previousSibling.nodeType?s=(a=l.previousSibling).nodeValue.length:(a=o.document.createTextNode(""),l.parentNode.insertBefore(a,l),s=0),l.parentNode.removeChild(l),{node:a,caretPosition:s}}return r.length>1?null:{node:r.item(0)}}if(o.getSelection){var c,u=o.getSelection();try{c=u.getRangeAt(0)}catch(e){c=o.document.createRange()}var d=c.startContainer;if(3===d.nodeType)return{node:d,caretPosition:c.startOffset};if(d!==c.endContainer)return null;if(1===d.nodeType){var h=c.startOffset;if(d.childNodes[h])return{node:d.childNodes[h]}}}return null}},{key:"getSelectedItemOnTextarea",value:function(e){var t=document.createTextNode(e.value),n=p.getLatexFromTextNode(t,e.selectionStart);return null===n?null:{node:t,caretPosition:e.selectionStart,startPosition:n.startPosition,endPosition:n.endPosition}}},{key:"getElementsByNameFromString",value:function(e,t,n){var i=[];e=e.toLowerCase(),t=t.toLowerCase();for(var o=e.indexOf("<".concat(t," "));-1!==o;){var r=void 0;r=n?">":"</".concat(t,">");var a=e.indexOf(r,o);-1!==a?(a+=r.length,i.push({start:o,end:a})):a=o+1,o=e.indexOf("<".concat(t," "),a)}return i}},{key:"decode64",value:function(e){var t="+".charCodeAt(0),n="/".charCodeAt(0),i="0".charCodeAt(0),o="a".charCodeAt(0),r="A".charCodeAt(0),a="-".charCodeAt(0),s="_".charCodeAt(0),l=e.charCodeAt(0);return l===t||l===a?62:l===n||l===s?63:l<i?-1:l<i+10?l-i+26+26:l<r+26?l-r:l<o+26?l-o+26:null}},{key:"b64ToByteArray",value:function(t,n){var i;if(t.length%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var o,r,a,s=[];for(o=n||((r="="===t.charAt(t.length-2)?2:"="===t.charAt(t.length-1)?1:0)>0?t.length-4:t.length),a=0;a<o;a+=4)i=e.decode64(t.charAt(a))<<18|e.decode64(t.charAt(a+1))<<12|e.decode64(t.charAt(a+2))<<6|e.decode64(t.charAt(a+3)),s.push(i>>16&255),s.push(i>>8&255),s.push(255&i);return r&&(2===r?(i=e.decode64(t.charAt(a))<<2|e.decode64(t.charAt(a+1))>>4,s.push(255&i)):1===r&&(i=e.decode64(t.charAt(a))<<10|e.decode64(t.charAt(a+1))<<4|e.decode64(t.charAt(a+2))>>2,s.push(i>>8&255),s.push(255&i))),s}},{key:"readInt32",value:function(e){if(e.length<4)return!1;var t=e.splice(0,4);return t[0]<<24|t[1]<<16|t[2]<<8|t[3]<<0}},{key:"readByte",value:function(e){return e.shift()<<0}},{key:"readBytes",value:function(e,t,n){return e.splice(t,n)}},{key:"updateTextArea",value:function(e,t){if(e&&t)if(e.focus(),null!=e.selectionStart){var n=e.selectionEnd,i=e.value.substring(0,e.selectionStart),o=e.value.substring(n,e.value.length);e.value=i+t+o,e.selectionEnd=n+t.length}else{document.selection.createRange().text=t}}},{key:"updateExistingTextOnTextarea",value:function(e,t,n,i){e.focus();var o=e.value.substring(0,n);e.value=o+t+e.value.substring(i,e.value.length),e.selectionEnd=n+t.length}},{key:"addArgument",value:function(e,t,n){var i;return i=e.indexOf("?")>0?"&":"?","".concat(e+i+t,"=").concat(n)}}]),e}();function x(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var A=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return function(e,t,n){t&&x(e.prototype,t),n&&x(e,n)}(e,null,[{key:"removeImgDataAttributes",value:function(e){var t=[],n=e.attributes;Object.keys(n).forEach(function(e){var i=n[e];0===i.name.indexOf("data-")&&t.push(i.name)}),t.forEach(function(t){e.removeAttribute(t)})}},{key:"clone",value:function(e,t){var n=l.get("imageCustomEditorName");e.hasAttribute(n)||t.removeAttribute(n),[l.get("imageMathmlAttribute"),n,"alt","height","width","style","src","role"].forEach(function(n){var i=e.getAttribute(n);i&&t.setAttribute(n,i)})}},{key:"setImgSize",value:function(t,n,i){var o,r,a,s;if(i)if("svg"===l.get("imageFormat"))if("base64"!==l.get("saveMode"))o=e.getMetricsFromSvgString(n);else{r=t.src.substr(t.src.indexOf("base64,")+7,t.src.length),s="",a=y.b64ToByteArray(r,r.length);for(var c=0;c<a.length;c+=1)s+=String.fromCharCode(a[c]);o=e.getMetricsFromSvgString(s)}else r=t.src.substr(t.src.indexOf("base64,")+7,t.src.length),a=y.b64ToByteArray(r,88),o=e.getMetricsFromBytes(a);else o=y.urlToAssArray(n);var u=o.cw;if(u){var d=o.ch,h=o.cb,m=o.dpi;m&&(u=96*u/m,d=96*d/m,h=96*h/m),t.width=u,t.height=d,t.style.verticalAlign="-".concat(d-h,"px")}}},{key:"fixAfterResize",value:function(t){if(t.removeAttribute("style"),t.removeAttribute("width"),t.removeAttribute("height"),t.style.maxWidth="none",-1!==t.src.indexOf("data:image"))if("svg"===l.get("imageFormat")){var n=decodeURIComponent(t.src.substring(32,t.src.length));e.setImgSize(t,n,!0)}else{var i=t.src.substring(22,t.src.length);e.setImgSize(t,i,!0)}else e.setImgSize(t,t.src)}},{key:"getMetricsFromSvgString",value:function(e){var t=e.indexOf('height="'),n=e.indexOf('"',t+8,e.length),i=e.substring(t+8,n);t=e.indexOf('width="'),n=e.indexOf('"',t+7,e.length);var o=e.substring(t+7,n);t=e.indexOf('wrs:baseline="'),n=e.indexOf('"',t+14,e.length);var r=e.substring(t+14,n);if(void 0!==o){var a=[];return a.cw=o,a.ch=i,void 0!==r&&(a.cb=r),a}return[]}},{key:"getMetricsFromBytes",value:function(e){var t,n,i,o,r;for(y.readBytes(e,0,8);e.length>=4;)1229472850===(i=y.readInt32(e))?(t=y.readInt32(e),n=y.readInt32(e),y.readInt32(e),y.readByte(e)):1650545477===i?o=y.readInt32(e):1883789683===i&&(r=y.readInt32(e),r=Math.round(r/39.37),y.readInt32(e),y.readByte(e)),y.readInt32(e);if(void 0!==t){var a=[];return a.cw=t,a.ch=n,a.dpi=r,o&&(a.cb=o),a}return[]}}]),e}();function C(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var k=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return function(e,t,n){t&&C(e.prototype,t),n&&C(e,n)}(e,null,[{key:"mathMLToAccessible",value:function(t,n,i){void 0===n&&(n="en"),a.containClass(t,"wrs_chemistry")&&(i.mode="chemistry");var o="";if(e.cache.get(t))o=e.cache.get(t);else{i.service="mathml2accessible",i.lang=n;var r=JSON.parse(g.getService("service",i));"error"!==r.status?(o=r.result.text,e.cache.populate(t,o)):o=w.get("error_convert_accessibility")}return o}},{key:"cache",get:function(){return e._cache},set:function(t){e._cache=t}}]),e}();k._cache=new u;n(1);function M(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var E=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return function(e,t,n){t&&M(e.prototype,t),n&&M(e,n)}(e,null,[{key:"mathmlToImgObject",value:function(t,n,i,o){var r=t.createElement("img");r.align="middle",r.style.maxWidth="none";var s=i||{};if(s.mml=n,s.lang=o,s.metrics="true",s.centerbaseline="false","base64"===l.get("saveMode")&&"default"===l.get("base64savemode")&&(s.base64=!0),r.className=l.get("imageClassName"),-1!==n.indexOf('class="')){var c=n.substring(n.indexOf('class="')+'class="'.length,n.length);c=(c=c.substring(0,c.indexOf('"'))).substring(4,c.length),r.setAttribute(l.get("imageCustomEditorName"),c)}if(!l.get("wirisPluginPerformance")||"xml"!==l.get("saveMode")&&"safeXml"!==l.get("saveMode")){var u=e.createImageSrc(n,s);r.setAttribute(l.get("imageMathmlAttribute"),a.safeXmlEncode(n)),r.src=u,A.setImgSize(r,u,"base64"===l.get("saveMode")&&"default"===l.get("base64savemode")),l.get("enableAccessibility")&&(r.alt=k.mathMLToAccessible(n,o,s))}else{var d=JSON.parse(e.createShowImageSrc(s,o));if("warning"===d.status)try{d=JSON.parse(g.getService("showimage",s))}catch(e){return null}"png"===(d=d.result).format?r.src="data:image/png;base64,".concat(d.content):r.src="data:image/svg+xml;charset=utf8,".concat(y.urlEncode(d.content)),r.setAttribute(l.get("imageMathmlAttribute"),a.safeXmlEncode(n)),A.setImgSize(r,d.content,!0),l.get("enableAccessibility")&&(void 0===d.alt?r.alt=k.mathMLToAccessible(n,o,s):r.alt=d.alt)}return void 0!==e.observer&&e.observer.observe(r),r.setAttribute("role","math"),r}},{key:"createImageSrc",value:function(e,t){"base64"===l.get("saveMode")&&"default"===l.get("base64savemode")&&(t.base64=!0);var n=g.getService("createimage",t);if(-1!==n.indexOf("@BASE@")){var i=g.getServicePath("createimage").split("/");i.pop(),n=n.split("@BASE@").join(i.join("/"))}return n}},{key:"initParse",value:function(t,n){return t=e.initParseSaveMode(t,n),e.initParseEditMode(t)}},{key:"initParseSaveMode",value:function(t,n){return l.get("saveMode")&&(t=p.parseMathmlToLatex(t,o.safeXmlCharacters),t=p.parseMathmlToLatex(t,o.xmlCharacters),t=e.parseMathmlToImg(t,o.safeXmlCharacters,n),t=e.parseMathmlToImg(t,o.xmlCharacters,n),"base64"===l.get("saveMode")&&"image"===l.get("base64savemode")&&(t=e.codeImgTransform(t,"base642showimage"))),t}},{key:"initParseEditMode",value:function(e){if(-1!==l.get("parseModes").indexOf("latex"))for(var t=y.getElementsByNameFromString(e,"img",!0),n='encoding="LaTeX">',i=0,o=0;o<t.length;o+=1){var r=e.substring(t[o].start+i,t[o].end+i);if(-1!==r.indexOf(' class="'.concat(l.get("imageClassName"),'"'))){var s=" ".concat(l.get("imageMathmlAttribute"),'="'),c=r.indexOf(s);if(-1===c&&(s=' alt="',c=r.indexOf(s)),-1!==c){c+=s.length;var u=r.indexOf('"',c),d=a.safeXmlDecode(r.substring(c,u)),h=d.indexOf(n);if(-1!==h){h+=n.length;var m=d.indexOf("</annotation>",h),g=d.substring(h,m),f="$$".concat(y.htmlEntitiesDecode(g),"$$");e=e.substring(0,t[o].start+i)+f+e.substring(t[o].end+i),i+=f.length-(t[o].end-t[o].start)}}}}return e}},{key:"endParse",value:function(t){var n=e.endParseEditMode(t);return e.endParseSaveMode(n)}},{key:"endParseEditMode",value:function(e){if(-1!==l.get("parseModes").indexOf("latex")){for(var t="",n=0,i=e.indexOf("$$");-1!==i;){if(t+=e.substring(n,i),-1!==(n=e.indexOf("$$",i+2))){var o=e.substring(i+2,n),r=y.htmlEntitiesDecode(o),s=p.getMathMLFromLatex(r,!0);l.get("saveHandTraces")||(s=a.removeAnnotation(s,"application/json")),t+=s,n+=2}else t+="$$",n=i+2;i=e.indexOf("$$",n)}e=t+=e.substring(n,e.length)}return e}},{key:"endParseSaveMode",value:function(t){return l.get("saveMode")&&("safeXml"===l.get("saveMode")?t=e.codeImgTransform(t,"img2mathml"):"xml"===l.get("saveMode")?t=e.codeImgTransform(t,"img2mathml"):"base64"===l.get("saveMode")&&"image"===l.get("base64savemode")&&(t=e.codeImgTransform(t,"img264"))),t}},{key:"createShowImageSrc",value:function(e,t){var n=[],i=["mml","color","centerbaseline","zoom","dpi","fontSize","fontFamily","defaultStretchy","backgroundColor","format"];i.forEach(function(t){var o=i[t];void 0!==e[o]&&(n[o]=e[o])});var o={};return Object.keys(e).forEach(function(t){"mml"!==t&&(o[t]=e[t])}),o.formula=com.wiris.js.JsPluginTools.md5encode(y.propertiesToString(n)),o.lang=void 0===t?"en":t,o.version=l.get("version"),g.getService("showimage",y.httpBuildQuery(o),!0)}},{key:"codeImgTransform",value:function(t,n){for(var i="",o=0,r=/<img/gi,s=r.source.length;r.test(t);){var c=r.lastIndex-s;i+=t.substring(o,c);for(var u=c+1;u<t.length&&o<=c;){var d=t.charAt(u);if('"'===d||"'"===d){var h=t.indexOf(d,u+1);u=-1===h?t.length:h}else">"===d&&(o=u+1);u+=1}if(o<c)return i+=t.substring(c,t.length);var m=t.substring(c,o),g=y.createObject(m),f=g.getAttribute(l.get("imageMathmlAttribute")),p=void 0,v=void 0;if("base642showimage"===n)null==f&&(f=g.getAttribute("alt")),f=a.safeXmlDecode(f),m=e.mathmlToImgObject(document,f,null,null),i+=y.createObjectCode(m);else if("img2mathml"===n)l.get("saveMode")&&("safeXml"===l.get("saveMode")?(p=!0,v=!0):"xml"===l.get("saveMode")&&(p=!0,v=!1)),i+=y.getWIRISImageOutput(m,p,v);else if("img264"===n){null===f&&(f=g.getAttribute("alt")),f=a.safeXmlDecode(f);var _={base64:"true"};m=e.mathmlToImgObject(document,f,_,null),A.setImgSize(m,m.src,!0),i+=y.createObjectCode(m)}}return i+=t.substring(o,t.length)}},{key:"parseMathmlToImg",value:function(t,n,i){for(var r="",s="".concat(n.tagOpener,"math"),c="".concat(n.tagOpener,"/math").concat(n.tagCloser),u=t.indexOf(s),d=0;-1!==u;){r+=t.substring(d,u);var h=t.indexOf(l.get("imageMathmlAttribute"));if(-1===(d=t.indexOf(c,u))?d=t.length-1:d+=-1!==h?t.indexOf("/>",u):c.length,a.isMathmlInAttribute(t,u)||-1!==h)r+=t.substring(u,d);else{var m=t.substring(u,d);m=n.id===o.safeXmlCharacters.id?a.safeXmlDecode(m):a.mathMLEntities(m),r+=y.createObjectCode(e.mathmlToImgObject(document,m,null,i))}u=t.indexOf(s,d)}return r+=t.substring(d,t.length)}}]),e}();if("undefined"!=typeof MutationObserver){var T=new MutationObserver(function(e){e.forEach(function(e){e.oldValue===l.get("imageClassName")&&"class"===e.attributeName&&-1===e.target.className.indexOf(l.get("imageClassName"))&&(e.target.className=l.get("imageClassName"))})});E.observer=Object.create(T),E.observer.Config={attributes:!0,attributeOldValue:!0},E.observer.observe=function(e){Object.getPrototypeOf(this).observe(e,this.Config)}}function I(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var O=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.isContentChanged=!1,this.waitingForChanges=!1}return function(e,t,n){t&&I(e.prototype,t),n&&I(e,n)}(e,[{key:"setIsContentChanged",value:function(e){this.isContentChanged=e}},{key:"getIsContentChanged",value:function(){return this.isContentChanged}},{key:"setWaitingForChanges",value:function(e){this.waitingForChanges=e}},{key:"caretPositionChanged",value:function(e){}},{key:"clipboardChanged",value:function(e){}},{key:"contentChanged",value:function(e){!0===this.waitingForChanges&&!1===this.isContentChanged&&(this.isContentChanged=!0)}},{key:"styleChanged",value:function(e){}},{key:"transformationReceived",value:function(e){}}]),e}();function j(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var P=function(){function e(t){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.editorAttributes={},!("editorAttributes"in t))throw new Error("ContentManager constructor error: editorAttributes property missed.");if(this.editorAttributes=t.editorAttributes,this.customEditors=null,"customEditors"in t&&(this.customEditors=t.customEditors),this.environment={},!("environment"in t))throw new Error("ContentManager constructor error: environment property missed");if(this.environment=t.environment,this.language="",!("language"in t))throw new Error("ContentManager constructor error: language property missed");this.language=t.language,this.editorListener=new O,this.editor=null,this.ua=navigator.userAgent.toLowerCase(),this.deviceProperties={},this.deviceProperties.isAndroid=this.ua.indexOf("android")>-1,this.deviceProperties.isIOS=this.ua.indexOf("ipad")>-1||this.ua.indexOf("iphone")>-1,this.toolbar=null,this.modalDialogInstance=null,this.listeners=new h,this.mathML=null,this.isNewElement=!0,this.integrationModel=null}return function(e,t,n){t&&j(e.prototype,t),n&&j(e,n)}(e,[{key:"addListener",value:function(e){this.listeners.add(e)}},{key:"setIntegrationModel",value:function(e){this.integrationModel=e}},{key:"setModalDialogInstance",value:function(e){this.modalDialogInstance=e}},{key:"insert",value:function(){this.updateTitle(this.modalDialogInstance),this.insertEditor(this.modalDialogInstance)}},{key:"insertEditor",value:function(){if(e.isEditorLoaded()){if(this.editor=window.com.wiris.jsEditor.JsEditor.newInstance(this.editorAttributes),this.editor.insertInto(this.modalDialogInstance.contentContainer),this.editor.focus(),this.modalDialogInstance.rtl&&this.editor.action("rtl"),this.editor.getEditorModel().isRTL()&&(this.editor.element.style.direction="rtl"),this.editor.getEditorModel().addEditorListener(this.editorListener),this.modalDialogInstance.deviceProperties.isIOS){setTimeout(function(){this.modalDialogInstance.hideKeyboard()},400);var t=document.getElementsByClassName("wrs_formulaDisplay")[0];y.addEvent(t,"focus",this.modalDialogInstance.handleOpenedIosSoftkeyboard),y.addEvent(t,"blur",this.modalDialogInstance.handleClosedIosSoftkeyboard)}this.listeners.fire("onLoad",{})}else setTimeout(e.prototype.insertEditor.bind(this),100)}},{key:"init",value:function(){e.isEditorLoaded()||this.addEditorAsExternalDependency()}},{key:"addEditorAsExternalDependency",value:function(){var t=document.createElement("script");t.type="text/javascript";var n=l.get("editorUrl"),i=document.createElement("a");e.setHrefToAnchorElement(i,n),e.setProtocolToAnchorElement(i),n=e.getURLFromAnchorElement(i);var o=this.getEditorStats();t.src="".concat(n,"?lang=").concat(this.language,"&stats-editor=").concat(o.editor,"&stats-mode=").concat(o.mode,"&stats-version=").concat(o.version),document.getElementsByTagName("head")[0].appendChild(t)}},{key:"getEditorStats",value:function(){var e={};return"editor"in this.environment?e.editor=this.environment.editor:e.editor="unknown","mode"in this.environment?e.mode=this.environment.mode:e.mode=l.get("saveMode"),"version"in this.environment?e.version=this.environment.version:e.version=l.get("version"),e}},{key:"setInitialContent",value:function(){this.isNewElement||this.setMathML(this.mathML)}},{key:"setMathML",value:function(e,t){var n=this;void 0===t&&(t=!1),this.editor.setMathMLWithCallback(e,function(){n.editorListener.setWaitingForChanges(!0)}),setTimeout(function(){n.editorListener.setIsContentChanged(!1)},500),t||this.onFocus()}},{key:"onFocus",value:function(){void 0!==this.editor&&null!=this.editor&&this.editor.focus()}},{key:"submitAction",value:function(){if(this.editor.isFormulaEmpty())this.integrationModel.updateFormula(null);else{var e=this.editor.getMathMLWithSemantics();if(null!==this.customEditors.getActiveEditor()){var t=this.customEditors.getActiveEditor().toolbar;e=a.addCustomEditorClassAttribute(e,t)}else Object.keys(this.customEditors.editors).forEach(function(t){e=a.removeCustomEditorClassAttribute(e,t)});var n=a.mathMLEntities(e);this.integrationModel.updateFormula(n)}this.customEditors.disable(),this.integrationModel.notifyWindowClosed(),this.setEmptyMathML(),this.customEditors.disable()}},{key:"setEmptyMathML",value:function(){this.deviceProperties.isAndroid||this.deviceProperties.isIOS?this.editor.getEditorModel().isRTL()?this.setMathML('<math dir="rtl"><semantics><annotation encoding="application/json">[]</annotation></semantics></math>',!0):this.setMathML('<math><semantics><annotation encoding="application/json">[]</annotation></semantics></math>',!0):this.editor.getEditorModel().isRTL()?this.setMathML('<math dir="rtl"/>',!0):this.setMathML("<math/>",!0)}},{key:"onOpen",value:function(){this.isNewElement?this.setEmptyMathML():this.setMathML(this.mathML),this.updateToolbar(),this.onFocus()}},{key:"updateToolbar",value:function(){this.updateTitle(this.modalDialogInstance);var e=this.customEditors.getActiveEditor();if(e){var t=e.toolbar?e.toolbar:_wrs_int_wirisProperties.toolbar;null!=this.toolbar&&this.toolbar===t||this.setToolbar(t)}else{var n=this.getToolbar();null!=this.toolbar&&this.toolbar===n||(this.setToolbar(n),this.customEditors.disable())}}},{key:"updateTitle",value:function(){var e=this.customEditors.getActiveEditor();e?this.modalDialogInstance.setTitle(e.title):this.modalDialogInstance.setTitle("MathType")}},{key:"getToolbar",value:function(){var e="general";return"toolbar"in this.editorAttributes&&(e=this.editorAttributes.toolbar),"general"===e&&(e="undefined"==typeof _wrs_int_wirisProperties||void 0===_wrs_int_wirisProperties.toolbar?"general":_wrs_int_wirisProperties.toolbar),e}},{key:"setToolbar",value:function(e){this.toolbar=e,this.editor.setParams({toolbar:this.toolbar})}},{key:"hasChanges",value:function(){return!this.editor.isFormulaEmpty()&&this.editorListener.getIsContentChanged()}},{key:"onKeyDown",value:function(e){if(void 0!==e.key&&!1===e.repeat)if("Escape"===e.key||"Esc"===e.key){var t=document.getElementsByClassName("wrs_expandButton wrs_expandButtonFor3RowsLayout wrs_pressed");0===t.length&&0===(t=document.getElementsByClassName("wrs_expandButton wrs_expandButtonFor2RowsLayout wrs_pressed")).length&&0===(t=document.getElementsByClassName("wrs_select wrs_pressed")).length&&(this.modalDialogInstance.cancelAction(),e.stopPropagation(),e.preventDefault())}else if(e.shiftKey&&"Tab"===e.key)if(document.activeElement===this.modalDialogInstance.submitButton)this.editor.focus(),e.stopPropagation(),e.preventDefault();else{var n=document.querySelector('[title="Manual"]');document.activeElement===n&&(this.modalDialogInstance.cancelButton.focus(),e.stopPropagation(),e.preventDefault())}else if("Tab"===e.key){if(document.activeElement===this.modalDialogInstance.cancelButton)document.querySelector('[title="Manual"]').focus(),e.stopPropagation(),e.preventDefault();else"wrs_formulaDisplay wrs_focused"===document.getElementsByClassName("wrs_formulaDisplay")[0].getAttribute("class")&&(this.modalDialogInstance.submitButton.focus(),e.stopPropagation(),e.preventDefault())}}}],[{key:"setHrefToAnchorElement",value:function(e,t){e.href=t}},{key:"setProtocolToAnchorElement",value:function(e){0===window.location.href.indexOf("https://")&&"http:"===e.protocol&&(e.protocol="https:")}},{key:"getURLFromAnchorElement",value:function(e){if("80"===e.port||"443"===e.port||""===e.port)return"".concat(e.protocol,"//").concat(e.hostname,"/").concat(e.pathname)}},{key:"isEditorLoaded",value:function(){return window.com&&window.com.wiris&&window.com.wiris.jsEditor&&window.com.wiris.jsEditor.JsEditor&&window.com.wiris.jsEditor.JsEditor.newInstance}}]),e}();function L(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var S=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.editors=[],this.activeEditor="default"}return function(e,t,n){t&&L(e.prototype,t),n&&L(e,n)}(e,[{key:"addEditor",value:function(e,t){var n={};n.name=t.name,n.toolbar=t.toolbar,n.icon=t.icon,n.confVariable=t.confVariable,n.title=t.title,n.tooltip=t.tooltip,this.editors[e]=n}},{key:"enable",value:function(e){this.activeEditor=e}},{key:"disable",value:function(){this.activeEditor="default"}},{key:"getActiveEditor",value:function(){return"default"!==this.activeEditor?this.editors[this.activeEditor]:null}}]),e}(),z={imageCustomEditorName:"data-custom-editor",imageClassName:"Wirisformula",CASClassName:"Wiriscas"};function B(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var D=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.cancelled=!1,this.defaultPrevented=!1}return function(e,t,n){t&&B(e.prototype,t),n&&B(e,n)}(e,[{key:"cancel",value:function(){this.cancelled=!0}},{key:"preventDefault",value:function(){this.defaultPrevented=!0}}]),e}();function F(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var N=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.overlayElement=t.overlayElement,this.callbacks=t.callbacks,this.overlayWrapper=this.overlayElement.appendChild(document.createElement("div")),this.overlayWrapper.setAttribute("class","wrs_popupmessage_overlay_envolture"),this.message=this.overlayWrapper.appendChild(document.createElement("div")),this.message.id="wrs_popupmessage",this.message.setAttribute("class","wrs_popupmessage_panel"),this.message.setAttribute("role","dialog"),this.message.setAttribute("aria-describedby","description_txt");var n=document.createElement("p"),i=document.createTextNode(t.strings.message);n.appendChild(i),n.id="description_txt",this.message.appendChild(n);var o=this.overlayWrapper.appendChild(document.createElement("div"));o.setAttribute("class","wrs_popupmessage_overlay"),o.addEventListener("click",this.cancelAction.bind(this)),this.buttonArea=this.message.appendChild(document.createElement("div")),this.buttonArea.setAttribute("class","wrs_popupmessage_button_area"),this.buttonArea.id="wrs_popup_button_area";var r={class:"wrs_button_accept",innerHTML:t.strings.submitString,id:"wrs_popup_accept_button"};this.closeButton=this.createButton(r,this.closeAction.bind(this)),this.buttonArea.appendChild(this.closeButton);var a={class:"wrs_button_cancel",innerHTML:t.strings.cancelString,id:"wrs_popup_cancel_button"};this.cancelButton=this.createButton(a,this.cancelAction.bind(this)),this.buttonArea.appendChild(this.cancelButton)}return function(e,t,n){t&&F(e.prototype,t),n&&F(e,n)}(e,[{key:"createButton",value:function(e,t){var n={};return(n=document.createElement("button")).setAttribute("id",e.id),n.setAttribute("class",e.class),n.innerHTML=e.innerHTML,n.addEventListener("click",t),n}},{key:"show",value:function(){"block"!==this.overlayWrapper.style.display?(document.activeElement.blur(),this.overlayWrapper.style.display="block",this.closeButton.focus()):(this.overlayWrapper.style.display="none",_wrs_modalWindow.focus())}},{key:"cancelAction",value:function(){this.overlayWrapper.style.display="none",void 0!==this.callbacks.cancelCallback&&this.callbacks.cancelCallback()}},{key:"closeAction",value:function(){this.cancelAction(),void 0!==this.callbacks.closeCallback&&this.callbacks.closeCallback()}},{key:"onKeyDown",value:function(e){void 0!==e.key&&("Escape"===e.key||"Esc"===e.key?(this.cancelAction(),e.stopPropagation(),e.preventDefault()):"Tab"===e.key&&(document.activeElement===this.closeButton?this.cancelButton.focus():this.closeButton.focus(),e.stopPropagation(),e.preventDefault()))}}]),e}(),R='<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n<svg\n   xmlns:dc="http://purl.org/dc/elements/1.1/"\n   xmlns:cc="http://creativecommons.org/ns#"\n   xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"\n   xmlns:svg="http://www.w3.org/2000/svg"\n   xmlns="http://www.w3.org/2000/svg"\n   xmlns:xlink="http://www.w3.org/1999/xlink"\n   viewBox="0 0 13.76 13.76"\n   height="13.76"\n   width="13.76"\n   id="svg3783"\n   version="1.1">\n  <metadata\n     id="metadata3789">\n    <rdf:RDF>\n      <cc:Work\n         rdf:about="">\n        <dc:format>image/svg+xml</dc:format>\n        <dc:type\n           rdf:resource="http://purl.org/dc/dcmitype/StillImage" />\n        <dc:title></dc:title>\n      </cc:Work>\n    </rdf:RDF>\n  </metadata>\n  <defs\n     id="defs3787" />\n  <image\n     y="0"\n     x="0"\n     id="image3791"\n     xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACsAAAArCAYAAADhXXHAAAAACXBIWXMAAC4jAAAuIwF4pT92AAAB\nvklEQVRYw83Z23GDMBAF0AsNhBIowSVQgjuISnAJKSEdZNOBS6CDOBUkqSC4gs2PyGhAQg92se4M\n4w8bccYW2hVumBmRdAB6ADfopQcw2SOYNoIkAL8APgB8AzgLI0/2S/iy1xkt3B9m9h0dM9/YHxM4\nJ/c4MfPkGX+y763OyYVKgUPQTXAJdC84Bg2CS6Gl4FSoF7wHmgvOhbrgzsW+8L4YJegccrEj749R\ngs7ZXGdz8wbAeNbREcDTzrHvblEgBbAUFACuy6JALJeL0E/P9sbvmBnNojcgAM+oJ58AhrlnWM5Z\nA+C9RmiokakBvIJuNTLSc7hojqY0Mo8EB6Ep2CPBm9BU7BHgKDQHqwlOguZiNcDJ0JLe4FV4iaLY\nJjF16dLqnoob+EdDs8A1QJPBtUCTwDVBo+DaoJvgNvBIR6rDl9wirbA1QIPgVgl6VwHb+dAr7Jkk\nS/Pg3mCkVOslxxV9yBFqSqTA/3N2Utkzye3pftw5OxzQ5tHeddcdzGj3o4VgClUwowgtAVOs3BpF\naA6YUnsDowhNAVNu12UUoVtgCn2+ifxp1wO42Ner4KPR5dJ2tsse2ZLvTQxbVf4AmC2z7WnSvpIA\nAAAASUVORK5CYII=\n"\n     style="image-rendering:optimizeQuality"\n     preserveAspectRatio="none"\n     height="13.76"\n     width="13.76" />\n</svg>\n',H='<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n<svg\n   xmlns:dc="http://purl.org/dc/elements/1.1/"\n   xmlns:cc="http://creativecommons.org/ns#"\n   xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"\n   xmlns:svg="http://www.w3.org/2000/svg"\n   xmlns="http://www.w3.org/2000/svg"\n   xmlns:xlink="http://www.w3.org/1999/xlink"\n   viewBox="0 0 13.76 13.76"\n   height="13.76"\n   width="13.76"\n   id="svg2"\n   version="1.1">\n  <metadata\n     id="metadata8">\n    <rdf:RDF>\n      <cc:Work\n         rdf:about="">\n        <dc:format>image/svg+xml</dc:format>\n        <dc:type\n           rdf:resource="http://purl.org/dc/dcmitype/StillImage" />\n        <dc:title></dc:title>\n      </cc:Work>\n    </rdf:RDF>\n  </metadata>\n  <defs\n     id="defs6" />\n  <image\n     y="0"\n     x="0"\n     id="image10"\n     xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACsAAAArCAYAAADhXXHAAAAACXBIWXMAAC4jAAAuIwF4pT92AAAB\n2ElEQVRYw9XZoXPCMBTH8S+5KfDzQ29606CH3/SmQTO96aGHHn/F0Himh8eDZSblQknSJH2F0DtE\nQw8+12vyfulr7XY7LuW4qvj+DugD18AC+AE2woa+/mz07y9cF7Y8d7YPDEtjK2AsCB4BvdLYHPi0\nXawioAA3wAfQaQiKHhuFYl1QSbAL6gWrSKgEuArqBKsEaB1wKNQKVsasHybcpRhwLNQED0zsoMbz\nFwJOhWL6Cmzd2e0D14Wi1/k9di2wFNnAEtBifd9jv4GtIPgaeBOCAkzLFayr/6idWSSY6DJ8sHT9\n6VK6zRFqKwo5gQ+grnKbA/gI6gsy5wRboT7sucBOaBX21GAvNAR7KnAlNBTbNDgIGoMtwO/C0Gko\nNBZbN525tk+dJrAj4F4YGxXgVQS019DkCgarM0OjwCoDaDBYZQINAquMoJVglRnUC1YZQp1g1RB0\nJryn65jYJ0HoRGPHguDX8hsZ6VAiGX4eUrJBbHqSArdN7LLBmCcBnpvYWfHWo6E8Wge8Ar7Kj8E4\nARwcnBPBB20BE7uJBMdAU8BH/YvyBAsFp0BjwNZGi201qALXgYaAnR0hX2upAzwDj/p8raFL5I4u\n8ALc6vNfvc+ztq5al9Rh/AfwZZ/LmlMllAAAAABJRU5ErkJggg==\n"\n     style="image-rendering:optimizeQuality"\n     preserveAspectRatio="none"\n     height="13.76"\n     width="13.76" />\n</svg>\n',X='<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n<svg\n   xmlns:dc="http://purl.org/dc/elements/1.1/"\n   xmlns:cc="http://creativecommons.org/ns#"\n   xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"\n   xmlns:svg="http://www.w3.org/2000/svg"\n   xmlns="http://www.w3.org/2000/svg"\n   xmlns:xlink="http://www.w3.org/1999/xlink"\n   viewBox="0 0 13.76 13.76"\n   height="13.76"\n   width="13.76"\n   id="svg3793"\n   version="1.1">\n  <metadata\n     id="metadata3799">\n    <rdf:RDF>\n      <cc:Work\n         rdf:about="">\n        <dc:format>image/svg+xml</dc:format>\n        <dc:type\n           rdf:resource="http://purl.org/dc/dcmitype/StillImage" />\n        <dc:title></dc:title>\n      </cc:Work>\n    </rdf:RDF>\n  </metadata>\n  <defs\n     id="defs3797" />\n  <image\n     y="0"\n     x="0"\n     id="image3801"\n     xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACsAAAArCAYAAADhXXHAAAAAAXNSR0IArs4c6QAAAARnQU1BAACx\njwv8YQUAAAAJcEhZcwAALiMAAC4jAXilP3YAAAG4SURBVFhHvZnhUYNAEEbRBkwH2oGUkA40FWgJ\nKSEdaAmxA0vQDmIHKSFWgPuAHZkEAnd8y5v5kuNHMm+WY1mSm6qqCiGlZdUspXzxopY9Wu6bpZQf\nSxlRWapwVx9p2dy2CxUHy9ryWx9pKdWyECYcIQshwlGyIBeOlAWpcLQsyISXkAWEX5tlPkvJwnP7\nns1SsnvLS7PMZwlZiShEy8pEIVJWKgpRsnJRiJBNFf2wbCzjfZgRUZi9JYWDxT9bWk6WIXbKym4t\nKRVloObO5oze6ZClWX9a5jyOcOrfmuUkXPRUH/1zVRhZpvsnCxN+jnDqHh0SdQaFu9vg0ZIqrBZ1\neoXP92yKcJSocyHcd4FNEY4WdbrCR1rGrukMF9BWVhZvLZ7U9rS2nH9HVvoq63iFu+RUlOpIuCYL\nCCPIqVjq1A9j5R3aBnMY2kKzMlbZHPQVbVHLhomCUjZUFFSy35ZQUVDIMo+Gi4JCltFwERSy75Y5\n4+VkFLLcKHLHyyRUF1jOeJmMShbChZWy0Df8yFDLgg8/cpCN6I9cdHJhZHmy7X2anAnCtDUZ/j/Y\ng2X2j709MHhTDAFF8QdK9SRpUl2yFgAAAABJRU5ErkJggg==\n"\n     style="image-rendering:optimizeQuality"\n     preserveAspectRatio="none"\n     height="13.76"\n     width="13.76" />\n</svg>\n',U='<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n<svg\n   xmlns:dc="http://purl.org/dc/elements/1.1/"\n   xmlns:cc="http://creativecommons.org/ns#"\n   xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"\n   xmlns:svg="http://www.w3.org/2000/svg"\n   xmlns="http://www.w3.org/2000/svg"\n   xmlns:xlink="http://www.w3.org/1999/xlink"\n   viewBox="0 0 13.76 13.76"\n   height="13.76"\n   width="13.76"\n   id="svg12"\n   version="1.1">\n  <metadata\n     id="metadata18">\n    <rdf:RDF>\n      <cc:Work\n         rdf:about="">\n        <dc:format>image/svg+xml</dc:format>\n        <dc:type\n           rdf:resource="http://purl.org/dc/dcmitype/StillImage" />\n        <dc:title></dc:title>\n      </cc:Work>\n    </rdf:RDF>\n  </metadata>\n  <defs\n     id="defs16" />\n  <image\n     y="0"\n     x="0"\n     id="image20"\n     xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACsAAAArCAYAAADhXXHAAAAAAXNSR0IArs4c6QAAAARnQU1BAACx\njwv8YQUAAAAJcEhZcwAALiMAAC4jAXilP3YAAAGMSURBVFhHvdk7TsNAFIVhQ0l6elLDJqCGngXQ\nU7MA6rALahZATQ81C6APrXP/jEaKHD/i8TnzS1eaICF/2I4f4qxt20bYOmaVlrK2Mb8s1Nj3mIu0\nlPYZszlPa1kvMf9pKe02Zq3Gcrhc4JUaSzawA0sWsAtLcrATS1KwG0sycA0sAd6kZXm1sNzVHtOy\nvBpYoK8xV/tPC3JjZVByYqVQcmHlUHJgLVBSY0ugPP7xO5PXYSW2FMr19ytm8sahxD7ElEBzk3c6\nsFysn/afymKPvsXMueh3oblRMNibmPuYZ34wsyWHfqhB8OFpwKvDHLADmusFd8/ZU8FOaO4I3PcF\nmwLXgOYOwVtexdnwdUy3vg2UQPnD2eji+vZsrruHS/eoBEpjWMpgrhi1Dv1gY6fBkuRQmtqzJVmg\npMbaoKTEWqGkwtqhpMBWgZICWwVKCuwpzxKSFNi5T2vFqb5gVcAqLNnBSixZwWos2cBg/9JSmgUM\n9iMt5QFe8tZ8VP6n3WXMHQtxPzHfabm0ptkBwWhpthzMp7YAAAAASUVORK5CYII=\n"\n     style="image-rendering:optimizeQuality"\n     preserveAspectRatio="none"\n     height="13.76"\n     width="13.76" />\n</svg>\n',W='<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n<svg\n   xmlns:dc="http://purl.org/dc/elements/1.1/"\n   xmlns:cc="http://creativecommons.org/ns#"\n   xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"\n   xmlns:svg="http://www.w3.org/2000/svg"\n   xmlns="http://www.w3.org/2000/svg"\n   xmlns:xlink="http://www.w3.org/1999/xlink"\n   viewBox="0 0 13.76 13.76"\n   height="13.76"\n   width="13.76"\n   id="svg3813"\n   version="1.1">\n  <metadata\n     id="metadata3819">\n    <rdf:RDF>\n      <cc:Work\n         rdf:about="">\n        <dc:format>image/svg+xml</dc:format>\n        <dc:type\n           rdf:resource="http://purl.org/dc/dcmitype/StillImage" />\n        <dc:title></dc:title>\n      </cc:Work>\n    </rdf:RDF>\n  </metadata>\n  <defs\n     id="defs3817" />\n  <image\n     y="0"\n     x="0"\n     id="image3821"\n     xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACsAAAArCAYAAADhXXHAAAAACXBIWXMAAC4jAAAuIwF4pT92AAAA\nnUlEQVRYw+3Z0QnCMBSF4T/FATqCG1g3cISO0NE6iiPoCE5gneD40ohPvgkJ/AcC9/EjHELgliT0\nkoGOIlasWLFixYoVK1asWLFixYoVK1bsjxy+5hlYgLEx47ofSEKSJW1nTUJJMgLPDlpwHoCpk8rO\nvgZixf4Zu3Vi3cq+WroBp4ahL+BYa3AB7o1CH7vvc7M1U4N/g2sdSk8bxjfDaMNdr+hmAQAAAABJ\nRU5ErkJggg==\n"\n     style="image-rendering:optimizeQuality"\n     preserveAspectRatio="none"\n     height="13.76"\n     width="13.76" />\n</svg>\n',J='<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n<svg\n   xmlns:dc="http://purl.org/dc/elements/1.1/"\n   xmlns:cc="http://creativecommons.org/ns#"\n   xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"\n   xmlns:svg="http://www.w3.org/2000/svg"\n   xmlns="http://www.w3.org/2000/svg"\n   xmlns:xlink="http://www.w3.org/1999/xlink"\n   viewBox="0 0 13.76 13.76"\n   height="13.76"\n   width="13.76"\n   id="svg32"\n   version="1.1">\n  <metadata\n     id="metadata38">\n    <rdf:RDF>\n      <cc:Work\n         rdf:about="">\n        <dc:format>image/svg+xml</dc:format>\n        <dc:type\n           rdf:resource="http://purl.org/dc/dcmitype/StillImage" />\n        <dc:title></dc:title>\n      </cc:Work>\n    </rdf:RDF>\n  </metadata>\n  <defs\n     id="defs36" />\n  <image\n     y="0"\n     x="0"\n     id="image40"\n     xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACsAAAArCAYAAADhXXHAAAAACXBIWXMAAC4jAAAuIwF4pT92AAAA\npklEQVRYw+3ZLQ4CMRCG4bcbFOvXg99T7FG4BafAw1VALx7dWyy2mIoGgSOZJu/n6p70ZybppFIK\nvWSgo4gVK1asWLFixYoVK1asWLFixYoV+yO7r/UMHIAxiO8FZGBrsUfgDEwBN/QNXIA11S/PW1Bo\nCz4N9ein4Nd1Dyw9PbDR0iVW7J+xudax6HkOtZVdg0MfQE7N0G4GlmANYgNW4A6QepowfgDMXB26\nb1V6LAAAAABJRU5ErkJggg==\n"\n     style="image-rendering:optimizeQuality"\n     preserveAspectRatio="none"\n     height="13.76"\n     width="13.76" />\n</svg>\n',Y='<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n<svg\n   xmlns:dc="http://purl.org/dc/elements/1.1/"\n   xmlns:cc="http://creativecommons.org/ns#"\n   xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"\n   xmlns:svg="http://www.w3.org/2000/svg"\n   xmlns="http://www.w3.org/2000/svg"\n   xmlns:xlink="http://www.w3.org/1999/xlink"\n   viewBox="0 0 13.76 13.76"\n   height="13.76"\n   width="13.76"\n   id="svg3823"\n   version="1.1">\n  <metadata\n     id="metadata3829">\n    <rdf:RDF>\n      <cc:Work\n         rdf:about="">\n        <dc:format>image/svg+xml</dc:format>\n        <dc:type\n           rdf:resource="http://purl.org/dc/dcmitype/StillImage" />\n        <dc:title></dc:title>\n      </cc:Work>\n    </rdf:RDF>\n  </metadata>\n  <defs\n     id="defs3827" />\n  <image\n     y="0"\n     x="0"\n     id="image3831"\n     xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACsAAAArCAYAAADhXXHAAAAAAXNSR0IArs4c6QAAAARnQU1BAACx\njwv8YQUAAAAJcEhZcwAALiMAAC4jAXilP3YAAAHOSURBVFhH1ZiLUcMwEEQNDcQl0AEuISVABZhO\nUkroICVAB6ECoINQgdmVfR5FlmQrkZzjzezEzsc8NPqcdNd1XfVfuB9ec3NAmv4yiRo5ImzBlm+c\nwZYtEHJCGsT3eSgHxKZFxs/tL+aMkCK8R3yMwu4PcsVmiXBIVDDCvh/miEtMeE5UaEsNMJcN8o64\ng26PvPSXs9S+/zRHQtgtvLRFCb9blZpnYw/9Rb6RR3M3zxtiprFbyKYwipK1+uwlnIkSrbITUaJR\n1itKtMkGRYk2WRZAQbTNBpzWtggrrwnaWja00hk0DrCgsEZZ4hXWKksmwjLAHobkgOv+V3+ZhXHQ\niWxKqXYLKNyILDdqbPKlldASPhA+Mxc7uwatkSOSix1iP//q2APshLBvfJo7hbizgQj/mDtl+KYu\nCj8h7NSqCM2zXJvZwqqEY4uCOuGYLKEwJ3kVzMlyscg5915FTFbdqhaSVbn8+mTV1gmurOqCxpZN\nEeUu9BlZd1obioTkQ7IhPGTjYZuPIoUMK/GUFrX39asuHJTlH3w1d3FCBxCrCUufZX+NCUdPSsAq\nwu4A8wnPiQrFhW1Z4govFRWKCoeOjzjoZF92CdwpZy6AquoPvJRHJxB8bJ8AAAAASUVORK5CYII=\n"\n     style="image-rendering:optimizeQuality"\n     preserveAspectRatio="none"\n     height="13.76"\n     width="13.76" />\n</svg>\n',V='<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n<svg\n   xmlns:dc="http://purl.org/dc/elements/1.1/"\n   xmlns:cc="http://creativecommons.org/ns#"\n   xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"\n   xmlns:svg="http://www.w3.org/2000/svg"\n   xmlns="http://www.w3.org/2000/svg"\n   xmlns:xlink="http://www.w3.org/1999/xlink"\n   viewBox="0 0 13.76 13.76"\n   height="13.76"\n   width="13.76"\n   id="svg42"\n   version="1.1">\n  <metadata\n     id="metadata48">\n    <rdf:RDF>\n      <cc:Work\n         rdf:about="">\n        <dc:format>image/svg+xml</dc:format>\n        <dc:type\n           rdf:resource="http://purl.org/dc/dcmitype/StillImage" />\n        <dc:title></dc:title>\n      </cc:Work>\n    </rdf:RDF>\n  </metadata>\n  <defs\n     id="defs46" />\n  <image\n     y="0"\n     x="0"\n     id="image50"\n     xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACsAAAArCAYAAADhXXHAAAAAAXNSR0IArs4c6QAAAARnQU1BAACx\njwv8YQUAAAAJcEhZcwAALiMAAC4jAXilP3YAAAG/SURBVFhH1ZgxUsMwEEUNJRyAGmp6qKGn5xRQ\nQ08NNfRQQw11DpAaanIAWrMv8WaELSlexhLLm/mRnImiF48jr7zVtm3zX9ju2ik5llxLdpdHNg4k\nT5I7yWB8Cdl9yZHkRmIRRpQxOxK+YzC+hKwSnTBBKKoMxpeUBSbkksgRE1V+CJeWhUPJ5ao7ICeq\nrIVryMKJpC88RlTZk1SThVDYIvoluZIsSqyz511SfEg4UxbRdw5qnlmFa9AsCn8hO4aBKHiUjYqC\nN9mkKHiSzYqCJ9lPSVIUPMmySqTudEu8XbOxO90ab7KQFPYoC1Fhr7IwENbagMLCUtXnoCTM1QZW\n3iS3dFT2mRfHvEjuVfZUckFnQh67dgqo1GYqC1MLn3XtZIR/sFcJW2C39FcD18KxpcutcGqddSmc\nuykg/LDq+iAnC/OudUFOVrfLbkjJWvb11YjJuhSFvqxbUQhlXYuCylpE2YXy2SkLlVEgaxVluzyT\nIEutWQ1kKZYtouF2maK4mjCyFN6bJsw9gKgmrNdsbsKNT0qEKsIqC7EJx4gqxYVDWQgntIgqRYXD\nbY3CLpcVgmdPC974BYy3/MgRNM03hR9ubFTHT48AAAAASUVORK5CYII=\n"\n     style="image-rendering:optimizeQuality"\n     preserveAspectRatio="none"\n     height="13.76"\n     width="13.76" />\n</svg>\n';function K(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Q(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function Z(e,t,n){return t&&Q(e.prototype,t),n&&Q(e,n),e}var q=function(){function e(t){var n=this;K(this,e),this.attributes=t;var i=navigator.userAgent.toLowerCase(),o=i.indexOf("android")>-1,r=i.indexOf("ipad")>-1||i.indexOf("iphone")>-1;this.iosSoftkeyboardOpened=!1,this.iosMeasureUnit=-1===i.indexOf("crios")?"%":"vh",this.iosDivHeight="100%".concat(this.iosMeasureUnit);var a=window.outerWidth,s=window.outerHeight,l=a>s,c=a<s,u=l&&this.attributes.height>s,d=c&&this.attributes.width>a,h=u||d;this.instanceId=document.getElementsByClassName("wrs_modal_dialogContainer").length,this.deviceProperties={orientation:l?"landscape":"portait",isAndroid:o,isIOS:r,isMobile:h,isDesktop:!h&&!r&&!o},this.properties={created:!1,state:"",previousState:"",position:{bottom:0,right:10},size:{height:338,width:580}},this.websiteBeforeLockParameters=null;var m={class:"wrs_modal_overlay"};m.id=this.getElementId(m.class),this.overlay=y.createElement("div",m),(m={}).class="wrs_modal_title_bar",m.id=this.getElementId(m.class),this.titleBar=y.createElement("div",m),(m={}).class="wrs_modal_title",m.id=this.getElementId(m.class),this.title=y.createElement("div",m),this.title.innerHTML="",(m={}).class="wrs_modal_close_button",m.id=this.getElementId(m.class),m.title=w.get("close"),m.style={},this.closeDiv=y.createElement("a",m),this.closeDiv.setAttribute("role","button");var g="background-size: 10px; background-image: url(data:image/svg+xml;base64,".concat(window.btoa(R),")"),f="background-size: 10px; background-image: url(data:image/svg+xml;base64,".concat(window.btoa(H),")");this.closeDiv.setAttribute("style",g),this.closeDiv.setAttribute("onmouseover",'this.style = "'.concat(f,'";')),this.closeDiv.setAttribute("onmouseout",'this.style = "'.concat(g,'";')),(m={}).class="wrs_modal_stack_button",m.id=this.getElementId(m.class),m.title=w.get("exit_fullscreen"),this.stackDiv=y.createElement("a",m),this.stackDiv.setAttribute("role","button"),g="background-size: 10px; background-image: url(data:image/svg+xml;base64,".concat(window.btoa(Y),")"),f="background-size: 10px; background-image: url(data:image/svg+xml;base64,".concat(window.btoa(V),")"),this.stackDiv.setAttribute("style",g),this.stackDiv.setAttribute("onmouseover",'this.style = "'.concat(f,'";')),this.stackDiv.setAttribute("onmouseout",'this.style = "'.concat(g,'";')),(m={}).class="wrs_modal_maximize_button",m.id=this.getElementId(m.class),m.title=w.get("fullscreen"),this.maximizeDiv=y.createElement("a",m),this.maximizeDiv.setAttribute("role","button"),g="background-size: 10px; background-repeat: no-repeat; background-image: url(data:image/svg+xml;base64,".concat(window.btoa(X),")"),f="background-size: 10px; background-repeat: no-repeat; background-image: url(data:image/svg+xml;base64,".concat(window.btoa(U),")"),this.maximizeDiv.setAttribute("style",g),this.maximizeDiv.setAttribute("onmouseover",'this.style = "'.concat(f,'";')),this.maximizeDiv.setAttribute("onmouseout",'this.style = "'.concat(g,'";')),(m={}).class="wrs_modal_minimize_button",m.id=this.getElementId(m.class),m.title=w.get("minimize"),this.minimizeDiv=y.createElement("a",m),this.minimizeDiv.setAttribute("role","button"),g="background-size: 10px; background-repeat: no-repeat; background-image: url(data:image/svg+xml;base64,".concat(window.btoa(W),")"),f="background-size: 10px; background-repeat: no-repeat; background-image: url(data:image/svg+xml;base64,".concat(window.btoa(J),")"),this.minimizeDiv.setAttribute("style",g),this.minimizeDiv.setAttribute("onmouseover",'this.style = "'.concat(f,'";')),this.minimizeDiv.setAttribute("onmouseout",'this.style = "'.concat(g,'";')),(m={}).class="wrs_modal_dialogContainer",m.id=this.getElementId(m.class),m.role="dialog",this.container=y.createElement("div",m),this.container.setAttribute("aria-labeledby","wrs_modal_title[0]"),(m={}).class="wrs_modal_wrapper",m.id=this.getElementId(m.class),this.wrapper=y.createElement("div",m),(m={}).class="wrs_content_container",m.id=this.getElementId(m.class),this.contentContainer=y.createElement("div",m),(m={}).class="wrs_modal_controls",m.id=this.getElementId(m.class),this.controls=y.createElement("div",m),(m={}).class="wrs_modal_buttons_container",m.id=this.getElementId(m.class),this.buttonContainer=y.createElement("div",m),this.submitButton=this.createSubmitButton({id:this.getElementId("wrs_modal_button_accept"),class:"wrs_modal_button_accept",innerHTML:w.get("accept")},this.submitAction.bind(this)),this.cancelButton=this.createSubmitButton({id:this.getElementId("wrs_modal_button_cancel"),class:"wrs_modal_button_cancel",innerHTML:w.get("cancel")},this.cancelAction.bind(this)),this.contentManager=null;var p={cancelString:w.get("cancel"),submitString:w.get("close"),message:w.get("close_modal_warning")},v={closeCallback:function(){n.close()},cancelCallback:function(){n.focus()}},_={overlayElement:this.container,callbacks:v,strings:p};this.popup=new N(_),this.rtl=!1,"rtl"in this.attributes&&(this.rtl=this.attributes.rtl),this.handleOpenedIosSoftkeyboard=this.handleOpenedIosSoftkeyboard.bind(this),this.handleClosedIosSoftkeyboard=this.handleClosedIosSoftkeyboard.bind(this)}return Z(e,[{key:"setContentManager",value:function(e){this.contentManager=e}},{key:"getContentManager",value:function(){return this.contentManager}},{key:"submitAction",value:function(){void 0!==this.contentManager.submitAction&&this.contentManager.submitAction(),this.close()}},{key:"cancelAction",value:function(){void 0===this.contentManager.hasChanges?this.close():this.contentManager.hasChanges()?this.showPopUpMessage():this.close()}},{key:"createSubmitButton",value:function(e,t){return new(function(){function n(){K(this,n),this.element=document.createElement("button"),this.element.id=e.id,this.element.className=e.class,this.element.innerHTML=e.innerHTML,y.addEvent(this.element,"click",t)}return Z(n,[{key:"getElement",value:function(){return this.element}}]),n}())(e,t).getElement()}},{key:"create",value:function(){this.titleBar.appendChild(this.closeDiv),this.titleBar.appendChild(this.stackDiv),this.titleBar.appendChild(this.maximizeDiv),this.titleBar.appendChild(this.minimizeDiv),this.titleBar.appendChild(this.title),this.deviceProperties.isDesktop&&this.container.appendChild(this.titleBar),this.wrapper.appendChild(this.contentContainer),this.wrapper.appendChild(this.controls),this.controls.appendChild(this.buttonContainer),this.buttonContainer.appendChild(this.submitButton),this.buttonContainer.appendChild(this.cancelButton),this.container.appendChild(this.wrapper),this.recalculateScrollBar(),document.body.appendChild(this.container),document.body.appendChild(this.overlay),this.deviceProperties.isDesktop?(this.createModalWindowDesktop(),this.createResizeButtons(),this.addListeners(),l.get("modalWindowFullScreen")&&this.maximize()):this.deviceProperties.isAndroid?this.createModalWindowAndroid():this.deviceProperties.isIOS&&!this.deviceProperties.isMobile&&this.createModalWindowIos(),null!=this.contentManager&&this.contentManager.insert(this),this.properties.open=!0,this.properties.created=!0,this.isRTL()&&(this.container.style.right="".concat(window.innerWidth-this.scrollbarWidth-this.container.offsetWidth,"px"),this.container.className+=" wrs_modal_rtl")}},{key:"createResizeButtons",value:function(){this.resizerBR=document.createElement("div"),this.resizerBR.className="wrs_bottom_right_resizer",this.resizerBR.innerHTML="◢",this.resizerTL=document.createElement("div"),this.resizerTL.className="wrs_bottom_left_resizer",this.container.appendChild(this.resizerBR),this.titleBar.appendChild(this.resizerTL),y.addEvent(this.resizerBR,"mousedown",this.activateResizeStateBR.bind(this)),y.addEvent(this.resizerTL,"mousedown",this.activateResizeStateTL.bind(this))}},{key:"activateResizeStateBR",value:function(e){this.initializeResizeProperties(e,!1)}},{key:"activateResizeStateTL",value:function(e){this.initializeResizeProperties(e,!0)}},{key:"initializeResizeProperties",value:function(e,t){y.addClass(document.body,"wrs_noselect"),y.addClass(this.overlay,"wrs_overlay_active"),this.resizeDataObject={x:this.eventClient(e).X,y:this.eventClient(e).Y},this.initialWidth=parseInt(this.container.style.width,10),this.initialHeight=parseInt(this.container.style.height,10),t?this.leftScale=!0:(this.initialRight=parseInt(this.container.style.right,10),this.initialBottom=parseInt(this.container.style.bottom,10)),this.initialRight||(this.initialRight=0),this.initialBottom||(this.initialBottom=0),document.body.style["user-select"]="none"}},{key:"open",value:function(){var e=this;this.removeClass("wrs_closed");var t=this.deviceProperties.isIOS,n=this.deviceProperties.isAndroid,i=this.deviceProperties.isMobile;if((t||n||i)&&(this.restoreWebsiteScale(),this.lockWebsiteScroll(),setTimeout(function(){e.hideKeyboard()},400)),this.properties.created?(this.properties.open||(this.properties.open=!0,this.deviceProperties.isAndroid||this.deviceProperties.isIOS||this.restoreState()),this.deviceProperties.isDesktop&&l.get("modalWindowFullScreen")&&this.maximize(),this.deviceProperties.isIOS&&(this.iosSoftkeyboardOpened=!1,this.setContainerHeight("".concat(100+this.iosMeasureUnit)))):this.create(),P.isEditorLoaded())this.contentManager.onOpen(this);else{var o=h.newListener("onLoad",function(){e.contentManager.onOpen(e)});this.contentManager.addListener(o)}}},{key:"close",value:function(){this.removeClass("wrs_maximized"),this.removeClass("wrs_minimized"),this.removeClass("wrs_stack"),this.addClass("wrs_closed"),this.saveModalProperties(),this.unlockWebsiteScroll(),this.properties.open=!1}},{key:"restoreWebsiteScale",value:function(){var e=document.querySelector("meta[name=viewport]"),t=["initial-scale=","minimum-scale=","maximum-scale="],n=["1.0","1.0","1.0"],i=function(e,t){var i=e.getAttribute("content");if(i){for(var o=i.split(","),r="",a=[],s=0;s<o.length;s+=1){for(var l=!1,c=0;!l&&c<t.length;)o[s].indexOf(t[c])&&(l=!0),c+=1;l||a.push(o[s])}for(var u=0;u<t.length;u+=1){var d=t[u]+n[u];r+=0===u?d:",".concat(d)}for(var h=0;h<a.length;h+=1)r+=",".concat(a[h]);e.setAttribute("content",r),e.setAttribute("content",""),e.setAttribute("content",i)}else e.setAttribute("content","initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"),e.removeAttribute("content")};e?i(e,t):(e=document.createElement("meta"),document.getElementsByTagName("head")[0].appendChild(e),i(e,t),e.remove())}},{key:"lockWebsiteScroll",value:function(){this.websiteBeforeLockParameters={bodyStylePosition:document.body.style.position?document.body.style.position:"",bodyStyleOverflow:document.body.style.overflow?document.body.style.overflow:"",htmlStyleOverflow:document.documentElement.style.overflow?document.documentElement.style.overflow:"",windowScrollX:window.scrollX,windowScrollY:window.scrollY}}},{key:"unlockWebsiteScroll",value:function(){if(this.websiteBeforeLockParameters){document.body.style.position=this.websiteBeforeLockParameters.bodyStylePosition,document.body.style.overflow=this.websiteBeforeLockParameters.bodyStyleOverflow,document.documentElement.style.overflow=this.websiteBeforeLockParameters.htmlStyleOverflow;var e=this.websiteBeforeLockParameters.windowScrollX,t=this.websiteBeforeLockParameters.windowScrollY;window.scrollTo(e,t),this.websiteBeforeLockParameters=null}}},{key:"isIE11",value:function(){return navigator.userAgent.search("Msie/")>=0||navigator.userAgent.search("Trident/")>=0||navigator.userAgent.search("Edge/")>=0}},{key:"isRTL",value:function(){return"ar"===this.attributes.language||"he"===this.attributes.language||this.rtl}},{key:"addClass",value:function(e){y.addClass(this.overlay,e),y.addClass(this.titleBar,e),y.addClass(this.overlay,e),y.addClass(this.container,e),y.addClass(this.contentContainer,e),y.addClass(this.stackDiv,e),y.addClass(this.minimizeDiv,e),y.addClass(this.maximizeDiv,e),y.addClass(this.wrapper,e)}},{key:"removeClass",value:function(e){y.removeClass(this.overlay,e),y.removeClass(this.titleBar,e),y.removeClass(this.overlay,e),y.removeClass(this.container,e),y.removeClass(this.contentContainer,e),y.removeClass(this.stackDiv,e),y.removeClass(this.minimizeDiv,e),y.removeClass(this.maximizeDiv,e),y.removeClass(this.wrapper,e)}},{key:"createModalWindowDesktop",value:function(){this.addClass("wrs_modal_desktop"),this.stack()}},{key:"createModalWindowAndroid",value:function(){this.addClass("wrs_modal_android"),window.addEventListener("resize",this.orientationChangeAndroidSoftkeyboard.bind(this))}},{key:"createModalWindowIos",value:function(){this.addClass("wrs_modal_ios"),window.addEventListener("resize",this.orientationChangeIosSoftkeyboard.bind(this))}},{key:"restoreState",value:function(){"maximized"===this.properties.state?this.maximize():"minimized"===this.properties.state?(this.properties.state=this.properties.previousState,this.properties.previousState="",this.minimize()):this.stack()}},{key:"stack",value:function(){this.properties.previousState=this.properties.state,this.properties.state="stack",this.removeClass("wrs_maximized"),this.minimizeDiv.title=w.get("minimize"),this.removeClass("wrs_minimized"),this.addClass("wrs_stack");var e="background-size: 10px; background-repeat: no-repeat; background-image: url(data:image/svg+xml;base64,".concat(window.btoa(W),")"),t="background-size: 10px; background-repeat: no-repeat; background-image: url(data:image/svg+xml;base64,".concat(window.btoa(J),")");this.minimizeDiv.setAttribute("style",e),this.minimizeDiv.setAttribute("onmouseover",'this.style = "'.concat(t,'";')),this.minimizeDiv.setAttribute("onmouseout",'this.style = "'.concat(e,'";')),this.restoreModalProperties(),void 0!==this.resizerBR&&void 0!==this.resizerTL&&this.setResizeButtonsVisibility(),this.recalculateScrollBar(),this.recalculatePosition(),this.recalculateScale(),this.focus()}},{key:"minimize",value:function(){if(this.saveModalProperties(),this.title.style.cursor="pointer","minimized"===this.properties.state&&"stack"===this.properties.previousState)this.stack();else if("minimized"===this.properties.state&&"maximized"===this.properties.previousState)this.maximize();else{this.container.style.height="30px",this.container.style.width="250px",this.container.style.bottom="0px",this.container.style.right="10px",this.removeListeners(),this.properties.previousState=this.properties.state,this.properties.state="minimized",this.setResizeButtonsVisibility(),this.minimizeDiv.title=w.get("maximize"),y.containsClass(this.overlay,"wrs_stack")?this.removeClass("wrs_stack"):this.removeClass("wrs_maximized"),this.addClass("wrs_minimized");var e="background-size: 10px; background-repeat: no-repeat; background-image: url(data:image/svg+xml;base64,".concat(window.btoa('<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n<svg\n   xmlns:dc="http://purl.org/dc/elements/1.1/"\n   xmlns:cc="http://creativecommons.org/ns#"\n   xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"\n   xmlns:svg="http://www.w3.org/2000/svg"\n   xmlns="http://www.w3.org/2000/svg"\n   xmlns:xlink="http://www.w3.org/1999/xlink"\n   viewBox="0 0 13.44 13.76"\n   height="13.76"\n   width="13.44"\n   id="svg3803"\n   version="1.1">\n  <metadata\n     id="metadata3809">\n    <rdf:RDF>\n      <cc:Work\n         rdf:about="">\n        <dc:format>image/svg+xml</dc:format>\n        <dc:type\n           rdf:resource="http://purl.org/dc/dcmitype/StillImage" />\n        <dc:title></dc:title>\n      </cc:Work>\n    </rdf:RDF>\n  </metadata>\n  <defs\n     id="defs3807" />\n  <image\n     y="0"\n     x="0"\n     id="image3811"\n     xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACoAAAArCAYAAAAOnxr+AAAACXBIWXMAAC4jAAAuIwF4pT92AAAA\nvElEQVRYw+3ZSw0CMRSF4b8T9iAFB4wDkDAWcICEkTA4GAeAA3AADurgsCkbAgsSMrmFczZNd1/a\n3vSVJFFDGipJNdBZaRdAB2wC2TIwAgNAkrQEjsA86GBegDZJGoF18JnfJtVR9idXvaGGGmrod/b6\nV9kD14k9LbD6FDqUM8CU2b2Deo0aaqihhhpqqKGGGhr1hH/wiP469FaBMzflEhc9PZKQ1CtmsqRO\nEunpHbeNNN3A+dFJ/mf6V+gduGPIoUgKLbAAAAAASUVORK5CYII=\n"\n     style="image-rendering:optimizeQuality"\n     preserveAspectRatio="none"\n     height="13.76"\n     width="13.44" />\n</svg>\n'),")"),t="background-size: 10px; background-repeat: no-repeat; background-image: url(data:image/svg+xml;base64,".concat(window.btoa('<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n<svg\n   xmlns:dc="http://purl.org/dc/elements/1.1/"\n   xmlns:cc="http://creativecommons.org/ns#"\n   xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"\n   xmlns:svg="http://www.w3.org/2000/svg"\n   xmlns="http://www.w3.org/2000/svg"\n   xmlns:xlink="http://www.w3.org/1999/xlink"\n   viewBox="0 0 13.44 13.76"\n   height="13.76"\n   width="13.44"\n   id="svg22"\n   version="1.1">\n  <metadata\n     id="metadata28">\n    <rdf:RDF>\n      <cc:Work\n         rdf:about="">\n        <dc:format>image/svg+xml</dc:format>\n        <dc:type\n           rdf:resource="http://purl.org/dc/dcmitype/StillImage" />\n        <dc:title></dc:title>\n      </cc:Work>\n    </rdf:RDF>\n  </metadata>\n  <defs\n     id="defs26" />\n  <image\n     y="0"\n     x="0"\n     id="image30"\n     xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACoAAAArCAYAAAAOnxr+AAAACXBIWXMAAC4jAAAuIwF4pT92AAAA\nvUlEQVRYw+3ZsQ3CMBCF4d8WFekZgBqWIDUDZACmYBQWYIn0pGYAegZIexROERHRIBTdhXeVy08+\nyT4/JzMjQmWCVBjoarSugK0z3/0degKODjeyBy5Am8ysARrnnT8nM7sCa+fQLgdAAlQ6ngQVVFBB\nfzeUTK6t8VAwU328ztV6QQUVVFBBBRVUUEG9Ds41sJvZs/8GelDrlw7tAjhvmZLo9o6RD4bEGUp+\nX1My/I0T4HN4rrcASf9M/wp9ASNzIKYYz2hAAAAAAElFTkSuQmCC\n"\n     style="image-rendering:optimizeQuality"\n     preserveAspectRatio="none"\n     height="13.76"\n     width="13.44" />\n</svg>\n'),")");this.minimizeDiv.setAttribute("style",e),this.minimizeDiv.setAttribute("onmouseover",'this.style = "'.concat(t,'";')),this.minimizeDiv.setAttribute("onmouseout",'this.style = "'.concat(e,'";'))}}},{key:"maximize",value:function(){this.saveModalProperties(),"maximized"!==this.properties.state&&(this.properties.previousState=this.properties.state,this.properties.state="maximized"),this.setResizeButtonsVisibility(),y.containsClass(this.overlay,"wrs_minimized")?(this.minimizeDiv.title=w.get("minimize"),this.removeClass("wrs_minimized")):y.containsClass(this.overlay,"wrs_stack")&&(this.container.style.left=null,this.container.style.top=null,this.removeClass("wrs_stack")),this.addClass("wrs_maximized");var e="background-size: 10px; background-repeat: no-repeat; background-image: url(data:image/svg+xml;base64,".concat(window.btoa(W),")"),t="background-size: 10px; background-repeat: no-repeat; background-image: url(data:image/svg+xml;base64,".concat(window.btoa(J),")");this.minimizeDiv.setAttribute("style",e),this.minimizeDiv.setAttribute("onmouseover",'this.style = "'.concat(t,'";')),this.minimizeDiv.setAttribute("onmouseout",'this.style = "'.concat(e,'";')),this.setSize(parseInt(.8*window.innerHeight,10),parseInt(.8*window.innerWidth,10)),this.container.clientHeight>700&&(this.container.style.height="700px"),this.container.clientWidth>1200&&(this.container.style.width="1200px");var n=window.innerHeight,i=window.innerWidth,o=n/2-this.container.offsetHeight/2,r=i/2-this.container.offsetWidth/2;this.setPosition(o,r),this.recalculateScale(),this.recalculatePosition(),this.recalculateSize(),this.focus()}},{key:"reExpand",value:function(){"minimized"===this.properties.state&&("maximized"===this.properties.previousState?this.maximize():this.stack(),this.title.style.cursor="")}},{key:"setSize",value:function(e,t){this.container.style.height="".concat(e,"px"),this.container.style.width="".concat(t,"px"),this.recalculateSize()}},{key:"setPosition",value:function(e,t){this.container.style.bottom="".concat(e,"px"),this.container.style.right="".concat(t,"px")}},{key:"saveModalProperties",value:function(){"stack"===this.properties.state&&(this.properties.position.bottom=parseInt(this.container.style.bottom,10),this.properties.position.right=parseInt(this.container.style.right,10),this.properties.size.width=parseInt(this.container.style.width,10),this.properties.size.height=parseInt(this.container.style.height,10))}},{key:"restoreModalProperties",value:function(){"stack"===this.properties.state&&(this.setPosition(this.properties.position.bottom,this.properties.position.right),this.setSize(this.properties.size.height,this.properties.size.width))}},{key:"recalculateSize",value:function(){this.wrapper.style.width="".concat(this.container.clientWidth-12,"px"),this.wrapper.style.height="".concat(this.container.clientHeight-38,"px"),this.contentContainer.style.height="".concat(parseInt(this.wrapper.offsetHeight-50,10),"px")}},{key:"setResizeButtonsVisibility",value:function(){"stack"===this.properties.state?(this.resizerTL.style.visibility="visible",this.resizerBR.style.visibility="visible"):(this.resizerTL.style.visibility="hidden",this.resizerBR.style.visibility="hidden")}},{key:"addListeners",value:function(){this.maximizeDiv.addEventListener("click",this.maximize.bind(this),!0),this.stackDiv.addEventListener("click",this.stack.bind(this),!0),this.minimizeDiv.addEventListener("click",this.minimize.bind(this),!0),this.closeDiv.addEventListener("click",this.cancelAction.bind(this)),this.title.addEventListener("click",this.reExpand.bind(this)),this.overlay.addEventListener("click",this.cancelAction.bind(this)),y.addEvent(window,"mousedown",this.startDrag.bind(this)),y.addEvent(window,"mouseup",this.stopDrag.bind(this)),y.addEvent(window,"mousemove",this.drag.bind(this)),y.addEvent(window,"resize",this.onWindowResize.bind(this)),y.addEvent(this.container,"keydown",this.onKeyDown.bind(this))}},{key:"removeListeners",value:function(){y.removeEvent(window,"mousedown",this.startDrag),y.removeEvent(window,"mouseup",this.stopDrag),y.removeEvent(window,"mousemove",this.drag),y.removeEvent(window,"resize",this.onWindowResize),y.removeEvent(this.container,"keydown",this.onKeyDown)}},{key:"eventClient",value:function(e){return void 0===e.clientX&&e.changedTouches?{X:e.changedTouches[0].clientX,Y:e.changedTouches[0].clientY}:{X:e.clientX,Y:e.clientY}}},{key:"startDrag",value:function(e){"minimized"!==this.properties.state&&e.target===this.title&&(void 0!==this.dragDataObject&&null!==this.dragDataObject||(this.dragDataObject={x:this.eventClient(e).X,y:this.eventClient(e).Y},this.lastDrag={x:"0px",y:"0px"},""===this.container.style.right&&(this.container.style.right="0px"),""===this.container.style.bottom&&(this.container.style.bottom="0px"),this.isIE11(),y.addClass(document.body,"wrs_noselect"),y.addClass(this.overlay,"wrs_overlay_active"),this.limitWindow=this.getLimitWindow()))}},{key:"drag",value:function(e){if(this.dragDataObject){e.preventDefault();var t=Math.min(this.eventClient(e).Y,this.limitWindow.minPointer.y);t=Math.max(this.limitWindow.maxPointer.y,t);var n=Math.min(this.eventClient(e).X,this.limitWindow.minPointer.x);n=Math.max(this.limitWindow.maxPointer.x,n);var i="".concat(n-this.dragDataObject.x,"px"),o="".concat(t-this.dragDataObject.y,"px");this.lastDrag={x:i,y:o},this.container.style.transform="translate3d(".concat(i,",").concat(o,",0)")}if(this.resizeDataObject){var r,a=window.innerWidth,s=window.innerHeight,l=Math.min(this.eventClient(e).X,a-this.scrollbarWidth-7),c=Math.min(this.eventClient(e).Y,s-7);l<0&&(l=0),c<0&&(c=0),r=this.leftScale?-1:1,this.container.style.width="".concat(this.initialWidth+r*(l-this.resizeDataObject.x),"px"),this.container.style.height="".concat(this.initialHeight+r*(c-this.resizeDataObject.y),"px"),this.leftScale||(this.resizeDataObject.x-l-this.initialWidth<-580?this.container.style.right="".concat(this.initialRight-(l-this.resizeDataObject.x),"px"):(this.container.style.right="".concat(this.initialRight+this.initialWidth-580,"px"),this.container.style.width="580px"),this.resizeDataObject.y-c<this.initialHeight-338?this.container.style.bottom="".concat(this.initialBottom-(c-this.resizeDataObject.y),"px"):(this.container.style.bottom="".concat(this.initialBottom+this.initialHeight-338,"px"),this.container.style.height="338px")),this.recalculateScale(),this.recalculatePosition()}}},{key:"getLimitWindow",value:function(){var e=window.innerWidth,t=window.innerHeight,n=this.container.offsetHeight,i=parseInt(this.container.style.bottom,10),o=parseInt(this.container.style.right,10),r=window.pageXOffset,a=this.dragDataObject.y,s=this.dragDataObject.x,l=n+i-(t-(a-r)),c=e-this.scrollbarWidth-(s-r)-o,u=t-this.container.offsetHeight+l,d=this.title.offsetHeight-(this.title.offsetHeight-l);return{minPointer:{x:e-c-this.scrollbarWidth,y:u},maxPointer:{x:this.container.offsetWidth-c,y:d}}}},{key:"getScrollBarWidth",value:function(){var e=document.createElement("p");e.style.width="100%",e.style.height="200px";var t=document.createElement("div");t.style.position="absolute",t.style.top="0px",t.style.left="0px",t.style.visibility="hidden",t.style.width="200px",t.style.height="150px",t.style.overflow="hidden",t.appendChild(e),document.body.appendChild(t);var n=e.offsetWidth;t.style.overflow="scroll";var i=e.offsetWidth;return n===i&&(i=t.clientWidth),document.body.removeChild(t),n-i}},{key:"stopDrag",value:function(){(this.dragDataObject||this.resizeDataObject)&&(this.container.style.transform="",this.dragDataObject&&(this.container.style.right="".concat(parseInt(this.container.style.right,10)-parseInt(this.lastDrag.x,10),"px"),this.container.style.bottom="".concat(parseInt(this.container.style.bottom,10)-parseInt(this.lastDrag.y,10),"px")),this.focus(),document.body.style["user-select"]="",this.isIE11(),y.removeClass(document.body,"wrs_noselect"),y.removeClass(this.overlay,"wrs_overlay_active")),this.dragDataObject=null,this.resizeDataObject=null,this.initialWidth=null,this.leftScale=null}},{key:"onWindowResize",value:function(){this.recalculateScrollBar(),this.recalculatePosition(),this.recalculateScale()}},{key:"onKeyDown",value:function(e){void 0!==e.key&&("block"!==this.popup.overlayWrapper.style.display?"Escape"===e.key||"Esc"===e.key?this.properties.open&&this.contentManager.onKeyDown(e):e.shiftKey&&"Tab"===e.key?document.activeElement===this.cancelButton?(this.submitButton.focus(),e.stopPropagation(),e.preventDefault()):this.contentManager.onKeyDown(e):"Tab"===e.key&&(document.activeElement===this.submitButton?(this.cancelButton.focus(),e.stopPropagation(),e.preventDefault()):this.contentManager.onKeyDown(e)):this.popup.onKeyDown(e))}},{key:"recalculatePosition",value:function(){this.container.style.right="".concat(Math.min(parseInt(this.container.style.right,10),window.innerWidth-this.scrollbarWidth-this.container.offsetWidth),"px"),parseInt(this.container.style.right,10)<0&&(this.container.style.right="0px"),this.container.style.bottom="".concat(Math.min(parseInt(this.container.style.bottom,10),window.innerHeight-this.container.offsetHeight),"px"),parseInt(this.container.style.bottom,10)<0&&(this.container.style.bottom="0px")}},{key:"recalculateScale",value:function(){var e=!1;parseInt(this.container.style.width,10)>580?(this.container.style.width="".concat(Math.min(parseInt(this.container.style.width,10),window.innerWidth-this.scrollbarWidth),"px"),e=!0):(this.container.style.width="580px",e=!0),parseInt(this.container.style.height,10)>338?(this.container.style.height="".concat(Math.min(parseInt(this.container.style.height,10),window.innerHeight),"px"),e=!0):(this.container.style.height="338px",e=!0),e&&this.recalculateSize()}},{key:"recalculateScrollBar",value:function(){this.hasScrollBar=window.innerWidth>document.documentElement.clientWidth,this.hasScrollBar?this.scrollbarWidth=this.getScrollBarWidth():this.scrollbarWidth=0}},{key:"hideKeyboard",value:function(){var e=document.createElement("input");this.container.appendChild(e),e.focus(),e.blur(),e.remove()}},{key:"focus",value:function(){null!=this.contentManager&&void 0!==this.contentManager.onFocus&&this.contentManager.onFocus()}},{key:"portraitMode",value:function(){return window.innerHeight>window.innerWidth}},{key:"handleOpenedIosSoftkeyboard",value:function(){this.iosSoftkeyboardOpened||null==this.iosDivHeight||this.iosDivHeight!=="100".concat(this.iosMeasureUnit)||(this.portraitMode()?this.setContainerHeight("63".concat(this.iosMeasureUnit)):this.setContainerHeight("40".concat(this.iosMeasureUnit))),this.iosSoftkeyboardOpened=!0}},{key:"handleClosedIosSoftkeyboard",value:function(){this.iosSoftkeyboardOpened=!1,this.setContainerHeight("100".concat(this.iosMeasureUnit))}},{key:"orientationChangeIosSoftkeyboard",value:function(){this.iosSoftkeyboardOpened?this.portraitMode()?this.setContainerHeight("63".concat(this.iosMeasureUnit)):this.setContainerHeight("40".concat(this.iosMeasureUnit)):this.setContainerHeight("100".concat(this.iosMeasureUnit))}},{key:"orientationChangeAndroidSoftkeyboard",value:function(){this.setContainerHeight("100%")}},{key:"setContainerHeight",value:function(e){this.iosDivHeight=e,this.wrapper.style.height=e}},{key:"showPopUpMessage",value:function(){"minimized"===this.properties.state&&this.stack(),this.popup.show()}},{key:"setTitle",value:function(e){this.title.innerHTML=e}},{key:"getElementId",value:function(e){return"".concat(e,"[").concat(this.instanceId,"]")}}]),e}();
-/*! http://mths.be/codepointat v0.1.0 by @mathias */
-String.prototype.codePointAt||function(){var e=function(e){if(null==this)throw TypeError();var t=String(this),n=t.length,i=e?Number(e):0;if(i!=i&&(i=0),!(i<0||i>=n)){var o,r=t.charCodeAt(i);return r>=55296&&r<=56319&&n>i+1&&(o=t.charCodeAt(i+1))>=56320&&o<=57343?1024*(r-55296)+o-56320+65536:r}};Object.defineProperty?Object.defineProperty(String.prototype,"codePointAt",{value:e,configurable:!0,writable:!0}):String.prototype.codePointAt=e}(),"function"!=typeof Object.assign&&Object.defineProperty(Object,"assign",{value:function(e,t){if(null==e)throw new TypeError("Cannot convert undefined or null to object");for(var n=Object(e),i=1;i<arguments.length;i++){var o=arguments[i];if(null!=o)for(var r in o)Object.prototype.hasOwnProperty.call(o,r)&&(n[r]=o[r])}return n},writable:!0,configurable:!0});n(2);function G(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var $=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.language="en",this.editMode="images",this.modalDialog=null,this.customEditors=new S;if(this.customEditors.addEditor("chemistry",{name:"Chemistry",toolbar:"chemistry",icon:"chem.png",confVariable:"chemEnabled",title:"ChemType",tooltip:"Insert a chemistry formula - ChemType"}),this.environment={},this.editionProperties={},this.editionProperties.isNewElement=!0,this.editionProperties.temporalImage=null,this.editionProperties.latexRange=null,this.editionProperties.range=null,this.integrationModel=null,this.contentManager=null,this.browser=function(){var e=navigator.userAgent,t="none";return e.search("Edge/")>=0?t="EDGE":e.search("Chrome/")>=0?t="CHROME":e.search("Trident/")>=0?t="IE":e.search("Firefox/")>=0?t="FIREFOX":e.search("Safari/")>=0&&(t="SAFARI"),t}(),this.listeners=new h,this.serviceProviderProperties={},!("serviceProviderProperties"in t))throw new Error("serviceProviderProperties property missing.");this.serviceProviderProperties=t.serviceProviderProperties}return function(e,t,n){t&&G(e.prototype,t),n&&G(e,n)}(e,[{key:"setIntegrationModel",value:function(e){this.integrationModel=e}},{key:"setEnvironment",value:function(e){"editor"in e&&(this.environment.editor=e.editor),"mode"in e&&(this.environment.mode=e.mode),"version"in e&&(this.environment.version=e.version)}},{key:"getModalDialog",value:function(){return this.modalDialog}},{key:"init",value:function(){var t=this;if(e.initialized)this.listeners.fire("onLoad",{});else{var n=h.newListener("onInit",function(){var e=g.getService("configurationjs","","get"),n=JSON.parse(e);l.addConfiguration(n),l.addConfiguration(z),w.language=t.language,t.listeners.fire("onLoad",{})});g.addListener(n),g.init(this.serviceProviderProperties),e.initialized=!0}}},{key:"addListener",value:function(e){this.listeners.add(e)}},{key:"beforeUpdateFormula",value:function(t,n){var i=new D;return i.mathml=t,i.wirisProperties={},null!=n&&Object.keys(n).forEach(function(e){i.wirisProperties[e]=n[e]}),i.language=this.language,i.editMode=this.editMode,this.listeners.fire("onBeforeFormulaInsertion",i)?{}:e.globalListeners.fire("onBeforeFormulaInsertion",i)?{}:{mathml:i.mathml,wirisProperties:i.wirisProperties}}},{key:"insertFormula",value:function(e,t,n,i){var o={};if(n)if("latex"===this.editMode){if(o.latex=p.getLatexFromMathML(n),this.integrationModel.fillNonLatexNode&&!o.latex){var r=new D;r.editMode=this.editMode,r.windowTarget=t,r.focusElement=e,r.latex=o.latex,this.integrationModel.fillNonLatexNode(r,t,n)}else o.node=t.document.createTextNode("$$".concat(o.latex,"$$"));this.insertElementOnSelection(o.node,e,t)}else o.node=E.mathmlToImgObject(t.document,n,i,this.language),this.insertElementOnSelection(o.node,e,t);else this.insertElementOnSelection(null,e,t);return o}},{key:"afterUpdateFormula",value:function(t,n,i,o){var r=new D;return r.editMode=this.editMode,r.windowTarget=n,r.focusElement=t,r.node=i,r.latex=o,this.listeners.fire("onAfterFormulaInsertion",r)?{}:(e.globalListeners.fire("onAfterFormulaInsertion",r),{})}},{key:"placeCaretAfterNode",value:function(e){this.integrationModel.getSelection();var t=e.ownerDocument;if(void 0!==t.getSelection&&e.parentElement){var n=t.createRange();n.setStartAfter(e),n.collapse(!0);var i=t.getSelection();i.removeAllRanges(),i.addRange(n),t.body.focus()}}},{key:"insertElementOnSelection",value:function(e,t,n){if(this.editionProperties.isNewElement)if(e)if("textarea"===t.type)y.updateTextArea(t,e.textContent);else if(document.selection&&0===document.getSelection){var i=n.document.selection.createRange();if(n.document.execCommand("InsertImage",!1,e.src),"parentElement"in i||(n.document.execCommand("delete",!1),i=n.document.selection.createRange(),n.document.execCommand("InsertImage",!1,e.src)),"parentElement"in i){var o=i.parentElement();"IMG"===o.nodeName.toUpperCase()?o.parentNode.replaceChild(e,o):i.pasteHTML(y.createObjectCode(e))}}else{var r=this.integrationModel.getSelection(),a=null;this.editionProperties.range?(a=this.editionProperties.range,this.editionProperties.range=null):a=r.getRangeAt(0),a.deleteContents();var s=a.startContainer,l=a.startOffset;3===s.nodeType?(s=s.splitText(l)).parentNode.insertBefore(e,s):1===s.nodeType&&s.insertBefore(e,s.childNodes[l]),this.placeCaretAfterNode(e)}else if("textarea"===t.type)t.focus();else{var c=this.integrationModel.getSelection();if(c.removeAllRanges(),this.editionProperties.range){var u=this.editionProperties.range;this.editionProperties.range=null,c.addRange(u)}}else if(this.editionProperties.latexRange)document.selection&&0===document.getSelection?(this.editionProperties.isNewElement=!0,this.editionProperties.latexRange.select(),this.insertElementOnSelection(e,t,n)):(this.editionProperties.latexRange.deleteContents(),this.editionProperties.latexRange.insertNode(e),this.placeCaretAfterNode(e));else if("textarea"===t.type){var d;d=void 0!==this.integrationModel.getSelectedItem?this.integrationModel.getSelectedItem(t,!1):y.getSelectedItemOnTextarea(t),y.updateExistingTextOnTextarea(t,e.textContent,d.startPosition,d.endPosition)}else e&&"img"===e.nodeName.toLowerCase()?(A.removeImgDataAttributes(this.editionProperties.temporalImage),A.clone(e,this.editionProperties.temporalImage)):this.editionProperties.temporalImage.remove(),this.placeCaretAfterNode(this.editionProperties.temporalImage)}},{key:"openModalDialog",value:function(e,t){var n,i=this;this.editMode="images";try{if(t){e.contentWindow.focus();var o=e.contentWindow.getSelection();this.editionProperties.range=o.getRangeAt(0)}else{e.focus();var r=getSelection();this.editionProperties.range=r.getRangeAt(0)}}catch(e){this.editionProperties.range=null}if(void 0===t&&(t=!0),this.editionProperties.latexRange=null,e)if(n=void 0!==this.integrationModel.getSelectedItem?this.integrationModel.getSelectedItem(e,t):y.getSelectedItem(e,t)){if(!n.caretPosition&&y.containsClass(n.node,l.get("imageClassName")))this.editionProperties.temporalImage=n.node,this.editionProperties.isNewElement=!1;else if(3===n.node.nodeType)if(this.integrationModel.getMathmlFromTextNode){var s=this.integrationModel.getMathmlFromTextNode(n.node,n.caretPosition);s&&(this.editMode="latex",this.editionProperties.isNewElement=!1,this.editionProperties.temporalImage=document.createElement("img"),this.editionProperties.temporalImage.setAttribute(l.get("imageMathmlAttribute"),a.safeXmlEncode(s)))}else{var c=p.getLatexFromTextNode(n.node,n.caretPosition);if(c){var u=p.getMathMLFromLatex(c.latex);this.editMode="latex",this.editionProperties.isNewElement=!1,this.editionProperties.temporalImage=document.createElement("img"),this.editionProperties.temporalImage.setAttribute(l.get("imageMathmlAttribute"),a.safeXmlEncode(u));var d=t?e.contentWindow:window;if("textarea"!==e.tagName.toLowerCase())if(document.selection){for(var m=0,g=c.startNode.previousSibling;g;)m+=y.getNodeLength(g),g=g.previousSibling;this.editionProperties.latexRange=d.document.selection.createRange(),this.editionProperties.latexRange.moveToElementText(c.startNode.parentNode),this.editionProperties.latexRange.move("character",m+c.startPosition),this.editionProperties.latexRange.moveEnd("character",c.latex.length+4)}else this.editionProperties.latexRange=d.document.createRange(),this.editionProperties.latexRange.setStart(c.startNode,c.startPosition),this.editionProperties.latexRange.setEnd(c.endNode,c.endPosition)}}}else"textarea"===e.tagName.toLowerCase()&&(this.editMode="latex");for(var f=l.get("editorAttributes").split(", "),v={},_=0,w=f.length;_<w;_+=1){var b=f[_].split("="),x=b[0],A=b[1];v[x]=A}var C={},k=l.get("editorParameters"),M=this.integrationModel.editorParameters;Object.assign(C,v,k),Object.assign(C,v,M),C.language=this.language,C.rtl=this.integrationModel.rtl;var E={};if(E.editorAttributes=C,E.language=this.language,E.customEditors=this.customEditors,E.environment=this.environment,null==this.modalDialog){this.modalDialog=new q(C),this.contentManager=new P(E);var T=h.newListener("onLoad",function(){if(i.contentManager.isNewElement=i.editionProperties.isNewElement,null!=i.editionProperties.temporalImage){var e=a.safeXmlDecode(i.editionProperties.temporalImage.getAttribute(l.get("imageMathmlAttribute")));i.contentManager.mathML=e}});this.contentManager.addListener(T),this.contentManager.init(),this.modalDialog.setContentManager(this.contentManager),this.contentManager.setModalDialogInstance(this.modalDialog)}else if(this.contentManager.isNewElement=this.editionProperties.isNewElement,null!=this.editionProperties.temporalImage){var I=a.safeXmlDecode(this.editionProperties.temporalImage.getAttribute(l.get("imageMathmlAttribute")));this.contentManager.mathML=I}this.contentManager.setIntegrationModel(this.integrationModel),this.modalDialog.open()}},{key:"getCustomEditors",value:function(){return this.customEditors}}],[{key:"addGlobalListener",value:function(t){e.globalListeners.add(t)}},{key:"globalListeners",get:function(){return e._globalListeners},set:function(t){e._globalListeners=t}},{key:"initialized",get:function(){return e._initialized},set:function(t){e._initialized=t}}]),e}();function ee(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}$._globalListeners=new h,$._initialized=!1;var te=function(){function e(t){var n=this;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.language="en",this.serviceProviderProperties={},"serviceProviderProperties"in t&&(this.serviceProviderProperties=t.serviceProviderProperties),this.configurationService="","configurationService"in t&&(this.serviceProviderProperties.URI=t.configurationService,console.warn("Deprecated property configurationService. Use serviceParameters on instead.",[t.configurationService])),this.version="version"in t?t.version:"",this.target=null,!("target"in t))throw new Error("IntegrationModel constructor error: target property missed.");this.target=t.target,"scriptName"in t&&(this.scriptName=t.scriptName),this.callbackMethodArguments={},"callbackMethodArguments"in t&&(this.callbackMethodArguments=t.callbackMethodArguments),this.environment={},"environment"in t&&(this.environment=t.environment),this.isIframe=!1,null!=this.target&&(this.isIframe="IFRAME"===this.target.tagName.toUpperCase()),this.editorObject=null,"editorObject"in t&&(this.editorObject=t.editorObject),this.rtl=!1,"rtl"in t&&(this.rtl=t.rtl),this.managesLanguage=!1,"managesLanguage"in t&&(this.managesLanguage=t.managesLanguage),this.temporalImageResizing=!1,this.core=null,this.listeners=new h,"integrationParameters"in t&&e.integrationParameters.forEach(function(e){if(e in t.integrationParameters){var i=t.integrationParameters[e];0!==Object.keys(i).length&&(n[e]=i)}})}return function(e,t,n){t&&ee(e.prototype,t),n&&ee(e,n)}(e,[{key:"init",value:function(){var e=this;this.language=this.getLanguage();var t=h.newListener("onLoad",function(){e.callbackFunction(e.callbackMethodArguments)});if(-1!==this.serviceProviderProperties.URI.indexOf("configuration")){var n=this.serviceProviderProperties.URI,i=g.getServerLanguageFromService(n);this.serviceProviderProperties.server=i;var o=this.serviceProviderProperties.URI.indexOf("configuration"),r=this.serviceProviderProperties.URI.substring(0,o);this.serviceProviderProperties.URI=r}var a=this.serviceProviderProperties.URI;a=0===a.indexOf("/")||0===a.indexOf("http")?a:y.concatenateUrl(this.getPath(),a),this.serviceProviderProperties.URI=a;var s={};s.serviceProviderProperties=this.serviceProviderProperties,this.setCore(new $(s)),this.core.addListener(t),this.core.language=this.language,this.core.init(),this.core.setEnvironment(this.environment)}},{key:"getPath",value:function(){if(void 0===this.scriptName)throw new Error("scriptName property needed for getPath.");for(var e=document.getElementsByTagName("script"),t="",n=0;n<e.length;n+=1){var i=e[n].src.lastIndexOf(this.scriptName);i>=0&&(t=e[n].src.substr(0,i-1))}return t}},{key:"getVersion",value:function(){return this.version}},{key:"setLanguage",value:function(e){this.language=e}},{key:"setCore",value:function(e){this.core=e,e.setIntegrationModel(this)}},{key:"getCore",value:function(){return this.core}},{key:"setTarget",value:function(e){this.target=e,this.isIframe="IFRAME"===this.target.tagName.toUpperCase()}},{key:"setEditorObject",value:function(e){this.editorObject=e}},{key:"openNewFormulaEditor",value:function(){this.core.editionProperties.isNewElement=!0,this.core.openModalDialog(this.target,this.isIframe)}},{key:"openExistingFormulaEditor",value:function(){this.core.editionProperties.isNewElement=!1,this.core.openModalDialog(this.target,this.isIframe)}},{key:"updateFormula",value:function(e){var t,n;this.editorParameters&&(e=com.wiris.editor.util.EditorUtils.addAnnotation(e,"application/vnd.wiris.mtweb-params+json",JSON.stringify(this.editorParameters)));this.isIframe?(t=this.target.contentWindow,n=this.target.contentWindow):(t=this.target,n=window);var i=this.core.beforeUpdateFormula(e,null);return i&&(i=this.insertFormula(t,n,i.mathml,i.wirisProperties))?this.core.afterUpdateFormula(i.focusElement,i.windowTarget,i.node,i.latex):""}},{key:"insertFormula",value:function(e,t,n,i){return this.core.insertFormula(e,t,n,i)}},{key:"getSelection",value:function(){return this.isIframe?(this.target.contentWindow.focus(),this.target.contentWindow.getSelection()):(this.target.focus(),window.getSelection())}},{key:"addEvents",value:function(){var e=this,t=this.isIframe?this.target.contentWindow.document:this.target;y.addElementEvents(t,function(t,n){e.doubleClickHandler(t,n)},function(t,n){e.mousedownHandler(t,n)},function(t,n){e.mouseupHandler(t,n)})}},{key:"doubleClickHandler",value:function(e){if("img"===e.nodeName.toLowerCase()){this.core.getCustomEditors().disable();var t=l.get("imageCustomEditorName");if(e.hasAttribute(t)){var n=e.getAttribute(t);this.core.getCustomEditors().enable(n)}y.containsClass(e,l.get("imageClassName"))&&(this.core.editionProperties.temporalImage=e,this.core.editionProperties.isNewElement=!0,this.openExistingFormulaEditor())}}},{key:"mouseupHandler",value:function(){var e=this;this.temporalImageResizing&&setTimeout(function(){A.fixAfterResize(e.temporalImageResizing)},10)}},{key:"mousedownHandler",value:function(e){"img"===e.nodeName.toLowerCase()&&y.containsClass(e,l.get("imageClassName"))&&(this.temporalImageResizing=e)}},{key:"getLanguage",value:function(){return this.getBrowserLanguage()}},{key:"getBrowserLanguage",value:function(){return navigator.userLanguage?navigator.userLanguage.substring(0,2):navigator.language?navigator.language.substring(0,2):"en"}},{key:"callbackFunction",value:function(){var e=this,t=h.newListener("onTargetReady",function(){e.addEvents(e.target)});this.listeners.add(t)}},{key:"notifyWindowClosed",value:function(){}},{key:"getMathmlFromTextNode",value:function(e,t){}},{key:"fillNonLatexNode",value:function(e,t,n){}},{key:"getSelectedItem",value:function(e,t){}}]),e}();function ne(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}te.prototype.getMathmlFromTextNode=void 0,te.prototype.fillNonLatexNode=void 0,te.prototype.getSelectedItem=void 0,te.integrationParameters=["serviceProviderProperties","editorParameters"];var ie=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return function(e,t,n){t&&ne(e.prototype,t),n&&ne(e,n)}(e,null,[{key:"init",value:function(){e.testServices()}},{key:"testServices",value:function(){var e;console.log("Testing configuration service..."),console.log(g.getService("configurationjs","","get")),console.log("Testing showimage service..."),(e=[]).mml='<math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mi>x</mi><mn>2</mn></msup></math>',console.log(g.getService("showimage",e)),console.log("Testing createimage service..."),(e=[]).mml='<math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mi>x</mi><mn>2</mn></msup></math>',console.log(g.getService("createimage",e,"post")),console.log("Testing MathML2Latex service..."),(e=[]).service="mathml2latex",e.mml='<math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mi>x</mi><mn>2</mn></msup></math>',console.log(g.getService("service",e)),console.log("Testing Latex2MathML service..."),(e=[]).service="latex2mathml",e.latex="x^2",console.log(g.getService("service",e)),console.log("Testing Mathml2Accesible service..."),(e=[]).service="mathml2accessible",e.mml='<math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mi>x</mi><mn>2</mn></msup></math>',console.log(g.getService("service",e))}}]),e}();window.WirisPlugin={Core:$,Parser:E,Image:A,MathML:a,Util:y,Configuration:l,Listeners:h,IntegrationModel:te,Latex:p,Test:ie}}]);
\ No newline at end of file
+!function(e){var t={};function n(i){if(t[i])return t[i].exports;var o=t[i]={i:i,l:!1,exports:{}};return e[i].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(i,o,function(t){return e[t]}.bind(null,o));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=7)}([function(e){e.exports=JSON.parse('{"ar":{"latex":"LaTeX","cancel":"إلغاء","accept":"موا�?ق","manual":"الدليل","insert_math":"إدراج صيغة رياضية - MathType","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"ca":{"latex":"LaTeX","cancel":"Cancel·lar","accept":"Acceptar","manual":"Manual","insert_math":"Inserir fórmula matemàtica - MathType","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"cs":{"latex":"LaTeX","cancel":"Storno","accept":"OK","manual":"Příru�?ka","insert_math":"Vložit matematický vzorec - MathType","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"da":{"latex":"LaTeX","cancel":"Annuller","accept":"OK","manual":"Brugervejledning","insert_math":"Indsæt matematisk formel - MathType","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"de":{"latex":"LaTeX","cancel":"Abbrechen","accept":"OK","manual":"Handbuch","insert_math":"Mathematische Formel einfügen - MathType","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"en":{"latex":"LaTeX","cancel":"Cancel","accept":"OK","manual":"Manual","insert_math":"Insert a math equation - MathType","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"es":{"latex":"LaTeX","cancel":"Cancelar","accept":"Aceptar","manual":"Manual","insert_math":"Insertar fórmula matemática - MathType","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"et":{"latex":"LaTeX","cancel":"Loobu","accept":"OK","manual":"Käsiraamat","insert_math":"Lisa matemaatiline valem – WIRIS","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"eu":{"latex":"LaTeX","cancel":"Ezeztatu","accept":"Onartu","manual":"Gida","insert_math":"Txertatu matematikako formula - MathType","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"fi":{"latex":"LaTeX","cancel":"Peruuta","accept":"OK","manual":"Manual","insert_math":"Liitä matemaattinen kaava - MathType","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"fr":{"latex":"LaTeX","cancel":"Annuler","accept":"OK","manual":"Manuel","insert_math":"Insérer une formule mathématique - MathType","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"gl":{"latex":"LaTeX","cancel":"Cancelar","accept":"Aceptar","manual":"Manual","insert_math":"Inserir fórmula matemática - MathType","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"he":{"latex":"LaTeX","cancel":"ביטול","accept":"�?ישור","manual":"מדריך","insert_math":"הוסף נוסחה מתמטית - MathType","insert_chem":"הוספת כתיבה כימית - ChemType","minimize":"מזערי","maximize":"מרבי","fullscreen":"מסך מל�?","exit_fullscreen":"יצי�?ה ממצב מסך מל�?","close":"סגירה","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"ה�?�? לצ�?ת? שינויי�? �?שר בוצעו ימחקו.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" �?יננה פונקציה","exception_invalid_date_format":"תסדיר ת�?ריך �?ינו תקין : ","exception_casting":"ל�? ניתן להמיר ","exception_casting_to":" ל "},"hr":{"latex":"LaTeX","cancel":"Poništi","accept":"U redu","manual":"Priru�?nik","insert_math":"Umetnite matemati�?ku formulu - MathType","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"hu":{"latex":"LaTeX","cancel":"Mégsem","accept":"OK","manual":"Kézikönyv","insert_math":"Matematikai képlet beszúrása - MathType","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"it":{"latex":"LaTeX","cancel":"Annulla","accept":"Accetta","manual":"Manuale","insert_math":"Inserisci una formula matematica - MathType","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"ja":{"latex":"LaTeX","cancel":"キャンセル","accept":"OK","manual":"マニュアル","insert_math":"数�?を挿入 - MathType","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"ko":{"latex":"LaTeX","cancel":"취소","accept":"승�?�","manual":"설명서","insert_math":"수학 공�? 삽입 - MathType","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"nl":{"latex":"LaTeX","cancel":"Annuleren","accept":"OK","manual":"Handleiding","insert_math":"Wiskundige formule invoegen - MathType","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"no":{"latex":"LaTeX","cancel":"Avbryt","accept":"OK","manual":"Håndbok","insert_math":"Sett inn matematikkformel - MathType","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"pl":{"latex":"LaTeX","cancel":"Anuluj","accept":"OK","manual":"Instrukcja","insert_math":"Wstaw formułę matematyczną - MathType","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"pt":{"latex":"LaTeX","cancel":"Cancelar","accept":"OK","manual":"Manual","insert_math":"Inserir fórmula matemática - MathType","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"pt_br":{"latex":"LaTeX","cancel":"Cancelar","accept":"OK","manual":"Manual","insert_math":"Inserir fórmula matemática - MathType","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"ru":{"latex":"LaTeX","cancel":"отмена","accept":"OK","manual":"вручную","insert_math":"В�?тавить математиче�?кую формулу: WIRIS","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"sv":{"latex":"LaTeX","cancel":"Avbryt","accept":"OK","manual":"Bruksanvisning","insert_math":"Infoga matematisk formel - MathType","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"tr":{"latex":"LaTeX","cancel":"Vazgeç","accept":"Tamam","manual":"Kılavuz","insert_math":"Matematik formülü ekle - MathType","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"zh":{"latex":"LaTeX","cancel":"�?�消","accept":"确定","manual":"手册","insert_math":"�?�入数学公�? - MathType","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"el":{"latex":"LaTeX","cancel":"Άκυ�?ο","accept":"ΟΚ","manual":"Χει�?οκίνητα","insert_math":"Εισαγωγή μαθηματικο�? τ�?που - MathType","insert_chem":"Insert a chemistry formula - ChemType","minimize":"Minimize","maximize":"Maximize","fullscreen":"Full-screen","exit_fullscreen":"Exit full-screen","close":"Close","mathtype":"MathType","title_modalwindow":"MathType modal window","close_modal_warning":"Are you sure you want to leave? The changes you made will be lost.","latex_name_label":"Latex Formula","browser_no_compatible":"Your browser is not compatible with AJAX technology. Please, use the latest version of Mozilla Firefox.","error_convert_accessibility":"Error converting from MathML to accessible text.","exception_cross_site":"Cross site scripting is only allowed for HTTP.","exception_high_surrogate":"High surrogate not followed by low surrogate in fixedCharCodeAt()","exception_string_length":"Invalid string. Length must be a multiple of 4","exception_key_nonobject":"Object.keys called on non-object","exception_null_or_undefined":" this is null or not defined","exception_not_function":" is not a function","exception_invalid_date_format":"Invalid date format : ","exception_casting":"Cannot cast ","exception_casting_to":" to "},"":{}}')},function(module,__webpack_exports__,__webpack_require__){"use strict";function _typeof(e){"@babel/helpers - typeof";return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var md5,_unused_webpack_default_export=md5;!function(){var HxOverrides=function(){};HxOverrides.__name__=!0,HxOverrides.dateStr=function(e){var t=e.getMonth()+1,n=e.getDate(),i=e.getHours(),o=e.getMinutes(),r=e.getSeconds();return e.getFullYear()+"-"+(t<10?"0"+t:""+t)+"-"+(n<10?"0"+n:""+n)+" "+(i<10?"0"+i:""+i)+":"+(o<10?"0"+o:""+o)+":"+(r<10?"0"+r:""+r)},HxOverrides.strDate=function(e){switch(e.length){case 8:var t=e.split(":"),n=new Date;return n.setTime(0),n.setUTCHours(t[0]),n.setUTCMinutes(t[1]),n.setUTCSeconds(t[2]),n;case 10:t=e.split("-");return new Date(t[0],t[1]-1,t[2],0,0,0);case 19:var i=(t=e.split(" "))[0].split("-"),o=t[1].split(":");return new Date(i[0],i[1]-1,i[2],o[0],o[1],o[2]);default:throw"Invalid date format : "+e}},HxOverrides.cca=function(e,t){var n=e.charCodeAt(t);if(n==n)return n},HxOverrides.substr=function(e,t,n){return null!=t&&0!=t&&null!=n&&n<0?"":(null==n&&(n=e.length),t<0?(t=e.length+t)<0&&(t=0):n<0&&(n=e.length+n-t),e.substr(t,n))},HxOverrides.remove=function(e,t){for(var n=0,i=e.length;n<i;){if(e[n]==t)return e.splice(n,1),!0;n++}return!1},HxOverrides.iter=function(e){return{cur:0,arr:e,hasNext:function(){return this.cur<this.arr.length},next:function(){return this.arr[this.cur++]}}};var IntIter=function(e,t){this.min=e,this.max=t};IntIter.__name__=!0,IntIter.prototype={next:function(){return this.min++},hasNext:function(){return this.min<this.max},__class__:IntIter};var Std=function(){};Std.__name__=!0,Std.is=function(e,t){return js.Boot.__instanceof(e,t)},Std.string=function(e){return js.Boot.__string_rec(e,"")},Std.int=function(e){return 0|e},Std.parseInt=function(e){var t=parseInt(e,10);return 0!=t||120!=HxOverrides.cca(e,1)&&88!=HxOverrides.cca(e,1)||(t=parseInt(e)),isNaN(t)?null:t},Std.parseFloat=function(e){return parseFloat(e)},Std.random=function(e){return Math.floor(Math.random()*e)};var com=com||{};com.wiris||(com.wiris={}),com.wiris.js||(com.wiris.js={}),com.wiris.js.JsPluginTools=function(){this.tryReady()},com.wiris.js.JsPluginTools.__name__=!0,com.wiris.js.JsPluginTools.main=function(){var e;e=com.wiris.js.JsPluginTools.getInstance(),haxe.Timer.delay($bind(e,e.tryReady),100)},com.wiris.js.JsPluginTools.getInstance=function(){return null==com.wiris.js.JsPluginTools.instance&&(com.wiris.js.JsPluginTools.instance=new com.wiris.js.JsPluginTools),com.wiris.js.JsPluginTools.instance},com.wiris.js.JsPluginTools.bypassEncapsulation=function(){null==window.com&&(window.com={}),null==window.com.wiris&&(window.com.wiris={}),null==window.com.wiris.js&&(window.com.wiris.js={}),null==window.com.wiris.js.JsPluginTools&&(window.com.wiris.js.JsPluginTools=com.wiris.js.JsPluginTools.getInstance())},com.wiris.js.JsPluginTools.prototype={md5encode:function(e){return haxe.Md5.encode(e)},doLoad:function(){this.ready=!0,com.wiris.js.JsPluginTools.instance=this,com.wiris.js.JsPluginTools.bypassEncapsulation()},tryReady:function(){this.ready=!1,js.Lib.document.readyState&&(this.doLoad(),this.ready=!0),this.ready||haxe.Timer.delay($bind(this,this.tryReady),100)},__class__:com.wiris.js.JsPluginTools};var haxe=haxe||{};haxe.Log=function(){},haxe.Log.__name__=!0,haxe.Log.trace=function(e,t){js.Boot.__trace(e,t)},haxe.Log.clear=function(){js.Boot.__clear_trace()},haxe.Md5=function(){},haxe.Md5.__name__=!0,haxe.Md5.encode=function(e){return(new haxe.Md5).doEncode(e)},haxe.Md5.prototype={doEncode:function(e){for(var t=this.str2blks(e),n=1732584193,i=-271733879,o=-1732584194,r=271733878,a=0;a<t.length;){var s=n,l=i,c=o,u=r;0,n=this.ff(n,i,o,r,t[a],7,-680876936),r=this.ff(r,n,i,o,t[a+1],12,-389564586),o=this.ff(o,r,n,i,t[a+2],17,606105819),i=this.ff(i,o,r,n,t[a+3],22,-1044525330),n=this.ff(n,i,o,r,t[a+4],7,-176418897),r=this.ff(r,n,i,o,t[a+5],12,1200080426),o=this.ff(o,r,n,i,t[a+6],17,-1473231341),i=this.ff(i,o,r,n,t[a+7],22,-45705983),n=this.ff(n,i,o,r,t[a+8],7,1770035416),r=this.ff(r,n,i,o,t[a+9],12,-1958414417),o=this.ff(o,r,n,i,t[a+10],17,-42063),i=this.ff(i,o,r,n,t[a+11],22,-1990404162),n=this.ff(n,i,o,r,t[a+12],7,1804603682),r=this.ff(r,n,i,o,t[a+13],12,-40341101),o=this.ff(o,r,n,i,t[a+14],17,-1502002290),i=this.ff(i,o,r,n,t[a+15],22,1236535329),n=this.gg(n,i,o,r,t[a+1],5,-165796510),r=this.gg(r,n,i,o,t[a+6],9,-1069501632),o=this.gg(o,r,n,i,t[a+11],14,643717713),i=this.gg(i,o,r,n,t[a],20,-373897302),n=this.gg(n,i,o,r,t[a+5],5,-701558691),r=this.gg(r,n,i,o,t[a+10],9,38016083),o=this.gg(o,r,n,i,t[a+15],14,-660478335),i=this.gg(i,o,r,n,t[a+4],20,-405537848),n=this.gg(n,i,o,r,t[a+9],5,568446438),r=this.gg(r,n,i,o,t[a+14],9,-1019803690),o=this.gg(o,r,n,i,t[a+3],14,-187363961),i=this.gg(i,o,r,n,t[a+8],20,1163531501),n=this.gg(n,i,o,r,t[a+13],5,-1444681467),r=this.gg(r,n,i,o,t[a+2],9,-51403784),o=this.gg(o,r,n,i,t[a+7],14,1735328473),i=this.gg(i,o,r,n,t[a+12],20,-1926607734),n=this.hh(n,i,o,r,t[a+5],4,-378558),r=this.hh(r,n,i,o,t[a+8],11,-2022574463),o=this.hh(o,r,n,i,t[a+11],16,1839030562),i=this.hh(i,o,r,n,t[a+14],23,-35309556),n=this.hh(n,i,o,r,t[a+1],4,-1530992060),r=this.hh(r,n,i,o,t[a+4],11,1272893353),o=this.hh(o,r,n,i,t[a+7],16,-155497632),i=this.hh(i,o,r,n,t[a+10],23,-1094730640),n=this.hh(n,i,o,r,t[a+13],4,681279174),r=this.hh(r,n,i,o,t[a],11,-358537222),o=this.hh(o,r,n,i,t[a+3],16,-722521979),i=this.hh(i,o,r,n,t[a+6],23,76029189),n=this.hh(n,i,o,r,t[a+9],4,-640364487),r=this.hh(r,n,i,o,t[a+12],11,-421815835),o=this.hh(o,r,n,i,t[a+15],16,530742520),i=this.hh(i,o,r,n,t[a+2],23,-995338651),n=this.ii(n,i,o,r,t[a],6,-198630844),r=this.ii(r,n,i,o,t[a+7],10,1126891415),o=this.ii(o,r,n,i,t[a+14],15,-1416354905),i=this.ii(i,o,r,n,t[a+5],21,-57434055),n=this.ii(n,i,o,r,t[a+12],6,1700485571),r=this.ii(r,n,i,o,t[a+3],10,-1894986606),o=this.ii(o,r,n,i,t[a+10],15,-1051523),i=this.ii(i,o,r,n,t[a+1],21,-2054922799),n=this.ii(n,i,o,r,t[a+8],6,1873313359),r=this.ii(r,n,i,o,t[a+15],10,-30611744),o=this.ii(o,r,n,i,t[a+6],15,-1560198380),i=this.ii(i,o,r,n,t[a+13],21,1309151649),n=this.ii(n,i,o,r,t[a+4],6,-145523070),r=this.ii(r,n,i,o,t[a+11],10,-1120210379),o=this.ii(o,r,n,i,t[a+2],15,718787259),i=this.ii(i,o,r,n,t[a+9],21,-343485551),n=this.addme(n,s),i=this.addme(i,l),o=this.addme(o,c),r=this.addme(r,u),a+=16}return this.rhex(n)+this.rhex(i)+this.rhex(o)+this.rhex(r)},ii:function(e,t,n,i,o,r,a){return this.cmn(this.bitXOR(n,this.bitOR(t,~i)),e,t,o,r,a)},hh:function(e,t,n,i,o,r,a){return this.cmn(this.bitXOR(this.bitXOR(t,n),i),e,t,o,r,a)},gg:function(e,t,n,i,o,r,a){return this.cmn(this.bitOR(this.bitAND(t,i),this.bitAND(n,~i)),e,t,o,r,a)},ff:function(e,t,n,i,o,r,a){return this.cmn(this.bitOR(this.bitAND(t,n),this.bitAND(~t,i)),e,t,o,r,a)},cmn:function(e,t,n,i,o,r){return this.addme(this.rol(this.addme(this.addme(t,e),this.addme(i,r)),o),n)},rol:function(e,t){return e<<t|e>>>32-t},str2blks:function(e){for(var t=1+(e.length+8>>6),n=new Array,i=0,o=16*t;i<o;){n[r=i++]=0}for(var r=0;r<e.length;)n[r>>2]|=HxOverrides.cca(e,r)<<(8*e.length+r)%4*8,r++;n[r>>2]|=128<<(8*e.length+r)%4*8;var a=8*e.length,s=16*t-2;return n[s]=255&a,n[s]|=(a>>>8&255)<<8,n[s]|=(a>>>16&255)<<16,n[s]|=(a>>>24&255)<<24,n},rhex:function(e){for(var t="",n=0;n<4;){var i=n++;t+="0123456789abcdef".charAt(e>>8*i+4&15)+"0123456789abcdef".charAt(e>>8*i&15)}return t},addme:function(e,t){var n=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(n>>16)<<16|65535&n},bitAND:function(e,t){return(e>>>1&t>>>1)<<1|1&e&t},bitXOR:function(e,t){return(e>>>1^t>>>1)<<1|1&e^1&t},bitOR:function(e,t){return(e>>>1|t>>>1)<<1|(1&e|1&t)},__class__:haxe.Md5},haxe.Timer=function(e){var t=this;this.id=window.setInterval(function(){t.run()},e)},haxe.Timer.__name__=!0,haxe.Timer.delay=function(e,t){var n=new haxe.Timer(t);return n.run=function(){n.stop(),e()},n},haxe.Timer.measure=function(e,t){var n=haxe.Timer.stamp(),i=e();return haxe.Log.trace(haxe.Timer.stamp()-n+"s",t),i},haxe.Timer.stamp=function(){return(new Date).getTime()/1e3},haxe.Timer.prototype={run:function(){},stop:function(){null!=this.id&&(window.clearInterval(this.id),this.id=null)},__class__:haxe.Timer};var js=js||{},$_;function $bind(e,t){var n=function e(){return e.method.apply(e.scope,arguments)};return n.scope=e,n.method=t,n}js.Boot=function(){},js.Boot.__name__=!0,js.Boot.__unhtml=function(e){return e.split("&").join("&amp;").split("<").join("&lt;").split(">").join("&gt;")},js.Boot.__trace=function(e,t){var n,i=null!=t?t.fileName+":"+t.lineNumber+": ":"";i+=js.Boot.__string_rec(e,""),"undefined"!=typeof document&&null!=(n=document.getElementById("haxe:trace"))?n.innerHTML+=js.Boot.__unhtml(i)+"<br/>":"undefined"!=typeof console&&null!=console.log&&console.log(i)},js.Boot.__clear_trace=function(){var e=document.getElementById("haxe:trace");null!=e&&(e.innerHTML="")},js.Boot.isClass=function(e){return e.__name__},js.Boot.isEnum=function(e){return e.__ename__},js.Boot.getClass=function(e){return e.__class__},js.Boot.__string_rec=function(e,t){if(null==e)return"null";if(t.length>=5)return"<...>";var n=_typeof(e);switch("function"==n&&(e.__name__||e.__ename__)&&(n="object"),n){case"object":if(e instanceof Array){if(e.__enum__){if(2==e.length)return e[0];var i=e[0]+"(";t+="\t";for(var o=2,r=e.length;o<r;){i+=2!=(a=o++)?","+js.Boot.__string_rec(e[a],t):js.Boot.__string_rec(e[a],t)}return i+")"}var a,s=e.length;i="[";t+="\t";for(r=0;r<s;){var l=r++;i+=(l>0?",":"")+js.Boot.__string_rec(e[l],t)}return i+="]"}var c;try{c=e.toString}catch(e){return"???"}if(null!=c&&c!=Object.toString){var u=e.toString();if("[object Object]"!=u)return u}var d=null;i="{\n";t+="\t";var h=null!=e.hasOwnProperty;for(var d in e)h&&!e.hasOwnProperty(d)||"prototype"!=d&&"__class__"!=d&&"__super__"!=d&&"__interfaces__"!=d&&"__properties__"!=d&&(2!=i.length&&(i+=", \n"),i+=t+d+" : "+js.Boot.__string_rec(e[d],t));return i+="\n"+(t=t.substring(1))+"}";case"function":return"<function>";case"string":return e;default:return String(e)}},js.Boot.__interfLoop=function(e,t){if(null==e)return!1;if(e==t)return!0;var n=e.__interfaces__;if(null!=n)for(var i=0,o=n.length;i<o;){var r=n[i++];if(r==t||js.Boot.__interfLoop(r,t))return!0}return js.Boot.__interfLoop(e.__super__,t)},js.Boot.__instanceof=function(e,t){try{if(e instanceof t)return t!=Array||null==e.__enum__;if(js.Boot.__interfLoop(e.__class__,t))return!0}catch(e){if(null==t)return!1}switch(t){case Int:return Math.ceil(e%2147483648)===e;case Float:return"number"==typeof e;case Bool:return!0===e||!1===e;case String:return"string"==typeof e;case Dynamic:return!0;default:return null!=e&&(t==Class&&null!=e.__name__||(t==Enum&&null!=e.__ename__||e.__enum__==t))}},js.Boot.__cast=function(e,t){if(js.Boot.__instanceof(e,t))return e;throw"Cannot cast "+Std.string(e)+" to "+Std.string(t)},js.Lib=function(){},js.Lib.__name__=!0,js.Lib.debug=function(){},js.Lib.alert=function(e){alert(js.Boot.__string_rec(e,""))},js.Lib.eval=function(code){return eval(code)},js.Lib.setErrorHandler=function(e){js.Lib.onerror=e},Array.prototype.indexOf&&(HxOverrides.remove=function(e,t){var n=e.indexOf(t);return-1!=n&&(e.splice(n,1),!0)}),Math.__name__=["Math"],Math.NaN=Number.NaN,Math.NEGATIVE_INFINITY=Number.NEGATIVE_INFINITY,Math.POSITIVE_INFINITY=Number.POSITIVE_INFINITY,Math.isFinite=function(e){return isFinite(e)},Math.isNaN=function(e){return isNaN(e)},String.prototype.__class__=String,String.__name__=!0,Array.prototype.__class__=Array,Array.__name__=!0,Date.prototype.__class__=Date,Date.__name__=["Date"];var Int={__name__:["Int"]},Dynamic={__name__:["Dynamic"]},Float=Number;Float.__name__=["Float"];var Bool=Boolean;Bool.__ename__=["Bool"];var Class={__name__:["Class"]},Enum={},Void={__ename__:["Void"]};"undefined"!=typeof document&&(js.Lib.document=document),"undefined"!=typeof window&&(js.Lib.window=window,js.Lib.window.onerror=function(e,t,n){var i=js.Lib.onerror;return null!=i&&i(e,[t+":"+n])}),com.wiris.js.JsPluginTools.main(),delete Array.prototype.__class__}(),function(){var HxOverrides=function(){};HxOverrides.__name__=!0,HxOverrides.dateStr=function(e){var t=e.getMonth()+1,n=e.getDate(),i=e.getHours(),o=e.getMinutes(),r=e.getSeconds();return e.getFullYear()+"-"+(t<10?"0"+t:""+t)+"-"+(n<10?"0"+n:""+n)+" "+(i<10?"0"+i:""+i)+":"+(o<10?"0"+o:""+o)+":"+(r<10?"0"+r:""+r)},HxOverrides.strDate=function(e){switch(e.length){case 8:var t=e.split(":"),n=new Date;return n.setTime(0),n.setUTCHours(t[0]),n.setUTCMinutes(t[1]),n.setUTCSeconds(t[2]),n;case 10:t=e.split("-");return new Date(t[0],t[1]-1,t[2],0,0,0);case 19:var i=(t=e.split(" "))[0].split("-"),o=t[1].split(":");return new Date(i[0],i[1]-1,i[2],o[0],o[1],o[2]);default:throw"Invalid date format : "+e}},HxOverrides.cca=function(e,t){var n=e.charCodeAt(t);if(n==n)return n},HxOverrides.substr=function(e,t,n){return null!=t&&0!=t&&null!=n&&n<0?"":(null==n&&(n=e.length),t<0?(t=e.length+t)<0&&(t=0):n<0&&(n=e.length+n-t),e.substr(t,n))},HxOverrides.remove=function(e,t){for(var n=0,i=e.length;n<i;){if(e[n]==t)return e.splice(n,1),!0;n++}return!1},HxOverrides.iter=function(e){return{cur:0,arr:e,hasNext:function(){return this.cur<this.arr.length},next:function(){return this.arr[this.cur++]}}};var IntIter=function(e,t){this.min=e,this.max=t};IntIter.__name__=!0,IntIter.prototype={next:function(){return this.min++},hasNext:function(){return this.min<this.max},__class__:IntIter};var Std=function(){};Std.__name__=!0,Std.is=function(e,t){return js.Boot.__instanceof(e,t)},Std.string=function(e){return js.Boot.__string_rec(e,"")},Std.int=function(e){return 0|e},Std.parseInt=function(e){var t=parseInt(e,10);return 0!=t||120!=HxOverrides.cca(e,1)&&88!=HxOverrides.cca(e,1)||(t=parseInt(e)),isNaN(t)?null:t},Std.parseFloat=function(e){return parseFloat(e)},Std.random=function(e){return Math.floor(Math.random()*e)};var com=com||{};com.wiris||(com.wiris={}),com.wiris.js||(com.wiris.js={}),com.wiris.js.JsPluginTools=function(){this.tryReady()},com.wiris.js.JsPluginTools.__name__=!0,com.wiris.js.JsPluginTools.main=function(){var e;e=com.wiris.js.JsPluginTools.getInstance(),haxe.Timer.delay($bind(e,e.tryReady),100)},com.wiris.js.JsPluginTools.getInstance=function(){return null==com.wiris.js.JsPluginTools.instance&&(com.wiris.js.JsPluginTools.instance=new com.wiris.js.JsPluginTools),com.wiris.js.JsPluginTools.instance},com.wiris.js.JsPluginTools.bypassEncapsulation=function(){null==window.com&&(window.com={}),null==window.com.wiris&&(window.com.wiris={}),null==window.com.wiris.js&&(window.com.wiris.js={}),null==window.com.wiris.js.JsPluginTools&&(window.com.wiris.js.JsPluginTools=com.wiris.js.JsPluginTools.getInstance())},com.wiris.js.JsPluginTools.prototype={md5encode:function(e){return haxe.Md5.encode(e)},doLoad:function(){this.ready=!0,com.wiris.js.JsPluginTools.instance=this,com.wiris.js.JsPluginTools.bypassEncapsulation()},tryReady:function(){this.ready=!1,js.Lib.document.readyState&&(this.doLoad(),this.ready=!0),this.ready||haxe.Timer.delay($bind(this,this.tryReady),100)},__class__:com.wiris.js.JsPluginTools};var haxe=haxe||{};haxe.Log=function(){},haxe.Log.__name__=!0,haxe.Log.trace=function(e,t){js.Boot.__trace(e,t)},haxe.Log.clear=function(){js.Boot.__clear_trace()},haxe.Md5=function(){},haxe.Md5.__name__=!0,haxe.Md5.encode=function(e){return(new haxe.Md5).doEncode(e)},haxe.Md5.prototype={doEncode:function(e){for(var t=this.str2blks(e),n=1732584193,i=-271733879,o=-1732584194,r=271733878,a=0;a<t.length;){var s=n,l=i,c=o,u=r;0,n=this.ff(n,i,o,r,t[a],7,-680876936),r=this.ff(r,n,i,o,t[a+1],12,-389564586),o=this.ff(o,r,n,i,t[a+2],17,606105819),i=this.ff(i,o,r,n,t[a+3],22,-1044525330),n=this.ff(n,i,o,r,t[a+4],7,-176418897),r=this.ff(r,n,i,o,t[a+5],12,1200080426),o=this.ff(o,r,n,i,t[a+6],17,-1473231341),i=this.ff(i,o,r,n,t[a+7],22,-45705983),n=this.ff(n,i,o,r,t[a+8],7,1770035416),r=this.ff(r,n,i,o,t[a+9],12,-1958414417),o=this.ff(o,r,n,i,t[a+10],17,-42063),i=this.ff(i,o,r,n,t[a+11],22,-1990404162),n=this.ff(n,i,o,r,t[a+12],7,1804603682),r=this.ff(r,n,i,o,t[a+13],12,-40341101),o=this.ff(o,r,n,i,t[a+14],17,-1502002290),i=this.ff(i,o,r,n,t[a+15],22,1236535329),n=this.gg(n,i,o,r,t[a+1],5,-165796510),r=this.gg(r,n,i,o,t[a+6],9,-1069501632),o=this.gg(o,r,n,i,t[a+11],14,643717713),i=this.gg(i,o,r,n,t[a],20,-373897302),n=this.gg(n,i,o,r,t[a+5],5,-701558691),r=this.gg(r,n,i,o,t[a+10],9,38016083),o=this.gg(o,r,n,i,t[a+15],14,-660478335),i=this.gg(i,o,r,n,t[a+4],20,-405537848),n=this.gg(n,i,o,r,t[a+9],5,568446438),r=this.gg(r,n,i,o,t[a+14],9,-1019803690),o=this.gg(o,r,n,i,t[a+3],14,-187363961),i=this.gg(i,o,r,n,t[a+8],20,1163531501),n=this.gg(n,i,o,r,t[a+13],5,-1444681467),r=this.gg(r,n,i,o,t[a+2],9,-51403784),o=this.gg(o,r,n,i,t[a+7],14,1735328473),i=this.gg(i,o,r,n,t[a+12],20,-1926607734),n=this.hh(n,i,o,r,t[a+5],4,-378558),r=this.hh(r,n,i,o,t[a+8],11,-2022574463),o=this.hh(o,r,n,i,t[a+11],16,1839030562),i=this.hh(i,o,r,n,t[a+14],23,-35309556),n=this.hh(n,i,o,r,t[a+1],4,-1530992060),r=this.hh(r,n,i,o,t[a+4],11,1272893353),o=this.hh(o,r,n,i,t[a+7],16,-155497632),i=this.hh(i,o,r,n,t[a+10],23,-1094730640),n=this.hh(n,i,o,r,t[a+13],4,681279174),r=this.hh(r,n,i,o,t[a],11,-358537222),o=this.hh(o,r,n,i,t[a+3],16,-722521979),i=this.hh(i,o,r,n,t[a+6],23,76029189),n=this.hh(n,i,o,r,t[a+9],4,-640364487),r=this.hh(r,n,i,o,t[a+12],11,-421815835),o=this.hh(o,r,n,i,t[a+15],16,530742520),i=this.hh(i,o,r,n,t[a+2],23,-995338651),n=this.ii(n,i,o,r,t[a],6,-198630844),r=this.ii(r,n,i,o,t[a+7],10,1126891415),o=this.ii(o,r,n,i,t[a+14],15,-1416354905),i=this.ii(i,o,r,n,t[a+5],21,-57434055),n=this.ii(n,i,o,r,t[a+12],6,1700485571),r=this.ii(r,n,i,o,t[a+3],10,-1894986606),o=this.ii(o,r,n,i,t[a+10],15,-1051523),i=this.ii(i,o,r,n,t[a+1],21,-2054922799),n=this.ii(n,i,o,r,t[a+8],6,1873313359),r=this.ii(r,n,i,o,t[a+15],10,-30611744),o=this.ii(o,r,n,i,t[a+6],15,-1560198380),i=this.ii(i,o,r,n,t[a+13],21,1309151649),n=this.ii(n,i,o,r,t[a+4],6,-145523070),r=this.ii(r,n,i,o,t[a+11],10,-1120210379),o=this.ii(o,r,n,i,t[a+2],15,718787259),i=this.ii(i,o,r,n,t[a+9],21,-343485551),n=this.addme(n,s),i=this.addme(i,l),o=this.addme(o,c),r=this.addme(r,u),a+=16}return this.rhex(n)+this.rhex(i)+this.rhex(o)+this.rhex(r)},ii:function(e,t,n,i,o,r,a){return this.cmn(this.bitXOR(n,this.bitOR(t,~i)),e,t,o,r,a)},hh:function(e,t,n,i,o,r,a){return this.cmn(this.bitXOR(this.bitXOR(t,n),i),e,t,o,r,a)},gg:function(e,t,n,i,o,r,a){return this.cmn(this.bitOR(this.bitAND(t,i),this.bitAND(n,~i)),e,t,o,r,a)},ff:function(e,t,n,i,o,r,a){return this.cmn(this.bitOR(this.bitAND(t,n),this.bitAND(~t,i)),e,t,o,r,a)},cmn:function(e,t,n,i,o,r){return this.addme(this.rol(this.addme(this.addme(t,e),this.addme(i,r)),o),n)},rol:function(e,t){return e<<t|e>>>32-t},str2blks:function(e){for(var t=1+(e.length+8>>6),n=new Array,i=0,o=16*t;i<o;){n[r=i++]=0}for(var r=0;r<e.length;)n[r>>2]|=HxOverrides.cca(e,r)<<(8*e.length+r)%4*8,r++;n[r>>2]|=128<<(8*e.length+r)%4*8;var a=8*e.length,s=16*t-2;return n[s]=255&a,n[s]|=(a>>>8&255)<<8,n[s]|=(a>>>16&255)<<16,n[s]|=(a>>>24&255)<<24,n},rhex:function(e){for(var t="",n=0;n<4;){var i=n++;t+="0123456789abcdef".charAt(e>>8*i+4&15)+"0123456789abcdef".charAt(e>>8*i&15)}return t},addme:function(e,t){var n=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(n>>16)<<16|65535&n},bitAND:function(e,t){return(e>>>1&t>>>1)<<1|1&e&t},bitXOR:function(e,t){return(e>>>1^t>>>1)<<1|1&e^1&t},bitOR:function(e,t){return(e>>>1|t>>>1)<<1|(1&e|1&t)},__class__:haxe.Md5},haxe.Timer=function(e){var t=this;this.id=window.setInterval(function(){t.run()},e)},haxe.Timer.__name__=!0,haxe.Timer.delay=function(e,t){var n=new haxe.Timer(t);return n.run=function(){n.stop(),e()},n},haxe.Timer.measure=function(e,t){var n=haxe.Timer.stamp(),i=e();return haxe.Log.trace(haxe.Timer.stamp()-n+"s",t),i},haxe.Timer.stamp=function(){return(new Date).getTime()/1e3},haxe.Timer.prototype={run:function(){},stop:function(){null!=this.id&&(window.clearInterval(this.id),this.id=null)},__class__:haxe.Timer};var js=js||{},$_;function $bind(e,t){var n=function e(){return e.method.apply(e.scope,arguments)};return n.scope=e,n.method=t,n}js.Boot=function(){},js.Boot.__name__=!0,js.Boot.__unhtml=function(e){return e.split("&").join("&amp;").split("<").join("&lt;").split(">").join("&gt;")},js.Boot.__trace=function(e,t){var n,i=null!=t?t.fileName+":"+t.lineNumber+": ":"";i+=js.Boot.__string_rec(e,""),"undefined"!=typeof document&&null!=(n=document.getElementById("haxe:trace"))?n.innerHTML+=js.Boot.__unhtml(i)+"<br/>":"undefined"!=typeof console&&null!=console.log&&console.log(i)},js.Boot.__clear_trace=function(){var e=document.getElementById("haxe:trace");null!=e&&(e.innerHTML="")},js.Boot.isClass=function(e){return e.__name__},js.Boot.isEnum=function(e){return e.__ename__},js.Boot.getClass=function(e){return e.__class__},js.Boot.__string_rec=function(e,t){if(null==e)return"null";if(t.length>=5)return"<...>";var n=_typeof(e);switch("function"==n&&(e.__name__||e.__ename__)&&(n="object"),n){case"object":if(e instanceof Array){if(e.__enum__){if(2==e.length)return e[0];var i=e[0]+"(";t+="\t";for(var o=2,r=e.length;o<r;){i+=2!=(a=o++)?","+js.Boot.__string_rec(e[a],t):js.Boot.__string_rec(e[a],t)}return i+")"}var a,s=e.length;i="[";t+="\t";for(r=0;r<s;){var l=r++;i+=(l>0?",":"")+js.Boot.__string_rec(e[l],t)}return i+="]"}var c;try{c=e.toString}catch(e){return"???"}if(null!=c&&c!=Object.toString){var u=e.toString();if("[object Object]"!=u)return u}var d=null;i="{\n";t+="\t";var h=null!=e.hasOwnProperty;for(var d in e)h&&!e.hasOwnProperty(d)||"prototype"!=d&&"__class__"!=d&&"__super__"!=d&&"__interfaces__"!=d&&"__properties__"!=d&&(2!=i.length&&(i+=", \n"),i+=t+d+" : "+js.Boot.__string_rec(e[d],t));return i+="\n"+(t=t.substring(1))+"}";case"function":return"<function>";case"string":return e;default:return String(e)}},js.Boot.__interfLoop=function(e,t){if(null==e)return!1;if(e==t)return!0;var n=e.__interfaces__;if(null!=n)for(var i=0,o=n.length;i<o;){var r=n[i++];if(r==t||js.Boot.__interfLoop(r,t))return!0}return js.Boot.__interfLoop(e.__super__,t)},js.Boot.__instanceof=function(e,t){try{if(e instanceof t)return t!=Array||null==e.__enum__;if(js.Boot.__interfLoop(e.__class__,t))return!0}catch(e){if(null==t)return!1}switch(t){case Int:return Math.ceil(e%2147483648)===e;case Float:return"number"==typeof e;case Bool:return!0===e||!1===e;case String:return"string"==typeof e;case Dynamic:return!0;default:return null!=e&&(t==Class&&null!=e.__name__||(t==Enum&&null!=e.__ename__||e.__enum__==t))}},js.Boot.__cast=function(e,t){if(js.Boot.__instanceof(e,t))return e;throw"Cannot cast "+Std.string(e)+" to "+Std.string(t)},js.Lib=function(){},js.Lib.__name__=!0,js.Lib.debug=function(){},js.Lib.alert=function(e){alert(js.Boot.__string_rec(e,""))},js.Lib.eval=function(code){return eval(code)},js.Lib.setErrorHandler=function(e){js.Lib.onerror=e},Array.prototype.indexOf&&(HxOverrides.remove=function(e,t){var n=e.indexOf(t);return-1!=n&&(e.splice(n,1),!0)}),Math.__name__=["Math"],Math.NaN=Number.NaN,Math.NEGATIVE_INFINITY=Number.NEGATIVE_INFINITY,Math.POSITIVE_INFINITY=Number.POSITIVE_INFINITY,Math.isFinite=function(e){return isFinite(e)},Math.isNaN=function(e){return isNaN(e)},String.prototype.__class__=String,String.__name__=!0,Array.prototype.__class__=Array,Array.__name__=!0,Date.prototype.__class__=Date,Date.__name__=["Date"];var Int={__name__:["Int"]},Dynamic={__name__:["Dynamic"]},Float=Number;Float.__name__=["Float"];var Bool=Boolean;Bool.__ename__=["Bool"];var Class={__name__:["Class"]},Enum={},Void={__ename__:["Void"]};"undefined"!=typeof document&&(js.Lib.document=document),"undefined"!=typeof window&&(js.Lib.window=window,js.Lib.window.onerror=function(e,t,n){var i=js.Lib.onerror;return null!=i&&i(e,[t+":"+n])}),com.wiris.js.JsPluginTools.main()}(),delete Array.prototype.__class__},function(e,t,n){var i=n(3);"string"==typeof i&&(i=[[e.i,i,""]]);var o={hmr:!0,transform:void 0,insertInto:void 0};n(5)(i,o);i.locals&&(e.exports=i.locals)},function(e,t,n){(e.exports=n(4)(!1)).push([e.i,".wrs_modal_overlay {\n    position: fixed;\n    font-family: arial, sans-serif;\n    top: 0;\n    right: 0;\n    left: 0;\n    bottom: 0;\n    background: rgba(0, 0, 0, 0.8);\n    z-index: 999998;\n    opacity: 0.65;\n    pointer-events: auto;\n}\n\n.wrs_modal_overlay.wrs_modal_ios {\n    visibility: hidden;\n    display: none;\n}\n\n.wrs_modal_overlay.wrs_modal_android {\n    visibility: hidden;\n    display: none;\n}\n\n.wrs_modal_overlay.wrs_modal_ios.moodle {\n    position: fixed;\n}\n\n.wrs_modal_overlay.wrs_modal_desktop.wrs_stack {\n    background: rgba(0, 0, 0, 0);\n    display: none;\n}\n\n.wrs_modal_overlay.wrs_modal_desktop.wrs_maximized {\n    background: rgba(0, 0, 0, 0.8);\n}\n\n.wrs_modal_overlay.wrs_modal_desktop.wrs_minimized {\n    background: rgba(0, 0, 0, 0);\n    display: none;\n}\n\n.wrs_modal_overlay.wrs_modal_desktop.wrs_closed {\n    background: rgba(0, 0, 0, 0);\n    display: none;\n}\n\n.wrs_modal_title {\n    color: #fff;\n    padding: 5px 0 5px 10px;\n    -moz-user-select: none;\n    -webkit-user-select: none;\n    -ms-user-select: none;\n    user-select: none;\n    text-align: left;\n}\n\n.wrs_modal_close_button {\n    float: right;\n    cursor: pointer;\n    color: #fff;\n    padding: 5px 10px 5px 0;\n    margin: 10px 7px 0 0;\n    background-repeat: no-repeat;\n}\n\n.wrs_modal_minimize_button {\n    float: right;\n    cursor: pointer;\n    color: #fff;\n    padding: 5px 10px 5px 0;\n    top: inherit;\n    margin: 10px 7px 0 0;\n}\n\n.wrs_modal_stack_button {\n    float: right;\n    cursor: pointer;\n    color: #fff;\n    margin: 10px 7px 0 0;\n    padding: 5px 10px 5px 0;\n    top: inherit;\n}\n\n.wrs_modal_stack_button.wrs_stack {\n    visibility: hidden;\n    margin: 0;\n    padding: 0;\n}\n\n.wrs_modal_stack_button.wrs_minimized {\n    visibility: hidden;\n    margin: 0;\n    padding: 0;\n}\n\n.wrs_modal_maximize_button {\n    float: right;\n    cursor: pointer;\n    color: #fff;\n    margin: 10px 7px 0 0;\n    padding: 5px 10px 5px 0;\n    top: inherit;\n}\n\n.wrs_modal_maximize_button.wrs_maximized {\n    visibility: hidden;\n    margin: 0;\n    padding: 0;\n}\n\n.wrs_modal_wrapper {\n    display: block;\n    margin: 6px;\n}\n\n.wrs_modal_title_bar {\n    display: block;\n    background-color: #778e9a;\n}\n\n.wrs_modal_dialogContainer {\n    border: none;\n    background: #fafafa;\n    z-index: 999999;\n}\n\n.wrs_modal_dialogContainer.wrs_modal_desktop {\n    font-size: 14px;\n}\n\n.wrs_modal_dialogContainer.wrs_modal_desktop.wrs_maximized {\n    position: fixed;\n}\n\n.wrs_modal_dialogContainer.wrs_modal_desktop.wrs_minimized {\n    position: fixed;\n    top: inherit;\n    margin: 0;\n    margin-right: 10px;\n}\n\n.wrs_modal_dialogContainer.wrs_closed {\n    visibility: hidden;\n    display: none;\n    opacity: 0;\n}\n\n\n/* Class that exists but hasn't got css properties defined\n.wrs_modal_dialogContainer.wrs_modal_desktop.wrs_minimized.wrs_drag {} */\n\n.wrs_modal_dialogContainer.wrs_modal_desktop.wrs_stack {\n    position: fixed;\n    bottom: 0;\n    right: 0;\n    box-shadow: rgba(0, 0, 0, 0.5) 0 2px 8px;\n}\n\n.wrs_modal_dialogContainer.wrs_drag {\n    box-shadow: rgba(0, 0, 0, 0.5) 0 2px 8px;\n}\n\n.wrs_modal_dialogContainer.wrs_modal_desktop.wrs_drag {\n    box-shadow: rgba(0, 0, 0, 0.5) 0 2px 8px;\n}\n\n.wrs_modal_dialogContainer.wrs_modal_android {\n    margin: auto;\n    position: fixed;\n    width: 99%;\n    height: 99%;\n    overflow: hidden;\n    transform: translate(50%, -50%);\n    top: 50%;\n    right: 50% !important;\n    position: fixed;\n}\n\n.wrs_modal_dialogContainer.wrs_modal_ios {\n    margin: auto;\n    position: fixed;\n    width: 100%;\n    height: 100%;\n    overflow: hidden;\n    transform: translate(50%, -50%);\n    top: 50%;\n    right: 50% !important;\n    position: fixed;\n}\n\n\n/* Class that exists but hasn't got css properties defined\n.wrs_content_container.wrs_maximized {} */\n\n.wrs_content_container.wrs_minimized {\n    display: none;\n}\n\n/* .wrs_editor {\n    flex-grow: 1;\n} */\n\n.wrs_content_container.wrs_modal_android {\n    width: 100%;\n    flex-grow: 1;\n    display: flex;\n    flex-direction: column;\n}\n\n.wrs_content_container.wrs_modal_android > div:first-child {\n    flex-grow: 1;\n}\n\n.wrs_content_container.wrs_modal_ios > div:first-child {\n    flex-grow: 1;\n}\n\n.wrs_content_container.wrs_modal_desktop > div:first-child {\n    flex-grow: 1;\n}\n\n.wrs_modal_wrapper.wrs_modal_android {\n    margin: auto;\n    display: flex;\n    flex-direction: column;\n    height: 100%;\n    width: 100%;\n}\n\n.wrs_content_container.wrs_modal_desktop {\n    width: 100%;\n    flex-grow: 1;\n    display: flex;\n    flex-direction: column;\n}\n\n.wrs_content_container.wrs_modal_ios {\n    width: 100%;\n    flex-grow: 1;\n    display: flex;\n    flex-direction: column;\n}\n\n.wrs_modal_wrapper.wrs_modal_ios {\n    margin: auto;\n    display: flex;\n    flex-direction: column;\n    height: 100%;\n    width: 100%;\n}\n\n.wrs_virtual_keyboard {\n    height: 100%;\n    width: 100%;\n    top: 0;\n    left: 50%;\n    transform: translate(-50%, 0%);\n}\n\n@media all and (orientation: portrait) {\n    .wrs_modal_dialogContainer.wrs_modal_mobile {\n        width: 100vmin;\n        height: 100vmin;\n        margin: auto;\n        border-width: 0;\n    }\n    .wrs_modal_wrapper.wrs_modal_mobile {\n        width: 100vmin;\n        height: 100vmin;\n        margin: auto;\n    }\n}\n\n@media all and (orientation: landscape) {\n    .wrs_modal_dialogContainer.wrs_modal_mobile {\n        width: 100vmin;\n        height: 100vmin;\n        margin: auto;\n        border-width: 0;\n    }\n    .wrs_modal_wrapper.wrs_modal_mobile {\n        width: 100vmin;\n        height: 100vmin;\n        margin: auto;\n    }\n}\n\n.wrs_modal_dialogContainer.wrs_modal_badStock {\n    width: 100%;\n    height: 280px;\n    margin: 0 auto;\n    border-width: 0;\n}\n\n.wrs_modal_wrapper.wrs_modal_badStock {\n    width: 100%;\n    height: 280px;\n    margin: 0 auto;\n    border-width: 0;\n}\n.wrs_noselect {\n    -moz-user-select: none;\n    -khtml-user-select: none;\n    -webkit-user-select: none;\n    -ms-user-select: none;\n    user-select: none;\n}\n.wrs_bottom_right_resizer {\n    width: 10px;\n    height: 10px;\n    color: #778e9a;\n    position: absolute;\n    right: 4px;\n    bottom: 8px;\n    cursor: se-resize;\n    -moz-user-select: none;\n    -webkit-user-select: none;\n    -ms-user-select: none;\n    user-select: none;\n}\n.wrs_bottom_left_resizer {\n    width: 15px;\n    height: 15px;\n    color: #778e9a;\n    position: absolute;\n    left: 0;\n    top: 0;\n    cursor: se-resize;\n}\n\n.wrs_modal_controls {\n    height: 42px;\n    margin: 3px 0;\n    overflow: hidden;\n    line-height: normal;\n}\n\n.wrs_modal_links {\n    margin: 10px auto;\n    margin-bottom: 0;\n    font-family: arial, sans-serif;\n    padding: 6px;\n    display: inline;\n    float: right;\n    text-align: right;\n}\n\n.wrs_modal_links > a {\n    text-decoration: none;\n    color: #778e9a;\n    font-size: 16px;\n}\n\n.wrs_modal_button_cancel,\n.wrs_modal_button_cancel:hover,\n.wrs_modal_button_cancel:visited,\n.wrs_modal_button_cancel:active,\n.wrs_modal_button_cancel:focus {\n    min-width: 80px;\n    font-size: 14px;\n    border-radius: 3px;\n    border: 1px solid #778e9a;\n    padding: 6px 8px;\n    margin: 10px auto;\n    margin-left: 5px;\n    margin-bottom: 0;\n    cursor: pointer;\n    font-family: arial, sans-serif;\n    background-color: #DDDDDD;\n    height: 32px;\n}\n\n.wrs_modal_button_accept,\n.wrs_modal_button_accept:hover,\n.wrs_modal_button_accept:visited,\n.wrs_modal_button_accept:active,\n.wrs_modal_button_accept:focus {\n    min-width: 80px;\n    font-size: 14px;\n    border-radius: 3px;\n    border: 1px solid #778e9a;\n    padding: 6px 8px;\n    margin: 10px auto;\n    margin-right: 5px;\n    margin-bottom: 0;\n    color: #fff;\n    background: #778e9a;\n    cursor: pointer;\n    font-family: arial, sans-serif;\n    height: 32px;\n}\n\n.wrs_editor_vertical_bar {\n    height: 20px;\n    float: right;\n    background: none;\n    width: 20px;\n    cursor: pointer;\n}\n\n.wrs_modal_buttons_container {\n    display: inline;\n    float: left;\n}\n\n.wrs_modal_buttons_container.wrs_modalAndroid {\n    padding-left: 6px;\n}\n\n.wrs_modal_buttons_container.wrs_modalDesktop {\n    padding-left: 0;\n}\n\n.wrs_modal_buttons_container > button {\n    line-height: normal;\n    background-image: none;\n}\n\n.wrs_modal_wrapper {\n    margin: 6px;\n    display: flex;\n    flex-direction: column;\n}\n\n.wrs_modal_wrapper.wrs_modal_desktop.wrs_minimized {\n    display: none;\n}\n\n@media only screen and (max-device-width: 480px) and (orientation: portrait) {\n    #wrs_modal_wrapper {\n        width: 140%;\n    }\n}\n\n.wrs_popupmessage_overlay_envolture {\n    display: none;\n    width: 100%;\n}\n.wrs_popupmessage_overlay {\n    position: absolute;\n    width: 100%;\n    height: 100%;\n    top: 0;\n    left: 0;\n    right: 0;\n    bottom: 0;\n    background-color: rgba(0, 0, 0, 0.5);\n    z-index: 4;\n    cursor: pointer;\n}\n.wrs_popupmessage_panel {\n    top: 50%;\n    left: 50%;\n    transform: translate(-50%, -50%);\n    position: absolute;\n    background: white;\n    max-width: 500px;\n    width: 75%;\n    border-radius: 2px;\n    padding: 20px;\n    font-family: sans-serif;\n    font-size: 15px;\n    text-align: left;\n    color: #2e2e2e;\n    z-index: 5;\n    max-height: 75%;\n    overflow: auto;\n}\n\n.wrs_popupmessage_button_area {\n    margin: 10px 0 0 0;\n}\n\n.wrs_panelContainer * {\n    border: 0;\n}\n\n.wrs_button_cancel,\n.wrs_button_cancel:hover,\n.wrs_button_cancel:visited,\n.wrs_button_cancel:active,\n.wrs_button_cancel:focus {\n    min-width: 80px;\n    font-size: 14px;\n    border-radius: 3px;\n    border: 1px solid #778e9a;\n    padding: 6px 8px;\n    margin: 10px auto;\n    margin-left: 5px;\n    margin-bottom: 0;\n    cursor: pointer;\n    font-family: arial, sans-serif;\n    background-color: #DDDDDD;\n    background-image: none;\n    height: 32px;\n}\n\n.wrs_button_accept,\n.wrs_button_accept:hover,\n.wrs_button_accept:visited,\n.wrs_button_accept:active,\n.wrs_button_accept:focus {\n    min-width: 80px;\n    font-size: 14px;\n    border-radius: 3px;\n    border: 1px solid #778e9a;\n    padding: 6px 8px;\n    margin: 10px auto;\n    margin-right: 5px;\n    margin-bottom: 0;\n    color: #fff;\n    background: #778e9a;\n    cursor: pointer;\n    font-family: arial, sans-serif;\n    height: 32px;\n}\n\n.wrs_editor button{\n    box-shadow: none;\n}\n\n.wrs_editor .wrs_header button{\n    border-bottom: none;\n    border-bottom-left-radius: 0;\n    border-bottom-right-radius: 0;\n}\n\n.wrs_modal_overlay.wrs_modal_desktop.wrs_stack.wrs_overlay_active {\n    display: block;\n}\n/* Fix selection in drupal style */\n.wrs_toolbar tr:focus{\n    background: none;\n}\n.wrs_toolbar tr:hover{\n    background: none;\n}\n/* End of fix drupal */\n.wrs_modal_rtl .wrs_modal_button_cancel {\n    margin-right: 5px;\n    margin-left: 0;\n}\n.wrs_modal_rtl .wrs_modal_button_accept {\n    margin-right: 0;\n    margin-left: 5px;\n}\n.wrs_modal_rtl .wrs_button_cancel {\n    margin-right: 5px;\n    margin-left: 0;\n}\n.wrs_modal_rtl .wrs_button_accept {\n    margin-right: 0;\n    margin-left: 5px;\n}\n",""])},function(e,t){e.exports=function(e){var t=[];return t.toString=function(){return this.map(function(t){var n=function(e,t){var n=e[1]||"",i=e[3];if(!i)return n;if(t&&"function"==typeof btoa){var o=function(e){return"/*# sourceMappingURL=data:application/json;charset=utf-8;base64,"+btoa(unescape(encodeURIComponent(JSON.stringify(e))))+" */"}(i),r=i.sources.map(function(e){return"/*# sourceURL="+i.sourceRoot+e+" */"});return[n].concat(r).concat([o]).join("\n")}return[n].join("\n")}(t,e);return t[2]?"@media "+t[2]+"{"+n+"}":n}).join("")},t.i=function(e,n){"string"==typeof e&&(e=[[null,e,""]]);for(var i={},o=0;o<this.length;o++){var r=this[o][0];"number"==typeof r&&(i[r]=!0)}for(o=0;o<e.length;o++){var a=e[o];"number"==typeof a[0]&&i[a[0]]||(n&&!a[2]?a[2]=n:n&&(a[2]="("+a[2]+") and ("+n+")"),t.push(a))}},t}},function(e,t,n){var i={},o=function(e){var t;return function(){return void 0===t&&(t=e.apply(this,arguments)),t}}(function(){return window&&document&&document.all&&!window.atob}),r=function(e){var t={};return function(e,n){if("function"==typeof e)return e();if(void 0===t[e]){var i=function(e,t){return t?t.querySelector(e):document.querySelector(e)}.call(this,e,n);if(window.HTMLIFrameElement&&i instanceof window.HTMLIFrameElement)try{i=i.contentDocument.head}catch(e){i=null}t[e]=i}return t[e]}}(),a=null,s=0,l=[],c=n(6);function u(e,t){for(var n=0;n<e.length;n++){var o=e[n],r=i[o.id];if(r){r.refs++;for(var a=0;a<r.parts.length;a++)r.parts[a](o.parts[a]);for(;a<o.parts.length;a++)r.parts.push(p(o.parts[a],t))}else{var s=[];for(a=0;a<o.parts.length;a++)s.push(p(o.parts[a],t));i[o.id]={id:o.id,refs:1,parts:s}}}}function d(e,t){for(var n=[],i={},o=0;o<e.length;o++){var r=e[o],a=t.base?r[0]+t.base:r[0],s={css:r[1],media:r[2],sourceMap:r[3]};i[a]?i[a].parts.push(s):n.push(i[a]={id:a,parts:[s]})}return n}function h(e,t){var n=r(e.insertInto);if(!n)throw new Error("Couldn't find a style target. This probably means that the value for the 'insertInto' parameter is invalid.");var i=l[l.length-1];if("top"===e.insertAt)i?i.nextSibling?n.insertBefore(t,i.nextSibling):n.appendChild(t):n.insertBefore(t,n.firstChild),l.push(t);else if("bottom"===e.insertAt)n.appendChild(t);else{if("object"!=typeof e.insertAt||!e.insertAt.before)throw new Error("[Style Loader]\n\n Invalid value for parameter 'insertAt' ('options.insertAt') found.\n Must be 'top', 'bottom', or Object.\n (https://github.com/webpack-contrib/style-loader#insertat)\n");var o=r(e.insertAt.before,n);n.insertBefore(t,o)}}function m(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e);var t=l.indexOf(e);t>=0&&l.splice(t,1)}function g(e){var t=document.createElement("style");if(void 0===e.attrs.type&&(e.attrs.type="text/css"),void 0===e.attrs.nonce){var i=function(){0;return n.nc}();i&&(e.attrs.nonce=i)}return f(t,e.attrs),h(e,t),t}function f(e,t){Object.keys(t).forEach(function(n){e.setAttribute(n,t[n])})}function p(e,t){var n,i,o,r;if(t.transform&&e.css){if(!(r="function"==typeof t.transform?t.transform(e.css):t.transform.default(e.css)))return function(){};e.css=r}if(t.singleton){var l=s++;n=a||(a=g(t)),i=v.bind(null,n,l,!1),o=v.bind(null,n,l,!0)}else e.sourceMap&&"function"==typeof URL&&"function"==typeof URL.createObjectURL&&"function"==typeof URL.revokeObjectURL&&"function"==typeof Blob&&"function"==typeof btoa?(n=function(e){var t=document.createElement("link");return void 0===e.attrs.type&&(e.attrs.type="text/css"),e.attrs.rel="stylesheet",f(t,e.attrs),h(e,t),t}(t),i=function(e,t,n){var i=n.css,o=n.sourceMap,r=void 0===t.convertToAbsoluteUrls&&o;(t.convertToAbsoluteUrls||r)&&(i=c(i));o&&(i+="\n/*# sourceMappingURL=data:application/json;base64,"+btoa(unescape(encodeURIComponent(JSON.stringify(o))))+" */");var a=new Blob([i],{type:"text/css"}),s=e.href;e.href=URL.createObjectURL(a),s&&URL.revokeObjectURL(s)}.bind(null,n,t),o=function(){m(n),n.href&&URL.revokeObjectURL(n.href)}):(n=g(t),i=function(e,t){var n=t.css,i=t.media;i&&e.setAttribute("media",i);if(e.styleSheet)e.styleSheet.cssText=n;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(n))}}.bind(null,n),o=function(){m(n)});return i(e),function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap)return;i(e=t)}else o()}}e.exports=function(e,t){if("undefined"!=typeof DEBUG&&DEBUG&&"object"!=typeof document)throw new Error("The style-loader cannot be used in a non-browser environment");(t=t||{}).attrs="object"==typeof t.attrs?t.attrs:{},t.singleton||"boolean"==typeof t.singleton||(t.singleton=o()),t.insertInto||(t.insertInto="head"),t.insertAt||(t.insertAt="bottom");var n=d(e,t);return u(n,t),function(e){for(var o=[],r=0;r<n.length;r++){var a=n[r];(s=i[a.id]).refs--,o.push(s)}e&&u(d(e,t),t);for(r=0;r<o.length;r++){var s;if(0===(s=o[r]).refs){for(var l=0;l<s.parts.length;l++)s.parts[l]();delete i[s.id]}}}};var _=function(){var e=[];return function(t,n){return e[t]=n,e.filter(Boolean).join("\n")}}();function v(e,t,n,i){var o=n?"":i.css;if(e.styleSheet)e.styleSheet.cssText=_(t,o);else{var r=document.createTextNode(o),a=e.childNodes;a[t]&&e.removeChild(a[t]),a.length?e.insertBefore(r,a[t]):e.appendChild(r)}}},function(e,t){e.exports=function(e){var t="undefined"!=typeof window&&window.location;if(!t)throw new Error("fixUrls requires window.location");if(!e||"string"!=typeof e)return e;var n=t.protocol+"//"+t.host,i=n+t.pathname.replace(/\/[^\/]*$/,"/");return e.replace(/url\s*\(((?:[^)(]|\((?:[^)(]+|\([^)(]*\))*\))*)\)/gi,function(e,t){var o,r=t.trim().replace(/^"(.*)"$/,function(e,t){return t}).replace(/^'(.*)'$/,function(e,t){return t});return/^(#|data:|http:\/\/|https:\/\/|file:\/\/\/|\s*$)/i.test(r)?e:(o=0===r.indexOf("//")?r:0===r.indexOf("/")?n+r:i+r.replace(/^\.\//,""),"url("+JSON.stringify(o)+")")})}},function(e,t,n){"use strict";function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}n.r(t);var o=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return function(e,t,n){t&&i(e.prototype,t),n&&i(e,n)}(e,null,[{key:"safeXmlCharactersEntities",get:function(){return{tagOpener:"&laquo;",tagCloser:"&raquo;",doubleQuote:"&uml;",realDoubleQuote:"&quot;"}}},{key:"safeBadBlackboardCharacters",get:function(){return{ltElement:"«mo»<«/mo»",gtElement:"«mo»>«/mo»",ampElement:"«mo»&«/mo»"}}},{key:"safeGoodBlackboardCharacters",get:function(){return{ltElement:"«mo»§lt;«/mo»",gtElement:"«mo»§gt;«/mo»",ampElement:"«mo»§amp;«/mo»"}}},{key:"xmlCharacters",get:function(){return{id:"xmlCharacters",tagOpener:"<",tagCloser:">",doubleQuote:'"',ampersand:"&",quote:"'"}}},{key:"safeXmlCharacters",get:function(){return{id:"safeXmlCharacters",tagOpener:"«",tagCloser:"»",doubleQuote:"¨",ampersand:"§",quote:"`",realDoubleQuote:"¨"}}}]),e}();function r(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var a=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return function(e,t,n){t&&r(e.prototype,t),n&&r(e,n)}(e,null,[{key:"isMathmlInAttribute",value:function(e,t){var n="[\\s]*(".concat("\"[^\"]*\"|'[^']*'",")[\\s]*=[\\s]*[\\w-]+[\\s]*"),i="('".concat(n,"')*"),o="^".concat("['\"][\\s]*=[\\s]*[\\w-]+").concat(i,"[\\s]+gmi<"),r=new RegExp(o),a=e.substring(0,t).split("").reverse().join("");return r.test(a)}},{key:"safeXmlDecode",value:function(e){var t=o.safeXmlCharactersEntities.tagOpener,n=o.safeXmlCharactersEntities.tagCloser,i=o.safeXmlCharactersEntities.doubleQuote,r=o.safeXmlCharactersEntities.realDoubleQuote;e=(e=(e=(e=e.split(t).join(o.safeXmlCharacters.tagOpener)).split(n).join(o.safeXmlCharacters.tagCloser)).split(i).join(o.safeXmlCharacters.doubleQuote)).split(r).join(o.safeXmlCharacters.realDoubleQuote);var a=o.safeBadBlackboardCharacters.ltElement,s=o.safeBadBlackboardCharacters.gtElement,l=o.safeBadBlackboardCharacters.ampElement;"_wrs_blackboard"in window&&window._wrs_blackboard&&(e=(e=(e=e.split(a).join(o.safeGoodBlackboardCharacters.ltElement)).split(s).join(o.safeGoodBlackboardCharacters.gtElement)).split(l).join(o.safeGoodBlackboardCharacters.ampElement)),t=o.safeXmlCharacters.tagOpener,n=o.safeXmlCharacters.tagCloser,i=o.safeXmlCharacters.doubleQuote,r=o.safeXmlCharacters.realDoubleQuote;var c=o.safeXmlCharacters.ampersand,u=o.safeXmlCharacters.quote;e=(e=(e=(e=(e=e.split(t).join(o.xmlCharacters.tagOpener)).split(n).join(o.xmlCharacters.tagCloser)).split(i).join(o.xmlCharacters.doubleQuote)).split(c).join(o.xmlCharacters.ampersand)).split(u).join(o.xmlCharacters.quote);for(var d="",h=null,m=0;m<e.length;m+=1){var g=e.charAt(m);null==h?"$"===g?h="":d+=g:";"===g?(d+="&".concat(h),h=null):g.match(/([a-zA-Z0-9#._-] | '-')/)?h+=g:(d+="$".concat(h),h=null,m-=1)}return d}},{key:"safeXmlEncode",value:function(e){var t=o.xmlCharacters.tagOpener,n=o.xmlCharacters.tagCloser,i=o.xmlCharacters.doubleQuote,r=o.xmlCharacters.ampersand,a=o.xmlCharacters.quote;return e=(e=(e=(e=(e=e.split(t).join(o.safeXmlCharacters.tagOpener)).split(n).join(o.safeXmlCharacters.tagCloser)).split(i).join(o.safeXmlCharacters.doubleQuote)).split(r).join(o.safeXmlCharacters.ampersand)).split(a).join(o.safeXmlCharacters.quote)}},{key:"mathMLEntities",value:function(e){for(var t="",n=0;n<e.length;n+=1){var i=e.charAt(n);if(e.codePointAt(n)>128)t+="&#".concat(e.codePointAt(n),";"),e.codePointAt(n)>65535&&(n+=1);else if("&"===i){var o=e.indexOf(";",n+1);if(o>=0){var r=document.createElement("span");r.innerHTML=e.substring(n,o+1),t+="&#".concat(y.fixedCharCodeAt(r.textContent||r.innerText,0),";"),n=o}else t+=i}else t+=i}return t}},{key:"addCustomEditorClassAttribute",value:function(e,t){var n="",i=e.indexOf("<math");if(0===i){var o=e.indexOf(">");if(-1===e.indexOf("class"))return n="".concat(e.substr(i,o),' class="wrs_').concat(t,'">'),n+=e.substr(o+1,e.length)}return e}},{key:"removeCustomEditorClassAttribute",value:function(e,t){return-1===e.indexOf("class")||-1===e.indexOf("wrs_".concat(t))?e:-1!==e.indexOf('class="wrs_'.concat(t,'"'))?e.replace('class="wrs_'.concat(t,'"'),""):e.replace("wrs_".concat(t),"")}},{key:"addAnnotation",value:function(t,n,i){var o="";if(-1!==t.indexOf("<annotation")){var r=t.indexOf("</semantics>");o="".concat(t.substring(0,r),'<annotation encoding="').concat(i,'">').concat(n,"</annotation>").concat(t.substring(r))}else if(e.isEmpty(t)){var a=t.indexOf("/>"),s=t.indexOf(">"),l=s===a?a:s;o="".concat(t.substring(0,l),'><semantics><annotation encoding="').concat(i,'">').concat(n,"</annotation></semantics></math>")}else{var c=t.indexOf(">")+1,u=t.lastIndexOf("</math>"),d=t.substring(c,u);o="".concat(t.substring(0,c),"<semantics>").concat(d,'<annotation encoding="').concat(i,'">').concat(n,"</annotation></semantics></math>")}return o}},{key:"removeAnnotation",value:function(t,n){var i=t,o='<annotation encoding="'.concat(n,'">'),r=t.indexOf(o);if(-1!==r){for(var a=!1,s=t.indexOf("<annotation");-1!==s;)s!==r&&(a=!0),s=t.indexOf("<annotation",s+1);if(a){var l=t.indexOf("</annotation>",r)+"</annotation>".length;i=t.substring(0,r)+t.substring(l)}else i=e.removeSemantics(t)}return i}},{key:"removeSemantics",value:function(e){var t=e,n=e.indexOf("<semantics>");if(-1!==n){var i=e.indexOf("<annotation",n+"<semantics>".length);-1!==i&&(t=e.substring(0,n)+e.substring(n+"<semantics>".length,i)+"</math>")}return t}},{key:"removeSemanticsOcurrences",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:o.xmlCharacters,n="".concat(t.tagOpener,"math"),i="".concat(t.tagOpener,"/math").concat(t.tagCloser),r="/".concat(t.tagCloser),a=t.tagCloser,s="".concat(t.tagOpener,"semantics").concat(t.tagCloser),l="".concat(t.tagOpener,"annotation encoding="),c="",u=e.indexOf(n),d=0;-1!==u;){c+=e.substring(d,u);var h=e.indexOf(i,u),m=e.indexOf(r,u),g=e.indexOf(a,u);-1!==h?d=h:m===g-1&&(d=m);var f=e.indexOf(s,u);if(-1!==f){var p=e.substring(u,f),_=e.indexOf(l,u);if(-1!==_){var v=f+s.length;c+=p+e.substring(v,_)+i,u=e.indexOf(n,u+n.length),d+=i.length}else d=u,u=e.indexOf(n,u+n.length)}else d=u,u=e.indexOf(n,u+n.length)}return c+=e.substring(d,e.length)}},{key:"containClass",value:function(e,t){var n=e.indexOf("class");if(-1===n)return!1;var i=e.indexOf(">",n);return-1!==e.substring(n,i).indexOf(t)}},{key:"isEmpty",value:function(e){var t=e.indexOf(">"),n=e.indexOf("/>"),i=!1;if(-1!==n&&n===t-1&&(i=!0),!i){var o=new RegExp("</(.+:)?math>").exec(e);o&&(i=t+1===o.index)}return i}},{key:"encodeProperties",value:function(e){return e.replace(/\w+=".*?"/g,function(e){var t=e.indexOf('"'),n=e.substring(t+1,e.length-1),i=y.htmlEntities(n);return"".concat(e.substring(0,t+1)).concat(i,'"')})}}]),e}();function s(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var l=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return function(e,t,n){t&&s(e.prototype,t),n&&s(e,n)}(e,null,[{key:"addConfiguration",value:function(t){Object.assign(e.properties,t)}},{key:"properties",get:function(){return e._properties},set:function(t){e._properties=t}},{key:"get",value:function(t){return Object.prototype.hasOwnProperty.call(e.properties,t)?e.properties[t]:!!Object.prototype.hasOwnProperty.call(e.properties,"_wrs_conf_")&&e.properties["_wrs_conf_".concat(t)]}},{key:"set",value:function(t,n){e.properties[t]=n}},{key:"update",value:function(t,n){if(e.get(t)){var i=Object.assign(e.get(t),n);e.set(t,i)}else e.set(t,n)}}]),e}();function c(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}l._properties={};var u=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.cache=[]}return function(e,t,n){t&&c(e.prototype,t),n&&c(e,n)}(e,[{key:"populate",value:function(e,t){this.cache[e]=t}},{key:"get",value:function(e){return!!Object.prototype.hasOwnProperty.call(this.cache,e)&&this.cache[e]}}]),e}();function d(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var h=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.listeners=[]}return function(e,t,n){t&&d(e.prototype,t),n&&d(e,n)}(e,[{key:"add",value:function(e){this.listeners.push(e)}},{key:"fire",value:function(e,t){for(var n=0;n<this.listeners.length&&!t.cancelled;n+=1)this.listeners[n].eventName===e&&this.listeners[n].callback(t);return t.defaultPrevented}}],[{key:"newListener",value:function(e,t){var n={};return n.eventName=e,n.callback=t,n}}]),e}();function m(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var g=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return function(e,t,n){t&&m(e.prototype,t),n&&m(e,n)}(e,null,[{key:"listeners",get:function(){return e._listeners}},{key:"addListener",value:function(t){e.listeners.add(t)}},{key:"fireEvent",value:function(t,n){e.listeners.fire(t,n)}},{key:"parameters",get:function(){return e._parameters},set:function(t){e._parameters=t}},{key:"servicePaths",get:function(){return e._servicePaths},set:function(t){e._servicePaths=t}},{key:"setServicePath",value:function(t,n){e.servicePaths[t]=n}},{key:"getServicePath",value:function(t){return e.servicePaths[t]}},{key:"integrationPath",get:function(){return e._integrationPath},set:function(t){e._integrationPath=t}},{key:"getServerURL",value:function(){var e=window.location.href.split("/");return"".concat(e[0],"//").concat(e[2])}},{key:"init",value:function(t){e.parameters=t;var n=e.createServiceURI("configurationjs"),i=e.createServiceURI("createimage"),o=e.createServiceURI("showimage"),r=e.createServiceURI("getmathml"),a=e.createServiceURI("service");if(0===e.parameters.URI.indexOf("/")){var s=e.getServerURL();n=s+n,o=s+o,i=s+i,r=s+r,a=s+a}e.setServicePath("configurationjs",n),e.setServicePath("showimage",o),e.setServicePath("createimage",i),e.setServicePath("service",a),e.setServicePath("getmathml",r),e.setServicePath("configurationjs",n),e.listeners.fire("onInit",{})}},{key:"getUrl",value:function(e,t){var n=window.location.toString().substr(0,window.location.toString().lastIndexOf("/")+1),i=y.createHttpRequest();return i?(void 0===t||void 0===t?i.open("GET",e,!1):"/"===e.substr(0,1)||"http://"===e.substr(0,7)||"https://"===e.substr(0,8)?i.open("POST",e,!1):i.open("POST",n+e,!1),void 0!==t&&t?(i.setRequestHeader("Content-type","application/x-www-form-urlencoded; charset=UTF-8"),i.send(y.httpBuildQuery(t))):i.send(null),i.responseText):""}},{key:"getService",value:function(t,n,i){var o;if(!0===i){var r="".concat(e.getServicePath(t),"?").concat(n);o=e.getUrl(r)}else{var a=e.getServicePath(t);o=e.getUrl(a,n)}return o}},{key:"getServerLanguageFromService",value:function(e){return-1!==e.indexOf(".php")?"php":-1!==e.indexOf(".aspx")?"aspx":-1!==e.indexOf("wirispluginengine")?"ruby":"java"}},{key:"createServiceURI",value:function(t){var n=e.serverExtension();return y.concatenateUrl(e.parameters.URI,t)+n}},{key:"serverExtension",value:function(){return-1!==e.parameters.server.indexOf("php")?".php":-1!==e.parameters.server.indexOf("aspx")?".aspx":""}}]),e}();function f(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}g._servicePaths={},g._integrationPath="",g._listeners=new h,g._parameters={};var p=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return function(e,t,n){t&&f(e.prototype,t),n&&f(e,n)}(e,null,[{key:"cache",get:function(){return e._cache},set:function(t){e._cache=t}},{key:"getLatexFromMathML",value:function(t){var n=a.removeSemantics(t),i=e.cache,o={service:"mathml2latex",mml:n},r=JSON.parse(g.getService("service",o)),s="";if("ok"===r.status){s=r.result.text;var l=y.htmlEntities(s),c=a.addAnnotation(t,l,"LaTeX");i.populate(s,c)}return s}},{key:"getMathMLFromLatex",value:function(t,n){var i=e.cache;if(e.cache.get(t))return e.cache.get(t);var o={service:"latex2mathml",latex:t};n&&(o.saveLatex="");var r,s=JSON.parse(g.getService("service",o));if("ok"===s.status){var l=s.result.text;r=-1===(l=l.split("\r").join("").split("\n").join(" ")).indexOf("semantics")&&-1===l.indexOf("annotation")?l=a.addAnnotation(l,t,"LaTeX"):l,i.get(t)||i.populate(t,l)}else r="$$".concat(t,"$$");return r}},{key:"parseMathmlToLatex",value:function(t,n){for(var i,r,s,l="",c="".concat(n.tagOpener,"math"),u="".concat(n.tagOpener,"/math").concat(n.tagCloser),d="".concat(n.tagOpener,"annotation encoding=").concat(n.doubleQuote,"LaTeX").concat(n.doubleQuote).concat(n.tagCloser),h="".concat(n.tagOpener,"/annotation").concat(n.tagCloser),m=t.indexOf(c),g=0;-1!==m;){if(l+=t.substring(g,m),-1===(g=t.indexOf(u,m))?g=t.length-1:g+=u.length,-1!==(r=(i=t.substring(m,g)).indexOf(d))){r+=d.length,s=i.indexOf(h);var f=i.substring(r,s);n===o.safeXmlCharacters&&(f=a.safeXmlDecode(f)),l+="$$".concat(f,"$$"),e.cache.populate(f,i)}else l+=i;m=t.indexOf(c,g)}return l+=t.substring(g,t.length)}},{key:"getLatexFromTextNode",value:function(e,t,n){void 0!==n&&null!=n||(n={open:"$$",close:"$$"});for(var i,o=e;o.previousSibling&&3===o.previousSibling.nodeType;)o=o.previousSibling;function r(e,t,i){for(var o=e.nodeValue.indexOf(i,t);-1===o;){if(!(e=e.nextSibling))return null;o=e.nodeValue?e.nodeValue.indexOf(n.close):-1}return{node:e,position:o}}function a(e,t,n,i){if(e===n)return t<=i;for(;e&&e!==n;)e=e.nextSibling;return e===n}var s,l={node:o,position:0},c=n.open.length;do{if(null==(i=r(l.node,l.position,n.open))||a(e,t,i.node,i.position))return null;if(null==(l=r(i.node,i.position+c,n.close)))return null;l.position+=c}while(a(l.node,l.position,e,t));if(i.node===l.node)s=i.node.nodeValue.substring(i.position+c,l.position-c);else{var u=i.position+c;s=i.node.nodeValue.substring(u,i.node.nodeValue.length);var d=i.node;do{(d=d.nextSibling)===l.node?s+=l.node.nodeValue.substring(0,l.position-c):s+=d.nodeValue?d.nodeValue:""}while(d!==l.node)}return{latex:s,startNode:i.node,startPosition:i.position,endNode:l.node,endPosition:l.position}}}]),e}();p._cache=new u;var _=n(0);function v(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var w=function(){function e(){throw function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),new Error("Static class StringManager can not be instantiated.")}return function(e,t,n){t&&v(e.prototype,t),n&&v(e,n)}(e,null,[{key:"get",value:function(e){var t=this.language;return t in this.strings||(console.warn("Unknown language ".concat(t," set in StringManager.")),t="en"),e in this.strings[t]?this.strings[t][e]:(console.warn("Unknown key ".concat(e," in StringManager.")),e)}}]),e}();function b(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}w.strings=_,w.language="en";var y=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return function(e,t,n){t&&b(e.prototype,t),n&&b(e,n)}(e,null,[{key:"fireEvent",value:function(e,t){if(document.createEvent){var n=document.createEvent("HTMLEvents");return n.initEvent(t,!0,!0),!e.dispatchEvent(n)}var i=document.createEventObject();return e.fireEvent("on".concat(t),i)}},{key:"addEvent",value:function(e,t,n){e.addEventListener?e.addEventListener(t,n,!0):e.attachEvent&&e.attachEvent("on".concat(t),n)}},{key:"removeEvent",value:function(e,t,n){e.removeEventListener?e.removeEventListener(t,n,!0):e.detachEvent&&e.detachEvent("on".concat(t),n)}},{key:"addElementEvents",value:function(t,n,i,o){n&&e.addEvent(t,"dblclick",function(e){var t=e||window.event,i=t.srcElement?t.srcElement:t.target;n(i,t)}),i&&e.addEvent(t,"mousedown",function(e){var t=e||window.event,n=t.srcElement?t.srcElement:t.target;i(n,t)}),o&&e.addEvent(t,"mouseup",function(e){var t=e||window.event,n=t.srcElement?t.srcElement:t.target;o(n,t)})}},{key:"addClass",value:function(t,n){e.containsClass(t,n)||(t.className+=" ".concat(n))}},{key:"containsClass",value:function(e,t){if(null==e||!("className"in e))return!1;for(var n=e.className.split(" "),i=n.length-1;i>=0;i-=1)if(n[i]===t)return!0;return!1}},{key:"removeClass",value:function(e,t){for(var n="",i=e.className.split(" "),o=0;o<i.length;o+=1)i[o]!==t&&(n+="".concat(i[o]," "));e.className=n.trim()}},{key:"convertOldXmlinitialtextAttribute",value:function(e){var t="value=",n=e.indexOf("xmlinitialtext"),i=e.indexOf(t,n),o=e.charAt(i+t.length),r=i+t.length+1,a=e.indexOf(o,r),s=e.substring(r,a),l=s.split("«").join("§lt;");return l=(l=(l=l.split("»").join("§gt;")).split("&").join("§")).split("¨").join("§quot;"),e=e.split(s).join(l)}},{key:"createElement",value:function(t,n,i){var o;void 0===n&&(n={}),void 0===i&&(i=document);try{var r="<".concat(t);Object.keys(n).forEach(function(t){r+=" ".concat(t,'="').concat(e.htmlEntities(n[t]),'"')}),r+=">",o=i.createElement(r)}catch(e){o=i.createElement(t),Object.keys(n).forEach(function(e){o.setAttribute(e,n[e])})}return o}},{key:"createObject",value:function(t,n){void 0===n&&(n=document),t=(t=(t=(t=t.split("<applet ").join('<span wirisObject="WirisApplet" ').split("<APPLET ").join('<span wirisObject="WirisApplet" ')).split("</applet>").join("</span>").split("</APPLET>").join("</span>")).split("<param ").join('<br wirisObject="WirisParam" ').split("<PARAM ").join('<br wirisObject="WirisParam" ')).split("</param>").join("</br>").split("</PARAM>").join("</br>");var i=e.createElement("div",{},n);return i.innerHTML=t,function t(i){if(i.getAttribute&&"WirisParam"===i.getAttribute("wirisObject")){for(var o={},r=0;r<i.attributes.length;r+=1)null!==i.attributes[r].nodeValue&&(o[i.attributes[r].nodeName]=i.attributes[r].nodeValue);var a=e.createElement("param",o,n);a.NAME&&(a.name=a.NAME,a.value=a.VALUE),a.removeAttribute("wirisObject"),i.parentNode.replaceChild(a,i)}else if(i.getAttribute&&"WirisApplet"===i.getAttribute("wirisObject")){for(var s={},l=0;l<i.attributes.length;l+=1)null!==i.attributes[l].nodeValue&&(s[i.attributes[l].nodeName]=i.attributes[l].nodeValue);var c=e.createElement("applet",s,n);c.removeAttribute("wirisObject");for(var u=0;u<i.childNodes.length;u+=1)t(i.childNodes[u]),"param"===i.childNodes[u].nodeName.toLowerCase()&&(c.appendChild(i.childNodes[u]),u-=1);i.parentNode.replaceChild(c,i)}else for(var d=0;d<i.childNodes.length;d+=1)t(i.childNodes[d])}(i),i.firstChild}},{key:"createObjectCode",value:function(t){if(void 0===t||null===t)return null;if(1===t.nodeType){for(var n="<".concat(t.tagName),i=0;i<t.attributes.length;i+=1)t.attributes[i].specified&&(n+=" ".concat(t.attributes[i].name,'="').concat(e.htmlEntities(t.attributes[i].value),'"'));if(t.childNodes.length>0){n+=">";for(var o=0;o<t.childNodes.length;o+=1)n+=e.createObject(t.childNodes[o]);n+="</".concat(t.tagName,">")}else"DIV"===t.nodeName||"SCRIPT"===t.nodeName?n+="></".concat(t.tagName,">"):n+="/>";return n}return 3===t.nodeType?e.htmlEntities(t.nodeValue):""}},{key:"concatenateUrl",value:function(e,t){var n="";return e.indexOf("/")!==e.length&&0!==t.indexOf("/")&&(n="/"),(e+n+t).replace(/([^:]\/)\/+/g,"$1")}},{key:"htmlEntities",value:function(e){return e.split("&").join("&amp;").split("<").join("&lt;").split(">").join("&gt;").split('"').join("&quot;")}},{key:"htmlEntitiesDecode",value:function(e){var t=document.createElement("textarea");return t.innerHTML=e,t.value}},{key:"createHttpRequest",value:function(){if("file://"===window.location.toString().substr(0,window.location.toString().lastIndexOf("/")+1).substr(0,7))throw w.get("exception_cross_site");if("undefined"!=typeof XMLHttpRequest)return new XMLHttpRequest;try{return new ActiveXObject("Msxml2.XMLHTTP")}catch(e){try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(e){return null}}}},{key:"httpBuildQuery",value:function(t){var n="";return Object.keys(t).forEach(function(i){null!=t[i]&&(n+="".concat(e.urlEncode(i),"=").concat(e.urlEncode(t[i]),"&"))}),"&"===n.substring(n.length-1)&&(n=n.substring(0,n.length-1)),n}},{key:"propertiesToString",value:function(t){var n=[];Object.keys(t).forEach(function(e){Object.prototype.hasOwnProperty.call(t,e)&&n.push(e)});for(var i=n.length,o=0;o<i;o+=1)for(var r=o+1;r<i;r+=1){var a=n[o],s=n[r];e.compareStrings(a,s)>0&&(n[o]=s,n[r]=a)}for(var l="",c=0;c<i;c+=1){var u=n[c];l+=u,l+="=";var d=t[u];l+=d=(d=(d=(d=d.replace("\\","\\\\")).replace("\n","\\n")).replace("\r","\\r")).replace("\t","\\t"),l+="\n"}return l}},{key:"compareStrings",value:function(t,n){var i,o=t.length,r=n.length,a=o>r?r:o;for(i=0;i<a;i+=1){var s=e.fixedCharCodeAt(t,i)-e.fixedCharCodeAt(n,i);if(0!==s)return s}return t.length-n.length}},{key:"fixedCharCodeAt",value:function(e,t){t=t||0;var n,i,o=e.charCodeAt(t);if(o>=55296&&o<=56319){if(n=o,i=e.charCodeAt(t+1),Number.isNaN(i))throw w.get("exception_high_surrogate");return 1024*(n-55296)+(i-56320)+65536}return!(o>=56320&&o<=57343)&&o}},{key:"urlToAssArray",value:function(e){var t;if((t=e.indexOf("?"))>0){var n=e.substring(t+1).split("&"),i={};for(t=0;t<n.length;t+=1){var o=n[t].split("=");o.length>1&&(i[o[0]]=decodeURIComponent(o[1].replace(/\+/g," ")))}return i}return{}}},{key:"urlEncode",value:function(e){return encodeURIComponent(e)}},{key:"getWIRISImageOutput",value:function(t,n,i){var o=e.createObject(t);if(o&&(o.className===l.get("imageClassName")||o.getAttribute(l.get("imageMathmlAttribute")))){if(!n)return t;var r=o.getAttribute(l.get("imageMathmlAttribute")),s=a.safeXmlDecode(r);return l.get("saveHandTraces")||(s=a.removeAnnotation(s,"application/json")),null==s&&(s=o.getAttribute("alt")),i?a.safeXmlEncode(s):s}return t}},{key:"getNodeLength",value:function(t){if(3===t.nodeType)return t.nodeValue.length;if(1===t.nodeType){var n={IMG:1,BR:1}[t.nodeName.toUpperCase()];void 0===n&&(n=0);for(var i=0;i<t.childNodes.length;i+=1)n+=e.getNodeLength(t.childNodes[i]);return n}return 0}},{key:"getSelectedItem",value:function(t,n,i){var o;if(n?(o=t.contentWindow).focus():(o=window,t.focus()),document.selection&&!i){var r=o.document.selection.createRange();if(r.parentElement){if(r.htmlText.length>0)return 0===r.text.length?e.getSelectedItem(t,n,!0):null;o.document.execCommand("InsertImage",!1,"#");var a,s,l=r.parentElement();return"IMG"!==l.nodeName.toUpperCase()&&(r.pasteHTML('<span id="wrs_openEditorWindow_temporalObject"></span>'),l=o.document.getElementById("wrs_openEditorWindow_temporalObject")),l.nextSibling&&3===l.nextSibling.nodeType?(a=l.nextSibling,s=0):l.previousSibling&&3===l.previousSibling.nodeType?s=(a=l.previousSibling).nodeValue.length:(a=o.document.createTextNode(""),l.parentNode.insertBefore(a,l),s=0),l.parentNode.removeChild(l),{node:a,caretPosition:s}}return r.length>1?null:{node:r.item(0)}}if(o.getSelection){var c,u=o.getSelection();try{c=u.getRangeAt(0)}catch(e){c=o.document.createRange()}var d=c.startContainer;if(3===d.nodeType)return{node:d,caretPosition:c.startOffset};if(d!==c.endContainer)return null;if(1===d.nodeType){var h=c.startOffset;if(d.childNodes[h])return{node:d.childNodes[h]}}}return null}},{key:"getSelectedItemOnTextarea",value:function(e){var t=document.createTextNode(e.value),n=p.getLatexFromTextNode(t,e.selectionStart);return null===n?null:{node:t,caretPosition:e.selectionStart,startPosition:n.startPosition,endPosition:n.endPosition}}},{key:"getElementsByNameFromString",value:function(e,t,n){var i=[];e=e.toLowerCase(),t=t.toLowerCase();for(var o=e.indexOf("<".concat(t," "));-1!==o;){var r=void 0;r=n?">":"</".concat(t,">");var a=e.indexOf(r,o);-1!==a?(a+=r.length,i.push({start:o,end:a})):a=o+1,o=e.indexOf("<".concat(t," "),a)}return i}},{key:"decode64",value:function(e){var t="+".charCodeAt(0),n="/".charCodeAt(0),i="0".charCodeAt(0),o="a".charCodeAt(0),r="A".charCodeAt(0),a="-".charCodeAt(0),s="_".charCodeAt(0),l=e.charCodeAt(0);return l===t||l===a?62:l===n||l===s?63:l<i?-1:l<i+10?l-i+26+26:l<r+26?l-r:l<o+26?l-o+26:null}},{key:"b64ToByteArray",value:function(t,n){var i;if(t.length%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var o,r,a,s=[];for(o=n||((r="="===t.charAt(t.length-2)?2:"="===t.charAt(t.length-1)?1:0)>0?t.length-4:t.length),a=0;a<o;a+=4)i=e.decode64(t.charAt(a))<<18|e.decode64(t.charAt(a+1))<<12|e.decode64(t.charAt(a+2))<<6|e.decode64(t.charAt(a+3)),s.push(i>>16&255),s.push(i>>8&255),s.push(255&i);return r&&(2===r?(i=e.decode64(t.charAt(a))<<2|e.decode64(t.charAt(a+1))>>4,s.push(255&i)):1===r&&(i=e.decode64(t.charAt(a))<<10|e.decode64(t.charAt(a+1))<<4|e.decode64(t.charAt(a+2))>>2,s.push(i>>8&255),s.push(255&i))),s}},{key:"readInt32",value:function(e){if(e.length<4)return!1;var t=e.splice(0,4);return t[0]<<24|t[1]<<16|t[2]<<8|t[3]<<0}},{key:"readByte",value:function(e){return e.shift()<<0}},{key:"readBytes",value:function(e,t,n){return e.splice(t,n)}},{key:"updateTextArea",value:function(e,t){if(e&&t)if(e.focus(),null!=e.selectionStart){var n=e.selectionEnd,i=e.value.substring(0,e.selectionStart),o=e.value.substring(n,e.value.length);e.value=i+t+o,e.selectionEnd=n+t.length}else{document.selection.createRange().text=t}}},{key:"updateExistingTextOnTextarea",value:function(e,t,n,i){e.focus();var o=e.value.substring(0,n);e.value=o+t+e.value.substring(i,e.value.length),e.selectionEnd=n+t.length}},{key:"addArgument",value:function(e,t,n){var i;return i=e.indexOf("?")>0?"&":"?","".concat(e+i+t,"=").concat(n)}}]),e}();function x(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var A=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return function(e,t,n){t&&x(e.prototype,t),n&&x(e,n)}(e,null,[{key:"removeImgDataAttributes",value:function(e){var t=[],n=e.attributes;Object.keys(n).forEach(function(e){var i=n[e];0===i.name.indexOf("data-")&&t.push(i.name)}),t.forEach(function(t){e.removeAttribute(t)})}},{key:"clone",value:function(e,t){var n=l.get("imageCustomEditorName");e.hasAttribute(n)||t.removeAttribute(n),[l.get("imageMathmlAttribute"),n,"alt","height","width","style","src","role"].forEach(function(n){var i=e.getAttribute(n);i&&t.setAttribute(n,i)})}},{key:"setImgSize",value:function(t,n,i){var o,r,a,s;if(i)if("svg"===l.get("imageFormat"))if("base64"!==l.get("saveMode"))o=e.getMetricsFromSvgString(n);else{r=t.src.substr(t.src.indexOf("base64,")+7,t.src.length),s="",a=y.b64ToByteArray(r,r.length);for(var c=0;c<a.length;c+=1)s+=String.fromCharCode(a[c]);o=e.getMetricsFromSvgString(s)}else r=t.src.substr(t.src.indexOf("base64,")+7,t.src.length),a=y.b64ToByteArray(r,88),o=e.getMetricsFromBytes(a);else o=y.urlToAssArray(n);var u=o.cw;if(u){var d=o.ch,h=o.cb,m=o.dpi;m&&(u=96*u/m,d=96*d/m,h=96*h/m),t.width=u,t.height=d,t.style.verticalAlign="-".concat(d-h,"px")}}},{key:"fixAfterResize",value:function(t){if(t.removeAttribute("style"),t.removeAttribute("width"),t.removeAttribute("height"),t.style.maxWidth="none",-1!==t.src.indexOf("data:image"))if("svg"===l.get("imageFormat")){var n=decodeURIComponent(t.src.substring(32,t.src.length));e.setImgSize(t,n,!0)}else{var i=t.src.substring(22,t.src.length);e.setImgSize(t,i,!0)}else e.setImgSize(t,t.src)}},{key:"getMetricsFromSvgString",value:function(e){var t=e.indexOf('height="'),n=e.indexOf('"',t+8,e.length),i=e.substring(t+8,n);t=e.indexOf('width="'),n=e.indexOf('"',t+7,e.length);var o=e.substring(t+7,n);t=e.indexOf('wrs:baseline="'),n=e.indexOf('"',t+14,e.length);var r=e.substring(t+14,n);if(void 0!==o){var a=[];return a.cw=o,a.ch=i,void 0!==r&&(a.cb=r),a}return[]}},{key:"getMetricsFromBytes",value:function(e){var t,n,i,o,r;for(y.readBytes(e,0,8);e.length>=4;)1229472850===(i=y.readInt32(e))?(t=y.readInt32(e),n=y.readInt32(e),y.readInt32(e),y.readByte(e)):1650545477===i?o=y.readInt32(e):1883789683===i&&(r=y.readInt32(e),r=Math.round(r/39.37),y.readInt32(e),y.readByte(e)),y.readInt32(e);if(void 0!==t){var a=[];return a.cw=t,a.ch=n,a.dpi=r,o&&(a.cb=o),a}return[]}}]),e}();function C(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var k=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return function(e,t,n){t&&C(e.prototype,t),n&&C(e,n)}(e,null,[{key:"cache",get:function(){return e._cache},set:function(t){e._cache=t}},{key:"mathMLToAccessible",value:function(t,n,i){void 0===n&&(n="en"),a.containClass(t,"wrs_chemistry")&&(i.mode="chemistry");var o="";if(e.cache.get(t))o=e.cache.get(t);else{i.service="mathml2accessible",i.lang=n;var r=JSON.parse(g.getService("service",i));"error"!==r.status?(o=r.result.text,e.cache.populate(t,o)):o=w.get("error_convert_accessibility")}return o}}]),e}();k._cache=new u;n(1);function M(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var E=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return function(e,t,n){t&&M(e.prototype,t),n&&M(e,n)}(e,null,[{key:"mathmlToImgObject",value:function(t,n,i,o){var r=t.createElement("img");r.align="middle",r.style.maxWidth="none";var s=i||{};if(s.mml=n,s.lang=o,s.metrics="true",s.centerbaseline="false","base64"===l.get("saveMode")&&"default"===l.get("base64savemode")&&(s.base64=!0),r.className=l.get("imageClassName"),-1!==n.indexOf('class="')){var c=n.substring(n.indexOf('class="')+'class="'.length,n.length);c=(c=c.substring(0,c.indexOf('"'))).substring(4,c.length),r.setAttribute(l.get("imageCustomEditorName"),c)}if(!l.get("wirisPluginPerformance")||"xml"!==l.get("saveMode")&&"safeXml"!==l.get("saveMode")){var u=e.createImageSrc(n,s);r.setAttribute(l.get("imageMathmlAttribute"),a.safeXmlEncode(n)),r.src=u,A.setImgSize(r,u,"base64"===l.get("saveMode")&&"default"===l.get("base64savemode")),l.get("enableAccessibility")&&(r.alt=k.mathMLToAccessible(n,o,s))}else{var d=JSON.parse(e.createShowImageSrc(s,o));if("warning"===d.status)try{d=JSON.parse(g.getService("showimage",s))}catch(e){return null}"png"===(d=d.result).format?r.src="data:image/png;base64,".concat(d.content):r.src="data:image/svg+xml;charset=utf8,".concat(y.urlEncode(d.content)),r.setAttribute(l.get("imageMathmlAttribute"),a.safeXmlEncode(n)),A.setImgSize(r,d.content,!0),l.get("enableAccessibility")&&(void 0===d.alt?r.alt=k.mathMLToAccessible(n,o,s):r.alt=d.alt)}return void 0!==e.observer&&e.observer.observe(r),r.setAttribute("role","math"),r}},{key:"createImageSrc",value:function(e,t){"base64"===l.get("saveMode")&&"default"===l.get("base64savemode")&&(t.base64=!0);var n=g.getService("createimage",t);if(-1!==n.indexOf("@BASE@")){var i=g.getServicePath("createimage").split("/");i.pop(),n=n.split("@BASE@").join(i.join("/"))}return n}},{key:"initParse",value:function(t,n){return t=e.initParseSaveMode(t,n),e.initParseEditMode(t)}},{key:"initParseSaveMode",value:function(t,n){return l.get("saveMode")&&(t=p.parseMathmlToLatex(t,o.safeXmlCharacters),t=p.parseMathmlToLatex(t,o.xmlCharacters),t=e.parseMathmlToImg(t,o.safeXmlCharacters,n),t=e.parseMathmlToImg(t,o.xmlCharacters,n),"base64"===l.get("saveMode")&&"image"===l.get("base64savemode")&&(t=e.codeImgTransform(t,"base642showimage"))),t}},{key:"initParseEditMode",value:function(e){if(-1!==l.get("parseModes").indexOf("latex"))for(var t=y.getElementsByNameFromString(e,"img",!0),n='encoding="LaTeX">',i=0,o=0;o<t.length;o+=1){var r=e.substring(t[o].start+i,t[o].end+i);if(-1!==r.indexOf(' class="'.concat(l.get("imageClassName"),'"'))){var s=" ".concat(l.get("imageMathmlAttribute"),'="'),c=r.indexOf(s);if(-1===c&&(s=' alt="',c=r.indexOf(s)),-1!==c){c+=s.length;var u=r.indexOf('"',c),d=a.safeXmlDecode(r.substring(c,u)),h=d.indexOf(n);if(-1!==h){h+=n.length;var m=d.indexOf("</annotation>",h),g=d.substring(h,m),f="$$".concat(y.htmlEntitiesDecode(g),"$$");e=e.substring(0,t[o].start+i)+f+e.substring(t[o].end+i),i+=f.length-(t[o].end-t[o].start)}}}}return e}},{key:"endParse",value:function(t){var n=e.endParseEditMode(t);return e.endParseSaveMode(n)}},{key:"endParseEditMode",value:function(e){if(-1!==l.get("parseModes").indexOf("latex")){for(var t="",n=0,i=e.indexOf("$$");-1!==i;){if(t+=e.substring(n,i),-1!==(n=e.indexOf("$$",i+2))){var o=e.substring(i+2,n),r=y.htmlEntitiesDecode(o),s=p.getMathMLFromLatex(r,!0);l.get("saveHandTraces")||(s=a.removeAnnotation(s,"application/json")),t+=s,n+=2}else t+="$$",n=i+2;i=e.indexOf("$$",n)}e=t+=e.substring(n,e.length)}return e}},{key:"endParseSaveMode",value:function(t){return l.get("saveMode")&&("safeXml"===l.get("saveMode")?t=e.codeImgTransform(t,"img2mathml"):"xml"===l.get("saveMode")?t=e.codeImgTransform(t,"img2mathml"):"base64"===l.get("saveMode")&&"image"===l.get("base64savemode")&&(t=e.codeImgTransform(t,"img264"))),t}},{key:"createShowImageSrc",value:function(e,t){var n=[],i=["mml","color","centerbaseline","zoom","dpi","fontSize","fontFamily","defaultStretchy","backgroundColor","format"];i.forEach(function(t){var o=i[t];void 0!==e[o]&&(n[o]=e[o])});var o={};return Object.keys(e).forEach(function(t){"mml"!==t&&(o[t]=e[t])}),o.formula=com.wiris.js.JsPluginTools.md5encode(y.propertiesToString(n)),o.lang=void 0===t?"en":t,o.version=l.get("version"),g.getService("showimage",y.httpBuildQuery(o),!0)}},{key:"codeImgTransform",value:function(t,n){for(var i="",o=0,r=/<img/gi,s=r.source.length;r.test(t);){var c=r.lastIndex-s;i+=t.substring(o,c);for(var u=c+1;u<t.length&&o<=c;){var d=t.charAt(u);if('"'===d||"'"===d){var h=t.indexOf(d,u+1);u=-1===h?t.length:h}else">"===d&&(o=u+1);u+=1}if(o<c)return i+=t.substring(c,t.length);var m=t.substring(c,o),g=y.createObject(m),f=g.getAttribute(l.get("imageMathmlAttribute")),p=void 0,_=void 0;if("base642showimage"===n)null==f&&(f=g.getAttribute("alt")),f=a.safeXmlDecode(f),m=e.mathmlToImgObject(document,f,null,null),i+=y.createObjectCode(m);else if("img2mathml"===n)l.get("saveMode")&&("safeXml"===l.get("saveMode")?(p=!0,_=!0):"xml"===l.get("saveMode")&&(p=!0,_=!1)),i+=y.getWIRISImageOutput(m,p,_);else if("img264"===n){null===f&&(f=g.getAttribute("alt")),f=a.safeXmlDecode(f);var v={base64:"true"};m=e.mathmlToImgObject(document,f,v,null),A.setImgSize(m,m.src,!0),i+=y.createObjectCode(m)}}return i+=t.substring(o,t.length)}},{key:"parseMathmlToImg",value:function(t,n,i){for(var r="",s="".concat(n.tagOpener,"math"),c="".concat(n.tagOpener,"/math").concat(n.tagCloser),u=t.indexOf(s),d=0;-1!==u;){r+=t.substring(d,u);var h=t.indexOf(l.get("imageMathmlAttribute"));if(-1===(d=t.indexOf(c,u))?d=t.length-1:d+=-1!==h?t.indexOf("/>",u):c.length,a.isMathmlInAttribute(t,u)||-1!==h)r+=t.substring(u,d);else{var m=t.substring(u,d);m=n.id===o.safeXmlCharacters.id?a.safeXmlDecode(m):a.mathMLEntities(m),r+=y.createObjectCode(e.mathmlToImgObject(document,m,null,i))}u=t.indexOf(s,d)}return r+=t.substring(d,t.length)}}]),e}();if("undefined"!=typeof MutationObserver){var T=new MutationObserver(function(e){e.forEach(function(e){e.oldValue===l.get("imageClassName")&&"class"===e.attributeName&&-1===e.target.className.indexOf(l.get("imageClassName"))&&(e.target.className=l.get("imageClassName"))})});E.observer=Object.create(T),E.observer.Config={attributes:!0,attributeOldValue:!0},E.observer.observe=function(e){Object.getPrototypeOf(this).observe(e,this.Config)}}function I(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var O=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.isContentChanged=!1,this.waitingForChanges=!1}return function(e,t,n){t&&I(e.prototype,t),n&&I(e,n)}(e,[{key:"setIsContentChanged",value:function(e){this.isContentChanged=e}},{key:"getIsContentChanged",value:function(){return this.isContentChanged}},{key:"setWaitingForChanges",value:function(e){this.waitingForChanges=e}},{key:"caretPositionChanged",value:function(e){}},{key:"clipboardChanged",value:function(e){}},{key:"contentChanged",value:function(e){!0===this.waitingForChanges&&!1===this.isContentChanged&&(this.isContentChanged=!0)}},{key:"styleChanged",value:function(e){}},{key:"transformationReceived",value:function(e){}}]),e}();function j(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var P=function(){function e(t){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.editorAttributes={},!("editorAttributes"in t))throw new Error("ContentManager constructor error: editorAttributes property missed.");if(this.editorAttributes=t.editorAttributes,this.customEditors=null,"customEditors"in t&&(this.customEditors=t.customEditors),this.environment={},!("environment"in t))throw new Error("ContentManager constructor error: environment property missed");if(this.environment=t.environment,this.language="",!("language"in t))throw new Error("ContentManager constructor error: language property missed");this.language=t.language,this.editorListener=new O,this.editor=null,this.ua=navigator.userAgent.toLowerCase(),this.deviceProperties={},this.deviceProperties.isAndroid=this.ua.indexOf("android")>-1,this.deviceProperties.isIOS=this.ua.indexOf("ipad")>-1||this.ua.indexOf("iphone")>-1,this.toolbar=null,this.modalDialogInstance=null,this.listeners=new h,this.mathML=null,this.isNewElement=!0,this.integrationModel=null}return function(e,t,n){t&&j(e.prototype,t),n&&j(e,n)}(e,[{key:"addListener",value:function(e){this.listeners.add(e)}},{key:"setIntegrationModel",value:function(e){this.integrationModel=e}},{key:"setModalDialogInstance",value:function(e){this.modalDialogInstance=e}},{key:"insert",value:function(){this.updateTitle(this.modalDialogInstance),this.insertEditor(this.modalDialogInstance)}},{key:"insertEditor",value:function(){if(e.isEditorLoaded()){if(this.editor=window.com.wiris.jsEditor.JsEditor.newInstance(this.editorAttributes),this.editor.insertInto(this.modalDialogInstance.contentContainer),this.editor.focus(),this.modalDialogInstance.rtl&&this.editor.action("rtl"),this.editor.getEditorModel().isRTL()&&(this.editor.element.style.direction="rtl"),this.editor.getEditorModel().addEditorListener(this.editorListener),this.modalDialogInstance.deviceProperties.isIOS){setTimeout(function(){this.modalDialogInstance.hideKeyboard()},400);var t=document.getElementsByClassName("wrs_formulaDisplay")[0];y.addEvent(t,"focus",this.modalDialogInstance.handleOpenedIosSoftkeyboard),y.addEvent(t,"blur",this.modalDialogInstance.handleClosedIosSoftkeyboard)}this.listeners.fire("onLoad",{})}else setTimeout(e.prototype.insertEditor.bind(this),100)}},{key:"init",value:function(){e.isEditorLoaded()||this.addEditorAsExternalDependency()}},{key:"addEditorAsExternalDependency",value:function(){var t=document.createElement("script");t.type="text/javascript";var n=l.get("editorUrl"),i=document.createElement("a");e.setHrefToAnchorElement(i,n),e.setProtocolToAnchorElement(i),n=e.getURLFromAnchorElement(i);var o=this.getEditorStats();t.src="".concat(n,"?lang=").concat(this.language,"&stats-editor=").concat(o.editor,"&stats-mode=").concat(o.mode,"&stats-version=").concat(o.version),document.getElementsByTagName("head")[0].appendChild(t)}},{key:"getEditorStats",value:function(){var e={};return"editor"in this.environment?e.editor=this.environment.editor:e.editor="unknown","mode"in this.environment?e.mode=this.environment.mode:e.mode=l.get("saveMode"),"version"in this.environment?e.version=this.environment.version:e.version=l.get("version"),e}},{key:"setInitialContent",value:function(){this.isNewElement||this.setMathML(this.mathML)}},{key:"setMathML",value:function(e,t){var n=this;void 0===t&&(t=!1),this.editor.setMathMLWithCallback(e,function(){n.editorListener.setWaitingForChanges(!0)}),setTimeout(function(){n.editorListener.setIsContentChanged(!1)},500),t||this.onFocus()}},{key:"onFocus",value:function(){void 0!==this.editor&&null!=this.editor&&this.editor.focus()}},{key:"submitAction",value:function(){if(this.editor.isFormulaEmpty())this.integrationModel.updateFormula(null);else{var e=this.editor.getMathMLWithSemantics();if(null!==this.customEditors.getActiveEditor()){var t=this.customEditors.getActiveEditor().toolbar;e=a.addCustomEditorClassAttribute(e,t)}else Object.keys(this.customEditors.editors).forEach(function(t){e=a.removeCustomEditorClassAttribute(e,t)});var n=a.mathMLEntities(e);this.integrationModel.updateFormula(n)}this.customEditors.disable(),this.integrationModel.notifyWindowClosed(),this.setEmptyMathML(),this.customEditors.disable()}},{key:"setEmptyMathML",value:function(){this.deviceProperties.isAndroid||this.deviceProperties.isIOS?this.editor.getEditorModel().isRTL()?this.setMathML('<math dir="rtl"><semantics><annotation encoding="application/json">[]</annotation></semantics></math>',!0):this.setMathML('<math><semantics><annotation encoding="application/json">[]</annotation></semantics></math>',!0):this.editor.getEditorModel().isRTL()?this.setMathML('<math dir="rtl"/>',!0):this.setMathML("<math/>",!0)}},{key:"onOpen",value:function(){this.isNewElement?this.setEmptyMathML():this.setMathML(this.mathML),this.updateToolbar(),this.onFocus()}},{key:"updateToolbar",value:function(){this.updateTitle(this.modalDialogInstance);var e=this.customEditors.getActiveEditor();if(e){var t=e.toolbar?e.toolbar:_wrs_int_wirisProperties.toolbar;null!=this.toolbar&&this.toolbar===t||this.setToolbar(t)}else{var n=this.getToolbar();null!=this.toolbar&&this.toolbar===n||(this.setToolbar(n),this.customEditors.disable())}}},{key:"updateTitle",value:function(){var e=this.customEditors.getActiveEditor();e?this.modalDialogInstance.setTitle(e.title):this.modalDialogInstance.setTitle("MathType")}},{key:"getToolbar",value:function(){var e="general";return"toolbar"in this.editorAttributes&&(e=this.editorAttributes.toolbar),"general"===e&&(e="undefined"==typeof _wrs_int_wirisProperties||void 0===_wrs_int_wirisProperties.toolbar?"general":_wrs_int_wirisProperties.toolbar),e}},{key:"setToolbar",value:function(e){this.toolbar=e,this.editor.setParams({toolbar:this.toolbar})}},{key:"hasChanges",value:function(){return!this.editor.isFormulaEmpty()&&this.editorListener.getIsContentChanged()}},{key:"onKeyDown",value:function(e){if(void 0!==e.key&&!1===e.repeat)if("Escape"===e.key||"Esc"===e.key){var t=document.getElementsByClassName("wrs_expandButton wrs_expandButtonFor3RowsLayout wrs_pressed");0===t.length&&0===(t=document.getElementsByClassName("wrs_expandButton wrs_expandButtonFor2RowsLayout wrs_pressed")).length&&0===(t=document.getElementsByClassName("wrs_select wrs_pressed")).length&&(this.modalDialogInstance.cancelAction(),e.stopPropagation(),e.preventDefault())}else if(e.shiftKey&&"Tab"===e.key)if(document.activeElement===this.modalDialogInstance.submitButton)this.editor.focus(),e.stopPropagation(),e.preventDefault();else{var n=document.querySelector('[title="Manual"]');document.activeElement===n&&(this.modalDialogInstance.cancelButton.focus(),e.stopPropagation(),e.preventDefault())}else if("Tab"===e.key){if(document.activeElement===this.modalDialogInstance.cancelButton)document.querySelector('[title="Manual"]').focus(),e.stopPropagation(),e.preventDefault();else"wrs_formulaDisplay wrs_focused"===document.getElementsByClassName("wrs_formulaDisplay")[0].getAttribute("class")&&(this.modalDialogInstance.submitButton.focus(),e.stopPropagation(),e.preventDefault())}}}],[{key:"setHrefToAnchorElement",value:function(e,t){e.href=t}},{key:"setProtocolToAnchorElement",value:function(e){0===window.location.href.indexOf("https://")&&"http:"===e.protocol&&(e.protocol="https:")}},{key:"getURLFromAnchorElement",value:function(e){return"80"===e.port||"443"===e.port||""===e.port?"".concat(e.protocol,"//").concat(e.hostname,"/").concat(e.pathname):"".concat(e.protocol,"//").concat(e.hostname,":").concat(e.port,"/").concat(e.pathname)}},{key:"isEditorLoaded",value:function(){return window.com&&window.com.wiris&&window.com.wiris.jsEditor&&window.com.wiris.jsEditor.JsEditor&&window.com.wiris.jsEditor.JsEditor.newInstance}}]),e}();function L(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var S=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.editors=[],this.activeEditor="default"}return function(e,t,n){t&&L(e.prototype,t),n&&L(e,n)}(e,[{key:"addEditor",value:function(e,t){var n={};n.name=t.name,n.toolbar=t.toolbar,n.icon=t.icon,n.confVariable=t.confVariable,n.title=t.title,n.tooltip=t.tooltip,this.editors[e]=n}},{key:"enable",value:function(e){this.activeEditor=e}},{key:"disable",value:function(){this.activeEditor="default"}},{key:"getActiveEditor",value:function(){return"default"!==this.activeEditor?this.editors[this.activeEditor]:null}}]),e}(),z={imageCustomEditorName:"data-custom-editor",imageClassName:"Wirisformula",CASClassName:"Wiriscas"};function B(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var D=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.cancelled=!1,this.defaultPrevented=!1}return function(e,t,n){t&&B(e.prototype,t),n&&B(e,n)}(e,[{key:"cancel",value:function(){this.cancelled=!0}},{key:"preventDefault",value:function(){this.defaultPrevented=!0}}]),e}();function F(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var N=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.overlayElement=t.overlayElement,this.callbacks=t.callbacks,this.overlayWrapper=this.overlayElement.appendChild(document.createElement("div")),this.overlayWrapper.setAttribute("class","wrs_popupmessage_overlay_envolture"),this.message=this.overlayWrapper.appendChild(document.createElement("div")),this.message.id="wrs_popupmessage",this.message.setAttribute("class","wrs_popupmessage_panel"),this.message.setAttribute("role","dialog"),this.message.setAttribute("aria-describedby","description_txt");var n=document.createElement("p"),i=document.createTextNode(t.strings.message);n.appendChild(i),n.id="description_txt",this.message.appendChild(n);var o=this.overlayWrapper.appendChild(document.createElement("div"));o.setAttribute("class","wrs_popupmessage_overlay"),o.addEventListener("click",this.cancelAction.bind(this)),this.buttonArea=this.message.appendChild(document.createElement("div")),this.buttonArea.setAttribute("class","wrs_popupmessage_button_area"),this.buttonArea.id="wrs_popup_button_area";var r={class:"wrs_button_accept",innerHTML:t.strings.submitString,id:"wrs_popup_accept_button"};this.closeButton=this.createButton(r,this.closeAction.bind(this)),this.buttonArea.appendChild(this.closeButton);var a={class:"wrs_button_cancel",innerHTML:t.strings.cancelString,id:"wrs_popup_cancel_button"};this.cancelButton=this.createButton(a,this.cancelAction.bind(this)),this.buttonArea.appendChild(this.cancelButton)}return function(e,t,n){t&&F(e.prototype,t),n&&F(e,n)}(e,[{key:"createButton",value:function(e,t){var n={};return(n=document.createElement("button")).setAttribute("id",e.id),n.setAttribute("class",e.class),n.innerHTML=e.innerHTML,n.addEventListener("click",t),n}},{key:"show",value:function(){"block"!==this.overlayWrapper.style.display?(document.activeElement.blur(),this.overlayWrapper.style.display="block",this.closeButton.focus()):(this.overlayWrapper.style.display="none",_wrs_modalWindow.focus())}},{key:"cancelAction",value:function(){this.overlayWrapper.style.display="none",void 0!==this.callbacks.cancelCallback&&this.callbacks.cancelCallback()}},{key:"closeAction",value:function(){this.cancelAction(),void 0!==this.callbacks.closeCallback&&this.callbacks.closeCallback()}},{key:"onKeyDown",value:function(e){void 0!==e.key&&("Escape"===e.key||"Esc"===e.key?(this.cancelAction(),e.stopPropagation(),e.preventDefault()):"Tab"===e.key&&(document.activeElement===this.closeButton?this.cancelButton.focus():this.closeButton.focus(),e.stopPropagation(),e.preventDefault()))}}]),e}(),R='<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n<svg\n   xmlns:dc="http://purl.org/dc/elements/1.1/"\n   xmlns:cc="http://creativecommons.org/ns#"\n   xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"\n   xmlns:svg="http://www.w3.org/2000/svg"\n   xmlns="http://www.w3.org/2000/svg"\n   xmlns:xlink="http://www.w3.org/1999/xlink"\n   viewBox="0 0 13.76 13.76"\n   height="13.76"\n   width="13.76"\n   id="svg3783"\n   version="1.1">\n  <metadata\n     id="metadata3789">\n    <rdf:RDF>\n      <cc:Work\n         rdf:about="">\n        <dc:format>image/svg+xml</dc:format>\n        <dc:type\n           rdf:resource="http://purl.org/dc/dcmitype/StillImage" />\n        <dc:title></dc:title>\n      </cc:Work>\n    </rdf:RDF>\n  </metadata>\n  <defs\n     id="defs3787" />\n  <image\n     y="0"\n     x="0"\n     id="image3791"\n     xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACsAAAArCAYAAADhXXHAAAAACXBIWXMAAC4jAAAuIwF4pT92AAAB\nvklEQVRYw83Z23GDMBAF0AsNhBIowSVQgjuISnAJKSEdZNOBS6CDOBUkqSC4gs2PyGhAQg92se4M\n4w8bccYW2hVumBmRdAB6ADfopQcw2SOYNoIkAL8APgB8AzgLI0/2S/iy1xkt3B9m9h0dM9/YHxM4\nJ/c4MfPkGX+y763OyYVKgUPQTXAJdC84Bg2CS6Gl4FSoF7wHmgvOhbrgzsW+8L4YJegccrEj749R\ngs7ZXGdz8wbAeNbREcDTzrHvblEgBbAUFACuy6JALJeL0E/P9sbvmBnNojcgAM+oJ58AhrlnWM5Z\nA+C9RmiokakBvIJuNTLSc7hojqY0Mo8EB6Ep2CPBm9BU7BHgKDQHqwlOguZiNcDJ0JLe4FV4iaLY\nJjF16dLqnoob+EdDs8A1QJPBtUCTwDVBo+DaoJvgNvBIR6rDl9wirbA1QIPgVgl6VwHb+dAr7Jkk\nS/Pg3mCkVOslxxV9yBFqSqTA/3N2Utkzye3pftw5OxzQ5tHeddcdzGj3o4VgClUwowgtAVOs3BpF\naA6YUnsDowhNAVNu12UUoVtgCn2+ifxp1wO42Ner4KPR5dJ2tsse2ZLvTQxbVf4AmC2z7WnSvpIA\nAAAASUVORK5CYII=\n"\n     style="image-rendering:optimizeQuality"\n     preserveAspectRatio="none"\n     height="13.76"\n     width="13.76" />\n</svg>\n',H='<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n<svg\n   xmlns:dc="http://purl.org/dc/elements/1.1/"\n   xmlns:cc="http://creativecommons.org/ns#"\n   xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"\n   xmlns:svg="http://www.w3.org/2000/svg"\n   xmlns="http://www.w3.org/2000/svg"\n   xmlns:xlink="http://www.w3.org/1999/xlink"\n   viewBox="0 0 13.76 13.76"\n   height="13.76"\n   width="13.76"\n   id="svg2"\n   version="1.1">\n  <metadata\n     id="metadata8">\n    <rdf:RDF>\n      <cc:Work\n         rdf:about="">\n        <dc:format>image/svg+xml</dc:format>\n        <dc:type\n           rdf:resource="http://purl.org/dc/dcmitype/StillImage" />\n        <dc:title></dc:title>\n      </cc:Work>\n    </rdf:RDF>\n  </metadata>\n  <defs\n     id="defs6" />\n  <image\n     y="0"\n     x="0"\n     id="image10"\n     xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACsAAAArCAYAAADhXXHAAAAACXBIWXMAAC4jAAAuIwF4pT92AAAB\n2ElEQVRYw9XZoXPCMBTH8S+5KfDzQ29606CH3/SmQTO96aGHHn/F0Himh8eDZSblQknSJH2F0DtE\nQw8+12vyfulr7XY7LuW4qvj+DugD18AC+AE2woa+/mz07y9cF7Y8d7YPDEtjK2AsCB4BvdLYHPi0\nXawioAA3wAfQaQiKHhuFYl1QSbAL6gWrSKgEuArqBKsEaB1wKNQKVsasHybcpRhwLNQED0zsoMbz\nFwJOhWL6Cmzd2e0D14Wi1/k9di2wFNnAEtBifd9jv4GtIPgaeBOCAkzLFayr/6idWSSY6DJ8sHT9\n6VK6zRFqKwo5gQ+grnKbA/gI6gsy5wRboT7sucBOaBX21GAvNAR7KnAlNBTbNDgIGoMtwO/C0Gko\nNBZbN525tk+dJrAj4F4YGxXgVQS019DkCgarM0OjwCoDaDBYZQINAquMoJVglRnUC1YZQp1g1RB0\nJryn65jYJ0HoRGPHguDX8hsZ6VAiGX4eUrJBbHqSArdN7LLBmCcBnpvYWfHWo6E8Wge8Ar7Kj8E4\nARwcnBPBB20BE7uJBMdAU8BH/YvyBAsFp0BjwNZGi201qALXgYaAnR0hX2upAzwDj/p8raFL5I4u\n8ALc6vNfvc+ztq5al9Rh/AfwZZ/LmlMllAAAAABJRU5ErkJggg==\n"\n     style="image-rendering:optimizeQuality"\n     preserveAspectRatio="none"\n     height="13.76"\n     width="13.76" />\n</svg>\n',X='<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n<svg\n   xmlns:dc="http://purl.org/dc/elements/1.1/"\n   xmlns:cc="http://creativecommons.org/ns#"\n   xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"\n   xmlns:svg="http://www.w3.org/2000/svg"\n   xmlns="http://www.w3.org/2000/svg"\n   xmlns:xlink="http://www.w3.org/1999/xlink"\n   viewBox="0 0 13.76 13.76"\n   height="13.76"\n   width="13.76"\n   id="svg3793"\n   version="1.1">\n  <metadata\n     id="metadata3799">\n    <rdf:RDF>\n      <cc:Work\n         rdf:about="">\n        <dc:format>image/svg+xml</dc:format>\n        <dc:type\n           rdf:resource="http://purl.org/dc/dcmitype/StillImage" />\n        <dc:title></dc:title>\n      </cc:Work>\n    </rdf:RDF>\n  </metadata>\n  <defs\n     id="defs3797" />\n  <image\n     y="0"\n     x="0"\n     id="image3801"\n     xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACsAAAArCAYAAADhXXHAAAAAAXNSR0IArs4c6QAAAARnQU1BAACx\njwv8YQUAAAAJcEhZcwAALiMAAC4jAXilP3YAAAG4SURBVFhHvZnhUYNAEEbRBkwH2oGUkA40FWgJ\nKSEdaAmxA0vQDmIHKSFWgPuAHZkEAnd8y5v5kuNHMm+WY1mSm6qqCiGlZdUspXzxopY9Wu6bpZQf\nSxlRWapwVx9p2dy2CxUHy9ryWx9pKdWyECYcIQshwlGyIBeOlAWpcLQsyISXkAWEX5tlPkvJwnP7\nns1SsnvLS7PMZwlZiShEy8pEIVJWKgpRsnJRiJBNFf2wbCzjfZgRUZi9JYWDxT9bWk6WIXbKym4t\nKRVloObO5oze6ZClWX9a5jyOcOrfmuUkXPRUH/1zVRhZpvsnCxN+jnDqHh0SdQaFu9vg0ZIqrBZ1\neoXP92yKcJSocyHcd4FNEY4WdbrCR1rGrukMF9BWVhZvLZ7U9rS2nH9HVvoq63iFu+RUlOpIuCYL\nCCPIqVjq1A9j5R3aBnMY2kKzMlbZHPQVbVHLhomCUjZUFFSy35ZQUVDIMo+Gi4JCltFwERSy75Y5\n4+VkFLLcKHLHyyRUF1jOeJmMShbChZWy0Df8yFDLgg8/cpCN6I9cdHJhZHmy7X2anAnCtDUZ/j/Y\ng2X2j709MHhTDAFF8QdK9SRpUl2yFgAAAABJRU5ErkJggg==\n"\n     style="image-rendering:optimizeQuality"\n     preserveAspectRatio="none"\n     height="13.76"\n     width="13.76" />\n</svg>\n',U='<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n<svg\n   xmlns:dc="http://purl.org/dc/elements/1.1/"\n   xmlns:cc="http://creativecommons.org/ns#"\n   xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"\n   xmlns:svg="http://www.w3.org/2000/svg"\n   xmlns="http://www.w3.org/2000/svg"\n   xmlns:xlink="http://www.w3.org/1999/xlink"\n   viewBox="0 0 13.76 13.76"\n   height="13.76"\n   width="13.76"\n   id="svg12"\n   version="1.1">\n  <metadata\n     id="metadata18">\n    <rdf:RDF>\n      <cc:Work\n         rdf:about="">\n        <dc:format>image/svg+xml</dc:format>\n        <dc:type\n           rdf:resource="http://purl.org/dc/dcmitype/StillImage" />\n        <dc:title></dc:title>\n      </cc:Work>\n    </rdf:RDF>\n  </metadata>\n  <defs\n     id="defs16" />\n  <image\n     y="0"\n     x="0"\n     id="image20"\n     xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACsAAAArCAYAAADhXXHAAAAAAXNSR0IArs4c6QAAAARnQU1BAACx\njwv8YQUAAAAJcEhZcwAALiMAAC4jAXilP3YAAAGMSURBVFhHvdk7TsNAFIVhQ0l6elLDJqCGngXQ\nU7MA6rALahZATQ81C6APrXP/jEaKHD/i8TnzS1eaICF/2I4f4qxt20bYOmaVlrK2Mb8s1Nj3mIu0\nlPYZszlPa1kvMf9pKe02Zq3Gcrhc4JUaSzawA0sWsAtLcrATS1KwG0sycA0sAd6kZXm1sNzVHtOy\nvBpYoK8xV/tPC3JjZVByYqVQcmHlUHJgLVBSY0ugPP7xO5PXYSW2FMr19ytm8sahxD7ElEBzk3c6\nsFysn/afymKPvsXMueh3oblRMNibmPuYZ34wsyWHfqhB8OFpwKvDHLADmusFd8/ZU8FOaO4I3PcF\nmwLXgOYOwVtexdnwdUy3vg2UQPnD2eji+vZsrruHS/eoBEpjWMpgrhi1Dv1gY6fBkuRQmtqzJVmg\npMbaoKTEWqGkwtqhpMBWgZICWwVKCuwpzxKSFNi5T2vFqb5gVcAqLNnBSixZwWos2cBg/9JSmgUM\n9iMt5QFe8tZ8VP6n3WXMHQtxPzHfabm0ptkBwWhpthzMp7YAAAAASUVORK5CYII=\n"\n     style="image-rendering:optimizeQuality"\n     preserveAspectRatio="none"\n     height="13.76"\n     width="13.76" />\n</svg>\n',W='<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n<svg\n   xmlns:dc="http://purl.org/dc/elements/1.1/"\n   xmlns:cc="http://creativecommons.org/ns#"\n   xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"\n   xmlns:svg="http://www.w3.org/2000/svg"\n   xmlns="http://www.w3.org/2000/svg"\n   xmlns:xlink="http://www.w3.org/1999/xlink"\n   viewBox="0 0 13.76 13.76"\n   height="13.76"\n   width="13.76"\n   id="svg3813"\n   version="1.1">\n  <metadata\n     id="metadata3819">\n    <rdf:RDF>\n      <cc:Work\n         rdf:about="">\n        <dc:format>image/svg+xml</dc:format>\n        <dc:type\n           rdf:resource="http://purl.org/dc/dcmitype/StillImage" />\n        <dc:title></dc:title>\n      </cc:Work>\n    </rdf:RDF>\n  </metadata>\n  <defs\n     id="defs3817" />\n  <image\n     y="0"\n     x="0"\n     id="image3821"\n     xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACsAAAArCAYAAADhXXHAAAAACXBIWXMAAC4jAAAuIwF4pT92AAAA\nnUlEQVRYw+3Z0QnCMBSF4T/FATqCG1g3cISO0NE6iiPoCE5gneD40ohPvgkJ/AcC9/EjHELgliT0\nkoGOIlasWLFixYoVK1asWLFixYoVK1bsjxy+5hlYgLEx47ofSEKSJW1nTUJJMgLPDlpwHoCpk8rO\nvgZixf4Zu3Vi3cq+WroBp4ahL+BYa3AB7o1CH7vvc7M1U4N/g2sdSk8bxjfDaMNdr+hmAQAAAABJ\nRU5ErkJggg==\n"\n     style="image-rendering:optimizeQuality"\n     preserveAspectRatio="none"\n     height="13.76"\n     width="13.76" />\n</svg>\n',J='<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n<svg\n   xmlns:dc="http://purl.org/dc/elements/1.1/"\n   xmlns:cc="http://creativecommons.org/ns#"\n   xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"\n   xmlns:svg="http://www.w3.org/2000/svg"\n   xmlns="http://www.w3.org/2000/svg"\n   xmlns:xlink="http://www.w3.org/1999/xlink"\n   viewBox="0 0 13.76 13.76"\n   height="13.76"\n   width="13.76"\n   id="svg32"\n   version="1.1">\n  <metadata\n     id="metadata38">\n    <rdf:RDF>\n      <cc:Work\n         rdf:about="">\n        <dc:format>image/svg+xml</dc:format>\n        <dc:type\n           rdf:resource="http://purl.org/dc/dcmitype/StillImage" />\n        <dc:title></dc:title>\n      </cc:Work>\n    </rdf:RDF>\n  </metadata>\n  <defs\n     id="defs36" />\n  <image\n     y="0"\n     x="0"\n     id="image40"\n     xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACsAAAArCAYAAADhXXHAAAAACXBIWXMAAC4jAAAuIwF4pT92AAAA\npklEQVRYw+3ZLQ4CMRCG4bcbFOvXg99T7FG4BafAw1VALx7dWyy2mIoGgSOZJu/n6p70ZybppFIK\nvWSgo4gVK1asWLFixYoVK1asWLFixYoV+yO7r/UMHIAxiO8FZGBrsUfgDEwBN/QNXIA11S/PW1Bo\nCz4N9ein4Nd1Dyw9PbDR0iVW7J+xudax6HkOtZVdg0MfQE7N0G4GlmANYgNW4A6QepowfgDMXB26\nb1V6LAAAAABJRU5ErkJggg==\n"\n     style="image-rendering:optimizeQuality"\n     preserveAspectRatio="none"\n     height="13.76"\n     width="13.76" />\n</svg>\n',Y='<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n<svg\n   xmlns:dc="http://purl.org/dc/elements/1.1/"\n   xmlns:cc="http://creativecommons.org/ns#"\n   xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"\n   xmlns:svg="http://www.w3.org/2000/svg"\n   xmlns="http://www.w3.org/2000/svg"\n   xmlns:xlink="http://www.w3.org/1999/xlink"\n   viewBox="0 0 13.76 13.76"\n   height="13.76"\n   width="13.76"\n   id="svg3823"\n   version="1.1">\n  <metadata\n     id="metadata3829">\n    <rdf:RDF>\n      <cc:Work\n         rdf:about="">\n        <dc:format>image/svg+xml</dc:format>\n        <dc:type\n           rdf:resource="http://purl.org/dc/dcmitype/StillImage" />\n        <dc:title></dc:title>\n      </cc:Work>\n    </rdf:RDF>\n  </metadata>\n  <defs\n     id="defs3827" />\n  <image\n     y="0"\n     x="0"\n     id="image3831"\n     xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACsAAAArCAYAAADhXXHAAAAAAXNSR0IArs4c6QAAAARnQU1BAACx\njwv8YQUAAAAJcEhZcwAALiMAAC4jAXilP3YAAAHOSURBVFhH1ZiLUcMwEEQNDcQl0AEuISVABZhO\nUkroICVAB6ECoINQgdmVfR5FlmQrkZzjzezEzsc8NPqcdNd1XfVfuB9ec3NAmv4yiRo5ImzBlm+c\nwZYtEHJCGsT3eSgHxKZFxs/tL+aMkCK8R3yMwu4PcsVmiXBIVDDCvh/miEtMeE5UaEsNMJcN8o64\ng26PvPSXs9S+/zRHQtgtvLRFCb9blZpnYw/9Rb6RR3M3zxtiprFbyKYwipK1+uwlnIkSrbITUaJR\n1itKtMkGRYk2WRZAQbTNBpzWtggrrwnaWja00hk0DrCgsEZZ4hXWKksmwjLAHobkgOv+V3+ZhXHQ\niWxKqXYLKNyILDdqbPKlldASPhA+Mxc7uwatkSOSix1iP//q2APshLBvfJo7hbizgQj/mDtl+KYu\nCj8h7NSqCM2zXJvZwqqEY4uCOuGYLKEwJ3kVzMlyscg5915FTFbdqhaSVbn8+mTV1gmurOqCxpZN\nEeUu9BlZd1obioTkQ7IhPGTjYZuPIoUMK/GUFrX39asuHJTlH3w1d3FCBxCrCUufZX+NCUdPSsAq\nwu4A8wnPiQrFhW1Z4govFRWKCoeOjzjoZF92CdwpZy6AquoPvJRHJxB8bJ8AAAAASUVORK5CYII=\n"\n     style="image-rendering:optimizeQuality"\n     preserveAspectRatio="none"\n     height="13.76"\n     width="13.76" />\n</svg>\n',V='<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n<svg\n   xmlns:dc="http://purl.org/dc/elements/1.1/"\n   xmlns:cc="http://creativecommons.org/ns#"\n   xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"\n   xmlns:svg="http://www.w3.org/2000/svg"\n   xmlns="http://www.w3.org/2000/svg"\n   xmlns:xlink="http://www.w3.org/1999/xlink"\n   viewBox="0 0 13.76 13.76"\n   height="13.76"\n   width="13.76"\n   id="svg42"\n   version="1.1">\n  <metadata\n     id="metadata48">\n    <rdf:RDF>\n      <cc:Work\n         rdf:about="">\n        <dc:format>image/svg+xml</dc:format>\n        <dc:type\n           rdf:resource="http://purl.org/dc/dcmitype/StillImage" />\n        <dc:title></dc:title>\n      </cc:Work>\n    </rdf:RDF>\n  </metadata>\n  <defs\n     id="defs46" />\n  <image\n     y="0"\n     x="0"\n     id="image50"\n     xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACsAAAArCAYAAADhXXHAAAAAAXNSR0IArs4c6QAAAARnQU1BAACx\njwv8YQUAAAAJcEhZcwAALiMAAC4jAXilP3YAAAG/SURBVFhH1ZgxUsMwEEUNJRyAGmp6qKGn5xRQ\nQ08NNfRQQw11DpAaanIAWrMv8WaELSlexhLLm/mRnImiF48jr7zVtm3zX9ju2ik5llxLdpdHNg4k\nT5I7yWB8Cdl9yZHkRmIRRpQxOxK+YzC+hKwSnTBBKKoMxpeUBSbkksgRE1V+CJeWhUPJ5ao7ICeq\nrIVryMKJpC88RlTZk1SThVDYIvoluZIsSqyz511SfEg4UxbRdw5qnlmFa9AsCn8hO4aBKHiUjYqC\nN9mkKHiSzYqCJ9lPSVIUPMmySqTudEu8XbOxO90ab7KQFPYoC1Fhr7IwENbagMLCUtXnoCTM1QZW\n3iS3dFT2mRfHvEjuVfZUckFnQh67dgqo1GYqC1MLn3XtZIR/sFcJW2C39FcD18KxpcutcGqddSmc\nuykg/LDq+iAnC/OudUFOVrfLbkjJWvb11YjJuhSFvqxbUQhlXYuCylpE2YXy2SkLlVEgaxVluzyT\nIEutWQ1kKZYtouF2maK4mjCyFN6bJsw9gKgmrNdsbsKNT0qEKsIqC7EJx4gqxYVDWQgntIgqRYXD\nbY3CLpcVgmdPC974BYy3/MgRNM03hR9ubFTHT48AAAAASUVORK5CYII=\n"\n     style="image-rendering:optimizeQuality"\n     preserveAspectRatio="none"\n     height="13.76"\n     width="13.76" />\n</svg>\n';function K(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Q(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function Z(e,t,n){return t&&Q(e.prototype,t),n&&Q(e,n),e}var q=function(){function e(t){var n=this;K(this,e),this.attributes=t;var i=navigator.userAgent.toLowerCase(),o=i.indexOf("android")>-1,r=i.indexOf("ipad")>-1||i.indexOf("iphone")>-1;this.iosSoftkeyboardOpened=!1,this.iosMeasureUnit=-1===i.indexOf("crios")?"%":"vh",this.iosDivHeight="100%".concat(this.iosMeasureUnit);var a=window.outerWidth,s=window.outerHeight,l=a>s,c=a<s,u=l&&this.attributes.height>s,d=c&&this.attributes.width>a,h=u||d;this.instanceId=document.getElementsByClassName("wrs_modal_dialogContainer").length,this.deviceProperties={orientation:l?"landscape":"portait",isAndroid:o,isIOS:r,isMobile:h,isDesktop:!h&&!r&&!o},this.properties={created:!1,state:"",previousState:"",position:{bottom:0,right:10},size:{height:338,width:580}},this.websiteBeforeLockParameters=null;var m={class:"wrs_modal_overlay"};m.id=this.getElementId(m.class),this.overlay=y.createElement("div",m),(m={}).class="wrs_modal_title_bar",m.id=this.getElementId(m.class),this.titleBar=y.createElement("div",m),(m={}).class="wrs_modal_title",m.id=this.getElementId(m.class),this.title=y.createElement("div",m),this.title.innerHTML="",(m={}).class="wrs_modal_close_button",m.id=this.getElementId(m.class),m.title=w.get("close"),m.style={},this.closeDiv=y.createElement("a",m),this.closeDiv.setAttribute("role","button");var g="background-size: 10px; background-image: url(data:image/svg+xml;base64,".concat(window.btoa(R),")"),f="background-size: 10px; background-image: url(data:image/svg+xml;base64,".concat(window.btoa(H),")");this.closeDiv.setAttribute("style",g),this.closeDiv.setAttribute("onmouseover",'this.style = "'.concat(f,'";')),this.closeDiv.setAttribute("onmouseout",'this.style = "'.concat(g,'";')),(m={}).class="wrs_modal_stack_button",m.id=this.getElementId(m.class),m.title=w.get("exit_fullscreen"),this.stackDiv=y.createElement("a",m),this.stackDiv.setAttribute("role","button"),g="background-size: 10px; background-image: url(data:image/svg+xml;base64,".concat(window.btoa(Y),")"),f="background-size: 10px; background-image: url(data:image/svg+xml;base64,".concat(window.btoa(V),")"),this.stackDiv.setAttribute("style",g),this.stackDiv.setAttribute("onmouseover",'this.style = "'.concat(f,'";')),this.stackDiv.setAttribute("onmouseout",'this.style = "'.concat(g,'";')),(m={}).class="wrs_modal_maximize_button",m.id=this.getElementId(m.class),m.title=w.get("fullscreen"),this.maximizeDiv=y.createElement("a",m),this.maximizeDiv.setAttribute("role","button"),g="background-size: 10px; background-repeat: no-repeat; background-image: url(data:image/svg+xml;base64,".concat(window.btoa(X),")"),f="background-size: 10px; background-repeat: no-repeat; background-image: url(data:image/svg+xml;base64,".concat(window.btoa(U),")"),this.maximizeDiv.setAttribute("style",g),this.maximizeDiv.setAttribute("onmouseover",'this.style = "'.concat(f,'";')),this.maximizeDiv.setAttribute("onmouseout",'this.style = "'.concat(g,'";')),(m={}).class="wrs_modal_minimize_button",m.id=this.getElementId(m.class),m.title=w.get("minimize"),this.minimizeDiv=y.createElement("a",m),this.minimizeDiv.setAttribute("role","button"),g="background-size: 10px; background-repeat: no-repeat; background-image: url(data:image/svg+xml;base64,".concat(window.btoa(W),")"),f="background-size: 10px; background-repeat: no-repeat; background-image: url(data:image/svg+xml;base64,".concat(window.btoa(J),")"),this.minimizeDiv.setAttribute("style",g),this.minimizeDiv.setAttribute("onmouseover",'this.style = "'.concat(f,'";')),this.minimizeDiv.setAttribute("onmouseout",'this.style = "'.concat(g,'";')),(m={}).class="wrs_modal_dialogContainer",m.id=this.getElementId(m.class),m.role="dialog",this.container=y.createElement("div",m),this.container.setAttribute("aria-labeledby","wrs_modal_title[0]"),(m={}).class="wrs_modal_wrapper",m.id=this.getElementId(m.class),this.wrapper=y.createElement("div",m),(m={}).class="wrs_content_container",m.id=this.getElementId(m.class),this.contentContainer=y.createElement("div",m),(m={}).class="wrs_modal_controls",m.id=this.getElementId(m.class),this.controls=y.createElement("div",m),(m={}).class="wrs_modal_buttons_container",m.id=this.getElementId(m.class),this.buttonContainer=y.createElement("div",m),this.submitButton=this.createSubmitButton({id:this.getElementId("wrs_modal_button_accept"),class:"wrs_modal_button_accept",innerHTML:w.get("accept")},this.submitAction.bind(this)),this.cancelButton=this.createSubmitButton({id:this.getElementId("wrs_modal_button_cancel"),class:"wrs_modal_button_cancel",innerHTML:w.get("cancel")},this.cancelAction.bind(this)),this.contentManager=null;var p={cancelString:w.get("cancel"),submitString:w.get("close"),message:w.get("close_modal_warning")},_={closeCallback:function(){n.close()},cancelCallback:function(){n.focus()}},v={overlayElement:this.container,callbacks:_,strings:p};this.popup=new N(v),this.rtl=!1,"rtl"in this.attributes&&(this.rtl=this.attributes.rtl),this.handleOpenedIosSoftkeyboard=this.handleOpenedIosSoftkeyboard.bind(this),this.handleClosedIosSoftkeyboard=this.handleClosedIosSoftkeyboard.bind(this)}return Z(e,[{key:"setContentManager",value:function(e){this.contentManager=e}},{key:"getContentManager",value:function(){return this.contentManager}},{key:"submitAction",value:function(){void 0!==this.contentManager.submitAction&&this.contentManager.submitAction(),this.close()}},{key:"cancelAction",value:function(){void 0===this.contentManager.hasChanges?this.close():this.contentManager.hasChanges()?this.showPopUpMessage():this.close()}},{key:"createSubmitButton",value:function(e,t){return new(function(){function n(){K(this,n),this.element=document.createElement("button"),this.element.id=e.id,this.element.className=e.class,this.element.innerHTML=e.innerHTML,y.addEvent(this.element,"click",t)}return Z(n,[{key:"getElement",value:function(){return this.element}}]),n}())(e,t).getElement()}},{key:"create",value:function(){this.parenteditor = document.getElementsByClassName("yui3-htmleditor").item(0) || document.body, this.titleBar.appendChild(this.closeDiv),this.titleBar.appendChild(this.stackDiv),this.titleBar.appendChild(this.maximizeDiv),this.titleBar.appendChild(this.minimizeDiv),this.titleBar.appendChild(this.title),this.deviceProperties.isDesktop&&this.container.appendChild(this.titleBar),this.wrapper.appendChild(this.contentContainer),this.wrapper.appendChild(this.controls),this.controls.appendChild(this.buttonContainer),this.buttonContainer.appendChild(this.submitButton),this.buttonContainer.appendChild(this.cancelButton),this.container.appendChild(this.wrapper),this.recalculateScrollBar(),this.parenteditor.appendChild(this.container),this.parenteditor.appendChild(this.overlay),this.deviceProperties.isDesktop?(this.createModalWindowDesktop(),this.createResizeButtons(),this.addListeners(),l.get("modalWindowFullScreen")&&this.maximize()):this.deviceProperties.isAndroid?this.createModalWindowAndroid():this.deviceProperties.isIOS&&!this.deviceProperties.isMobile&&this.createModalWindowIos(),null!=this.contentManager&&this.contentManager.insert(this),this.properties.open=!0,this.properties.created=!0,this.isRTL()&&(this.container.style.right="".concat(window.innerWidth-this.scrollbarWidth-this.container.offsetWidth,"px"),this.container.className+=" wrs_modal_rtl")}},{key:"createResizeButtons",value:function(){this.resizerBR=document.createElement("div"),this.resizerBR.className="wrs_bottom_right_resizer",this.resizerBR.innerHTML="◢",this.resizerTL=document.createElement("div"),this.resizerTL.className="wrs_bottom_left_resizer",this.container.appendChild(this.resizerBR),this.titleBar.appendChild(this.resizerTL),y.addEvent(this.resizerBR,"mousedown",this.activateResizeStateBR.bind(this)),y.addEvent(this.resizerTL,"mousedown",this.activateResizeStateTL.bind(this))}},{key:"activateResizeStateBR",value:function(e){this.initializeResizeProperties(e,!1)}},{key:"activateResizeStateTL",value:function(e){this.initializeResizeProperties(e,!0)}},{key:"initializeResizeProperties",value:function(e,t){y.addClass(document.body,"wrs_noselect"),y.addClass(this.overlay,"wrs_overlay_active"),this.resizeDataObject={x:this.eventClient(e).X,y:this.eventClient(e).Y},this.initialWidth=parseInt(this.container.style.width,10),this.initialHeight=parseInt(this.container.style.height,10),t?this.leftScale=!0:(this.initialRight=parseInt(this.container.style.right,10),this.initialBottom=parseInt(this.container.style.bottom,10)),this.initialRight||(this.initialRight=0),this.initialBottom||(this.initialBottom=0),document.body.style["user-select"]="none"}},{key:"open",value:function(){var e=this;this.removeClass("wrs_closed");var t=this.deviceProperties.isIOS,n=this.deviceProperties.isAndroid,i=this.deviceProperties.isMobile;if((t||n||i)&&(this.restoreWebsiteScale(),this.lockWebsiteScroll(),setTimeout(function(){e.hideKeyboard()},400)),this.properties.created?(this.properties.open||(this.properties.open=!0,this.deviceProperties.isAndroid||this.deviceProperties.isIOS||this.restoreState()),this.deviceProperties.isDesktop&&l.get("modalWindowFullScreen")&&this.maximize(),this.deviceProperties.isIOS&&(this.iosSoftkeyboardOpened=!1,this.setContainerHeight("".concat(100+this.iosMeasureUnit)))):this.create(),P.isEditorLoaded())this.contentManager.onOpen(this);else{var o=h.newListener("onLoad",function(){e.contentManager.onOpen(e)});this.contentManager.addListener(o)}}},{key:"close",value:function(){this.removeClass("wrs_maximized"),this.removeClass("wrs_minimized"),this.removeClass("wrs_stack"),this.addClass("wrs_closed"),this.saveModalProperties(),this.unlockWebsiteScroll(),this.properties.open=!1}},{key:"restoreWebsiteScale",value:function(){var e=document.querySelector("meta[name=viewport]"),t=["initial-scale=","minimum-scale=","maximum-scale="],n=["1.0","1.0","1.0"],i=function(e,t){var i=e.getAttribute("content");if(i){for(var o=i.split(","),r="",a=[],s=0;s<o.length;s+=1){for(var l=!1,c=0;!l&&c<t.length;)o[s].indexOf(t[c])&&(l=!0),c+=1;l||a.push(o[s])}for(var u=0;u<t.length;u+=1){var d=t[u]+n[u];r+=0===u?d:",".concat(d)}for(var h=0;h<a.length;h+=1)r+=",".concat(a[h]);e.setAttribute("content",r),e.setAttribute("content",""),e.setAttribute("content",i)}else e.setAttribute("content","initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"),e.removeAttribute("content")};e?i(e,t):(e=document.createElement("meta"),document.getElementsByTagName("head")[0].appendChild(e),i(e,t),e.remove())}},{key:"lockWebsiteScroll",value:function(){this.websiteBeforeLockParameters={bodyStylePosition:document.body.style.position?document.body.style.position:"",bodyStyleOverflow:document.body.style.overflow?document.body.style.overflow:"",htmlStyleOverflow:document.documentElement.style.overflow?document.documentElement.style.overflow:"",windowScrollX:window.scrollX,windowScrollY:window.scrollY}}},{key:"unlockWebsiteScroll",value:function(){if(this.websiteBeforeLockParameters){document.body.style.position=this.websiteBeforeLockParameters.bodyStylePosition,document.body.style.overflow=this.websiteBeforeLockParameters.bodyStyleOverflow,document.documentElement.style.overflow=this.websiteBeforeLockParameters.htmlStyleOverflow;var e=this.websiteBeforeLockParameters.windowScrollX,t=this.websiteBeforeLockParameters.windowScrollY;window.scrollTo(e,t),this.websiteBeforeLockParameters=null}}},{key:"isIE11",value:function(){return navigator.userAgent.search("Msie/")>=0||navigator.userAgent.search("Trident/")>=0||navigator.userAgent.search("Edge/")>=0}},{key:"isRTL",value:function(){return"ar"===this.attributes.language||"he"===this.attributes.language||this.rtl}},{key:"addClass",value:function(e){y.addClass(this.overlay,e),y.addClass(this.titleBar,e),y.addClass(this.overlay,e),y.addClass(this.container,e),y.addClass(this.contentContainer,e),y.addClass(this.stackDiv,e),y.addClass(this.minimizeDiv,e),y.addClass(this.maximizeDiv,e),y.addClass(this.wrapper,e)}},{key:"removeClass",value:function(e){y.removeClass(this.overlay,e),y.removeClass(this.titleBar,e),y.removeClass(this.overlay,e),y.removeClass(this.container,e),y.removeClass(this.contentContainer,e),y.removeClass(this.stackDiv,e),y.removeClass(this.minimizeDiv,e),y.removeClass(this.maximizeDiv,e),y.removeClass(this.wrapper,e)}},{key:"createModalWindowDesktop",value:function(){this.addClass("wrs_modal_desktop"),this.stack()}},{key:"createModalWindowAndroid",value:function(){this.addClass("wrs_modal_android"),window.addEventListener("resize",this.orientationChangeAndroidSoftkeyboard.bind(this))}},{key:"createModalWindowIos",value:function(){this.addClass("wrs_modal_ios"),window.addEventListener("resize",this.orientationChangeIosSoftkeyboard.bind(this))}},{key:"restoreState",value:function(){"maximized"===this.properties.state?this.maximize():"minimized"===this.properties.state?(this.properties.state=this.properties.previousState,this.properties.previousState="",this.minimize()):this.stack()}},{key:"stack",value:function(){this.properties.previousState=this.properties.state,this.properties.state="stack",this.removeClass("wrs_maximized"),this.minimizeDiv.title=w.get("minimize"),this.removeClass("wrs_minimized"),this.addClass("wrs_stack");var e="background-size: 10px; background-repeat: no-repeat; background-image: url(data:image/svg+xml;base64,".concat(window.btoa(W),")"),t="background-size: 10px; background-repeat: no-repeat; background-image: url(data:image/svg+xml;base64,".concat(window.btoa(J),")");this.minimizeDiv.setAttribute("style",e),this.minimizeDiv.setAttribute("onmouseover",'this.style = "'.concat(t,'";')),this.minimizeDiv.setAttribute("onmouseout",'this.style = "'.concat(e,'";')),this.restoreModalProperties(),void 0!==this.resizerBR&&void 0!==this.resizerTL&&this.setResizeButtonsVisibility(),this.recalculateScrollBar(),this.recalculatePosition(),this.recalculateScale(),this.focus()}},{key:"minimize",value:function(){if(this.saveModalProperties(),this.title.style.cursor="pointer","minimized"===this.properties.state&&"stack"===this.properties.previousState)this.stack();else if("minimized"===this.properties.state&&"maximized"===this.properties.previousState)this.maximize();else{this.container.style.height="30px",this.container.style.width="250px",this.container.style.bottom="0px",this.container.style.right="10px",this.removeListeners(),this.properties.previousState=this.properties.state,this.properties.state="minimized",this.setResizeButtonsVisibility(),this.minimizeDiv.title=w.get("maximize"),y.containsClass(this.overlay,"wrs_stack")?this.removeClass("wrs_stack"):this.removeClass("wrs_maximized"),this.addClass("wrs_minimized");var e="background-size: 10px; background-repeat: no-repeat; background-image: url(data:image/svg+xml;base64,".concat(window.btoa('<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n<svg\n   xmlns:dc="http://purl.org/dc/elements/1.1/"\n   xmlns:cc="http://creativecommons.org/ns#"\n   xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"\n   xmlns:svg="http://www.w3.org/2000/svg"\n   xmlns="http://www.w3.org/2000/svg"\n   xmlns:xlink="http://www.w3.org/1999/xlink"\n   viewBox="0 0 13.44 13.76"\n   height="13.76"\n   width="13.44"\n   id="svg3803"\n   version="1.1">\n  <metadata\n     id="metadata3809">\n    <rdf:RDF>\n      <cc:Work\n         rdf:about="">\n        <dc:format>image/svg+xml</dc:format>\n        <dc:type\n           rdf:resource="http://purl.org/dc/dcmitype/StillImage" />\n        <dc:title></dc:title>\n      </cc:Work>\n    </rdf:RDF>\n  </metadata>\n  <defs\n     id="defs3807" />\n  <image\n     y="0"\n     x="0"\n     id="image3811"\n     xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACoAAAArCAYAAAAOnxr+AAAACXBIWXMAAC4jAAAuIwF4pT92AAAA\nvElEQVRYw+3ZSw0CMRSF4b8T9iAFB4wDkDAWcICEkTA4GAeAA3AADurgsCkbAgsSMrmFczZNd1/a\n3vSVJFFDGipJNdBZaRdAB2wC2TIwAgNAkrQEjsA86GBegDZJGoF18JnfJtVR9idXvaGGGmrod/b6\nV9kD14k9LbD6FDqUM8CU2b2Deo0aaqihhhpqqKGGGhr1hH/wiP469FaBMzflEhc9PZKQ1CtmsqRO\nEunpHbeNNN3A+dFJ/mf6V+gduGPIoUgKLbAAAAAASUVORK5CYII=\n"\n     style="image-rendering:optimizeQuality"\n     preserveAspectRatio="none"\n     height="13.76"\n     width="13.44" />\n</svg>\n'),")"),t="background-size: 10px; background-repeat: no-repeat; background-image: url(data:image/svg+xml;base64,".concat(window.btoa('<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n<svg\n   xmlns:dc="http://purl.org/dc/elements/1.1/"\n   xmlns:cc="http://creativecommons.org/ns#"\n   xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"\n   xmlns:svg="http://www.w3.org/2000/svg"\n   xmlns="http://www.w3.org/2000/svg"\n   xmlns:xlink="http://www.w3.org/1999/xlink"\n   viewBox="0 0 13.44 13.76"\n   height="13.76"\n   width="13.44"\n   id="svg22"\n   version="1.1">\n  <metadata\n     id="metadata28">\n    <rdf:RDF>\n      <cc:Work\n         rdf:about="">\n        <dc:format>image/svg+xml</dc:format>\n        <dc:type\n           rdf:resource="http://purl.org/dc/dcmitype/StillImage" />\n        <dc:title></dc:title>\n      </cc:Work>\n    </rdf:RDF>\n  </metadata>\n  <defs\n     id="defs26" />\n  <image\n     y="0"\n     x="0"\n     id="image30"\n     xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACoAAAArCAYAAAAOnxr+AAAACXBIWXMAAC4jAAAuIwF4pT92AAAA\nvUlEQVRYw+3ZsQ3CMBCF4d8WFekZgBqWIDUDZACmYBQWYIn0pGYAegZIexROERHRIBTdhXeVy08+\nyT4/JzMjQmWCVBjoarSugK0z3/0degKODjeyBy5Am8ysARrnnT8nM7sCa+fQLgdAAlQ6ngQVVFBB\nfzeUTK6t8VAwU328ztV6QQUVVFBBBRVUUEG9Ds41sJvZs/8GelDrlw7tAjhvmZLo9o6RD4bEGUp+\nX1My/I0T4HN4rrcASf9M/wp9ASNzIKYYz2hAAAAAAElFTkSuQmCC\n"\n     style="image-rendering:optimizeQuality"\n     preserveAspectRatio="none"\n     height="13.76"\n     width="13.44" />\n</svg>\n'),")");this.minimizeDiv.setAttribute("style",e),this.minimizeDiv.setAttribute("onmouseover",'this.style = "'.concat(t,'";')),this.minimizeDiv.setAttribute("onmouseout",'this.style = "'.concat(e,'";'))}}},{key:"maximize",value:function(){this.saveModalProperties(),"maximized"!==this.properties.state&&(this.properties.previousState=this.properties.state,this.properties.state="maximized"),this.setResizeButtonsVisibility(),y.containsClass(this.overlay,"wrs_minimized")?(this.minimizeDiv.title=w.get("minimize"),this.removeClass("wrs_minimized")):y.containsClass(this.overlay,"wrs_stack")&&(this.container.style.left=null,this.container.style.top=null,this.removeClass("wrs_stack")),this.addClass("wrs_maximized");var e="background-size: 10px; background-repeat: no-repeat; background-image: url(data:image/svg+xml;base64,".concat(window.btoa(W),")"),t="background-size: 10px; background-repeat: no-repeat; background-image: url(data:image/svg+xml;base64,".concat(window.btoa(J),")");this.minimizeDiv.setAttribute("style",e),this.minimizeDiv.setAttribute("onmouseover",'this.style = "'.concat(t,'";')),this.minimizeDiv.setAttribute("onmouseout",'this.style = "'.concat(e,'";')),this.setSize(parseInt(.8*window.innerHeight,10),parseInt(.8*window.innerWidth,10)),this.container.clientHeight>700&&(this.container.style.height="700px"),this.container.clientWidth>1200&&(this.container.style.width="1200px");var n=window.innerHeight,i=window.innerWidth,o=n/2-this.container.offsetHeight/2,r=i/2-this.container.offsetWidth/2;this.setPosition(o,r),this.recalculateScale(),this.recalculatePosition(),this.recalculateSize(),this.focus()}},{key:"reExpand",value:function(){"minimized"===this.properties.state&&("maximized"===this.properties.previousState?this.maximize():this.stack(),this.title.style.cursor="")}},{key:"setSize",value:function(e,t){this.container.style.height="".concat(e,"px"),this.container.style.width="".concat(t,"px"),this.recalculateSize()}},{key:"setPosition",value:function(e,t){this.container.style.bottom="".concat(e,"px"),this.container.style.right="".concat(t,"px")}},{key:"saveModalProperties",value:function(){"stack"===this.properties.state&&(this.properties.position.bottom=parseInt(this.container.style.bottom,10),this.properties.position.right=parseInt(this.container.style.right,10),this.properties.size.width=parseInt(this.container.style.width,10),this.properties.size.height=parseInt(this.container.style.height,10))}},{key:"restoreModalProperties",value:function(){"stack"===this.properties.state&&(this.setPosition(this.properties.position.bottom,this.properties.position.right),this.setSize(this.properties.size.height,this.properties.size.width))}},{key:"recalculateSize",value:function(){this.wrapper.style.width="".concat(this.container.clientWidth-12,"px"),this.wrapper.style.height="".concat(this.container.clientHeight-38,"px"),this.contentContainer.style.height="".concat(parseInt(this.wrapper.offsetHeight-50,10),"px")}},{key:"setResizeButtonsVisibility",value:function(){"stack"===this.properties.state?(this.resizerTL.style.visibility="visible",this.resizerBR.style.visibility="visible"):(this.resizerTL.style.visibility="hidden",this.resizerBR.style.visibility="hidden")}},{key:"addListeners",value:function(){this.maximizeDiv.addEventListener("click",this.maximize.bind(this),!0),this.stackDiv.addEventListener("click",this.stack.bind(this),!0),this.minimizeDiv.addEventListener("click",this.minimize.bind(this),!0),this.closeDiv.addEventListener("click",this.cancelAction.bind(this)),this.title.addEventListener("click",this.reExpand.bind(this)),this.overlay.addEventListener("click",this.cancelAction.bind(this)),y.addEvent(window,"mousedown",this.startDrag.bind(this)),y.addEvent(window,"mouseup",this.stopDrag.bind(this)),y.addEvent(window,"mousemove",this.drag.bind(this)),y.addEvent(window,"resize",this.onWindowResize.bind(this)),y.addEvent(this.container,"keydown",this.onKeyDown.bind(this))}},{key:"removeListeners",value:function(){y.removeEvent(window,"mousedown",this.startDrag),y.removeEvent(window,"mouseup",this.stopDrag),y.removeEvent(window,"mousemove",this.drag),y.removeEvent(window,"resize",this.onWindowResize),y.removeEvent(this.container,"keydown",this.onKeyDown)}},{key:"eventClient",value:function(e){return void 0===e.clientX&&e.changedTouches?{X:e.changedTouches[0].clientX,Y:e.changedTouches[0].clientY}:{X:e.clientX,Y:e.clientY}}},{key:"startDrag",value:function(e){"minimized"!==this.properties.state&&e.target===this.title&&(void 0!==this.dragDataObject&&null!==this.dragDataObject||(this.dragDataObject={x:this.eventClient(e).X,y:this.eventClient(e).Y},this.lastDrag={x:"0px",y:"0px"},""===this.container.style.right&&(this.container.style.right="0px"),""===this.container.style.bottom&&(this.container.style.bottom="0px"),this.isIE11(),y.addClass(document.body,"wrs_noselect"),y.addClass(this.overlay,"wrs_overlay_active"),this.limitWindow=this.getLimitWindow()))}},{key:"drag",value:function(e){if(this.dragDataObject){e.preventDefault();var t=Math.min(this.eventClient(e).Y,this.limitWindow.minPointer.y);t=Math.max(this.limitWindow.maxPointer.y,t);var n=Math.min(this.eventClient(e).X,this.limitWindow.minPointer.x);n=Math.max(this.limitWindow.maxPointer.x,n);var i="".concat(n-this.dragDataObject.x,"px"),o="".concat(t-this.dragDataObject.y,"px");this.lastDrag={x:i,y:o},this.container.style.transform="translate3d(".concat(i,",").concat(o,",0)")}if(this.resizeDataObject){var r,a=window.innerWidth,s=window.innerHeight,l=Math.min(this.eventClient(e).X,a-this.scrollbarWidth-7),c=Math.min(this.eventClient(e).Y,s-7);l<0&&(l=0),c<0&&(c=0),r=this.leftScale?-1:1,this.container.style.width="".concat(this.initialWidth+r*(l-this.resizeDataObject.x),"px"),this.container.style.height="".concat(this.initialHeight+r*(c-this.resizeDataObject.y),"px"),this.leftScale||(this.resizeDataObject.x-l-this.initialWidth<-580?this.container.style.right="".concat(this.initialRight-(l-this.resizeDataObject.x),"px"):(this.container.style.right="".concat(this.initialRight+this.initialWidth-580,"px"),this.container.style.width="580px"),this.resizeDataObject.y-c<this.initialHeight-338?this.container.style.bottom="".concat(this.initialBottom-(c-this.resizeDataObject.y),"px"):(this.container.style.bottom="".concat(this.initialBottom+this.initialHeight-338,"px"),this.container.style.height="338px")),this.recalculateScale(),this.recalculatePosition()}}},{key:"getLimitWindow",value:function(){var e=window.innerWidth,t=window.innerHeight,n=this.container.offsetHeight,i=parseInt(this.container.style.bottom,10),o=parseInt(this.container.style.right,10),r=window.pageXOffset,a=this.dragDataObject.y,s=this.dragDataObject.x,l=n+i-(t-(a-r)),c=e-this.scrollbarWidth-(s-r)-o,u=t-this.container.offsetHeight+l,d=this.title.offsetHeight-(this.title.offsetHeight-l);return{minPointer:{x:e-c-this.scrollbarWidth,y:u},maxPointer:{x:this.container.offsetWidth-c,y:d}}}},{key:"getScrollBarWidth",value:function(){var e=document.createElement("p");e.style.width="100%",e.style.height="200px";var t=document.createElement("div");t.style.position="absolute",t.style.top="0px",t.style.left="0px",t.style.visibility="hidden",t.style.width="200px",t.style.height="150px",t.style.overflow="hidden",t.appendChild(e),document.body.appendChild(t);var n=e.offsetWidth;t.style.overflow="scroll";var i=e.offsetWidth;return n===i&&(i=t.clientWidth),document.body.removeChild(t),n-i}},{key:"stopDrag",value:function(){(this.dragDataObject||this.resizeDataObject)&&(this.container.style.transform="",this.dragDataObject&&(this.container.style.right="".concat(parseInt(this.container.style.right,10)-parseInt(this.lastDrag.x,10),"px"),this.container.style.bottom="".concat(parseInt(this.container.style.bottom,10)-parseInt(this.lastDrag.y,10),"px")),this.focus(),document.body.style["user-select"]="",this.isIE11(),y.removeClass(document.body,"wrs_noselect"),y.removeClass(this.overlay,"wrs_overlay_active")),this.dragDataObject=null,this.resizeDataObject=null,this.initialWidth=null,this.leftScale=null}},{key:"onWindowResize",value:function(){this.recalculateScrollBar(),this.recalculatePosition(),this.recalculateScale()}},{key:"onKeyDown",value:function(e){void 0!==e.key&&("block"!==this.popup.overlayWrapper.style.display?"Escape"===e.key||"Esc"===e.key?this.properties.open&&this.contentManager.onKeyDown(e):e.shiftKey&&"Tab"===e.key?document.activeElement===this.cancelButton?(this.submitButton.focus(),e.stopPropagation(),e.preventDefault()):this.contentManager.onKeyDown(e):"Tab"===e.key&&(document.activeElement===this.submitButton?(this.cancelButton.focus(),e.stopPropagation(),e.preventDefault()):this.contentManager.onKeyDown(e)):this.popup.onKeyDown(e))}},{key:"recalculatePosition",value:function(){this.container.style.right="".concat(Math.min(parseInt(this.container.style.right,10),window.innerWidth-this.scrollbarWidth-this.container.offsetWidth),"px"),parseInt(this.container.style.right,10)<0&&(this.container.style.right="0px"),this.container.style.bottom="".concat(Math.min(parseInt(this.container.style.bottom,10),window.innerHeight-this.container.offsetHeight),"px"),parseInt(this.container.style.bottom,10)<0&&(this.container.style.bottom="0px")}},{key:"recalculateScale",value:function(){var e=!1;parseInt(this.container.style.width,10)>580?(this.container.style.width="".concat(Math.min(parseInt(this.container.style.width,10),window.innerWidth-this.scrollbarWidth),"px"),e=!0):(this.container.style.width="580px",e=!0),parseInt(this.container.style.height,10)>338?(this.container.style.height="".concat(Math.min(parseInt(this.container.style.height,10),window.innerHeight),"px"),e=!0):(this.container.style.height="338px",e=!0),e&&this.recalculateSize()}},{key:"recalculateScrollBar",value:function(){this.hasScrollBar=window.innerWidth>document.documentElement.clientWidth,this.hasScrollBar?this.scrollbarWidth=this.getScrollBarWidth():this.scrollbarWidth=0}},{key:"hideKeyboard",value:function(){var e=document.createElement("input");this.container.appendChild(e),e.focus(),e.blur(),e.remove()}},{key:"focus",value:function(){null!=this.contentManager&&void 0!==this.contentManager.onFocus&&this.contentManager.onFocus()}},{key:"portraitMode",value:function(){return window.innerHeight>window.innerWidth}},{key:"handleOpenedIosSoftkeyboard",value:function(){this.iosSoftkeyboardOpened||null==this.iosDivHeight||this.iosDivHeight!=="100".concat(this.iosMeasureUnit)||(this.portraitMode()?this.setContainerHeight("63".concat(this.iosMeasureUnit)):this.setContainerHeight("40".concat(this.iosMeasureUnit))),this.iosSoftkeyboardOpened=!0}},{key:"handleClosedIosSoftkeyboard",value:function(){this.iosSoftkeyboardOpened=!1,this.setContainerHeight("100".concat(this.iosMeasureUnit))}},{key:"orientationChangeIosSoftkeyboard",value:function(){this.iosSoftkeyboardOpened?this.portraitMode()?this.setContainerHeight("63".concat(this.iosMeasureUnit)):this.setContainerHeight("40".concat(this.iosMeasureUnit)):this.setContainerHeight("100".concat(this.iosMeasureUnit))}},{key:"orientationChangeAndroidSoftkeyboard",value:function(){this.setContainerHeight("100%")}},{key:"setContainerHeight",value:function(e){this.iosDivHeight=e,this.wrapper.style.height=e}},{key:"showPopUpMessage",value:function(){"minimized"===this.properties.state&&this.stack(),this.popup.show()}},{key:"setTitle",value:function(e){this.title.innerHTML=e}},{key:"getElementId",value:function(e){return"".concat(e,"[").concat(this.instanceId,"]")}}]),e}();
+    /*! http://mths.be/codepointat v0.1.0 by @mathias */
+    String.prototype.codePointAt||function(){var e=function(e){if(null==this)throw TypeError();var t=String(this),n=t.length,i=e?Number(e):0;if(i!=i&&(i=0),!(i<0||i>=n)){var o,r=t.charCodeAt(i);return r>=55296&&r<=56319&&n>i+1&&(o=t.charCodeAt(i+1))>=56320&&o<=57343?1024*(r-55296)+o-56320+65536:r}};Object.defineProperty?Object.defineProperty(String.prototype,"codePointAt",{value:e,configurable:!0,writable:!0}):String.prototype.codePointAt=e}(),"function"!=typeof Object.assign&&Object.defineProperty(Object,"assign",{value:function(e,t){if(null==e)throw new TypeError("Cannot convert undefined or null to object");for(var n=Object(e),i=1;i<arguments.length;i++){var o=arguments[i];if(null!=o)for(var r in o)Object.prototype.hasOwnProperty.call(o,r)&&(n[r]=o[r])}return n},writable:!0,configurable:!0});n(2);function G(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var $=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.language="en",this.editMode="images",this.modalDialog=null,this.customEditors=new S;if(this.customEditors.addEditor("chemistry",{name:"Chemistry",toolbar:"chemistry",icon:"chem.png",confVariable:"chemEnabled",title:"ChemType",tooltip:"Insert a chemistry formula - ChemType"}),this.environment={},this.editionProperties={},this.editionProperties.isNewElement=!0,this.editionProperties.temporalImage=null,this.editionProperties.latexRange=null,this.editionProperties.range=null,this.integrationModel=null,this.contentManager=null,this.browser=function(){var e=navigator.userAgent,t="none";return e.search("Edge/")>=0?t="EDGE":e.search("Chrome/")>=0?t="CHROME":e.search("Trident/")>=0?t="IE":e.search("Firefox/")>=0?t="FIREFOX":e.search("Safari/")>=0&&(t="SAFARI"),t}(),this.listeners=new h,this.serviceProviderProperties={},!("serviceProviderProperties"in t))throw new Error("serviceProviderProperties property missing.");this.serviceProviderProperties=t.serviceProviderProperties}return function(e,t,n){t&&G(e.prototype,t),n&&G(e,n)}(e,[{key:"setIntegrationModel",value:function(e){this.integrationModel=e}},{key:"setEnvironment",value:function(e){"editor"in e&&(this.environment.editor=e.editor),"mode"in e&&(this.environment.mode=e.mode),"version"in e&&(this.environment.version=e.version)}},{key:"getModalDialog",value:function(){return this.modalDialog}},{key:"init",value:function(){var t=this;if(e.initialized)this.listeners.fire("onLoad",{});else{var n=h.newListener("onInit",function(){var e=g.getService("configurationjs","","get"),n=JSON.parse(e);l.addConfiguration(n),l.addConfiguration(z),w.language=t.language,t.listeners.fire("onLoad",{})});g.addListener(n),g.init(this.serviceProviderProperties),e.initialized=!0}}},{key:"addListener",value:function(e){this.listeners.add(e)}},{key:"beforeUpdateFormula",value:function(t,n){var i=new D;return i.mathml=t,i.wirisProperties={},null!=n&&Object.keys(n).forEach(function(e){i.wirisProperties[e]=n[e]}),i.language=this.language,i.editMode=this.editMode,this.listeners.fire("onBeforeFormulaInsertion",i)?{}:e.globalListeners.fire("onBeforeFormulaInsertion",i)?{}:{mathml:i.mathml,wirisProperties:i.wirisProperties}}},{key:"insertFormula",value:function(e,t,n,i){var o={};if(n)if("latex"===this.editMode){if(o.latex=p.getLatexFromMathML(n),this.integrationModel.fillNonLatexNode&&!o.latex){var r=new D;r.editMode=this.editMode,r.windowTarget=t,r.focusElement=e,r.latex=o.latex,this.integrationModel.fillNonLatexNode(r,t,n)}else o.node=t.document.createTextNode("$$".concat(o.latex,"$$"));this.insertElementOnSelection(o.node,e,t)}else o.node=E.mathmlToImgObject(t.document,n,i,this.language),this.insertElementOnSelection(o.node,e,t);else this.insertElementOnSelection(null,e,t);return o}},{key:"afterUpdateFormula",value:function(t,n,i,o){var r=new D;return r.editMode=this.editMode,r.windowTarget=n,r.focusElement=t,r.node=i,r.latex=o,this.listeners.fire("onAfterFormulaInsertion",r)?{}:(e.globalListeners.fire("onAfterFormulaInsertion",r),{})}},{key:"placeCaretAfterNode",value:function(e){this.integrationModel.getSelection();var t=e.ownerDocument;if(void 0!==t.getSelection&&e.parentElement){var n=t.createRange();n.setStartAfter(e),n.collapse(!0);var i=t.getSelection();i.removeAllRanges(),i.addRange(n),t.body.focus()}}},{key:"insertElementOnSelection",value:function(e,t,n){if(this.editionProperties.isNewElement)if(e)if("textarea"===t.type)y.updateTextArea(t,e.textContent);else if(document.selection&&0===document.getSelection){var i=n.document.selection.createRange();if(n.document.execCommand("InsertImage",!1,e.src),"parentElement"in i||(n.document.execCommand("delete",!1),i=n.document.selection.createRange(),n.document.execCommand("InsertImage",!1,e.src)),"parentElement"in i){var o=i.parentElement();"IMG"===o.nodeName.toUpperCase()?o.parentNode.replaceChild(e,o):i.pasteHTML(y.createObjectCode(e))}}else{var r=this.integrationModel.getSelection(),a=null;this.editionProperties.range?(a=this.editionProperties.range,this.editionProperties.range=null):a=r.getRangeAt(0),a.deleteContents();var s=a.startContainer,l=a.startOffset;3===s.nodeType?(s=s.splitText(l)).parentNode.insertBefore(e,s):1===s.nodeType&&s.insertBefore(e,s.childNodes[l]),this.placeCaretAfterNode(e)}else if("textarea"===t.type)t.focus();else{var c=this.integrationModel.getSelection();if(c.removeAllRanges(),this.editionProperties.range){var u=this.editionProperties.range;this.editionProperties.range=null,c.addRange(u)}}else if(this.editionProperties.latexRange)document.selection&&0===document.getSelection?(this.editionProperties.isNewElement=!0,this.editionProperties.latexRange.select(),this.insertElementOnSelection(e,t,n)):(this.editionProperties.latexRange.deleteContents(),this.editionProperties.latexRange.insertNode(e),this.placeCaretAfterNode(e));else if("textarea"===t.type){var d;d=void 0!==this.integrationModel.getSelectedItem?this.integrationModel.getSelectedItem(t,!1):y.getSelectedItemOnTextarea(t),y.updateExistingTextOnTextarea(t,e.textContent,d.startPosition,d.endPosition)}else e&&"img"===e.nodeName.toLowerCase()?(A.removeImgDataAttributes(this.editionProperties.temporalImage),A.clone(e,this.editionProperties.temporalImage)):this.editionProperties.temporalImage.remove(),this.placeCaretAfterNode(this.editionProperties.temporalImage)}},{key:"openModalDialog",value:function(e,t){var n,i=this;this.editMode="images";try{if(t){e.contentWindow.focus();var o=e.contentWindow.getSelection();this.editionProperties.range=o.getRangeAt(0)}else{e.focus();var r=getSelection();this.editionProperties.range=r.getRangeAt(0)}}catch(e){this.editionProperties.range=null}if(void 0===t&&(t=!0),this.editionProperties.latexRange=null,e)if(n=void 0!==this.integrationModel.getSelectedItem?this.integrationModel.getSelectedItem(e,t):y.getSelectedItem(e,t)){if(!n.caretPosition&&y.containsClass(n.node,l.get("imageClassName")))this.editionProperties.temporalImage=n.node,this.editionProperties.isNewElement=!1;else if(3===n.node.nodeType)if(this.integrationModel.getMathmlFromTextNode){var s=this.integrationModel.getMathmlFromTextNode(n.node,n.caretPosition);s&&(this.editMode="latex",this.editionProperties.isNewElement=!1,this.editionProperties.temporalImage=document.createElement("img"),this.editionProperties.temporalImage.setAttribute(l.get("imageMathmlAttribute"),a.safeXmlEncode(s)))}else{var c=p.getLatexFromTextNode(n.node,n.caretPosition);if(c){var u=p.getMathMLFromLatex(c.latex);this.editMode="latex",this.editionProperties.isNewElement=!1,this.editionProperties.temporalImage=document.createElement("img"),this.editionProperties.temporalImage.setAttribute(l.get("imageMathmlAttribute"),a.safeXmlEncode(u));var d=t?e.contentWindow:window;if("textarea"!==e.tagName.toLowerCase())if(document.selection){for(var m=0,g=c.startNode.previousSibling;g;)m+=y.getNodeLength(g),g=g.previousSibling;this.editionProperties.latexRange=d.document.selection.createRange(),this.editionProperties.latexRange.moveToElementText(c.startNode.parentNode),this.editionProperties.latexRange.move("character",m+c.startPosition),this.editionProperties.latexRange.moveEnd("character",c.latex.length+4)}else this.editionProperties.latexRange=d.document.createRange(),this.editionProperties.latexRange.setStart(c.startNode,c.startPosition),this.editionProperties.latexRange.setEnd(c.endNode,c.endPosition)}}}else"textarea"===e.tagName.toLowerCase()&&(this.editMode="latex");for(var f=l.get("editorAttributes").split(", "),_={},v=0,w=f.length;v<w;v+=1){var b=f[v].split("="),x=b[0],A=b[1];_[x]=A}var C={},k=l.get("editorParameters"),M=this.integrationModel.editorParameters;Object.assign(C,_,k),Object.assign(C,_,M),C.language=this.language,C.rtl=this.integrationModel.rtl;var E={};if(E.editorAttributes=C,E.language=this.language,E.customEditors=this.customEditors,E.environment=this.environment,null==this.modalDialog){this.modalDialog=new q(C),this.contentManager=new P(E);var T=h.newListener("onLoad",function(){if(i.contentManager.isNewElement=i.editionProperties.isNewElement,null!=i.editionProperties.temporalImage){var e=a.safeXmlDecode(i.editionProperties.temporalImage.getAttribute(l.get("imageMathmlAttribute")));i.contentManager.mathML=e}});this.contentManager.addListener(T),this.contentManager.init(),this.modalDialog.setContentManager(this.contentManager),this.contentManager.setModalDialogInstance(this.modalDialog)}else if(this.contentManager.isNewElement=this.editionProperties.isNewElement,null!=this.editionProperties.temporalImage){var I=a.safeXmlDecode(this.editionProperties.temporalImage.getAttribute(l.get("imageMathmlAttribute")));this.contentManager.mathML=I}this.contentManager.setIntegrationModel(this.integrationModel),this.modalDialog.open()}},{key:"getCustomEditors",value:function(){return this.customEditors}}],[{key:"globalListeners",get:function(){return e._globalListeners},set:function(t){e._globalListeners=t}},{key:"initialized",get:function(){return e._initialized},set:function(t){e._initialized=t}},{key:"addGlobalListener",value:function(t){e.globalListeners.add(t)}}]),e}();function ee(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}$._globalListeners=new h,$._initialized=!1;var te=function(){function e(t){var n=this;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.language="en",this.serviceProviderProperties={},"serviceProviderProperties"in t&&(this.serviceProviderProperties=t.serviceProviderProperties),this.configurationService="","configurationService"in t&&(this.serviceProviderProperties.URI=t.configurationService,console.warn("Deprecated property configurationService. Use serviceParameters on instead.",[t.configurationService])),this.version="version"in t?t.version:"",this.target=null,!("target"in t))throw new Error("IntegrationModel constructor error: target property missed.");this.target=t.target,"scriptName"in t&&(this.scriptName=t.scriptName),this.callbackMethodArguments={},"callbackMethodArguments"in t&&(this.callbackMethodArguments=t.callbackMethodArguments),this.environment={},"environment"in t&&(this.environment=t.environment),this.isIframe=!1,null!=this.target&&(this.isIframe="IFRAME"===this.target.tagName.toUpperCase()),this.editorObject=null,"editorObject"in t&&(this.editorObject=t.editorObject),this.rtl=!1,"rtl"in t&&(this.rtl=t.rtl),this.managesLanguage=!1,"managesLanguage"in t&&(this.managesLanguage=t.managesLanguage),this.temporalImageResizing=!1,this.core=null,this.listeners=new h,"integrationParameters"in t&&e.integrationParameters.forEach(function(e){if(e in t.integrationParameters){var i=t.integrationParameters[e];0!==Object.keys(i).length&&(n[e]=i)}})}return function(e,t,n){t&&ee(e.prototype,t),n&&ee(e,n)}(e,[{key:"init",value:function(){var e=this;this.language=this.getLanguage();var t=h.newListener("onLoad",function(){e.callbackFunction(e.callbackMethodArguments)});if(-1!==this.serviceProviderProperties.URI.indexOf("configuration")){var n=this.serviceProviderProperties.URI,i=g.getServerLanguageFromService(n);this.serviceProviderProperties.server=i;var o=this.serviceProviderProperties.URI.indexOf("configuration"),r=this.serviceProviderProperties.URI.substring(0,o);this.serviceProviderProperties.URI=r}var a=this.serviceProviderProperties.URI;a=0===a.indexOf("/")||0===a.indexOf("http")?a:y.concatenateUrl(this.getPath(),a),this.serviceProviderProperties.URI=a;var s={};s.serviceProviderProperties=this.serviceProviderProperties,this.setCore(new $(s)),this.core.addListener(t),this.core.language=this.language,this.core.init(),this.core.setEnvironment(this.environment)}},{key:"getPath",value:function(){if(void 0===this.scriptName)throw new Error("scriptName property needed for getPath.");for(var e=document.getElementsByTagName("script"),t="",n=0;n<e.length;n+=1){var i=e[n].src.lastIndexOf(this.scriptName);i>=0&&(t=e[n].src.substr(0,i-1))}return t}},{key:"setLanguage",value:function(e){this.language=e}},{key:"setCore",value:function(e){this.core=e,e.setIntegrationModel(this)}},{key:"getCore",value:function(){return this.core}},{key:"setTarget",value:function(e){this.target=e,this.isIframe="IFRAME"===this.target.tagName.toUpperCase()}},{key:"setEditorObject",value:function(e){this.editorObject=e}},{key:"openNewFormulaEditor",value:function(){this.core.editionProperties.isNewElement=!0,this.core.openModalDialog(this.target,this.isIframe)}},{key:"openExistingFormulaEditor",value:function(){this.core.editionProperties.isNewElement=!1,this.core.openModalDialog(this.target,this.isIframe)}},{key:"updateFormula",value:function(e){var t,n;this.editorParameters&&(e=com.wiris.editor.util.EditorUtils.addAnnotation(e,"application/vnd.wiris.mtweb-params+json",JSON.stringify(this.editorParameters)));this.isIframe?(t=this.target.contentWindow,n=this.target.contentWindow):(t=this.target,n=window);var i=this.core.beforeUpdateFormula(e,null);return i&&(i=this.insertFormula(t,n,i.mathml,i.wirisProperties))?this.core.afterUpdateFormula(i.focusElement,i.windowTarget,i.node,i.latex):""}},{key:"insertFormula",value:function(e,t,n,i){return this.core.insertFormula(e,t,n,i)}},{key:"getSelection",value:function(){return this.isIframe?(this.target.contentWindow.focus(),this.target.contentWindow.getSelection()):(this.target.focus(),window.getSelection())}},{key:"addEvents",value:function(){var e=this,t=this.isIframe?this.target.contentWindow.document:this.target;y.addElementEvents(t,function(t,n){e.doubleClickHandler(t,n)},function(t,n){e.mousedownHandler(t,n)},function(t,n){e.mouseupHandler(t,n)})}},{key:"doubleClickHandler",value:function(e){if("img"===e.nodeName.toLowerCase()){this.core.getCustomEditors().disable();var t=l.get("imageCustomEditorName");if(e.hasAttribute(t)){var n=e.getAttribute(t);this.core.getCustomEditors().enable(n)}y.containsClass(e,l.get("imageClassName"))&&(this.core.editionProperties.temporalImage=e,this.core.editionProperties.isNewElement=!0,this.openExistingFormulaEditor())}}},{key:"mouseupHandler",value:function(){var e=this;this.temporalImageResizing&&setTimeout(function(){A.fixAfterResize(e.temporalImageResizing)},10)}},{key:"mousedownHandler",value:function(e){"img"===e.nodeName.toLowerCase()&&y.containsClass(e,l.get("imageClassName"))&&(this.temporalImageResizing=e)}},{key:"getLanguage",value:function(){return this.getBrowserLanguage()}},{key:"getBrowserLanguage",value:function(){return navigator.userLanguage?navigator.userLanguage.substring(0,2):navigator.language?navigator.language.substring(0,2):"en"}},{key:"callbackFunction",value:function(){var e=this,t=h.newListener("onTargetReady",function(){e.addEvents(e.target)});this.listeners.add(t)}},{key:"notifyWindowClosed",value:function(){}},{key:"getMathmlFromTextNode",value:function(e,t){}},{key:"fillNonLatexNode",value:function(e,t,n){}},{key:"getSelectedItem",value:function(e,t){}}]),e}();function ne(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}te.prototype.getMathmlFromTextNode=void 0,te.prototype.fillNonLatexNode=void 0,te.prototype.getSelectedItem=void 0,te.integrationParameters=["serviceProviderProperties","editorParameters"];var ie=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return function(e,t,n){t&&ne(e.prototype,t),n&&ne(e,n)}(e,null,[{key:"init",value:function(){e.testServices()}},{key:"testServices",value:function(){var e;console.log("Testing configuration service..."),console.log(g.getService("configurationjs","","get")),console.log("Testing showimage service..."),(e=[]).mml='<math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mi>x</mi><mn>2</mn></msup></math>',console.log(g.getService("showimage",e)),console.log("Testing createimage service..."),(e=[]).mml='<math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mi>x</mi><mn>2</mn></msup></math>',console.log(g.getService("createimage",e,"post")),console.log("Testing MathML2Latex service..."),(e=[]).service="mathml2latex",e.mml='<math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mi>x</mi><mn>2</mn></msup></math>',console.log(g.getService("service",e)),console.log("Testing Latex2MathML service..."),(e=[]).service="latex2mathml",e.latex="x^2",console.log(g.getService("service",e)),console.log("Testing Mathml2Accesible service..."),(e=[]).service="mathml2accessible",e.mml='<math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mi>x</mi><mn>2</mn></msup></math>',console.log(g.getService("service",e))}}]),e}();window.WirisPlugin={Core:$,Parser:E,Image:A,MathML:a,Util:y,Configuration:l,Listeners:h,IntegrationModel:te,Latex:p,Test:ie}}]);
\ No newline at end of file
Index: mod/assign/feedback/editpdf/README.md
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/mod/assign/feedback/editpdf/README.md b/mod/assign/feedback/editpdf/README.md
new file mode 100644
--- /dev/null	(revision 04987007906c32f192cd454d58ec87f4a53d79c4)
+++ b/mod/assign/feedback/editpdf/README.md	(revision 04987007906c32f192cd454d58ec87f4a53d79c4)
@@ -0,0 +1,23 @@
+# Assign Feedback Edit PDF plugin
+## Requirements
+### OS packages
+- texlive-full (200+ packages)
+  - debian: apt install texlive-full
+  - redhat: yum install texlive
+- imagick
+  - debian: apt install php-imagick
+  - redhat: yum install php74-pecl-imagick
+- ghostscript (you probably have it installed because of Moodle)
+
+### PHP extensions
+- imagick
+
+### Moodle Plugins
+- editor_atto
+- filter_tex
+- filter_mathjaxloader
+
+## Enable Plugin
+1. Enable Atto Editor
+1. Enable filter_tex
+1. Enable filter_mathjaxloader
Index: mod/assign/feedback/editpdf/ajax.php
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/mod/assign/feedback/editpdf/ajax.php b/mod/assign/feedback/editpdf/ajax.php
--- a/mod/assign/feedback/editpdf/ajax.php	(revision 2729694d4d56ca2c88bb180aee3f254f8be906cf)
+++ b/mod/assign/feedback/editpdf/ajax.php	(revision 0b9764ed79311babea3acc01b01be2b999f9ec4f)
@@ -108,6 +108,7 @@
             $index = count($response->pages);
             $page = new stdClass();
             $comments = page_editor::get_comments($grade->id, $index, $draft);
+            $htmlcomments = page_editor::get_htmlcomments($grade->id, $index, $draft);
             $page->url = moodle_url::make_pluginfile_url($context->id,
                                                         'assignfeedback_editpdf',
                                                         $filearea,
@@ -115,6 +116,7 @@
                                                         '/',
                                                         $pagefile->get_filename())->out();
             $page->comments = $comments;
+            $page->htmlcomments = $htmlcomments;
             if ($imageinfo = $pagefile->get_imageinfo()) {
                 $page->width = $imageinfo['width'];
                 $page->height = $imageinfo['height'];
@@ -152,6 +154,10 @@
     $added = page_editor::set_comments($grade->id, $index, $page->comments);
     if ($added != count($page->comments)) {
         array_push($response->errors, get_string('couldnotsavepage', 'assignfeedback_editpdf', $index+1));
+    }
+    $added = page_editor::set_htmlcomments($grade->id, $index, $page->htmlcomments);
+    if ($added != count($page->htmlcomments)) {
+        array_push($response->errors, get_string('couldnotsavepage', 'assignfeedback_editpdf', $index+1));
     }
     $added = page_editor::set_annotations($grade->id, $index, $page->annotations);
     if ($added != count($page->annotations)) {
Index: mod/assign/feedback/editpdf/backup/moodle2/backup_assignfeedback_editpdf_subplugin.class.php
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/mod/assign/feedback/editpdf/backup/moodle2/backup_assignfeedback_editpdf_subplugin.class.php b/mod/assign/feedback/editpdf/backup/moodle2/backup_assignfeedback_editpdf_subplugin.class.php
--- a/mod/assign/feedback/editpdf/backup/moodle2/backup_assignfeedback_editpdf_subplugin.class.php	(revision 2729694d4d56ca2c88bb180aee3f254f8be906cf)
+++ b/mod/assign/feedback/editpdf/backup/moodle2/backup_assignfeedback_editpdf_subplugin.class.php	(revision 1e14e638a053afef52d4e058417d3e3228ac6d7b)
@@ -48,6 +48,8 @@
         $subpluginelementannotation = new backup_nested_element('annotation', null, array('gradeid', 'pageno', 'type', 'x', 'y', 'endx', 'endy', 'colour', 'path', 'draft'));
         $subpluginelementcomments = new backup_nested_element('feedback_editpdf_comments');
         $subpluginelementcomment = new backup_nested_element('comment', null, array('gradeid', 'pageno', 'x', 'y', 'width', 'rawtext', 'colour', 'draft'));
+        $subpluginelementhtmlcomments = new backup_nested_element('feedback_editpdf_htmlcomments');
+        $subpluginelementhtmlcomment = new backup_nested_element('htmlcomment', null, array('gradeid', 'pageno', 'x', 'y', 'width', 'rawtext', 'draft'));
         $subpluginelementrotation = new backup_nested_element('feedback_editpdf_rotation');
         $subpluginelementpagerotation = new backup_nested_element('pagerotation', null,
             array('gradeid', 'pageno', 'pathnamehash', 'isrotated', 'degree'));
@@ -56,16 +58,19 @@
         $subplugin->add_child($subpluginwrapper);
         $subpluginelementannotations->add_child($subpluginelementannotation);
         $subpluginelementcomments->add_child($subpluginelementcomment);
+        $subpluginelementhtmlcomments->add_child($subpluginelementhtmlcomment);
         $subpluginelementrotation->add_child($subpluginelementpagerotation);
         $subpluginwrapper->add_child($subpluginelementfiles);
         $subpluginwrapper->add_child($subpluginelementannotations);
         $subpluginwrapper->add_child($subpluginelementcomments);
+        $subpluginwrapper->add_child($subpluginelementhtmlcomments);
         $subpluginwrapper->add_child($subpluginelementrotation);
 
         // Set source to populate the data.
         $subpluginelementfiles->set_source_sql('SELECT id AS gradeid from {assign_grades} where id = :gradeid', array('gradeid' => backup::VAR_PARENTID));
         $subpluginelementannotation->set_source_table('assignfeedback_editpdf_annot', array('gradeid' => backup::VAR_PARENTID));
         $subpluginelementcomment->set_source_table('assignfeedback_editpdf_cmnt', array('gradeid' => backup::VAR_PARENTID));
+        $subpluginelementhtmlcomment->set_source_table('assignfeedback_editpdf_htcm', array('gradeid' => backup::VAR_PARENTID));
         $subpluginelementpagerotation->set_source_table('assignfeedback_editpdf_rot', array('gradeid' => backup::VAR_PARENTID));
         // We only need to backup the files in the final pdf area, and the readonly page images - the others can be regenerated.
         $subpluginelementfiles->annotate_files('assignfeedback_editpdf',
Index: mod/assign/feedback/editpdf/backup/moodle2/restore_assignfeedback_editpdf_subplugin.class.php
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/mod/assign/feedback/editpdf/backup/moodle2/restore_assignfeedback_editpdf_subplugin.class.php b/mod/assign/feedback/editpdf/backup/moodle2/restore_assignfeedback_editpdf_subplugin.class.php
--- a/mod/assign/feedback/editpdf/backup/moodle2/restore_assignfeedback_editpdf_subplugin.class.php	(revision 2729694d4d56ca2c88bb180aee3f254f8be906cf)
+++ b/mod/assign/feedback/editpdf/backup/moodle2/restore_assignfeedback_editpdf_subplugin.class.php	(revision 1e14e638a053afef52d4e058417d3e3228ac6d7b)
@@ -57,6 +57,11 @@
         $elepath = $this->get_pathfor('/feedback_editpdf_annotations/annotation');
         $paths[] = new restore_path_element($elename, $elepath);
 
+        // Html comment details.
+        $elename = $this->get_namefor('htmlcomment');
+        $elepath = $this->get_pathfor('/feedback_editpdf_htmlcomments/htmlcomment');
+        $paths[] = new restore_path_element($elename, $elepath);
+
         // Rotation details.
         $elename = $this->get_namefor('pagerotation');
         $elepath = $this->get_pathfor('/feedback_editpdf_rotation/pagerotation');
@@ -114,6 +119,23 @@
 
     }
 
+    /**
+     * Processes one feedback_editpdf_htmlcomments/htmlcomment element
+     * @param mixed $data
+     */
+    public function process_assignfeedback_editpdf_htmlcomment($data) {
+        global $DB;
+
+        $data = (object)$data;
+        $oldgradeid = $data->gradeid;
+        // The mapping is set in the restore for the core assign activity
+        // when a grade node is processed.
+        $data->gradeid = $this->get_mappingid('grade', $data->gradeid);
+
+        $DB->insert_record('assignfeedback_editpdf_htcm', $data);
+
+    }
+
     /**
      * Processes one /feedback_editpdf_rotation/pagerotation element
      * @param mixed $data
Index: mod/assign/feedback/editpdf/classes/document_services.php
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/mod/assign/feedback/editpdf/classes/document_services.php b/mod/assign/feedback/editpdf/classes/document_services.php
--- a/mod/assign/feedback/editpdf/classes/document_services.php	(revision 2729694d4d56ca2c88bb180aee3f254f8be906cf)
+++ b/mod/assign/feedback/editpdf/classes/document_services.php	(revision 0b9764ed79311babea3acc01b01be2b999f9ec4f)
@@ -691,6 +691,7 @@
         page_editor::release_drafts($grade->id);
 
         $allcomments = array();
+        $allhtmlcomments = array();
 
         for ($i = 0; $i < $pagecount; $i++) {
             $pagerotation = page_editor::get_page_rotation($grade->id, $i);
@@ -708,12 +709,17 @@
             }
 
             $comments = page_editor::get_comments($grade->id, $i, false);
+            $htmlcomments = page_editor::get_htmlcomments($grade->id, $i, false);
             $annotations = page_editor::get_annotations($grade->id, $i, false);
 
             if (!empty($comments)) {
                 $allcomments[$i] = $comments;
             }
 
+            if (!empty($htmlcomments)) {
+                $allhtmlcomments[$i] = $htmlcomments;
+            }
+
             foreach ($annotations as $annotation) {
                 $pdf->add_annotation($annotation->x,
                                      $annotation->y,
@@ -740,6 +746,17 @@
             }
         }
 
+        if (!empty($allhtmlcomments)) {
+            // Add the comment markers with links.
+            foreach ($allhtmlcomments as $pageno => $htmlcomments) {
+                foreach ($htmlcomments as $index => $htmlcomment) {
+                    $pdf->add_htmlcomment($htmlcomment->pageno, $htmlcomment->width , $htmlcomment->x, $htmlcomment->y,
+                            $htmlcomment->rawtext);
+                }
+            }
+        }
+
+
         fulldelete($stamptmpdir);
 
         $filename = self::get_downloadable_feedback_filename($assignment, $userid, $attemptnumber);
Index: mod/assign/feedback/editpdf/classes/htmlcomment.php
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/mod/assign/feedback/editpdf/classes/htmlcomment.php b/mod/assign/feedback/editpdf/classes/htmlcomment.php
new file mode 100644
--- /dev/null	(revision 0b9764ed79311babea3acc01b01be2b999f9ec4f)
+++ b/mod/assign/feedback/editpdf/classes/htmlcomment.php	(revision 0b9764ed79311babea3acc01b01be2b999f9ec4f)
@@ -0,0 +1,73 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * This file contains the comment class for the assignfeedback_editpdf plugin
+ *
+ * @package   assignfeedback_editpdf
+ * @copyright 2012 Davo Smith
+ * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+namespace assignfeedback_editpdf;
+
+/**
+ * This class represents a comment box on a page of feedback.
+ * @copyright 2012 Davo Smith
+ * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+class htmlcomment {
+
+    /** @var int unique id for this annotation */
+    public $id = 0;
+
+    /** @var int gradeid for this annotation */
+    public $gradeid = 0;
+
+    /** @var int page number for this annotation */
+    public $pageno = 0;
+
+    /** @var int starting location in pixels. Image resolution is 100 pixels per inch */
+    public $x = 0;
+
+    /** @var int starting location in pixels. Image resolution is 100 pixels per inch */
+    public $y = 0;
+
+    /** @var int width of the comment box */
+    public $width = 120;
+
+    /** @var string The comment text. */
+    public $rawtext = '';
+
+    /**
+     * Convert a compatible stdClass into an instance of a comment.
+     * @param \stdClass $record
+     */
+    public function __construct(\stdClass $record = null) {
+        if ($record) {
+            $intcols = array('width', 'x', 'y');
+            foreach ($this as $key => $value) {
+                if (isset($record->$key)) {
+                    if (in_array($key, $intcols)) {
+                        $this->$key = (int)($record->$key);
+                    } else {
+                        $this->$key = $record->$key;
+                    }
+                }
+            }
+        }
+    }
+}
Index: mod/assign/feedback/editpdf/classes/page_editor.php
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/mod/assign/feedback/editpdf/classes/page_editor.php b/mod/assign/feedback/editpdf/classes/page_editor.php
--- a/mod/assign/feedback/editpdf/classes/page_editor.php	(revision 2729694d4d56ca2c88bb180aee3f254f8be906cf)
+++ b/mod/assign/feedback/editpdf/classes/page_editor.php	(revision 0b9764ed79311babea3acc01b01be2b999f9ec4f)
@@ -127,6 +127,99 @@
         return $DB->delete_records('assignfeedback_editpdf_cmnt', array('id'=>$commentid));
     }
 
+    /**
+     * Get all htmlcomments for a page.
+     * @param int $gradeid
+     * @param int $pageno
+     * @param bool $draft
+     * @return htmlcomment[]
+     */
+    public static function get_htmlcomments($gradeid, $pageno, $draft) {
+        global $DB;
+
+        $htmlcomments = array();
+        $params = array('gradeid'=>$gradeid, 'pageno'=>$pageno, 'draft'=>1);
+        if (!$draft) {
+            $params['draft'] = 0;
+        }
+        // Fetch comments ordered by position on the page.
+        $records = $DB->get_records('assignfeedback_editpdf_htcm', $params, 'y, x');
+        foreach ($records as $record) {
+            array_push($htmlcomments, new htmlcomment($record));
+        }
+
+        return $htmlcomments;
+    }
+
+    /**
+     * Set all htmlcomments for a page.
+     * @param int $gradeid
+     * @param int $pageno
+     * @param htmlcomment[] $htmlcomments
+     * @return int - the number of htmlcomments.
+     */
+    public static function set_htmlcomments($gradeid, $pageno, $htmlcomments) {
+        global $DB;
+
+        $DB->delete_records('assignfeedback_editpdf_htcm', array('gradeid'=>$gradeid, 'pageno'=>$pageno, 'draft'=>1));
+
+        $added = 0;
+        foreach ($htmlcomments as $record) {
+            // Force these.
+            if (!($record instanceof htmlcomment)) {
+                $htmlcomment = new htmlcomment($record);
+            } else {
+                $htmlcomment = $record;
+            }
+            if (trim($htmlcomment->rawtext) === '') {
+                continue;
+            }
+            $htmlcomment->gradeid = $gradeid;
+            $htmlcomment->pageno = $pageno;
+            $htmlcomment->draft = 1;
+            if (self::add_htmlcomment($htmlcomment)) {
+                $added++;
+            }
+        }
+
+        return $added;
+    }
+
+    /**
+     * Get a single htmlcomment by id.
+     * @param int $htmlcommentid
+     * @return htmlcomment or false
+     */
+    public static function get_htmlcomment($htmlcommentid) {
+        global $DB;
+        $record = $DB->get_record('assignfeedback_editpdf_htcm', array('id'=>$htmlcommentid), '*', IGNORE_MISSING);
+        if ($record) {
+            return new htmlcomment($record);
+        }
+        return false;
+    }
+
+    /**
+     * Add a htmlcomment to a page.
+     * @param htmlcomment $htmlcomment
+     * @return bool
+     */
+    public static function add_htmlcomment(htmlcomment $htmlcomment) {
+        global $DB;
+        $htmlcomment->id = null;
+        return $DB->insert_record('assignfeedback_editpdf_htcm', $htmlcomment);
+    }
+
+    /**
+     * Remove a htmlcomment from a page.
+     * @param int $htmlcommentid
+     * @return bool
+     */
+    public static function remove_htmlcomment($htmlcommentid) {
+        global $DB;
+        return $DB->delete_records('assignfeedback_editpdf_htcm', array('id'=>$htmlcommentid));
+    }
+
     /**
      * Get all annotations for a page.
      * @param int $gradeid
@@ -205,6 +298,7 @@
 
         // Delete the non-draft annotations and comments.
         $result = $DB->delete_records('assignfeedback_editpdf_cmnt', array('gradeid'=>$gradeid, 'draft'=>0));
+        $result = $DB->delete_records('assignfeedback_editpdf_htcm', array('gradeid'=>$gradeid, 'draft'=>0)) && $result;
         $result = $DB->delete_records('assignfeedback_editpdf_annot', array('gradeid'=>$gradeid, 'draft'=>0)) && $result;
         return $result;
     }
@@ -219,6 +313,7 @@
 
         // Delete the previous non-draft annotations and comments.
         $DB->delete_records('assignfeedback_editpdf_cmnt', array('gradeid'=>$gradeid, 'draft'=>0));
+        $DB->delete_records('assignfeedback_editpdf_htcm', array('gradeid'=>$gradeid, 'draft'=>0));
         $DB->delete_records('assignfeedback_editpdf_annot', array('gradeid'=>$gradeid, 'draft'=>0));
 
         // Copy all the draft annotations and comments to non-drafts.
@@ -234,6 +329,12 @@
             $record->draft = 0;
             $DB->insert_record('assignfeedback_editpdf_cmnt', $record);
         }
+        $records = $DB->get_records('assignfeedback_editpdf_htcm', array('gradeid'=>$gradeid, 'draft'=>1));
+        foreach ($records as $record) {
+            unset($record->id);
+            $record->draft = 0;
+            $DB->insert_record('assignfeedback_editpdf_htcm', $record);
+        }
 
         return true;
     }
@@ -251,6 +352,9 @@
         }
         if ($DB->count_records('assignfeedback_editpdf_cmnt', $params)) {
             return true;
+        }
+        if ($DB->count_records('assignfeedback_editpdf_htcm', $params)) {
+            return true;
         }
         if ($DB->count_records('assignfeedback_editpdf_annot', $params)) {
             return true;
@@ -268,6 +372,7 @@
 
         // Delete the previous non-draft annotations and comments.
         $DB->delete_records('assignfeedback_editpdf_cmnt', array('gradeid'=>$gradeid, 'draft'=>1));
+        $DB->delete_records('assignfeedback_editpdf_htcm', array('gradeid'=>$gradeid, 'draft'=>1));
         $DB->delete_records('assignfeedback_editpdf_annot', array('gradeid'=>$gradeid, 'draft'=>1));
 
         // Copy all the draft annotations and comments to non-drafts.
@@ -283,6 +388,13 @@
             $record->draft = 0;
             $DB->insert_record('assignfeedback_editpdf_annot', $record);
         }
+
+        $records = $DB->get_records('assignfeedback_editpdf_htcm', array('gradeid'=>$gradeid, 'draft'=>0));
+        foreach ($records as $record) {
+            unset($record->id);
+            $record->draft = 0;
+            $DB->insert_record('assignfeedback_editpdf_annot', $record);
+        }
 
         return true;
     }
@@ -325,10 +437,12 @@
         // Delete any existing annotations and comments from current user.
         $DB->delete_records('assignfeedback_editpdf_annot', array('gradeid' => $grade->id));
         $DB->delete_records('assignfeedback_editpdf_cmnt', array('gradeid' => $grade->id));
+        $DB->delete_records('assignfeedback_editpdf_htcm', array('gradeid' => $grade->id));
         // Get gradeid, annotations and comments from sourceuserid.
         $sourceusergrade = $assignment->get_user_grade($sourceuserid, true, $grade->attemptnumber);
         $annotations = $DB->get_records('assignfeedback_editpdf_annot', array('gradeid' => $sourceusergrade->id, 'draft' => 1));
         $comments = $DB->get_records('assignfeedback_editpdf_cmnt', array('gradeid' => $sourceusergrade->id, 'draft' => 1));
+        $htmlcomments = $DB->get_records('assignfeedback_editpdf_htcm', array('gradeid' => $sourceusergrade->id, 'draft' => 1));
         $contextid = $assignment->get_context()->id;
         $sourceitemid = $sourceusergrade->id;
 
@@ -342,6 +456,11 @@
             $DB->insert_record('assignfeedback_editpdf_cmnt', $comment);
         }
 
+        foreach ($htmlcomments as $htmlcomment) {
+            $comment->gradeid = $grade->id;
+            $DB->insert_record('assignfeedback_editpdf_htcm', $htmlcomment);
+        }
+
         $fs = get_file_storage();
 
         // Copy the stamp files.
@@ -394,6 +513,7 @@
         $conditions = array('gradeid' => $gradeid, 'draft' => 1);
         $result = $DB->delete_records('assignfeedback_editpdf_annot', $conditions);
         $result = $result && $DB->delete_records('assignfeedback_editpdf_cmnt', $conditions);
+        $result = $result && $DB->delete_records('assignfeedback_editpdf_htcm', $conditions);
         return $result;
     }
 
Index: mod/assign/feedback/editpdf/classes/pdf.php
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/mod/assign/feedback/editpdf/classes/pdf.php b/mod/assign/feedback/editpdf/classes/pdf.php
--- a/mod/assign/feedback/editpdf/classes/pdf.php	(revision 2729694d4d56ca2c88bb180aee3f254f8be906cf)
+++ b/mod/assign/feedback/editpdf/classes/pdf.php	(revision 0b9764ed79311babea3acc01b01be2b999f9ec4f)
@@ -30,6 +30,7 @@
 global $CFG;
 require_once($CFG->libdir.'/pdflib.php');
 require_once($CFG->dirroot.'/mod/assign/feedback/editpdf/fpdi/autoload.php');
+require_once($CFG->dirroot.'/mod/assign/feedback/editpdf/vendor/phplatex/phplatex.php');
 
 /**
  * Library code for manipulating PDFs
@@ -382,6 +383,1532 @@
         return true;
     }
 
+    /**
+     * Process opening tags.
+     * @param $dom (array) html dom array
+     * @param $key (int) current element id
+     * @param $cell (boolean) if true add the default left (or right if RTL) padding to each new line (default false).
+     * @return $dom array
+     * @protected
+     */
+    protected function openHTMLTagHandler($dom, $key, $cell) {
+        global $CFG;
+        $tag = $dom[$key];
+        $parent = $dom[($dom[$key]['parent'])];
+        $firsttag = ($key == 1);
+        // check for text direction attribute
+        if (isset($tag['dir'])) {
+            $this->setTempRTL($tag['dir']);
+        } else {
+            $this->tmprtl = false;
+        }
+        if ($tag['block']) {
+            $hbz = 0; // distance from y to line bottom
+            $hb = 0; // vertical space between block tags
+            // calculate vertical space for block tags
+            if (isset($this->tagvspaces[$tag['value']][0]['h']) && !empty($this->tagvspaces[$tag['value']][0]['h']) && ($this->tagvspaces[$tag['value']][0]['h'] >= 0)) {
+                $cur_h = $this->tagvspaces[$tag['value']][0]['h'];
+            } elseif (isset($tag['fontsize'])) {
+                $cur_h = $this->getCellHeight($tag['fontsize'] / $this->k);
+            } else {
+                $cur_h = $this->getCellHeight($this->FontSize);
+            }
+            if (isset($this->tagvspaces[$tag['value']][0]['n'])) {
+                $on = $this->tagvspaces[$tag['value']][0]['n'];
+            } elseif (preg_match('/[h][0-9]/', $tag['value']) > 0) {
+                $on = 0.6;
+            } else {
+                $on = 1;
+            }
+            if ((!isset($this->tagvspaces[$tag['value']])) AND (in_array($tag['value'], array('div', 'dt', 'dd', 'li', 'br', 'hr')))) {
+                $hb = 0;
+            } else {
+                $hb = ($on * $cur_h);
+            }
+            if (($this->htmlvspace <= 0) AND ($on > 0)) {
+                if (isset($parent['fontsize'])) {
+                    $hbz = (($parent['fontsize'] / $this->k) * $this->cell_height_ratio);
+                } else {
+                    $hbz = $this->getCellHeight($this->FontSize);
+                }
+            }
+            if (isset($dom[($key - 1)]) AND ($dom[($key - 1)]['value'] == 'table')) {
+                // fix vertical space after table
+                $hbz = 0;
+            }
+            // closing vertical space
+            $hbc = 0;
+            if (isset($this->tagvspaces[$tag['value']][1]['h']) && !empty($this->tagvspaces[$tag['value']][1]['h']) && ($this->tagvspaces[$tag['value']][1]['h'] >= 0)) {
+                $pre_h = $this->tagvspaces[$tag['value']][1]['h'];
+            } elseif (isset($parent['fontsize'])) {
+                $pre_h = $this->getCellHeight($parent['fontsize'] / $this->k);
+            } else {
+                $pre_h = $this->getCellHeight($this->FontSize);
+            }
+            if (isset($this->tagvspaces[$tag['value']][1]['n'])) {
+                $cn = $this->tagvspaces[$tag['value']][1]['n'];
+            } elseif (preg_match('/[h][0-9]/', $tag['value']) > 0) {
+                $cn = 0.6;
+            } else {
+                $cn = 1;
+            }
+            if (isset($this->tagvspaces[$tag['value']][1])) {
+                $hbc = ($cn * $pre_h);
+            }
+        }
+        // Opening tag
+        switch($tag['value']) {
+            case 'table': {
+                $cp = 0;
+                $cs = 0;
+                $dom[$key]['rowspans'] = array();
+                if (!isset($dom[$key]['attribute']['nested']) OR ($dom[$key]['attribute']['nested'] != 'true')) {
+                    $this->htmlvspace = 0;
+                    // set table header
+                    if (!\TCPDF_STATIC::empty_string($dom[$key]['thead'])) {
+                        // set table header
+                        $this->thead = $dom[$key]['thead'];
+                        if (!isset($this->theadMargins) OR (empty($this->theadMargins))) {
+                            $this->theadMargins = array();
+                            $this->theadMargins['cell_padding'] = $this->cell_padding;
+                            $this->theadMargins['lmargin'] = $this->lMargin;
+                            $this->theadMargins['rmargin'] = $this->rMargin;
+                            $this->theadMargins['page'] = $this->page;
+                            $this->theadMargins['cell'] = $cell;
+                            $this->theadMargins['gvars'] = $this->getGraphicVars();
+                        }
+                    }
+                }
+                // store current margins and page
+                $dom[$key]['old_cell_padding'] = $this->cell_padding;
+                if (isset($tag['attribute']['cellpadding'])) {
+                    $pad = $this->getHTMLUnitToUnits($tag['attribute']['cellpadding'], 1, 'px');
+                    $this->SetCellPadding($pad);
+                } elseif (isset($tag['padding'])) {
+                    $this->cell_padding = $tag['padding'];
+                }
+                if (isset($tag['attribute']['cellspacing'])) {
+                    $cs = $this->getHTMLUnitToUnits($tag['attribute']['cellspacing'], 1, 'px');
+                } elseif (isset($tag['border-spacing'])) {
+                    $cs = $tag['border-spacing']['V'];
+                }
+                $prev_y = $this->y;
+                if ($this->checkPageBreak(((2 * $cp) + (2 * $cs) + $this->lasth), '', false) OR ($this->y < $prev_y)) {
+                    $this->inthead = true;
+                    // add a page (or trig AcceptPageBreak() for multicolumn mode)
+                    $this->checkPageBreak($this->PageBreakTrigger + 1);
+                }
+                break;
+            }
+            case 'tr': {
+                // array of columns positions
+                $dom[$key]['cellpos'] = array();
+                break;
+            }
+            case 'hr': {
+                if ((isset($tag['height'])) AND ($tag['height'] != '')) {
+                    $hrHeight = $this->getHTMLUnitToUnits($tag['height'], 1, 'px');
+                } else {
+                    $hrHeight = $this->GetLineWidth();
+                }
+                $this->addHTMLVertSpace($hbz, max($hb, ($hrHeight / 2)), $cell, $firsttag);
+                $x = $this->GetX();
+                $y = $this->GetY();
+                $wtmp = $this->w - $this->lMargin - $this->rMargin;
+                if ($cell) {
+                    $wtmp -= ($this->cell_padding['L'] + $this->cell_padding['R']);
+                }
+                if ((isset($tag['width'])) AND ($tag['width'] != '')) {
+                    $hrWidth = $this->getHTMLUnitToUnits($tag['width'], $wtmp, 'px');
+                } else {
+                    $hrWidth = $wtmp;
+                }
+                $prevlinewidth = $this->GetLineWidth();
+                $this->SetLineWidth($hrHeight);
+                $this->Line($x, $y, $x + $hrWidth, $y);
+                $this->SetLineWidth($prevlinewidth);
+                $this->addHTMLVertSpace(max($hbc, ($hrHeight / 2)), 0, $cell, !isset($dom[($key + 1)]));
+                break;
+            }
+            case 'a': {
+                if (array_key_exists('href', $tag['attribute'])) {
+                    $this->HREF['url'] = $tag['attribute']['href'];
+                }
+                break;
+            }
+            case 'img': {
+                if (empty($tag['attribute']['src'])) {
+                    break;
+                }
+                $imgsrc = $tag['attribute']['src'];
+                if ($imgsrc[0] === '@') {
+                    // data stream
+                    $imgsrc = '@'.base64_decode(substr($imgsrc, 1));
+                    $type = '';
+                } else {
+                    $findataroot = strpos($imgsrc,$CFG->tempdir);
+                    if ( $findataroot === false ) {
+                        if (($imgsrc[0] === '/') and !empty($_SERVER['DOCUMENT_ROOT']) and ($_SERVER['DOCUMENT_ROOT'] != '/')) {
+                            // fix image path
+                            $findroot = strpos($imgsrc, $_SERVER['DOCUMENT_ROOT']);
+                            if (($findroot === false) or ($findroot > 1)) {
+                                if (substr($_SERVER['DOCUMENT_ROOT'], -1) == '/') {
+                                    $imgsrc = substr($_SERVER['DOCUMENT_ROOT'], 0, -1) . $imgsrc;
+                                } else {
+                                    $imgsrc = $_SERVER['DOCUMENT_ROOT'] . $imgsrc;
+                                }
+                            }
+                            $imgsrc = urldecode($imgsrc);
+                            $testscrtype = @parse_url($imgsrc);
+                            if (empty($testscrtype['query'])) {
+                                // convert URL to server path
+                                $imgsrc = str_replace(K_PATH_URL, K_PATH_MAIN, $imgsrc);
+                            } else if (preg_match('|^https?://|', $imgsrc) !== 1) {
+                                // convert URL to server path
+                                $imgsrc = str_replace(K_PATH_MAIN, K_PATH_URL, $imgsrc);
+                            }
+                        }
+                    }
+                    // get image type
+                    $type = \TCPDF_IMAGES::getImageFileType($imgsrc);
+                }
+                if (!isset($tag['width'])) {
+                    $tag['width'] = 0;
+                }
+                if (!isset($tag['height'])) {
+                    $tag['height'] = 0;
+                }
+                //if (!isset($tag['attribute']['align'])) {
+                // the only alignment supported is "bottom"
+                // further development is required for other modes.
+                $tag['attribute']['align'] = 'bottom';
+                //}
+                switch($tag['attribute']['align']) {
+                    case 'top': {
+                        $align = 'T';
+                        break;
+                    }
+                    case 'middle': {
+                        $align = 'M';
+                        break;
+                    }
+                    case 'bottom': {
+                        $align = 'B';
+                        break;
+                    }
+                    default: {
+                        $align = 'B';
+                        break;
+                    }
+                }
+                $prevy = $this->y;
+                $xpos = $this->x;
+                $imglink = '';
+                if (isset($this->HREF['url']) AND !\TCPDF_STATIC::empty_string($this->HREF['url'])) {
+                    $imglink = $this->HREF['url'];
+                    if ($imglink[0] == '#') {
+                        // convert url to internal link
+                        $lnkdata = explode(',', $imglink);
+                        if (isset($lnkdata[0])) {
+                            $page = intval(substr($lnkdata[0], 1));
+                            if (empty($page) OR ($page <= 0)) {
+                                $page = $this->page;
+                            }
+                            if (isset($lnkdata[1]) AND (strlen($lnkdata[1]) > 0)) {
+                                $lnky = floatval($lnkdata[1]);
+                            } else {
+                                $lnky = 0;
+                            }
+                            $imglink = $this->AddLink();
+                            $this->SetLink($imglink, $lnky, $page);
+                        }
+                    }
+                }
+                $border = 0;
+                if (isset($tag['border']) AND !empty($tag['border'])) {
+                    // currently only support 1 (frame) or a combination of 'LTRB'
+                    $border = $tag['border'];
+                }
+                $iw = '';
+                if (isset($tag['width'])) {
+                    $iw = $this->getHTMLUnitToUnits($tag['width'], ($tag['fontsize'] / $this->k), 'px', false);
+                }
+                $ih = '';
+                if (isset($tag['height'])) {
+                    $ih = $this->getHTMLUnitToUnits($tag['height'], ($tag['fontsize'] / $this->k), 'px', false);
+                }
+                if (($type == 'eps') OR ($type == 'ai')) {
+                    $this->ImageEps($imgsrc, $xpos, $this->y, $iw, $ih, $imglink, true, $align, '', $border, true);
+                } elseif ($type == 'svg') {
+                    $this->ImageSVG($imgsrc, $xpos, $this->y, $iw, $ih, $imglink, $align, '', $border, true);
+                } else {
+                    $this->Image($imgsrc, $xpos, $this->y, $iw, $ih, '', $imglink, $align, false, 300, '', false, false, $border, false, false, true);
+                }
+                switch($align) {
+                    case 'T': {
+                        $this->y = $prevy;
+                        break;
+                    }
+                    case 'M': {
+                        $this->y = (($this->img_rb_y + $prevy - ($this->getCellHeight($tag['fontsize'] / $this->k))) / 2);
+                        break;
+                    }
+                    case 'B': {
+                        $this->y = $this->img_rb_y - ($this->getCellHeight($tag['fontsize'] / $this->k) - ($this->getFontDescent($tag['fontname'], $tag['fontstyle'], $tag['fontsize']) * $this->cell_height_ratio));
+                        break;
+                    }
+                }
+                break;
+            }
+            case 'dl': {
+                ++$this->listnum;
+                if ($this->listnum == 1) {
+                    $this->addHTMLVertSpace($hbz, $hb, $cell, $firsttag);
+                } else {
+                    $this->addHTMLVertSpace(0, 0, $cell, $firsttag);
+                }
+                break;
+            }
+            case 'dt': {
+                $this->addHTMLVertSpace($hbz, $hb, $cell, $firsttag);
+                break;
+            }
+            case 'dd': {
+                if ($this->rtl) {
+                    $this->rMargin += $this->listindent;
+                } else {
+                    $this->lMargin += $this->listindent;
+                }
+                ++$this->listindentlevel;
+                $this->addHTMLVertSpace($hbz, $hb, $cell, $firsttag);
+                break;
+            }
+            case 'ul':
+            case 'ol': {
+                ++$this->listnum;
+                if ($tag['value'] == 'ol') {
+                    $this->listordered[$this->listnum] = true;
+                } else {
+                    $this->listordered[$this->listnum] = false;
+                }
+                if (isset($tag['attribute']['start'])) {
+                    $this->listcount[$this->listnum] = intval($tag['attribute']['start']) - 1;
+                } else {
+                    $this->listcount[$this->listnum] = 0;
+                }
+                if ($this->rtl) {
+                    $this->rMargin += $this->listindent;
+                    $this->x -= $this->listindent;
+                } else {
+                    $this->lMargin += $this->listindent;
+                    $this->x += $this->listindent;
+                }
+                ++$this->listindentlevel;
+                if ($this->listnum == 1) {
+                    if ($key > 1) {
+                        $this->addHTMLVertSpace($hbz, $hb, $cell, $firsttag);
+                    }
+                } else {
+                    $this->addHTMLVertSpace(0, 0, $cell, $firsttag);
+                }
+                break;
+            }
+            case 'li': {
+                if ($key > 2) {
+                    $this->addHTMLVertSpace($hbz, $hb, $cell, $firsttag);
+                }
+                if ($this->listordered[$this->listnum]) {
+                    // ordered item
+                    if (isset($parent['attribute']['type']) AND !\TCPDF_STATIC::empty_string($parent['attribute']['type'])) {
+                        $this->lispacer = $parent['attribute']['type'];
+                    } elseif (isset($parent['listtype']) AND !\TCPDF_STATIC::empty_string($parent['listtype'])) {
+                        $this->lispacer = $parent['listtype'];
+                    } elseif (isset($this->lisymbol) AND !\TCPDF_STATIC::empty_string($this->lisymbol)) {
+                        $this->lispacer = $this->lisymbol;
+                    } else {
+                        $this->lispacer = '#';
+                    }
+                    ++$this->listcount[$this->listnum];
+                    if (isset($tag['attribute']['value'])) {
+                        $this->listcount[$this->listnum] = intval($tag['attribute']['value']);
+                    }
+                } else {
+                    // unordered item
+                    if (isset($parent['attribute']['type']) AND !\TCPDF_STATIC::empty_string($parent['attribute']['type'])) {
+                        $this->lispacer = $parent['attribute']['type'];
+                    } elseif (isset($parent['listtype']) AND !\TCPDF_STATIC::empty_string($parent['listtype'])) {
+                        $this->lispacer = $parent['listtype'];
+                    } elseif (isset($this->lisymbol) AND !\TCPDF_STATIC::empty_string($this->lisymbol)) {
+                        $this->lispacer = $this->lisymbol;
+                    } else {
+                        $this->lispacer = '!';
+                    }
+                }
+                break;
+            }
+            case 'blockquote': {
+                if ($this->rtl) {
+                    $this->rMargin += $this->listindent;
+                } else {
+                    $this->lMargin += $this->listindent;
+                }
+                ++$this->listindentlevel;
+                $this->addHTMLVertSpace($hbz, $hb, $cell, $firsttag);
+                break;
+            }
+            case 'br': {
+                $this->addHTMLVertSpace($hbz, $hb, $cell, $firsttag);
+                break;
+            }
+            case 'div': {
+                $this->addHTMLVertSpace($hbz, $hb, $cell, $firsttag);
+                break;
+            }
+            case 'p': {
+                $this->addHTMLVertSpace($hbz, $hb, $cell, $firsttag);
+                break;
+            }
+            case 'pre': {
+                $this->addHTMLVertSpace($hbz, $hb, $cell, $firsttag);
+                $this->premode = true;
+                break;
+            }
+            case 'sup': {
+                $this->SetXY($this->GetX(), $this->GetY() - ((0.7 * $this->FontSizePt) / $this->k));
+                break;
+            }
+            case 'sub': {
+                $this->SetXY($this->GetX(), $this->GetY() + ((0.3 * $this->FontSizePt) / $this->k));
+                break;
+            }
+            case 'h1':
+            case 'h2':
+            case 'h3':
+            case 'h4':
+            case 'h5':
+            case 'h6': {
+                $this->addHTMLVertSpace($hbz, $hb, $cell, $firsttag);
+                break;
+            }
+            // Form fields (since 4.8.000 - 2009-09-07)
+            case 'form': {
+                if (isset($tag['attribute']['action'])) {
+                    $this->form_action = $tag['attribute']['action'];
+                } else {
+                    $this->Error('Please explicitly set action attribute path!');
+                }
+                if (isset($tag['attribute']['enctype'])) {
+                    $this->form_enctype = $tag['attribute']['enctype'];
+                } else {
+                    $this->form_enctype = 'application/x-www-form-urlencoded';
+                }
+                if (isset($tag['attribute']['method'])) {
+                    $this->form_mode = $tag['attribute']['method'];
+                } else {
+                    $this->form_mode = 'post';
+                }
+                break;
+            }
+            case 'input': {
+                if (isset($tag['attribute']['name']) AND !\TCPDF_STATIC::empty_string($tag['attribute']['name'])) {
+                    $name = $tag['attribute']['name'];
+                } else {
+                    break;
+                }
+                $prop = array();
+                $opt = array();
+                if (isset($tag['attribute']['readonly']) AND !\TCPDF_STATIC::empty_string($tag['attribute']['readonly'])) {
+                    $prop['readonly'] = true;
+                }
+                if (isset($tag['attribute']['value']) AND !\TCPDF_STATIC::empty_string($tag['attribute']['value'])) {
+                    $value = $tag['attribute']['value'];
+                }
+                if (isset($tag['attribute']['maxlength']) AND !\TCPDF_STATIC::empty_string($tag['attribute']['maxlength'])) {
+                    $opt['maxlen'] = intval($tag['attribute']['maxlength']);
+                }
+                $h = $this->getCellHeight($this->FontSize);
+                if (isset($tag['attribute']['size']) AND !\TCPDF_STATIC::empty_string($tag['attribute']['size'])) {
+                    $w = intval($tag['attribute']['size']) * $this->GetStringWidth(chr(32)) * 2;
+                } else {
+                    $w = $h;
+                }
+                if (isset($tag['attribute']['checked']) AND (($tag['attribute']['checked'] == 'checked') OR ($tag['attribute']['checked'] == 'true'))) {
+                    $checked = true;
+                } else {
+                    $checked = false;
+                }
+                if (isset($tag['align'])) {
+                    switch ($tag['align']) {
+                        case 'C': {
+                            $opt['q'] = 1;
+                            break;
+                        }
+                        case 'R': {
+                            $opt['q'] = 2;
+                            break;
+                        }
+                        case 'L':
+                        default: {
+                            break;
+                        }
+                    }
+                }
+                switch ($tag['attribute']['type']) {
+                    case 'text': {
+                        if (isset($value)) {
+                            $opt['v'] = $value;
+                        }
+                        $this->TextField($name, $w, $h, $prop, $opt, '', '', false);
+                        break;
+                    }
+                    case 'password': {
+                        if (isset($value)) {
+                            $opt['v'] = $value;
+                        }
+                        $prop['password'] = 'true';
+                        $this->TextField($name, $w, $h, $prop, $opt, '', '', false);
+                        break;
+                    }
+                    case 'checkbox': {
+                        if (!isset($value)) {
+                            break;
+                        }
+                        $this->CheckBox($name, $w, $checked, $prop, $opt, $value, '', '', false);
+                        break;
+                    }
+                    case 'radio': {
+                        if (!isset($value)) {
+                            break;
+                        }
+                        $this->RadioButton($name, $w, $prop, $opt, $value, $checked, '', '', false);
+                        break;
+                    }
+                    case 'submit': {
+                        if (!isset($value)) {
+                            $value = 'submit';
+                        }
+                        $w = $this->GetStringWidth($value) * 1.5;
+                        $h *= 1.6;
+                        $prop = array('lineWidth'=>1, 'borderStyle'=>'beveled', 'fillColor'=>array(196, 196, 196), 'strokeColor'=>array(255, 255, 255));
+                        $action = array();
+                        $action['S'] = 'SubmitForm';
+                        $action['F'] = $this->form_action;
+                        if ($this->form_enctype != 'FDF') {
+                            $action['Flags'] = array('ExportFormat');
+                        }
+                        if ($this->form_mode == 'get') {
+                            $action['Flags'] = array('GetMethod');
+                        }
+                        $this->Button($name, $w, $h, $value, $action, $prop, $opt, '', '', false);
+                        break;
+                    }
+                    case 'reset': {
+                        if (!isset($value)) {
+                            $value = 'reset';
+                        }
+                        $w = $this->GetStringWidth($value) * 1.5;
+                        $h *= 1.6;
+                        $prop = array('lineWidth'=>1, 'borderStyle'=>'beveled', 'fillColor'=>array(196, 196, 196), 'strokeColor'=>array(255, 255, 255));
+                        $this->Button($name, $w, $h, $value, array('S'=>'ResetForm'), $prop, $opt, '', '', false);
+                        break;
+                    }
+                    case 'file': {
+                        $prop['fileSelect'] = 'true';
+                        $this->TextField($name, $w, $h, $prop, $opt, '', '', false);
+                        if (!isset($value)) {
+                            $value = '*';
+                        }
+                        $w = $this->GetStringWidth($value) * 2;
+                        $h *= 1.2;
+                        $prop = array('lineWidth'=>1, 'borderStyle'=>'beveled', 'fillColor'=>array(196, 196, 196), 'strokeColor'=>array(255, 255, 255));
+                        $jsaction = 'var f=this.getField(\''.$name.'\'); f.browseForFileToSubmit();';
+                        $this->Button('FB_'.$name, $w, $h, $value, $jsaction, $prop, $opt, '', '', false);
+                        break;
+                    }
+                    case 'hidden': {
+                        if (isset($value)) {
+                            $opt['v'] = $value;
+                        }
+                        $opt['f'] = array('invisible', 'hidden');
+                        $this->TextField($name, 0, 0, $prop, $opt, '', '', false);
+                        break;
+                    }
+                    case 'image': {
+                        // THIS TYPE MUST BE FIXED
+                        if (isset($tag['attribute']['src']) AND !\TCPDF_STATIC::empty_string($tag['attribute']['src'])) {
+                            $img = $tag['attribute']['src'];
+                        } else {
+                            break;
+                        }
+                        $value = 'img';
+                        //$opt['mk'] = array('i'=>$img, 'tp'=>1, 'if'=>array('sw'=>'A', 's'=>'A', 'fb'=>false));
+                        if (isset($tag['attribute']['onclick']) AND !empty($tag['attribute']['onclick'])) {
+                            $jsaction = $tag['attribute']['onclick'];
+                        } else {
+                            $jsaction = '';
+                        }
+                        $this->Button($name, $w, $h, $value, $jsaction, $prop, $opt, '', '', false);
+                        break;
+                    }
+                    case 'button': {
+                        if (!isset($value)) {
+                            $value = ' ';
+                        }
+                        $w = $this->GetStringWidth($value) * 1.5;
+                        $h *= 1.6;
+                        $prop = array('lineWidth'=>1, 'borderStyle'=>'beveled', 'fillColor'=>array(196, 196, 196), 'strokeColor'=>array(255, 255, 255));
+                        if (isset($tag['attribute']['onclick']) AND !empty($tag['attribute']['onclick'])) {
+                            $jsaction = $tag['attribute']['onclick'];
+                        } else {
+                            $jsaction = '';
+                        }
+                        $this->Button($name, $w, $h, $value, $jsaction, $prop, $opt, '', '', false);
+                        break;
+                    }
+                }
+                break;
+            }
+            case 'textarea': {
+                $prop = array();
+                $opt = array();
+                if (isset($tag['attribute']['readonly']) AND !\TCPDF_STATIC::empty_string($tag['attribute']['readonly'])) {
+                    $prop['readonly'] = true;
+                }
+                if (isset($tag['attribute']['name']) AND !\TCPDF_STATIC::empty_string($tag['attribute']['name'])) {
+                    $name = $tag['attribute']['name'];
+                } else {
+                    break;
+                }
+                if (isset($tag['attribute']['value']) AND !\TCPDF_STATIC::empty_string($tag['attribute']['value'])) {
+                    $opt['v'] = $tag['attribute']['value'];
+                }
+                if (isset($tag['attribute']['cols']) AND !\TCPDF_STATIC::empty_string($tag['attribute']['cols'])) {
+                    $w = intval($tag['attribute']['cols']) * $this->GetStringWidth(chr(32)) * 2;
+                } else {
+                    $w = 40;
+                }
+                if (isset($tag['attribute']['rows']) AND !\TCPDF_STATIC::empty_string($tag['attribute']['rows'])) {
+                    $h = intval($tag['attribute']['rows']) * $this->getCellHeight($this->FontSize);
+                } else {
+                    $h = 10;
+                }
+                $prop['multiline'] = 'true';
+                $this->TextField($name, $w, $h, $prop, $opt, '', '', false);
+                break;
+            }
+            case 'select': {
+                $h = $this->getCellHeight($this->FontSize);
+                if (isset($tag['attribute']['size']) AND !\TCPDF_STATIC::empty_string($tag['attribute']['size'])) {
+                    $h *= ($tag['attribute']['size'] + 1);
+                }
+                $prop = array();
+                $opt = array();
+                if (isset($tag['attribute']['name']) AND !\TCPDF_STATIC::empty_string($tag['attribute']['name'])) {
+                    $name = $tag['attribute']['name'];
+                } else {
+                    break;
+                }
+                $w = 0;
+                if (isset($tag['attribute']['opt']) AND !\TCPDF_STATIC::empty_string($tag['attribute']['opt'])) {
+                    $options = explode('#!NwL!#', $tag['attribute']['opt']);
+                    $values = array();
+                    foreach ($options as $val) {
+                        if (strpos($val, '#!TaB!#') !== false) {
+                            $opts = explode('#!TaB!#', $val);
+                            $values[] = $opts;
+                            $w = max($w, $this->GetStringWidth($opts[1]));
+                        } else {
+                            $values[] = $val;
+                            $w = max($w, $this->GetStringWidth($val));
+                        }
+                    }
+                } else {
+                    break;
+                }
+                $w *= 2;
+                if (isset($tag['attribute']['multiple']) AND ($tag['attribute']['multiple']='multiple')) {
+                    $prop['multipleSelection'] = 'true';
+                    $this->ListBox($name, $w, $h, $values, $prop, $opt, '', '', false);
+                } else {
+                    $this->ComboBox($name, $w, $h, $values, $prop, $opt, '', '', false);
+                }
+                break;
+            }
+            case 'tcpdf': {
+                if (defined('K_TCPDF_CALLS_IN_HTML') AND (K_TCPDF_CALLS_IN_HTML === true)) {
+                    // Special tag used to call TCPDF methods
+                    if (isset($tag['attribute']['method'])) {
+                        $tcpdf_method = $tag['attribute']['method'];
+                        if (method_exists($this, $tcpdf_method)) {
+                            if (isset($tag['attribute']['params']) AND (!empty($tag['attribute']['params']))) {
+                                $params = $this->unserializeTCPDFtagParameters($tag['attribute']['params']);
+                                call_user_func_array(array($this, $tcpdf_method), $params);
+                            } else {
+                                $this->$tcpdf_method();
+                            }
+                            $this->newline = true;
+                        }
+                    }
+                }
+                break;
+            }
+            default: {
+                break;
+            }
+        }
+        // define tags that support borders and background colors
+        $bordertags = array('blockquote','br','dd','dl','div','dt','h1','h2','h3','h4','h5','h6','hr','li','ol','p','pre','ul','tcpdf','table');
+        if (in_array($tag['value'], $bordertags)) {
+            // set border
+            $dom[$key]['borderposition'] = $this->getBorderStartPosition();
+        }
+        if ($dom[$key]['self'] AND isset($dom[$key]['attribute']['pagebreakafter'])) {
+            $pba = $dom[$key]['attribute']['pagebreakafter'];
+            // check for pagebreak
+            if (($pba == 'true') OR ($pba == 'left') OR ($pba == 'right')) {
+                // add a page (or trig AcceptPageBreak() for multicolumn mode)
+                $this->checkPageBreak($this->PageBreakTrigger + 1);
+            }
+            if ((($pba == 'left') AND (((!$this->rtl) AND (($this->page % 2) == 0)) OR (($this->rtl) AND (($this->page % 2) != 0))))
+                    OR (($pba == 'right') AND (((!$this->rtl) AND (($this->page % 2) != 0)) OR (($this->rtl) AND (($this->page % 2) == 0))))) {
+                // add a page (or trig AcceptPageBreak() for multicolumn mode)
+                $this->checkPageBreak($this->PageBreakTrigger + 1);
+            }
+        }
+        return $dom;
+    }
+
+
+    /**
+     * Returns the HTML DOM array.
+     * @param $html (string) html code
+     * @return array
+     * @protected
+     * @since 3.2.000 (2008-06-20)
+     */
+    protected function getHtmlDomArray($html) {
+        // array of CSS styles ( selector => properties).
+        $css = array();
+        // get CSS array defined at previous call
+        $matches = array();
+        if (preg_match_all('/<cssarray>([^\<]*)<\/cssarray>/isU', $html, $matches) > 0) {
+            if (isset($matches[1][0])) {
+                $css = array_merge($css, json_decode($this->unhtmlentities($matches[1][0]), true));
+            }
+            $html = preg_replace('/<cssarray>(.*?)<\/cssarray>/isU', '', $html);
+        }
+        // extract external CSS files
+        $matches = array();
+        if (preg_match_all('/<link([^\>]*)>/isU', $html, $matches) > 0) {
+            foreach ($matches[1] as $key => $link) {
+                $type = array();
+                if (preg_match('/type[\s]*=[\s]*"text\/css"/', $link, $type)) {
+                    $type = array();
+                    preg_match('/media[\s]*=[\s]*"([^"]*)"/', $link, $type);
+                    // get 'all' and 'print' media, other media types are discarded
+                    // (all, braille, embossed, handheld, print, projection, screen, speech, tty, tv)
+                    if (empty($type) OR (isset($type[1]) AND (($type[1] == 'all') OR ($type[1] == 'print')))) {
+                        $type = array();
+                        if (preg_match('/href[\s]*=[\s]*"([^"]*)"/', $link, $type) > 0) {
+                            // read CSS data file
+                            $cssdata = \TCPDF_STATIC::fileGetContents(trim($type[1]));
+                            if (($cssdata !== FALSE) AND (strlen($cssdata) > 0)) {
+                                $css = array_merge($css, \TCPDF_STATIC::extractCSSproperties($cssdata));
+                            }
+                        }
+                    }
+                }
+            }
+        }
+        // extract style tags
+        $matches = array();
+        if (preg_match_all('/<style([^\>]*)>([^\<]*)<\/style>/isU', $html, $matches) > 0) {
+            foreach ($matches[1] as $key => $media) {
+                $type = array();
+                preg_match('/media[\s]*=[\s]*"([^"]*)"/', $media, $type);
+                // get 'all' and 'print' media, other media types are discarded
+                // (all, braille, embossed, handheld, print, projection, screen, speech, tty, tv)
+                if (empty($type) OR (isset($type[1]) AND (($type[1] == 'all') OR ($type[1] == 'print')))) {
+                    $cssdata = $matches[2][$key];
+                    $css = array_merge($css, \TCPDF_STATIC::extractCSSproperties($cssdata));
+                }
+            }
+        }
+        // create a special tag to contain the CSS array (used for table content)
+        $csstagarray = '<cssarray>'.htmlentities(json_encode($css)).'</cssarray>';
+        // remove head and style blocks
+        $html = preg_replace('/<head([^\>]*)>(.*?)<\/head>/siU', '', $html);
+        $html = preg_replace('/<style([^\>]*)>([^\<]*)<\/style>/isU', '', $html);
+        // define block tags
+        $blocktags = array('blockquote','br','dd','dl','div','dt','h1','h2','h3','h4','h5','h6','hr','li','ol','p','pre','ul','tcpdf','table','tr','td');
+        // define self-closing tags
+        $selfclosingtags = array('area','base','basefont','br','hr','input','img','link','meta');
+        // remove all unsupported tags (the line below lists all supported tags)
+        $html = strip_tags($html, '<marker/><a><b><blockquote><body><br><br/><dd><del><div><dl><dt><em><font><form><h1><h2><h3><h4><h5><h6><hr><hr/><i><img><input><label><li><ol><option><p><pre><s><select><small><span><strike><strong><sub><sup><table><tablehead><tcpdf><td><textarea><th><thead><tr><tt><u><ul>');
+        //replace some blank characters
+        $html = preg_replace('/<pre/', '<xre', $html); // preserve pre tag
+        $html = preg_replace('/<(table|tr|td|th|tcpdf|blockquote|dd|div|dl|dt|form|h1|h2|h3|h4|h5|h6|br|hr|li|ol|ul|p)([^\>]*)>[\n\r\t]+/', '<\\1\\2>', $html);
+        $html = preg_replace('@(\r\n|\r)@', "\n", $html);
+        $repTable = array("\t" => ' ', "\0" => ' ', "\x0B" => ' ', "\\" => "\\\\");
+        $html = strtr($html, $repTable);
+        $offset = 0;
+        while (($offset < strlen($html)) AND ($pos = strpos($html, '</pre>', $offset)) !== false) {
+            $html_a = substr($html, 0, $offset);
+            $html_b = substr($html, $offset, ($pos - $offset + 6));
+            while (preg_match("'<xre([^\>]*)>(.*?)\n(.*?)</pre>'si", $html_b)) {
+                // preserve newlines on <pre> tag
+                $html_b = preg_replace("'<xre([^\>]*)>(.*?)\n(.*?)</pre>'si", "<xre\\1>\\2<br />\\3</pre>", $html_b);
+            }
+            while (preg_match("'<xre([^\>]*)>(.*?)".$this->re_space['p']."(.*?)</pre>'".$this->re_space['m'], $html_b)) {
+                // preserve spaces on <pre> tag
+                $html_b = preg_replace("'<xre([^\>]*)>(.*?)".$this->re_space['p']."(.*?)</pre>'".$this->re_space['m'], "<xre\\1>\\2&nbsp;\\3</pre>", $html_b);
+            }
+            $html = $html_a.$html_b.substr($html, $pos + 6);
+            $offset = strlen($html_a.$html_b);
+        }
+        $offset = 0;
+        while (($offset < strlen($html)) AND ($pos = strpos($html, '</textarea>', $offset)) !== false) {
+            $html_a = substr($html, 0, $offset);
+            $html_b = substr($html, $offset, ($pos - $offset + 11));
+            while (preg_match("'<textarea([^\>]*)>(.*?)\n(.*?)</textarea>'si", $html_b)) {
+                // preserve newlines on <textarea> tag
+                $html_b = preg_replace("'<textarea([^\>]*)>(.*?)\n(.*?)</textarea>'si", "<textarea\\1>\\2<TBR>\\3</textarea>", $html_b);
+                $html_b = preg_replace("'<textarea([^\>]*)>(.*?)[\"](.*?)</textarea>'si", "<textarea\\1>\\2''\\3</textarea>", $html_b);
+            }
+            $html = $html_a.$html_b.substr($html, $pos + 11);
+            $offset = strlen($html_a.$html_b);
+        }
+        $html = preg_replace('/([\s]*)<option/si', '<option', $html);
+        $html = preg_replace('/<\/option>([\s]*)/si', '</option>', $html);
+        $offset = 0;
+        while (($offset < strlen($html)) AND ($pos = strpos($html, '</option>', $offset)) !== false) {
+            $html_a = substr($html, 0, $offset);
+            $html_b = substr($html, $offset, ($pos - $offset + 9));
+            while (preg_match("'<option([^\>]*)>(.*?)</option>'si", $html_b)) {
+                $html_b = preg_replace("'<option([\s]+)value=\"([^\"]*)\"([^\>]*)>(.*?)</option>'si", "\\2#!TaB!#\\4#!NwL!#", $html_b);
+                $html_b = preg_replace("'<option([^\>]*)>(.*?)</option>'si", "\\2#!NwL!#", $html_b);
+            }
+            $html = $html_a.$html_b.substr($html, $pos + 9);
+            $offset = strlen($html_a.$html_b);
+        }
+        if (preg_match("'</select'si", $html)) {
+            $html = preg_replace("'<select([^\>]*)>'si", "<select\\1 opt=\"", $html);
+            $html = preg_replace("'#!NwL!#</select>'si", "\" />", $html);
+        }
+        $html = str_replace("\n", ' ', $html);
+        // restore textarea newlines
+        $html = str_replace('<TBR>', "\n", $html);
+        // remove extra spaces from code
+        $html = preg_replace('/[\s]+<\/(table|tr|ul|ol|dl)>/', '</\\1>', $html);
+        $html = preg_replace('/'.$this->re_space['p'].'+<\/(td|th|li|dt|dd)>/'.$this->re_space['m'], '</\\1>', $html);
+        $html = preg_replace('/[\s]+<(tr|td|th|li|dt|dd)/', '<\\1', $html);
+        $html = preg_replace('/'.$this->re_space['p'].'+<(ul|ol|dl|br)/'.$this->re_space['m'], '<\\1', $html);
+        $html = preg_replace('/<\/(table|tr|td|th|blockquote|dd|dt|dl|div|dt|h1|h2|h3|h4|h5|h6|hr|li|ol|ul|p)>[\s]+</', '</\\1><', $html);
+        $html = preg_replace('/<\/(td|th)>/', '<marker style="font-size:0"/></\\1>', $html);
+        $html = preg_replace('/<\/table>([\s]*)<marker style="font-size:0"\/>/', '</table>', $html);
+        $html = preg_replace('/'.$this->re_space['p'].'+<img/'.$this->re_space['m'], chr(32).'<img', $html);
+        $html = preg_replace('/<img([^\>]*)>[\s]+([^\<])/xi', '<img\\1>&nbsp;\\2', $html);
+        $html = preg_replace('/<img([^\>]*)>/xi', '<img\\1><span><marker style="font-size:0"/></span>', $html);
+        $html = preg_replace('/<xre/', '<pre', $html); // restore pre tag
+        $html = preg_replace('/<textarea([^\>]*)>([^\<]*)<\/textarea>/xi', '<textarea\\1 value="\\2" />', $html);
+        $html = preg_replace('/<li([^\>]*)><\/li>/', '<li\\1>&nbsp;</li>', $html);
+        $html = preg_replace('/<li([^\>]*)>'.$this->re_space['p'].'*<img/'.$this->re_space['m'], '<li\\1><font size="1">&nbsp;</font><img', $html);
+        $html = preg_replace('/<([^\>\/]*)>[\s]/', '<\\1>&nbsp;', $html); // preserve some spaces
+        $html = preg_replace('/[\s]<\/([^\>]*)>/', '&nbsp;</\\1>', $html); // preserve some spaces
+        $html = preg_replace('/<su([bp])/', '<zws/><su\\1', $html); // fix sub/sup alignment
+        $html = preg_replace('/<\/su([bp])>/', '</su\\1><zws/>', $html); // fix sub/sup alignment
+        $html = preg_replace('/'.$this->re_space['p'].'+/'.$this->re_space['m'], chr(32), $html); // replace multiple spaces with a single space
+        // trim string
+        $html = $this->stringTrim($html);
+        // fix br tag after li
+        $html = preg_replace('/<li><br([^\>]*)>/', '<li> <br\\1>', $html);
+        // fix first image tag alignment
+        $html = preg_replace('/^<img/', '<span style="font-size:0"><br /></span> <img', $html, 1);
+        // pattern for generic tag
+        $tagpattern = '/(<[^>]+>)/';
+        // explodes the string
+        $a = preg_split($tagpattern, $html, -1, PREG_SPLIT_DELIM_CAPTURE | PREG_SPLIT_NO_EMPTY);
+        // count elements
+        $maxel = count($a);
+        $elkey = 0;
+        $key = 0;
+
+        //Font size
+        $fontsize = null;
+        if (strpos($a[0], 'h3') !== false) {
+            $fontsize = 26.25;
+        } else if (strpos($a[0], 'h4') !== false) {
+            $fontsize = 22.5;
+        } else if (strpos($a[0], 'h5') !== false) {
+            $fontsize = 18.75;
+        }
+
+        // create an array of elements
+        $dom = array();
+        $dom[$key] = array();
+        // set inheritable properties fot the first void element
+        // possible inheritable properties are: azimuth, border-collapse, border-spacing, caption-side, color, cursor, direction, empty-cells, font, font-family, font-stretch, font-size, font-size-adjust, font-style, font-variant, font-weight, letter-spacing, line-height, list-style, list-style-image, list-style-position, list-style-type, orphans, page, page-break-inside, quotes, speak, speak-header, text-align, text-indent, text-transform, volume, white-space, widows, word-spacing
+        $dom[$key]['tag'] = false;
+        $dom[$key]['block'] = false;
+        $dom[$key]['value'] = '';
+        $dom[$key]['parent'] = 0;
+        $dom[$key]['hide'] = false;
+        $dom[$key]['fontname'] = $this->FontFamily;
+        $dom[$key]['fontstyle'] =  $this->FontStyle;
+        $dom[$key]['fontsize'] = $fontsize != null ? $fontsize : $this->FontSizePt;
+        $dom[$key]['font-stretch'] = $this->font_stretching;
+        $dom[$key]['letter-spacing'] = $this->font_spacing;
+        $dom[$key]['stroke'] = $this->textstrokewidth;
+        $dom[$key]['fill'] = (($this->textrendermode % 2) == 0);
+        $dom[$key]['clip'] = ($this->textrendermode > 3);
+        $dom[$key]['line-height'] = $this->cell_height_ratio;
+        $dom[$key]['bgcolor'] = false;
+        $dom[$key]['fgcolor'] = $this->fgcolor; // color
+        $dom[$key]['strokecolor'] = $this->strokecolor;
+        $dom[$key]['align'] = '';
+        $dom[$key]['listtype'] = '';
+        $dom[$key]['text-indent'] = 0;
+        $dom[$key]['text-transform'] = '';
+        $dom[$key]['border'] = array();
+        $dom[$key]['dir'] = $this->rtl?'rtl':'ltr';
+        $thead = false; // true when we are inside the THEAD tag
+        ++$key;
+        $level = array();
+        array_push($level, 0); // root
+        while ($elkey < $maxel) {
+            $dom[$key] = array();
+            $element = $a[$elkey];
+            $dom[$key]['elkey'] = $elkey;
+            if (preg_match($tagpattern, $element)) {
+                // html tag
+                $element = substr($element, 1, -1);
+                // get tag name
+                preg_match('/[\/]?([a-zA-Z0-9]*)/', $element, $tag);
+                $tagname = strtolower($tag[1]);
+                // check if we are inside a table header
+                if ($tagname == 'thead') {
+                    if ($element[0] == '/') {
+                        $thead = false;
+                    } else {
+                        $thead = true;
+                    }
+                    ++$elkey;
+                    continue;
+                }
+                $dom[$key]['tag'] = true;
+                $dom[$key]['value'] = $tagname;
+                if (in_array($dom[$key]['value'], $blocktags)) {
+                    $dom[$key]['block'] = true;
+                } else {
+                    $dom[$key]['block'] = false;
+                }
+                if ($element[0] == '/') {
+                    // *** closing html tag
+                    $dom[$key]['opening'] = false;
+                    $dom[$key]['parent'] = end($level);
+                    array_pop($level);
+                    $dom[$key]['hide'] = $dom[($dom[($dom[$key]['parent'])]['parent'])]['hide'];
+                    $dom[$key]['fontname'] = $dom[($dom[($dom[$key]['parent'])]['parent'])]['fontname'];
+                    $dom[$key]['fontstyle'] = $dom[($dom[($dom[$key]['parent'])]['parent'])]['fontstyle'];
+                    $dom[$key]['fontsize'] = $dom[($dom[($dom[$key]['parent'])]['parent'])]['fontsize'];
+                    $dom[$key]['font-stretch'] = $dom[($dom[($dom[$key]['parent'])]['parent'])]['font-stretch'];
+                    $dom[$key]['letter-spacing'] = $dom[($dom[($dom[$key]['parent'])]['parent'])]['letter-spacing'];
+                    $dom[$key]['stroke'] = $dom[($dom[($dom[$key]['parent'])]['parent'])]['stroke'];
+                    $dom[$key]['fill'] = $dom[($dom[($dom[$key]['parent'])]['parent'])]['fill'];
+                    $dom[$key]['clip'] = $dom[($dom[($dom[$key]['parent'])]['parent'])]['clip'];
+                    $dom[$key]['line-height'] = $dom[($dom[($dom[$key]['parent'])]['parent'])]['line-height'];
+                    $dom[$key]['bgcolor'] = $dom[($dom[($dom[$key]['parent'])]['parent'])]['bgcolor'];
+                    $dom[$key]['fgcolor'] = $dom[($dom[($dom[$key]['parent'])]['parent'])]['fgcolor'];
+                    $dom[$key]['strokecolor'] = $dom[($dom[($dom[$key]['parent'])]['parent'])]['strokecolor'];
+                    $dom[$key]['align'] = $dom[($dom[($dom[$key]['parent'])]['parent'])]['align'];
+                    $dom[$key]['text-transform'] = $dom[($dom[($dom[$key]['parent'])]['parent'])]['text-transform'];
+                    $dom[$key]['dir'] = $dom[($dom[($dom[$key]['parent'])]['parent'])]['dir'];
+                    if (isset($dom[($dom[($dom[$key]['parent'])]['parent'])]['listtype'])) {
+                        $dom[$key]['listtype'] = $dom[($dom[($dom[$key]['parent'])]['parent'])]['listtype'];
+                    }
+                    // set the number of columns in table tag
+                    if (($dom[$key]['value'] == 'tr') AND (!isset($dom[($dom[($dom[$key]['parent'])]['parent'])]['cols']))) {
+                        $dom[($dom[($dom[$key]['parent'])]['parent'])]['cols'] = $dom[($dom[$key]['parent'])]['cols'];
+                    }
+                    if (($dom[$key]['value'] == 'td') OR ($dom[$key]['value'] == 'th')) {
+                        $dom[($dom[$key]['parent'])]['content'] = $csstagarray;
+                        for ($i = ($dom[$key]['parent'] + 1); $i < $key; ++$i) {
+                            $dom[($dom[$key]['parent'])]['content'] .= stripslashes($a[$dom[$i]['elkey']]);
+                        }
+                        $key = $i;
+                        // mark nested tables
+                        $dom[($dom[$key]['parent'])]['content'] = str_replace('<table', '<table nested="true"', $dom[($dom[$key]['parent'])]['content']);
+                        // remove thead sections from nested tables
+                        $dom[($dom[$key]['parent'])]['content'] = str_replace('<thead>', '', $dom[($dom[$key]['parent'])]['content']);
+                        $dom[($dom[$key]['parent'])]['content'] = str_replace('</thead>', '', $dom[($dom[$key]['parent'])]['content']);
+                    }
+                    // store header rows on a new table
+                    if (($dom[$key]['value'] == 'tr') AND ($dom[($dom[$key]['parent'])]['thead'] === true)) {
+                        if (\TCPDF_STATIC::empty_string($dom[($dom[($dom[$key]['parent'])]['parent'])]['thead'])) {
+                            $dom[($dom[($dom[$key]['parent'])]['parent'])]['thead'] = $csstagarray.$a[$dom[($dom[($dom[$key]['parent'])]['parent'])]['elkey']];
+                        }
+                        for ($i = $dom[$key]['parent']; $i <= $key; ++$i) {
+                            $dom[($dom[($dom[$key]['parent'])]['parent'])]['thead'] .= $a[$dom[$i]['elkey']];
+                        }
+                        if (!isset($dom[($dom[$key]['parent'])]['attribute'])) {
+                            $dom[($dom[$key]['parent'])]['attribute'] = array();
+                        }
+                        // header elements must be always contained in a single page
+                        $dom[($dom[$key]['parent'])]['attribute']['nobr'] = 'true';
+                    }
+                    if (($dom[$key]['value'] == 'table') AND (!\TCPDF_STATIC::empty_string($dom[($dom[$key]['parent'])]['thead']))) {
+                        // remove the nobr attributes from the table header
+                        $dom[($dom[$key]['parent'])]['thead'] = str_replace(' nobr="true"', '', $dom[($dom[$key]['parent'])]['thead']);
+                        $dom[($dom[$key]['parent'])]['thead'] .= '</tablehead>';
+                    }
+                } else {
+                    // *** opening or self-closing html tag
+                    $dom[$key]['opening'] = true;
+                    $dom[$key]['parent'] = end($level);
+                    if ((substr($element, -1, 1) == '/') OR (in_array($dom[$key]['value'], $selfclosingtags))) {
+                        // self-closing tag
+                        $dom[$key]['self'] = true;
+                    } else {
+                        // opening tag
+                        array_push($level, $key);
+                        $dom[$key]['self'] = false;
+                    }
+                    // copy some values from parent
+                    $parentkey = 0;
+                    if ($key > 0) {
+                        $parentkey = $dom[$key]['parent'];
+                        $dom[$key]['hide'] = $dom[$parentkey]['hide'];
+                        $dom[$key]['fontname'] = $dom[$parentkey]['fontname'];
+                        $dom[$key]['fontstyle'] = $dom[$parentkey]['fontstyle'];
+                        $dom[$key]['fontsize'] = $dom[$parentkey]['fontsize'];
+                        $dom[$key]['font-stretch'] = $dom[$parentkey]['font-stretch'];
+                        $dom[$key]['letter-spacing'] = $dom[$parentkey]['letter-spacing'];
+                        $dom[$key]['stroke'] = $dom[$parentkey]['stroke'];
+                        $dom[$key]['fill'] = $dom[$parentkey]['fill'];
+                        $dom[$key]['clip'] = $dom[$parentkey]['clip'];
+                        $dom[$key]['line-height'] = $dom[$parentkey]['line-height'];
+                        $dom[$key]['bgcolor'] = $dom[$parentkey]['bgcolor'];
+                        $dom[$key]['fgcolor'] = $dom[$parentkey]['fgcolor'];
+                        $dom[$key]['strokecolor'] = $dom[$parentkey]['strokecolor'];
+                        $dom[$key]['align'] = $dom[$parentkey]['align'];
+                        $dom[$key]['listtype'] = $dom[$parentkey]['listtype'];
+                        $dom[$key]['text-indent'] = $dom[$parentkey]['text-indent'];
+                        $dom[$key]['text-transform'] = $dom[$parentkey]['text-transform'];
+                        $dom[$key]['border'] = array();
+                        $dom[$key]['dir'] = $dom[$parentkey]['dir'];
+                    }
+                    // get attributes
+                    preg_match_all('/([^=\s]*)[\s]*=[\s]*"([^"]*)"/', $element, $attr_array, PREG_PATTERN_ORDER);
+                    $dom[$key]['attribute'] = array(); // reset attribute array
+                    foreach($attr_array[1] as $id => $name) {
+                        $dom[$key]['attribute'][strtolower($name)] = $attr_array[2][$id];
+                    }
+                    if (!empty($css)) {
+                        // merge CSS style to current style
+                        list($dom[$key]['csssel'], $dom[$key]['cssdata']) = \TCPDF_STATIC::getCSSdataArray($dom, $key, $css);
+                        $dom[$key]['attribute']['style'] = \TCPDF_STATIC::getTagStyleFromCSSarray($dom[$key]['cssdata']);
+                    }
+                    // split style attributes
+                    if (isset($dom[$key]['attribute']['style']) AND !empty($dom[$key]['attribute']['style'])) {
+                        // get style attributes
+                        preg_match_all('/([^;:\s]*):([^;]*)/', $dom[$key]['attribute']['style'], $style_array, PREG_PATTERN_ORDER);
+                        $dom[$key]['style'] = array(); // reset style attribute array
+                        foreach($style_array[1] as $id => $name) {
+                            // in case of duplicate attribute the last replace the previous
+                            $dom[$key]['style'][strtolower($name)] = trim($style_array[2][$id]);
+                        }
+                        // --- get some style attributes ---
+                        // text direction
+                        if (isset($dom[$key]['style']['direction'])) {
+                            $dom[$key]['dir'] = $dom[$key]['style']['direction'];
+                        }
+                        // display
+                        if (isset($dom[$key]['style']['display'])) {
+                            $dom[$key]['hide'] = (trim(strtolower($dom[$key]['style']['display'])) == 'none');
+                        }
+                        // font family
+                        if (isset($dom[$key]['style']['font-family'])) {
+                            $dom[$key]['fontname'] = $this->getFontFamilyName($dom[$key]['style']['font-family']);
+                        }
+                        // list-style-type
+                        if (isset($dom[$key]['style']['list-style-type'])) {
+                            $dom[$key]['listtype'] = trim(strtolower($dom[$key]['style']['list-style-type']));
+                            if ($dom[$key]['listtype'] == 'inherit') {
+                                $dom[$key]['listtype'] = $dom[$parentkey]['listtype'];
+                            }
+                        }
+                        // text-indent
+                        if (isset($dom[$key]['style']['text-indent'])) {
+                            $dom[$key]['text-indent'] = $this->getHTMLUnitToUnits($dom[$key]['style']['text-indent']);
+                            if ($dom[$key]['text-indent'] == 'inherit') {
+                                $dom[$key]['text-indent'] = $dom[$parentkey]['text-indent'];
+                            }
+                        }
+                        // text-transform
+                        if (isset($dom[$key]['style']['text-transform'])) {
+                            $dom[$key]['text-transform'] = $dom[$key]['style']['text-transform'];
+                        }
+                        // font size
+                        if (isset($dom[$key]['style']['font-size'])) {
+                            $fsize = trim($dom[$key]['style']['font-size']);
+                            $dom[$key]['fontsize'] = $this->getHTMLFontUnits($fsize, $dom[0]['fontsize'], $dom[$parentkey]['fontsize'], 'pt');
+                        }
+                        // font-stretch
+                        if (isset($dom[$key]['style']['font-stretch'])) {
+                            $dom[$key]['font-stretch'] = $this->getCSSFontStretching($dom[$key]['style']['font-stretch'], $dom[$parentkey]['font-stretch']);
+                        }
+                        // letter-spacing
+                        if (isset($dom[$key]['style']['letter-spacing'])) {
+                            $dom[$key]['letter-spacing'] = $this->getCSSFontSpacing($dom[$key]['style']['letter-spacing'], $dom[$parentkey]['letter-spacing']);
+                        }
+                        // line-height (internally is the cell height ratio)
+                        if (isset($dom[$key]['style']['line-height'])) {
+                            $lineheight = trim($dom[$key]['style']['line-height']);
+                            switch ($lineheight) {
+                                // A normal line height. This is default
+                                case 'normal': {
+                                    $dom[$key]['line-height'] = $dom[0]['line-height'];
+                                    break;
+                                }
+                                case 'inherit': {
+                                    $dom[$key]['line-height'] = $dom[$parentkey]['line-height'];
+                                }
+                                default: {
+                                    if (is_numeric($lineheight)) {
+                                        // convert to percentage of font height
+                                        $lineheight = ($lineheight * 100).'%';
+                                    }
+                                    $dom[$key]['line-height'] = $this->getHTMLUnitToUnits($lineheight, 1, '%', true);
+                                    if (substr($lineheight, -1) !== '%') {
+                                        if ($dom[$key]['fontsize'] <= 0) {
+                                            $dom[$key]['line-height'] = 1;
+                                        } else {
+                                            $dom[$key]['line-height'] = (($dom[$key]['line-height'] - $this->cell_padding['T'] - $this->cell_padding['B']) / $dom[$key]['fontsize']);
+                                        }
+                                    }
+                                }
+                            }
+                        }
+                        // font style
+                        if (isset($dom[$key]['style']['font-weight'])) {
+                            if (strtolower($dom[$key]['style']['font-weight'][0]) == 'n') {
+                                if (strpos($dom[$key]['fontstyle'], 'B') !== false) {
+                                    $dom[$key]['fontstyle'] = str_replace('B', '', $dom[$key]['fontstyle']);
+                                }
+                            } elseif (strtolower($dom[$key]['style']['font-weight'][0]) == 'b') {
+                                $dom[$key]['fontstyle'] .= 'B';
+                            }
+                        }
+                        if (isset($dom[$key]['style']['font-style']) AND (strtolower($dom[$key]['style']['font-style'][0]) == 'i')) {
+                            $dom[$key]['fontstyle'] .= 'I';
+                        }
+                        // font color
+                        if (isset($dom[$key]['style']['color']) AND (!\TCPDF_STATIC::empty_string($dom[$key]['style']['color']))) {
+                            $dom[$key]['fgcolor'] = \TCPDF_COLORS::convertHTMLColorToDec($dom[$key]['style']['color'], $this->spot_colors);
+                        } elseif ($dom[$key]['value'] == 'a') {
+                            $dom[$key]['fgcolor'] = $this->htmlLinkColorArray;
+                        }
+                        // background color
+                        if (isset($dom[$key]['style']['background-color']) AND (!\TCPDF_STATIC::empty_string($dom[$key]['style']['background-color']))) {
+                            $dom[$key]['bgcolor'] = \TCPDF_COLORS::convertHTMLColorToDec($dom[$key]['style']['background-color'], $this->spot_colors);
+                        }
+                        // text-decoration
+                        if (isset($dom[$key]['style']['text-decoration'])) {
+                            $decors = explode(' ', strtolower($dom[$key]['style']['text-decoration']));
+                            foreach ($decors as $dec) {
+                                $dec = trim($dec);
+                                if (!\TCPDF_STATIC::empty_string($dec)) {
+                                    if ($dec[0] == 'u') {
+                                        // underline
+                                        $dom[$key]['fontstyle'] .= 'U';
+                                    } elseif ($dec[0] == 'l') {
+                                        // line-through
+                                        $dom[$key]['fontstyle'] .= 'D';
+                                    } elseif ($dec[0] == 'o') {
+                                        // overline
+                                        $dom[$key]['fontstyle'] .= 'O';
+                                    }
+                                }
+                            }
+                        } elseif ($dom[$key]['value'] == 'a') {
+                            $dom[$key]['fontstyle'] = $this->htmlLinkFontStyle;
+                        }
+                        // check for width attribute
+                        if (isset($dom[$key]['style']['width'])) {
+                            $dom[$key]['width'] = $dom[$key]['style']['width'];
+                        }
+                        // check for height attribute
+                        if (isset($dom[$key]['style']['height'])) {
+                            $dom[$key]['height'] = $dom[$key]['style']['height'];
+                        }
+                        // check for text alignment
+                        if (isset($dom[$key]['style']['text-align'])) {
+                            $dom[$key]['align'] = strtoupper($dom[$key]['style']['text-align'][0]);
+                        }
+                        // check for CSS border properties
+                        if (isset($dom[$key]['style']['border'])) {
+                            $borderstyle = $this->getCSSBorderStyle($dom[$key]['style']['border']);
+                            if (!empty($borderstyle)) {
+                                $dom[$key]['border']['LTRB'] = $borderstyle;
+                            }
+                        }
+                        if (isset($dom[$key]['style']['border-color'])) {
+                            $brd_colors = preg_split('/[\s]+/', trim($dom[$key]['style']['border-color']));
+                            if (isset($brd_colors[3])) {
+                                $dom[$key]['border']['L']['color'] = \TCPDF_COLORS::convertHTMLColorToDec($brd_colors[3], $this->spot_colors);
+                            }
+                            if (isset($brd_colors[1])) {
+                                $dom[$key]['border']['R']['color'] = \TCPDF_COLORS::convertHTMLColorToDec($brd_colors[1], $this->spot_colors);
+                            }
+                            if (isset($brd_colors[0])) {
+                                $dom[$key]['border']['T']['color'] = \TCPDF_COLORS::convertHTMLColorToDec($brd_colors[0], $this->spot_colors);
+                            }
+                            if (isset($brd_colors[2])) {
+                                $dom[$key]['border']['B']['color'] = \TCPDF_COLORS::convertHTMLColorToDec($brd_colors[2], $this->spot_colors);
+                            }
+                        }
+                        if (isset($dom[$key]['style']['border-width'])) {
+                            $brd_widths = preg_split('/[\s]+/', trim($dom[$key]['style']['border-width']));
+                            if (isset($brd_widths[3])) {
+                                $dom[$key]['border']['L']['width'] = $this->getCSSBorderWidth($brd_widths[3]);
+                            }
+                            if (isset($brd_widths[1])) {
+                                $dom[$key]['border']['R']['width'] = $this->getCSSBorderWidth($brd_widths[1]);
+                            }
+                            if (isset($brd_widths[0])) {
+                                $dom[$key]['border']['T']['width'] = $this->getCSSBorderWidth($brd_widths[0]);
+                            }
+                            if (isset($brd_widths[2])) {
+                                $dom[$key]['border']['B']['width'] = $this->getCSSBorderWidth($brd_widths[2]);
+                            }
+                        }
+                        if (isset($dom[$key]['style']['border-style'])) {
+                            $brd_styles = preg_split('/[\s]+/', trim($dom[$key]['style']['border-style']));
+                            if (isset($brd_styles[3]) AND ($brd_styles[3]!='none')) {
+                                $dom[$key]['border']['L']['cap'] = 'square';
+                                $dom[$key]['border']['L']['join'] = 'miter';
+                                $dom[$key]['border']['L']['dash'] = $this->getCSSBorderDashStyle($brd_styles[3]);
+                                if ($dom[$key]['border']['L']['dash'] < 0) {
+                                    $dom[$key]['border']['L'] = array();
+                                }
+                            }
+                            if (isset($brd_styles[1])) {
+                                $dom[$key]['border']['R']['cap'] = 'square';
+                                $dom[$key]['border']['R']['join'] = 'miter';
+                                $dom[$key]['border']['R']['dash'] = $this->getCSSBorderDashStyle($brd_styles[1]);
+                                if ($dom[$key]['border']['R']['dash'] < 0) {
+                                    $dom[$key]['border']['R'] = array();
+                                }
+                            }
+                            if (isset($brd_styles[0])) {
+                                $dom[$key]['border']['T']['cap'] = 'square';
+                                $dom[$key]['border']['T']['join'] = 'miter';
+                                $dom[$key]['border']['T']['dash'] = $this->getCSSBorderDashStyle($brd_styles[0]);
+                                if ($dom[$key]['border']['T']['dash'] < 0) {
+                                    $dom[$key]['border']['T'] = array();
+                                }
+                            }
+                            if (isset($brd_styles[2])) {
+                                $dom[$key]['border']['B']['cap'] = 'square';
+                                $dom[$key]['border']['B']['join'] = 'miter';
+                                $dom[$key]['border']['B']['dash'] = $this->getCSSBorderDashStyle($brd_styles[2]);
+                                if ($dom[$key]['border']['B']['dash'] < 0) {
+                                    $dom[$key]['border']['B'] = array();
+                                }
+                            }
+                        }
+                        $cellside = array('L' => 'left', 'R' => 'right', 'T' => 'top', 'B' => 'bottom');
+                        foreach ($cellside as $bsk => $bsv) {
+                            if (isset($dom[$key]['style']['border-'.$bsv])) {
+                                $borderstyle = $this->getCSSBorderStyle($dom[$key]['style']['border-'.$bsv]);
+                                if (!empty($borderstyle)) {
+                                    $dom[$key]['border'][$bsk] = $borderstyle;
+                                }
+                            }
+                            if (isset($dom[$key]['style']['border-'.$bsv.'-color'])) {
+                                $dom[$key]['border'][$bsk]['color'] = \TCPDF_COLORS::convertHTMLColorToDec($dom[$key]['style']['border-'.$bsv.'-color'], $this->spot_colors);
+                            }
+                            if (isset($dom[$key]['style']['border-'.$bsv.'-width'])) {
+                                $dom[$key]['border'][$bsk]['width'] = $this->getCSSBorderWidth($dom[$key]['style']['border-'.$bsv.'-width']);
+                            }
+                            if (isset($dom[$key]['style']['border-'.$bsv.'-style'])) {
+                                $dom[$key]['border'][$bsk]['dash'] = $this->getCSSBorderDashStyle($dom[$key]['style']['border-'.$bsv.'-style']);
+                                if ($dom[$key]['border'][$bsk]['dash'] < 0) {
+                                    $dom[$key]['border'][$bsk] = array();
+                                }
+                            }
+                        }
+                        // check for CSS padding properties
+                        if (isset($dom[$key]['style']['padding'])) {
+                            $dom[$key]['padding'] = $this->getCSSPadding($dom[$key]['style']['padding']);
+                        } else {
+                            $dom[$key]['padding'] = $this->cell_padding;
+                        }
+                        foreach ($cellside as $psk => $psv) {
+                            if (isset($dom[$key]['style']['padding-'.$psv])) {
+                                $dom[$key]['padding'][$psk] = $this->getHTMLUnitToUnits($dom[$key]['style']['padding-'.$psv], 0, 'px', false);
+                            }
+                        }
+                        // check for CSS margin properties
+                        if (isset($dom[$key]['style']['margin'])) {
+                            $dom[$key]['margin'] = $this->getCSSMargin($dom[$key]['style']['margin']);
+                        } else {
+                            $dom[$key]['margin'] = $this->cell_margin;
+                        }
+                        foreach ($cellside as $psk => $psv) {
+                            if (isset($dom[$key]['style']['margin-'.$psv])) {
+                                $dom[$key]['margin'][$psk] = $this->getHTMLUnitToUnits(str_replace('auto', '0', $dom[$key]['style']['margin-'.$psv]), 0, 'px', false);
+                            }
+                        }
+                        // check for CSS border-spacing properties
+                        if (isset($dom[$key]['style']['border-spacing'])) {
+                            $dom[$key]['border-spacing'] = $this->getCSSBorderMargin($dom[$key]['style']['border-spacing']);
+                        }
+                        // page-break-inside
+                        if (isset($dom[$key]['style']['page-break-inside']) AND ($dom[$key]['style']['page-break-inside'] == 'avoid')) {
+                            $dom[$key]['attribute']['nobr'] = 'true';
+                        }
+                        // page-break-before
+                        if (isset($dom[$key]['style']['page-break-before'])) {
+                            if ($dom[$key]['style']['page-break-before'] == 'always') {
+                                $dom[$key]['attribute']['pagebreak'] = 'true';
+                            } elseif ($dom[$key]['style']['page-break-before'] == 'left') {
+                                $dom[$key]['attribute']['pagebreak'] = 'left';
+                            } elseif ($dom[$key]['style']['page-break-before'] == 'right') {
+                                $dom[$key]['attribute']['pagebreak'] = 'right';
+                            }
+                        }
+                        // page-break-after
+                        if (isset($dom[$key]['style']['page-break-after'])) {
+                            if ($dom[$key]['style']['page-break-after'] == 'always') {
+                                $dom[$key]['attribute']['pagebreakafter'] = 'true';
+                            } elseif ($dom[$key]['style']['page-break-after'] == 'left') {
+                                $dom[$key]['attribute']['pagebreakafter'] = 'left';
+                            } elseif ($dom[$key]['style']['page-break-after'] == 'right') {
+                                $dom[$key]['attribute']['pagebreakafter'] = 'right';
+                            }
+                        }
+                    }
+                    if (isset($dom[$key]['attribute']['display'])) {
+                        $dom[$key]['hide'] = (trim(strtolower($dom[$key]['attribute']['display'])) == 'none');
+                    }
+                    if (isset($dom[$key]['attribute']['border']) AND ($dom[$key]['attribute']['border'] != 0)) {
+                        $borderstyle = $this->getCSSBorderStyle($dom[$key]['attribute']['border'].' solid black');
+                        if (!empty($borderstyle)) {
+                            $dom[$key]['border']['LTRB'] = $borderstyle;
+                        }
+                    }
+                    // check for font tag
+                    if ($dom[$key]['value'] == 'font') {
+                        // font family
+                        if (isset($dom[$key]['attribute']['face'])) {
+                            $dom[$key]['fontname'] = $this->getFontFamilyName($dom[$key]['attribute']['face']);
+                        }
+                        // font size
+                        if (isset($dom[$key]['attribute']['size'])) {
+                            if ($key > 0) {
+                                if ($dom[$key]['attribute']['size'][0] == '+') {
+                                    $dom[$key]['fontsize'] = $dom[($dom[$key]['parent'])]['fontsize'] + intval(substr($dom[$key]['attribute']['size'], 1));
+                                } elseif ($dom[$key]['attribute']['size'][0] == '-') {
+                                    $dom[$key]['fontsize'] = $dom[($dom[$key]['parent'])]['fontsize'] - intval(substr($dom[$key]['attribute']['size'], 1));
+                                } else {
+                                    $dom[$key]['fontsize'] = intval($dom[$key]['attribute']['size']);
+                                }
+                            } else {
+                                $dom[$key]['fontsize'] = intval($dom[$key]['attribute']['size']);
+                            }
+                        }
+                    }
+                    // force natural alignment for lists
+                    if ((($dom[$key]['value'] == 'ul') OR ($dom[$key]['value'] == 'ol') OR ($dom[$key]['value'] == 'dl'))
+                            AND (!isset($dom[$key]['align']) OR \TCPDF_STATIC::empty_string($dom[$key]['align']) OR ($dom[$key]['align'] != 'J'))) {
+                        if ($this->rtl) {
+                            $dom[$key]['align'] = 'R';
+                        } else {
+                            $dom[$key]['align'] = 'L';
+                        }
+                    }
+                    if (($dom[$key]['value'] == 'small') OR ($dom[$key]['value'] == 'sup') OR ($dom[$key]['value'] == 'sub')) {
+                        if (!isset($dom[$key]['attribute']['size']) AND !isset($dom[$key]['style']['font-size'])) {
+                            $dom[$key]['fontsize'] = $dom[$key]['fontsize'] * K_SMALL_RATIO;
+                        }
+                    }
+                    if (($dom[$key]['value'] == 'strong') OR ($dom[$key]['value'] == 'b')) {
+                        $dom[$key]['fontstyle'] .= 'B';
+                    }
+                    if (($dom[$key]['value'] == 'em') OR ($dom[$key]['value'] == 'i')) {
+                        $dom[$key]['fontstyle'] .= 'I';
+                    }
+                    if ($dom[$key]['value'] == 'u') {
+                        $dom[$key]['fontstyle'] .= 'U';
+                    }
+                    if (($dom[$key]['value'] == 'del') OR ($dom[$key]['value'] == 's') OR ($dom[$key]['value'] == 'strike')) {
+                        $dom[$key]['fontstyle'] .= 'D';
+                    }
+                    if (!isset($dom[$key]['style']['text-decoration']) AND ($dom[$key]['value'] == 'a')) {
+                        $dom[$key]['fontstyle'] = $this->htmlLinkFontStyle;
+                    }
+                    if (($dom[$key]['value'] == 'pre') OR ($dom[$key]['value'] == 'tt')) {
+                        $dom[$key]['fontname'] = $this->default_monospaced_font;
+                    }
+                    if (!empty($dom[$key]['value']) AND ($dom[$key]['value'][0] == 'h') AND (intval($dom[$key]['value'][1]) > 0) AND (intval($dom[$key]['value'][1]) < 7)) {
+                        // headings h1, h2, h3, h4, h5, h6
+                        if (!isset($dom[$key]['attribute']['size']) AND !isset($dom[$key]['style']['font-size'])) {
+                            $headsize = (4 - intval($dom[$key]['value'][1])) * 2;
+                            $dom[$key]['fontsize'] = $dom[0]['fontsize'] + $headsize;
+                        }
+                        if (!isset($dom[$key]['style']['font-weight'])) {
+                            $dom[$key]['fontstyle'] .= 'B';
+                        }
+                    }
+                    if (($dom[$key]['value'] == 'table')) {
+                        $dom[$key]['rows'] = 0; // number of rows
+                        $dom[$key]['trids'] = array(); // IDs of TR elements
+                        $dom[$key]['thead'] = ''; // table header rows
+                    }
+                    if (($dom[$key]['value'] == 'tr')) {
+                        $dom[$key]['cols'] = 0;
+                        if ($thead) {
+                            $dom[$key]['thead'] = true;
+                            // rows on thead block are printed as a separate table
+                        } else {
+                            $dom[$key]['thead'] = false;
+                            // store the number of rows on table element
+                            ++$dom[($dom[$key]['parent'])]['rows'];
+                            // store the TR elements IDs on table element
+                            array_push($dom[($dom[$key]['parent'])]['trids'], $key);
+                        }
+                    }
+                    if (($dom[$key]['value'] == 'th') OR ($dom[$key]['value'] == 'td')) {
+                        if (isset($dom[$key]['attribute']['colspan'])) {
+                            $colspan = intval($dom[$key]['attribute']['colspan']);
+                        } else {
+                            $colspan = 1;
+                        }
+                        $dom[$key]['attribute']['colspan'] = $colspan;
+                        $dom[($dom[$key]['parent'])]['cols'] += $colspan;
+                    }
+                    // text direction
+                    if (isset($dom[$key]['attribute']['dir'])) {
+                        $dom[$key]['dir'] = $dom[$key]['attribute']['dir'];
+                    }
+                    // set foreground color attribute
+                    if (isset($dom[$key]['attribute']['color']) AND (!\TCPDF_STATIC::empty_string($dom[$key]['attribute']['color']))) {
+                        $dom[$key]['fgcolor'] = \TCPDF_COLORS::convertHTMLColorToDec($dom[$key]['attribute']['color'], $this->spot_colors);
+                    } elseif (!isset($dom[$key]['style']['color']) AND ($dom[$key]['value'] == 'a')) {
+                        $dom[$key]['fgcolor'] = $this->htmlLinkColorArray;
+                    }
+                    // set background color attribute
+                    if (isset($dom[$key]['attribute']['bgcolor']) AND (!\TCPDF_STATIC::empty_string($dom[$key]['attribute']['bgcolor']))) {
+                        $dom[$key]['bgcolor'] = \TCPDF_COLORS::convertHTMLColorToDec($dom[$key]['attribute']['bgcolor'], $this->spot_colors);
+                    }
+                    // set stroke color attribute
+                    if (isset($dom[$key]['attribute']['strokecolor']) AND (!\TCPDF_STATIC::empty_string($dom[$key]['attribute']['strokecolor']))) {
+                        $dom[$key]['strokecolor'] = \TCPDF_COLORS::convertHTMLColorToDec($dom[$key]['attribute']['strokecolor'], $this->spot_colors);
+                    }
+                    // check for width attribute
+                    if (isset($dom[$key]['attribute']['width'])) {
+                        $dom[$key]['width'] = $dom[$key]['attribute']['width'];
+                    }
+                    // check for height attribute
+                    if (isset($dom[$key]['attribute']['height'])) {
+                        $dom[$key]['height'] = $dom[$key]['attribute']['height'];
+                    }
+                    // check for text alignment
+                    if (isset($dom[$key]['attribute']['align']) AND (!\TCPDF_STATIC::empty_string($dom[$key]['attribute']['align'])) AND ($dom[$key]['value'] !== 'img')) {
+                        $dom[$key]['align'] = strtoupper($dom[$key]['attribute']['align'][0]);
+                    }
+                    // check for text rendering mode (the following attributes do not exist in HTML)
+                    if (isset($dom[$key]['attribute']['stroke'])) {
+                        // font stroke width
+                        $dom[$key]['stroke'] = $this->getHTMLUnitToUnits($dom[$key]['attribute']['stroke'], $dom[$key]['fontsize'], 'pt', true);
+                    }
+                    if (isset($dom[$key]['attribute']['fill'])) {
+                        // font fill
+                        if ($dom[$key]['attribute']['fill'] == 'true') {
+                            $dom[$key]['fill'] = true;
+                        } else {
+                            $dom[$key]['fill'] = false;
+                        }
+                    }
+                    if (isset($dom[$key]['attribute']['clip'])) {
+                        // clipping mode
+                        if ($dom[$key]['attribute']['clip'] == 'true') {
+                            $dom[$key]['clip'] = true;
+                        } else {
+                            $dom[$key]['clip'] = false;
+                        }
+                    }
+                } // end opening tag
+            } else {
+                // text
+                $dom[$key]['tag'] = false;
+                $dom[$key]['block'] = false;
+                $dom[$key]['parent'] = end($level);
+                $dom[$key]['dir'] = $dom[$dom[$key]['parent']]['dir'];
+                if (!empty($dom[$dom[$key]['parent']]['text-transform'])) {
+                    // text-transform for unicode requires mb_convert_case (Multibyte String Functions)
+                    if (function_exists('mb_convert_case')) {
+                        $ttm = array('capitalize' => MB_CASE_TITLE, 'uppercase' => MB_CASE_UPPER, 'lowercase' => MB_CASE_LOWER);
+                        if (isset($ttm[$dom[$dom[$key]['parent']]['text-transform']])) {
+                            $element = mb_convert_case($element, $ttm[$dom[$dom[$key]['parent']]['text-transform']], $this->encoding);
+                        }
+                    } elseif (!$this->isunicode) {
+                        switch ($dom[$dom[$key]['parent']]['text-transform']) {
+                            case 'capitalize': {
+                                $element = ucwords(strtolower($element));
+                                break;
+                            }
+                            case 'uppercase': {
+                                $element = strtoupper($element);
+                                break;
+                            }
+                            case 'lowercase': {
+                                $element = strtolower($element);
+                                break;
+                            }
+                        }
+                    }
+                }
+                $dom[$key]['value'] = stripslashes($this->unhtmlentities($element));
+            }
+            ++$elkey;
+            ++$key;
+        }
+        return $dom;
+    }
+
+
+    /**
+     * Add a htmlcomment marker to the specified page.
+     *
+     * @param int $pageno The page number to add markers to (starting at 0).
+     * @param int $index The comment index.
+     * @param int $x The x-coordinate of the marker (in pixels).
+     * @param int $y The y-coordinate of the marker (in pixels).
+     * @param string $rawtext The fill colour of the marker (red, yellow, green, blue, white, clear).
+     * @return bool Success status.
+     */
+    public function add_htmlcomment($pageno, $width, $x, $y, $rawtext ) {
+        if (!$this->filename) {
+            return false;
+        }
+        $checklat = preg_match_all('/\\\\\\([\S\s]*?\\\\\\)/u',$rawtext, $latexs,PREG_SET_ORDER);
+        if($checklat){
+            foreach ($latexs as $latex){
+                $replat = texify($latex[0], 300, 0.0,0.0,0.0, 1.0,1.0,1.0);
+                $rawtext = str_replace($latex[0],$replat ,$rawtext);
+            }
+        }
+        $x *= $this->scale;
+        $y *= $this->scale;
+        $width = 24 * $width;
+        $this->setPage($pageno + 1);
+        // Add the label.
+        $this->writeHTMLCell($width, 0, $x, $y, $rawtext, 0, 0, false, true, 'C');
+        return true;
+    }
+
     /**
      * Add an annotation to the current page
      * @param int $sx starting x-coordinate (in pixels)
@@ -536,6 +2063,8 @@
      * @return string the filename of the generated image
      */
     public function get_image($pageno) {
+        global $CFG;
+
         if (!$this->filename) {
             throw new \coding_exception('Attempting to generate a page image without first setting the PDF filename');
         }
@@ -558,7 +2087,15 @@
         }
 
         if ($generate) {
-            $command = $this->get_command_for_image($pageno, $imagefile);
+            // Use ghostscript to generate an image of the specified page.
+            $gsexec = \escapeshellarg($CFG->pathtogs);
+            $imageres = \escapeshellarg(100);
+            $imagefilearg = \escapeshellarg($imagefile);
+            $filename = \escapeshellarg($this->filename);
+            $pagenoinc = \escapeshellarg($pageno + 1);
+            $command = "$gsexec -q -sDEVICE=png16m -dSAFER -dBATCH -dNOPAUSE -r$imageres -dFirstPage=$pagenoinc -dLastPage=$pagenoinc ".
+                "-dDOINTERPOLATE -dGraphicsAlphaBits=4 -dTextAlphaBits=4 -sOutputFile=$imagefilearg $filename";
+
             $output = null;
             $result = exec($command, $output);
             if (!file_exists($imagefile)) {
Index: mod/assign/feedback/editpdf/classes/privacy/provider.php
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/mod/assign/feedback/editpdf/classes/privacy/provider.php b/mod/assign/feedback/editpdf/classes/privacy/provider.php
--- a/mod/assign/feedback/editpdf/classes/privacy/provider.php	(revision 2729694d4d56ca2c88bb180aee3f254f8be906cf)
+++ b/mod/assign/feedback/editpdf/classes/privacy/provider.php	(revision 0b9764ed79311babea3acc01b01be2b999f9ec4f)
@@ -174,6 +174,7 @@
         // Remove table entries.
         $DB->delete_records_select('assignfeedback_editpdf_annot', "gradeid $sql", $params);
         $DB->delete_records_select('assignfeedback_editpdf_cmnt', "gradeid $sql", $params);
+        $DB->delete_records_select('assignfeedback_editpdf_htcm', "gradeid $sql", $params);
         $DB->delete_records_select('assignfeedback_editpdf_rot', "gradeid $sql", $params);
         // Submission records in assignfeedback_editpdf_queue will be cleaned up in a scheduled task
     }
Index: mod/assign/feedback/editpdf/classes/renderer.php
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/mod/assign/feedback/editpdf/classes/renderer.php b/mod/assign/feedback/editpdf/classes/renderer.php
--- a/mod/assign/feedback/editpdf/classes/renderer.php	(revision 2729694d4d56ca2c88bb180aee3f254f8be906cf)
+++ b/mod/assign/feedback/editpdf/classes/renderer.php	(revision 0b9764ed79311babea3acc01b01be2b999f9ec4f)
@@ -48,6 +48,7 @@
             'navigate-next-button' => 'l',
             'searchcomments' => 'h',
             'expcolcomments' => 'g',
+                'expcolhtmlcomments' => 'g',
             'comment' => 'z',
             'commentcolour' => 'x',
             'select' => 'c',
@@ -201,8 +202,13 @@
             $toolbar4 .= $this->render_toolbar_button('background_colour_clear', 'currentstamp', $this->get_shortcut('currentstamp'));
             $toolbar4 = html_writer::div($toolbar4, 'toolbar', array('role'=>'toolbar'));
 
+            // Html
+            $toolbar5 = '';
+            $toolbar5 .= $this->render_toolbar_button('math', 'htmleditor');
+            $toolbar5 = html_writer::div($toolbar5, 'toolbar', array('role' => 'toolbar'));
+
             // Add toolbars to toolbar_group in order of display, and float the toolbar_group right.
-            $toolbars = $rotationtools . $toolbar1 . $toolbar2 . $toolbar3 . $toolbar4;
+            $toolbars = $rotationtools . $toolbar1 . $toolbar2 . $toolbar3 . $toolbar4 . $toolbar5;
             $toolbargroup = html_writer::div($toolbars, 'toolbar_group', array('role' => 'toolbar_group'));
         }
 
@@ -235,7 +241,10 @@
         $canvas .= $infomessage;
 
         $body .= $canvas;
-
+        $textarea = html_writer::tag('textarea', '', ["id" => "html_editor",
+                "class" => "htmleditor", "rows" => "20", "cols" => "50"]);
+        $textcontainer = html_writer::tag('div', $textarea);
+        $body .= html_writer::tag('div', $textcontainer, ["id" => "editorcontainer", "class" => "hidden"]);
         $footer = '';
 
         $editorparams = array(
@@ -278,9 +287,128 @@
             'cannotopenpdf',
             'pagenumber',
             'partialwarning',
-            'draftchangessaved'
+                'draftchangessaved',
+                'add',
+                'htmleditor',
+                'edithtml'
         ), 'assignfeedback_editpdf');
 
+        $textareaid = 'html_editor';
+        $options = array('subdirs' => 0, 'maxbytes' => 0, 'maxfiles' => 0, 'changeformat' => 0,
+                'areamaxbytes' => FILE_AREA_MAX_BYTES_UNLIMITED, 'context' => $this->page->context, 'noclean' => 0,
+                'trusttext' => 0, 'return_types' => 15, 'enable_filemanagement' => true, 'removeorphaneddrafts' => true,
+                'autosave' => false, 'trusted');
+        $configstr = "collapse = collapse
+                    style1 = title, bold, italic, fontcolor, backcolor
+                    list = unorderedlist, orderedlist, indent
+                    links = link, fontsize
+                    style2 = underline, strike, subscript, superscript
+                    align = align,rtl
+                    insert = equation, charmap, table, clear
+                    undo = undo
+                    accessibility = accessibilitychecker, accessibilityhelper
+                    math = wiris
+                    other = html";
+
+        $grouplines = explode("\n", $configstr);
+
+        $groups = array();
+
+        foreach ($grouplines as $groupline) {
+            $line = explode('=', $groupline);
+            if (count($line) > 1) {
+                $group = trim(array_shift($line));
+                $plugins = array_map('trim', explode(',', array_shift($line)));
+                $groups[$group] = $plugins;
+            }
+        }
+
+        $modules = array('moodle-editor_atto-editor');
+
+        $jsplugins = array();
+        foreach ($groups as $group => $plugins) {
+            $groupplugins = array();
+            foreach ($plugins as $plugin) {
+                // Do not die on missing plugin.
+                if (!\core_component::get_component_directory('atto_' . $plugin)) {
+                    continue;
+                }
+
+                // Remove manage files if requested.
+                if ($plugin == 'managefiles' && isset($options['enable_filemanagement']) &&
+                        !$options['enable_filemanagement']) {
+                    continue;
+                }
+
+                $jsplugin = array();
+                $jsplugin['name'] = $plugin;
+                $jsplugin['params'] = array();
+                $modules[] = 'moodle-atto_' . $plugin . '-button';
+
+                component_callback('atto_' . $plugin, 'strings_for_js');
+                $extra = component_callback('atto_' . $plugin, 'params_for_js',
+                        array($textareaid, $options, null));
+
+                if ($extra) {
+                    $jsplugin = array_merge($jsplugin, $extra);
+                }
+                // We always need the plugin name.
+                $this->page->requires->string_for_js('pluginname', 'atto_' . $plugin);
+                $groupplugins[] = $jsplugin;
+            }
+            $jsplugins[] = array('group' => $group, 'plugins' => $groupplugins);
+        }
+
+        $this->page->requires->strings_for_js(array(
+                'editor_command_keycode',
+                'editor_control_keycode',
+                'plugin_title_shortcut',
+                'textrecovered',
+                'autosavefailed',
+                'autosavesucceeded',
+                'errortextrecovery'
+        ), 'editor_atto');
+        $this->page->requires->strings_for_js(array(
+                'warning',
+                'info'
+        ), 'moodle');
+        $this->page->requires->yui_module($modules,
+                'Y.M.editor_atto.Editor.init',
+                array($this->get_init_params_atto($textareaid, $options, null, $jsplugins)), '', true);
+
         return $html;
     }
+
+    function get_init_params_atto($elementid, array $options = null, array $fpoptions = null, $plugins = null) {
+        global $PAGE;
+
+        $directionality = get_string('thisdirection', 'langconfig');
+        $lang = current_language();
+        $autosave = true;
+        $autosavefrequency = get_config('editor_atto', 'autosavefrequency');
+        if (isset($options['autosave'])) {
+            $autosave = $options['autosave'];
+        }
+        $contentcss = $PAGE->theme->editor_css_url()->out(false);
+
+        // Autosave disabled for guests and not logged in users.
+        if (isguestuser() or !isloggedin()) {
+            $autosave = false;
+        }
+        // Note <> is a safe separator, because it will not appear in the output of s().
+        $pagehash = sha1($PAGE->url . '<>');
+        $params = array(
+                'elementid' => $elementid,
+                'content_css' => $contentcss,
+                'contextid' => $options['context']->id,
+                'autosaveEnabled' => $autosave,
+                'autosaveFrequency' => $autosavefrequency,
+                'language' => $lang,
+                'directionality' => $directionality,
+                'filepickeroptions' => array(),
+                'plugins' => $plugins,
+                'pageHash' => $pagehash,
+        );
+        return $params;
+    }
 }
Index: mod/assign/feedback/editpdf/db/install.xml
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/mod/assign/feedback/editpdf/db/install.xml b/mod/assign/feedback/editpdf/db/install.xml
--- a/mod/assign/feedback/editpdf/db/install.xml	(revision 2729694d4d56ca2c88bb180aee3f254f8be906cf)
+++ b/mod/assign/feedback/editpdf/db/install.xml	(revision 0b9764ed79311babea3acc01b01be2b999f9ec4f)
@@ -88,5 +88,24 @@
         <INDEX NAME="gradeid_pageno" UNIQUE="true" FIELDS="gradeid, pageno"/>
       </INDEXES>
     </TABLE>
+    <TABLE NAME="assignfeedback_editpdf_htcm" COMMENT="Stores htmlcomments added to pdfs">
+      <FIELDS>
+        <FIELD NAME="id" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="true"/>
+        <FIELD NAME="gradeid" TYPE="int" LENGTH="10" NOTNULL="true" DEFAULT="0" SEQUENCE="false"/>
+        <FIELD NAME="x" TYPE="int" LENGTH="10" NOTNULL="false" DEFAULT="0" SEQUENCE="false" COMMENT="x-position of the top-left corner of the comment (in pixels - image resolution is set to 100 pixels per inch)"/>
+        <FIELD NAME="y" TYPE="int" LENGTH="10" NOTNULL="false" DEFAULT="0" SEQUENCE="false" COMMENT="y-position of the top-left corner of the comment (in pixels - image resolution is set to 100 pixels per inch)"/>
+        <FIELD NAME="width" TYPE="int" LENGTH="10" NOTNULL="false" DEFAULT="120" SEQUENCE="false" COMMENT="width, in pixels, of the comment box"/>
+        <FIELD NAME="rawtext" TYPE="text" NOTNULL="false" SEQUENCE="false" COMMENT="Raw text of the comment"/>
+        <FIELD NAME="pageno" TYPE="int" LENGTH="10" NOTNULL="true" DEFAULT="0" SEQUENCE="false" COMMENT="The page in the PDF that this comment appears on"/>
+        <FIELD NAME="draft" TYPE="int" LENGTH="2" NOTNULL="true" DEFAULT="1" SEQUENCE="false" COMMENT="Is this a draft comment?"/>
+      </FIELDS>
+      <KEYS>
+        <KEY NAME="primary" TYPE="primary" FIELDS="id"/>
+        <KEY NAME="gradeid" TYPE="foreign" FIELDS="gradeid" REFTABLE="assign_grades" REFFIELDS="id"/>
+      </KEYS>
+      <INDEXES>
+        <INDEX NAME="gradeid_pageno" UNIQUE="false" FIELDS="gradeid, pageno"/>
+      </INDEXES>
+    </TABLE>
   </TABLES>
 </XMLDB>
Index: mod/assign/feedback/editpdf/db/upgrade.php
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/mod/assign/feedback/editpdf/db/upgrade.php b/mod/assign/feedback/editpdf/db/upgrade.php
--- a/mod/assign/feedback/editpdf/db/upgrade.php	(revision 2729694d4d56ca2c88bb180aee3f254f8be906cf)
+++ b/mod/assign/feedback/editpdf/db/upgrade.php	(revision 0b9764ed79311babea3acc01b01be2b999f9ec4f)
@@ -101,14 +101,33 @@
         upgrade_plugin_savepoint(true, 2019010800, 'assignfeedback', 'editpdf');
     }
 
-    // Automatically generated Moodle v3.7.0 release upgrade line.
-    // Put any upgrade step following this.
+    if ($oldversion < 2021042100) {
+        // Define table assignfeedback_editpdf_htcm to be created.
+        $table = new xmldb_table('assignfeedback_editpdf_htcm');
+        // Adding fields to table assignfeedback_editpdf_rot.
+        $table->add_field('id', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, XMLDB_SEQUENCE, null);
+        $table->add_field('gradeid', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, null, '0');
+        $table->add_field('x', XMLDB_TYPE_INTEGER, '10', null, false, null, '0');
+        $table->add_field('y', XMLDB_TYPE_INTEGER, '10', null, false, null, '0');
+        $table->add_field('width', XMLDB_TYPE_INTEGER, '10', null, false, null, '120');
+        $table->add_field('rawtext', XMLDB_TYPE_TEXT, null, null, false, null, null);
+        $table->add_field('pageno', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, null, '0');
+        $table->add_field('draft', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, null, '1');
 
-    // Automatically generated Moodle v3.8.0 release upgrade line.
-    // Put any upgrade step following this.
+        // Adding keys to table assignfeedback_editpdf_rot.
+        $table->add_key('primary', XMLDB_KEY_PRIMARY, ['id']);
+        $table->add_key('gradeid', XMLDB_KEY_FOREIGN, ['gradeid'], 'assign_grades', ['id']);
 
-    // Automatically generated Moodle v3.9.0 release upgrade line.
-    // Put any upgrade step following this.
+        // Adding indexes to table assignfeedback_editpdf_rot.
+        $table->add_index('gradeid_pageno', XMLDB_INDEX_NOTUNIQUE, ['gradeid', 'pageno']);
+
+        // Conditionally launch create table for assignfeedback_editpdf_rot.
+        if (!$dbman->table_exists($table)) {
+            $dbman->create_table($table);
+        }
+        // Editpdf savepoint reached.
+        upgrade_plugin_savepoint(true, 2021042100, 'assignfeedback', 'editpdf');
+    }
 
     return true;
 }
Index: mod/assign/feedback/editpdf/environment.xml
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/mod/assign/feedback/editpdf/environment.xml b/mod/assign/feedback/editpdf/environment.xml
new file mode 100644
--- /dev/null	(revision 0b9764ed79311babea3acc01b01be2b999f9ec4f)
+++ b/mod/assign/feedback/editpdf/environment.xml	(revision 0b9764ed79311babea3acc01b01be2b999f9ec4f)
@@ -0,0 +1,8 @@
+<?xml version="1.0" encoding="UTF-8" ?>
+<COMPATIBILITY_MATRIX>
+    <PLUGIN name="assignfeedback_editpdf">
+        <PHP_EXTENSIONS>
+            <PHP_EXTENSION name="imagick" level="required"></PHP_EXTENSION>
+        </PHP_EXTENSIONS>
+    </PLUGIN>
+</COMPATIBILITY_MATRIX>
Index: mod/assign/feedback/editpdf/lang/en/assignfeedback_editpdf.php
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/mod/assign/feedback/editpdf/lang/en/assignfeedback_editpdf.php b/mod/assign/feedback/editpdf/lang/en/assignfeedback_editpdf.php
--- a/mod/assign/feedback/editpdf/lang/en/assignfeedback_editpdf.php	(revision 2729694d4d56ca2c88bb180aee3f254f8be906cf)
+++ b/mod/assign/feedback/editpdf/lang/en/assignfeedback_editpdf.php	(revision 0b9764ed79311babea3acc01b01be2b999f9ec4f)
@@ -109,3 +109,6 @@
 $string['preparesubmissionsforannotation'] = 'Prepare submissions for annotation';
 $string['rotateleft'] = 'Rotate 90 degrees to the left';
 $string['rotateright'] = 'Rotate 90 degrees to the right';
+$string['htmleditor'] = 'Html editor';
+$string['add'] = 'Add';
+$string['edithtml'] = 'Edit html';
Index: mod/assign/feedback/editpdf/lang/he/assignfeedback_editpdf.php
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/mod/assign/feedback/editpdf/lang/he/assignfeedback_editpdf.php b/mod/assign/feedback/editpdf/lang/he/assignfeedback_editpdf.php
new file mode 100644
--- /dev/null	(revision 0b9764ed79311babea3acc01b01be2b999f9ec4f)
+++ b/mod/assign/feedback/editpdf/lang/he/assignfeedback_editpdf.php	(revision 0b9764ed79311babea3acc01b01be2b999f9ec4f)
@@ -0,0 +1,29 @@
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * Strings for component 'assignfeedback_editpdf', language 'en'
+ *
+ * @package   assignfeedback_editpdf
+ * @copyright 2012 Davo Smith
+ * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+defined('MOODLE_INTERNAL') || die();
+
+$string['htmleditor'] = 'עורך מתמטי';
+$string['add'] = 'הוסף';
+$string['edithtml'] = 'Edit html';
Index: mod/assign/feedback/editpdf/locallib.php
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/mod/assign/feedback/editpdf/locallib.php b/mod/assign/feedback/editpdf/locallib.php
--- a/mod/assign/feedback/editpdf/locallib.php	(revision 2729694d4d56ca2c88bb180aee3f254f8be906cf)
+++ b/mod/assign/feedback/editpdf/locallib.php	(revision 0b9764ed79311babea3acc01b01be2b999f9ec4f)
@@ -246,6 +246,29 @@
                         return true;
                     }
                 }
+
+                // Select all htmlcomments.
+                $drafthtmlcomments = page_editor::get_htmlcomments($sourcegrade->id, $i, true);
+                $nondrafthtmlcomments = page_editor::get_htmlcomments($grade->id, $i, false);
+                if (count($drafthtmlcomments) != count($nondrafthtmlcomments)) {
+                    return true;
+                } else {
+                    // Go for a closer inspection.
+                    $matches = 0;
+                    foreach ($nondrafthtmlcomments as $ndhtmlcomment) {
+                        foreach ($drafthtmlcomments as $dhtmlcomment) {
+                            foreach ($ndhtmlcomment as $key => $value) {
+                                if ($key != 'id' && $value != $dhtmlcomment->{$key}) {
+                                    continue 2;
+                                }
+                            }
+                            $matches++;
+                        }
+                    }
+                    if ($matches !== count($nondrafthtmlcomments)) {
+                        return true;
+                    }
+                }
             }
         }
         return false;
@@ -319,8 +342,9 @@
         global $DB;
 
         $comments = $DB->count_records('assignfeedback_editpdf_cmnt', array('gradeid'=>$grade->id, 'draft'=>0));
+        $htmlcomments = $DB->count_records('assignfeedback_editpdf_htcm', array('gradeid'=>$grade->id, 'draft'=>0));
         $annotations = $DB->count_records('assignfeedback_editpdf_annot', array('gradeid'=>$grade->id, 'draft'=>0));
-        return $comments == 0 && $annotations == 0;
+        return $comments == 0 && $annotations == 0 && $htmlcomments == 0;
     }
 
     /**
@@ -335,6 +359,7 @@
             list($gradeids, $params) = $DB->get_in_or_equal(array_keys($grades), SQL_PARAMS_NAMED);
             $DB->delete_records_select('assignfeedback_editpdf_annot', 'gradeid ' . $gradeids, $params);
             $DB->delete_records_select('assignfeedback_editpdf_cmnt', 'gradeid ' . $gradeids, $params);
+            $DB->delete_records_select('assignfeedback_editpdf_htcm', 'gradeid ' . $gradeids, $params);
         }
         return true;
     }
Index: mod/assign/feedback/editpdf/pix/math.svg
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/mod/assign/feedback/editpdf/pix/math.svg b/mod/assign/feedback/editpdf/pix/math.svg
new file mode 100644
--- /dev/null	(revision 0b9764ed79311babea3acc01b01be2b999f9ec4f)
+++ b/mod/assign/feedback/editpdf/pix/math.svg	(revision 0b9764ed79311babea3acc01b01be2b999f9ec4f)
@@ -0,0 +1,1 @@
+<svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="square-root-alt" class="svg-inline--fa fa-square-root-alt fa-w-18" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path fill="currentColor" d="M571.31 251.31l-22.62-22.62c-6.25-6.25-16.38-6.25-22.63 0L480 274.75l-46.06-46.06c-6.25-6.25-16.38-6.25-22.63 0l-22.62 22.62c-6.25 6.25-6.25 16.38 0 22.63L434.75 320l-46.06 46.06c-6.25 6.25-6.25 16.38 0 22.63l22.62 22.62c6.25 6.25 16.38 6.25 22.63 0L480 365.25l46.06 46.06c6.25 6.25 16.38 6.25 22.63 0l22.62-22.62c6.25-6.25 6.25-16.38 0-22.63L525.25 320l46.06-46.06c6.25-6.25 6.25-16.38 0-22.63zM552 0H307.65c-14.54 0-27.26 9.8-30.95 23.87l-84.79 322.8-58.41-106.1A32.008 32.008 0 0 0 105.47 224H24c-13.25 0-24 10.74-24 24v48c0 13.25 10.75 24 24 24h43.62l88.88 163.73C168.99 503.5 186.3 512 204.94 512c17.27 0 44.44-9 54.28-41.48L357.03 96H552c13.25 0 24-10.75 24-24V24c0-13.26-10.75-24-24-24z"></path></svg>
\ No newline at end of file
Index: mod/assign/feedback/editpdf/styles.css
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/mod/assign/feedback/editpdf/styles.css b/mod/assign/feedback/editpdf/styles.css
--- a/mod/assign/feedback/editpdf/styles.css	(revision 2729694d4d56ca2c88bb180aee3f254f8be906cf)
+++ b/mod/assign/feedback/editpdf/styles.css	(revision 0b9764ed79311babea3acc01b01be2b999f9ec4f)
@@ -72,7 +72,9 @@
 
 .yui3-colourpicker-hidden,
 .yui3-commentsearch-hidden,
-.yui3-commentmenu-hidden {
+.yui3-commentmenu-hidden,
+.yui3-htmlcommentmenu-hidden,
+.yui3-htmleditor-hidden {
     display: none;
 }
 
@@ -401,6 +403,14 @@
     position: relative;
 }
 
+.assignfeedback_editpdf_widget #editorcontainer {
+    position: relative;
+}
+
+.assignfeedback_editpdf_widget #editorcontainer #html_editor_tbl {
+    margin: auto;
+}
+
 @media (max-width: 960px) {
     .assignfeedback_editpdf_widget .pageheader {
         height: 104px;
Index: mod/assign/feedback/editpdf/tests/behat/view_previous_annotations.feature
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/mod/assign/feedback/editpdf/tests/behat/view_previous_annotations.feature b/mod/assign/feedback/editpdf/tests/behat/view_previous_annotations.feature
--- a/mod/assign/feedback/editpdf/tests/behat/view_previous_annotations.feature	(revision 2729694d4d56ca2c88bb180aee3f254f8be906cf)
+++ b/mod/assign/feedback/editpdf/tests/behat/view_previous_annotations.feature	(revision 0b9764ed79311babea3acc01b01be2b999f9ec4f)
@@ -25,7 +25,7 @@
       | Description | Submit your PDF file |
       | assignsubmission_file_enabled | 1 |
       | Maximum number of uploaded files | 2 |
-      | Attempts reopened | Manually |
+      | Additional attempts | Manually |
       | Maximum attempts | Unlimited |
     And I log out
     And I log in as "student1"
Index: mod/assign/feedback/editpdf/vendor/phplatex/LICENSE
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/mod/assign/feedback/editpdf/vendor/phplatex/LICENSE b/mod/assign/feedback/editpdf/vendor/phplatex/LICENSE
new file mode 100644
--- /dev/null	(revision 0b9764ed79311babea3acc01b01be2b999f9ec4f)
+++ b/mod/assign/feedback/editpdf/vendor/phplatex/LICENSE	(revision 0b9764ed79311babea3acc01b01be2b999f9ec4f)
@@ -0,0 +1,340 @@
+GNU GENERAL PUBLIC LICENSE
+                       Version 2, June 1991
+
+ Copyright (C) 1989, 1991 Free Software Foundation, Inc., <http://fsf.org/>
+ 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA
+ Everyone is permitted to copy and distribute verbatim copies
+ of this license document, but changing it is not allowed.
+
+                            Preamble
+
+  The licenses for most software are designed to take away your
+freedom to share and change it.  By contrast, the GNU General Public
+License is intended to guarantee your freedom to share and change free
+software--to make sure the software is free for all its users.  This
+General Public License applies to most of the Free Software
+Foundation's software and to any other program whose authors commit to
+using it.  (Some other Free Software Foundation software is covered by
+the GNU Lesser General Public License instead.)  You can apply it to
+your programs, too.
+
+  When we speak of free software, we are referring to freedom, not
+price.  Our General Public Licenses are designed to make sure that you
+have the freedom to distribute copies of free software (and charge for
+this service if you wish), that you receive source code or can get it
+if you want it, that you can change the software or use pieces of it
+in new free programs; and that you know you can do these things.
+
+  To protect your rights, we need to make restrictions that forbid
+anyone to deny you these rights or to ask you to surrender the rights.
+These restrictions translate to certain responsibilities for you if you
+distribute copies of the software, or if you modify it.
+
+  For example, if you distribute copies of such a program, whether
+gratis or for a fee, you must give the recipients all the rights that
+you have.  You must make sure that they, too, receive or can get the
+source code.  And you must show them these terms so they know their
+rights.
+
+  We protect your rights with two steps: (1) copyright the software, and
+(2) offer you this license which gives you legal permission to copy,
+distribute and/or modify the software.
+
+  Also, for each author's protection and ours, we want to make certain
+that everyone understands that there is no warranty for this free
+software.  If the software is modified by someone else and passed on, we
+want its recipients to know that what they have is not the original, so
+that any problems introduced by others will not reflect on the original
+authors' reputations.
+
+  Finally, any free program is threatened constantly by software
+patents.  We wish to avoid the danger that redistributors of a free
+program will individually obtain patent licenses, in effect making the
+program proprietary.  To prevent this, we have made it clear that any
+patent must be licensed for everyone's free use or not licensed at all.
+
+  The precise terms and conditions for copying, distribution and
+modification follow.
+
+                    GNU GENERAL PUBLIC LICENSE
+   TERMS AND CONDITIONS FOR COPYING, DISTRIBUTION AND MODIFICATION
+
+  0. This License applies to any program or other work which contains
+a notice placed by the copyright holder saying it may be distributed
+under the terms of this General Public License.  The "Program", below,
+refers to any such program or work, and a "work based on the Program"
+means either the Program or any derivative work under copyright law:
+that is to say, a work containing the Program or a portion of it,
+either verbatim or with modifications and/or translated into another
+language.  (Hereinafter, translation is included without limitation in
+the term "modification".)  Each licensee is addressed as "you".
+
+Activities other than copying, distribution and modification are not
+covered by this License; they are outside its scope.  The act of
+running the Program is not restricted, and the output from the Program
+is covered only if its contents constitute a work based on the
+Program (independent of having been made by running the Program).
+Whether that is true depends on what the Program does.
+
+  1. You may copy and distribute verbatim copies of the Program's
+source code as you receive it, in any medium, provided that you
+conspicuously and appropriately publish on each copy an appropriate
+copyright notice and disclaimer of warranty; keep intact all the
+notices that refer to this License and to the absence of any warranty;
+and give any other recipients of the Program a copy of this License
+along with the Program.
+
+You may charge a fee for the physical act of transferring a copy, and
+you may at your option offer warranty protection in exchange for a fee.
+
+  2. You may modify your copy or copies of the Program or any portion
+of it, thus forming a work based on the Program, and copy and
+distribute such modifications or work under the terms of Section 1
+above, provided that you also meet all of these conditions:
+
+    a) You must cause the modified files to carry prominent notices
+    stating that you changed the files and the date of any change.
+
+    b) You must cause any work that you distribute or publish, that in
+    whole or in part contains or is derived from the Program or any
+    part thereof, to be licensed as a whole at no charge to all third
+    parties under the terms of this License.
+
+    c) If the modified program normally reads commands interactively
+    when run, you must cause it, when started running for such
+    interactive use in the most ordinary way, to print or display an
+    announcement including an appropriate copyright notice and a
+    notice that there is no warranty (or else, saying that you provide
+    a warranty) and that users may redistribute the program under
+    these conditions, and telling the user how to view a copy of this
+    License.  (Exception: if the Program itself is interactive but
+    does not normally print such an announcement, your work based on
+    the Program is not required to print an announcement.)
+
+These requirements apply to the modified work as a whole.  If
+identifiable sections of that work are not derived from the Program,
+and can be reasonably considered independent and separate works in
+themselves, then this License, and its terms, do not apply to those
+sections when you distribute them as separate works.  But when you
+distribute the same sections as part of a whole which is a work based
+on the Program, the distribution of the whole must be on the terms of
+this License, whose permissions for other licensees extend to the
+entire whole, and thus to each and every part regardless of who wrote it.
+
+Thus, it is not the intent of this section to claim rights or contest
+your rights to work written entirely by you; rather, the intent is to
+exercise the right to control the distribution of derivative or
+collective works based on the Program.
+
+In addition, mere aggregation of another work not based on the Program
+with the Program (or with a work based on the Program) on a volume of
+a storage or distribution medium does not bring the other work under
+the scope of this License.
+
+  3. You may copy and distribute the Program (or a work based on it,
+under Section 2) in object code or executable form under the terms of
+Sections 1 and 2 above provided that you also do one of the following:
+
+    a) Accompany it with the complete corresponding machine-readable
+    source code, which must be distributed under the terms of Sections
+    1 and 2 above on a medium customarily used for software interchange; or,
+
+    b) Accompany it with a written offer, valid for at least three
+    years, to give any third party, for a charge no more than your
+    cost of physically performing source distribution, a complete
+    machine-readable copy of the corresponding source code, to be
+    distributed under the terms of Sections 1 and 2 above on a medium
+    customarily used for software interchange; or,
+
+    c) Accompany it with the information you received as to the offer
+    to distribute corresponding source code.  (This alternative is
+    allowed only for noncommercial distribution and only if you
+    received the program in object code or executable form with such
+    an offer, in accord with Subsection b above.)
+
+The source code for a work means the preferred form of the work for
+making modifications to it.  For an executable work, complete source
+code means all the source code for all modules it contains, plus any
+associated interface definition files, plus the scripts used to
+control compilation and installation of the executable.  However, as a
+special exception, the source code distributed need not include
+anything that is normally distributed (in either source or binary
+form) with the major components (compiler, kernel, and so on) of the
+operating system on which the executable runs, unless that component
+itself accompanies the executable.
+
+If distribution of executable or object code is made by offering
+access to copy from a designated place, then offering equivalent
+access to copy the source code from the same place counts as
+distribution of the source code, even though third parties are not
+compelled to copy the source along with the object code.
+
+  4. You may not copy, modify, sublicense, or distribute the Program
+except as expressly provided under this License.  Any attempt
+otherwise to copy, modify, sublicense or distribute the Program is
+void, and will automatically terminate your rights under this License.
+However, parties who have received copies, or rights, from you under
+this License will not have their licenses terminated so long as such
+parties remain in full compliance.
+
+  5. You are not required to accept this License, since you have not
+signed it.  However, nothing else grants you permission to modify or
+distribute the Program or its derivative works.  These actions are
+prohibited by law if you do not accept this License.  Therefore, by
+modifying or distributing the Program (or any work based on the
+Program), you indicate your acceptance of this License to do so, and
+all its terms and conditions for copying, distributing or modifying
+the Program or works based on it.
+
+  6. Each time you redistribute the Program (or any work based on the
+Program), the recipient automatically receives a license from the
+original licensor to copy, distribute or modify the Program subject to
+these terms and conditions.  You may not impose any further
+restrictions on the recipients' exercise of the rights granted herein.
+You are not responsible for enforcing compliance by third parties to
+this License.
+
+  7. If, as a consequence of a court judgment or allegation of patent
+infringement or for any other reason (not limited to patent issues),
+conditions are imposed on you (whether by court order, agreement or
+otherwise) that contradict the conditions of this License, they do not
+excuse you from the conditions of this License.  If you cannot
+distribute so as to satisfy simultaneously your obligations under this
+License and any other pertinent obligations, then as a consequence you
+may not distribute the Program at all.  For example, if a patent
+license would not permit royalty-free redistribution of the Program by
+all those who receive copies directly or indirectly through you, then
+the only way you could satisfy both it and this License would be to
+refrain entirely from distribution of the Program.
+
+If any portion of this section is held invalid or unenforceable under
+any particular circumstance, the balance of the section is intended to
+apply and the section as a whole is intended to apply in other
+circumstances.
+
+It is not the purpose of this section to induce you to infringe any
+patents or other property right claims or to contest validity of any
+such claims; this section has the sole purpose of protecting the
+integrity of the free software distribution system, which is
+implemented by public license practices.  Many people have made
+generous contributions to the wide range of software distributed
+through that system in reliance on consistent application of that
+system; it is up to the author/donor to decide if he or she is willing
+to distribute software through any other system and a licensee cannot
+impose that choice.
+
+This section is intended to make thoroughly clear what is believed to
+be a consequence of the rest of this License.
+
+  8. If the distribution and/or use of the Program is restricted in
+certain countries either by patents or by copyrighted interfaces, the
+original copyright holder who places the Program under this License
+may add an explicit geographical distribution limitation excluding
+those countries, so that distribution is permitted only in or among
+countries not thus excluded.  In such case, this License incorporates
+the limitation as if written in the body of this License.
+
+  9. The Free Software Foundation may publish revised and/or new versions
+of the General Public License from time to time.  Such new versions will
+be similar in spirit to the present version, but may differ in detail to
+address new problems or concerns.
+
+Each version is given a distinguishing version number.  If the Program
+specifies a version number of this License which applies to it and "any
+later version", you have the option of following the terms and conditions
+either of that version or of any later version published by the Free
+Software Foundation.  If the Program does not specify a version number of
+this License, you may choose any version ever published by the Free Software
+Foundation.
+
+  10. If you wish to incorporate parts of the Program into other free
+programs whose distribution conditions are different, write to the author
+to ask for permission.  For software which is copyrighted by the Free
+Software Foundation, write to the Free Software Foundation; we sometimes
+make exceptions for this.  Our decision will be guided by the two goals
+of preserving the free status of all derivatives of our free software and
+of promoting the sharing and reuse of software generally.
+
+                            NO WARRANTY
+
+  11. BECAUSE THE PROGRAM IS LICENSED FREE OF CHARGE, THERE IS NO WARRANTY
+FOR THE PROGRAM, TO THE EXTENT PERMITTED BY APPLICABLE LAW.  EXCEPT WHEN
+OTHERWISE STATED IN WRITING THE COPYRIGHT HOLDERS AND/OR OTHER PARTIES
+PROVIDE THE PROGRAM "AS IS" WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESSED
+OR IMPLIED, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
+MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  THE ENTIRE RISK AS
+TO THE QUALITY AND PERFORMANCE OF THE PROGRAM IS WITH YOU.  SHOULD THE
+PROGRAM PROVE DEFECTIVE, YOU ASSUME THE COST OF ALL NECESSARY SERVICING,
+REPAIR OR CORRECTION.
+
+  12. IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN WRITING
+WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MAY MODIFY AND/OR
+REDISTRIBUTE THE PROGRAM AS PERMITTED ABOVE, BE LIABLE TO YOU FOR DAMAGES,
+INCLUDING ANY GENERAL, SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES ARISING
+OUT OF THE USE OR INABILITY TO USE THE PROGRAM (INCLUDING BUT NOT LIMITED
+TO LOSS OF DATA OR DATA BEING RENDERED INACCURATE OR LOSSES SUSTAINED BY
+YOU OR THIRD PARTIES OR A FAILURE OF THE PROGRAM TO OPERATE WITH ANY OTHER
+PROGRAMS), EVEN IF SUCH HOLDER OR OTHER PARTY HAS BEEN ADVISED OF THE
+POSSIBILITY OF SUCH DAMAGES.
+
+                     END OF TERMS AND CONDITIONS
+
+            How to Apply These Terms to Your New Programs
+
+  If you develop a new program, and you want it to be of the greatest
+possible use to the public, the best way to achieve this is to make it
+free software which everyone can redistribute and change under these terms.
+
+  To do so, attach the following notices to the program.  It is safest
+to attach them to the start of each source file to most effectively
+convey the exclusion of warranty; and each file should have at least
+the "copyright" line and a pointer to where the full notice is found.
+
+    {description}
+    Copyright (C) {year}  {fullname}
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License along
+    with this program; if not, write to the Free Software Foundation, Inc.,
+    51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
+
+Also add information on how to contact you by electronic and paper mail.
+
+If the program is interactive, make it output a short notice like this
+when it starts in an interactive mode:
+
+    Gnomovision version 69, Copyright (C) year name of author
+    Gnomovision comes with ABSOLUTELY NO WARRANTY; for details type `show w'.
+    This is free software, and you are welcome to redistribute it
+    under certain conditions; type `show c' for details.
+
+The hypothetical commands `show w' and `show c' should show the appropriate
+parts of the General Public License.  Of course, the commands you use may
+be called something other than `show w' and `show c'; they could even be
+mouse-clicks or menu items--whatever suits your program.
+
+You should also get your employer (if you work as a programmer) or your
+school, if any, to sign a "copyright disclaimer" for the program, if
+necessary.  Here is a sample; alter the names:
+
+  Yoyodyne, Inc., hereby disclaims all copyright interest in the program
+  `Gnomovision' (which makes passes at compilers) written by James Hacker.
+
+  {signature of Ty Coon}, 1 April 1989
+  Ty Coon, President of Vice
+
+This General Public License does not permit incorporating your program into
+proprietary programs.  If your program is a subroutine library, you may
+consider it more useful to permit linking proprietary applications with the
+library.  If this is what you want to do, use the GNU Lesser General
+Public License instead of this License.
+
Index: mod/assign/feedback/editpdf/vendor/phplatex/README.md
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/mod/assign/feedback/editpdf/vendor/phplatex/README.md b/mod/assign/feedback/editpdf/vendor/phplatex/README.md
new file mode 100644
--- /dev/null	(revision 0b9764ed79311babea3acc01b01be2b999f9ec4f)
+++ b/mod/assign/feedback/editpdf/vendor/phplatex/README.md	(revision 0b9764ed79311babea3acc01b01be2b999f9ec4f)
@@ -0,0 +1,73 @@
+
+Renders LaTeX into images by calling LaTeX itself from PHP (I'm no fan of PHP, but this does make it pretty portable)
+
+See also http://phplatex.scarfboy.com/
+
+
+Requirements
+- PHP                                    (>=4.3.0, as it uses sha1())
+- imagemagick                            (for convert)
+- ghostscript, and TeX Live (or teTeX),  (for latex and dvips)
+- TeX packages: color, amsmath, amsfonts, amssymb, and the extarticle document class.
+  Most are standard.   You may need relatively recent versions of some.
+
+
+
+Installation
+- Put phplatex.php somewhere from which you can include it
+- Have the requirements installed, and check they are where phplatex.php expects them to be (/usr/bin, you can edit this if you want)
+- Create subdirecties 'tmp' and 'images' in each directory you will be *calling* the script from, with write permissions for the effective user, for example `mkdir tmp images; chown apache:apache tmp images`
+-- TODO: allow for a single global settable tmp and images directories (easier in dynamic sites and such)
+- *Optional: configure apache to serve these images with a far-future Expires: header*
+
+
+Use
+- Include the code:
+    `include('path/to/phplatex.php');`
+- To render some TeX:
+    `echo texify("TeX");`
+Due to PHP parsing, you will need to double all your backslahes, and escape your dollar signs.
+PHP offers no alternatives to that.
+
+
+For advanced use, the function definition is actually:
+-  `texify(texstring, dpi, r,g,b, br,bg,bb, extraprelude);`
+So, for example:
+-  `print texify('Times in TeX', 160, 0.2,0.0,0.0, 1.0,1.0,1.0, '\\usepackage{pslatex}');`
+
+Maintenance
+- Remove leftovers in the tmp directory at will
+- You can empty the img directory to remove unused images (still-used one will be regenerated)
+
+
+Features
+- Will cache generated images. 
+  Based on a hash of the document string, using the same TeX uses the cached image via a filesystem check+read). This means leaving the texify() calls in your code is cheap.
+- CSS lowering to compensate for descenders, so TeX text used inline in HTML should look halfway decent.
+- Tweakable size. The default (90) is approximately the same size as HTML text. Capped at 300.
+- Allows inclusion of extra TeX packages, via extraprelude.
+- Allows coloring of page background and default text color   (default is black on white, 0.,0.,0. on 1.,1.,1.)
+- Generates PNGs with transparency (note: consider antialiasing to that background)
+- Relies on image trimming (instead of e.g. trusting dvips' bounding box)
+
+
+Caveats
+- Won't work on safe-mode PHP  (common enough on cheaper shared hosting)
+- Fails on TeX that is more than one page.
+  Should not bother you for most things that are inline.
+  Workaround: use \small or \footnotesize and a larger DPI setting.
+  TODO: think about better fixes.
+- Image conversion can fail for very large images  (hence the DPI cap)
+- I cannot guarantee this is safe from a security standpoint -- in theory it's mostly fine, but TeX *is* a full-fledged language.
+
+
+Arguables
+- Image generation can take a second per image. You may hit the PHP time limit a few times before
+  a page with a lot of TeX images is all built and cached.
+- Uses \nonstopmode, meaning latex will fix errors it can rather than complain. You can get away with some bad TeX
+- No input filter on what TeX is allowed. Know what this means security-wise - USE AT YOUR OWN RISK.
+  Basically, the processes can do everything the effective user (of the apache process) can.
+- On low resolutions, the (default) Computer Modern fonts don't render as well as, say, pslatex fonts 
+  (Times, Helvatica, Courier), due to thickness and antialiasing. Change fontset to taste.
+
+
Index: mod/assign/feedback/editpdf/vendor/phplatex/phplatex.php
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/mod/assign/feedback/editpdf/vendor/phplatex/phplatex.php b/mod/assign/feedback/editpdf/vendor/phplatex/phplatex.php
new file mode 100644
--- /dev/null	(revision 0b9764ed79311babea3acc01b01be2b999f9ec4f)
+++ b/mod/assign/feedback/editpdf/vendor/phplatex/phplatex.php	(revision 0b9764ed79311babea3acc01b01be2b999f9ec4f)
@@ -0,0 +1,124 @@
+<?php
+# Written by scarfboy@gmail.com.
+# Use at your own risk.
+# See README for usage details.
+#In case these are elsewhere
+#literally used in extensions, and in parameters to convert. Should be either png or gif
+
+function phplatex_cleantmp($tempfname,$todir) {
+  #specifically removes the various files that probably got created for a specific run, based on the run's filename.
+  global $imgfmt;
+  if (chdir($todir)===FALSE) { return '[directory access error, fix permissions (and empty tmp manually this time)]'; }
+  error_reporting(0); #at least one of these probably will not exist, but disable the error reporting related to that.
+  unlink($tempfname);     #the longer/cleaner way would be check for existance for each
+  unlink($tempfname.".tex");  unlink($tempfname.".log");
+  unlink($tempfname.".aux");  unlink($tempfname.".dvi");
+  unlink($tempfname.".ps");   unlink($tempfname.".".$imgfmt);
+  error_reporting(E_ERROR | E_WARNING | E_PARSE | E_NOTICE);
+  #try-catch would have been nice. This is rather overkill too, the way I use it.
+  return '';
+}
+
+function phplatex_colorhex($r,$g,$b) {
+  #there has to be a better way of doing this. It's not even particularly clean.
+  $hex=array("","","");
+  if(strlen($hex[0]=dechex(min(255*$r,255)))==1){ $hex[0]="0".$hex[0]; }
+  if(strlen($hex[1]=dechex(min(255*$g,255)))==1){ $hex[1]="0".$hex[1]; }
+  if(strlen($hex[2]=dechex(min(255*$b,255)))==1){ $hex[2]="0".$hex[2]; }
+  return implode("",$hex);
+}
+
+
+function texify($string,$dpi='90', $r=0.0,$g=0.0,$b=0.0, $br=1.0,$bg=1.0,$bb=1.0,$extraprelude="", $trans=FALSE) {
+  global $CFG;
+  $imgfmt="png";
+  $path_to_latex = '/usr/bin/latex';
+  $path_to_dvips = '/usr/bin/dvips';
+  $path_to_convert = '/usr/bin/convert';
+  if ($dpi>300) $dpi=300;
+
+  $back = phplatex_colorhex($br,$bg,$bb);
+  $fore = phplatex_colorhex($r,$g,$b);
+
+  # Figure out TeX, either to get the right cache entry or to, you know, compile
+  # Semi-common (ams) symbol packages are included.
+  $totex = "\\documentclass[14pt,landscape]{extarticle}\n".
+           "\\usepackage{color}\n".
+           "\\usepackage{amsmath}\n\\usepackage{amsfonts}\n\\usepackage{amssymb}\n".
+           $extraprelude."\n".
+           "\\pagestyle{empty}\n".  #removes header/footer; necessary for trim
+           "\\begin{document}\n".
+           "\\color[rgb]{".$r.",".$g.",".$b."}\n".
+           $string."\n".
+           "\\end{document}\n";
+  $hashfn = sha1($totex).".".$dpi.".".$fore.".".$back.".".intval($trans);  #file cache entry string:  40-char hash string plus size
+  $stralt = str_replace("&","&amp;", preg_replace("/[\"\n]/","",$string)); # stuck in the alt and title attributes
+                                                                           # May need some extra safety.
+  $heredir=getcwd();
+
+  # Experiment: Tries to adjust vertical positioning, so that rendered TeX text looks natural enough inline with HTML text
+  #  Only descenders are really a problem since HTML's leeway is upwards.
+  #  TODO: This can always use more work.
+  #        Avoid using characters that are part of TeX commands.
+  #  Some things vary per font, e.g. the slash. In the default CM it is a descender, in Times and others it isn't.
+  $ascenders ="/(b|d|f|h|i|j|k|l|t|A|B|C|D|E|F|G|H|I|J|L|K|M|N|O|P|Q|R|S|T|U|V|W|X|Y|Z|\[|\]|\\{|\\}|\(|\)|\/|0|1|2|3|4|5|6|7|8|9|\\#|\*|\?|'|\\\\'|\\\\`|\\\\v)/";
+  $monoliners="/(a|c|e|m|n|o|r|s|u|v|w|x|z|-|=|\+|:|.)/";
+  $descenders="/(g|j|p|\/|q|y|Q|,|;|\[|\]|\\{|\\}|\(|\)|\#|\\\\LaTeX|\\\\TeX|\\\\c\{)/";
+  $deepdescenders="/(\[|\]|\\{|\\}|\(|\)|\\int)/";
+
+  # check image cache, return link if exists
+  #the vertical-align is to fix text baseline/descender(/tail) details in and on-average sort of way
+  if (file_exists($CFG->dataroot.'/temp/'.$hashfn.'.'.$imgfmt))
+    return '<img style="width:25px; height:auto;" title="'.$stralt.'" alt="'.$stralt.'" src="'.$CFG->dataroot.'/temp/'.$hashfn.'.'.$imgfmt.'">';
+
+
+  # chdir to have superfluous files be created in tmp. (you stiill have to empty this yourself)
+  error_reporting(0); # not checking existence myself, that would be double.
+  if (chdir($CFG->dataroot.'/temp')===FALSE) { return '[directory access error, fix permissions]'; } #I should chech whether file creation is allowed to give a nice error for that problem case
+  error_reporting(E_ERROR | E_WARNING | E_PARSE | E_NOTICE); # TODO: set old value
+
+  $tfn = tempnam(getcwd(), 'PTX'); #file in tmp dir
+
+  #write temporary .tex file
+  if ( ($tex = fopen($tfn.'.tex', "w"))==FALSE) { return '[file access error] '.phplatex_cleantmp($tfn,$heredir); }
+  fwrite($tex, $totex);
+  fclose($tex);
+
+
+  # Run latex to create a .dvi.  Have it try to fix minor errors instead of breaking/pausing on them.
+  exec($path_to_latex.' --interaction=nonstopmode '.$tfn.'.tex');
+  if (!file_exists($tfn.".dvi")) {
+    $log = file_get_contents($tfn.'.log'); #The log always exists, but now it's actually interesting since it'll contain an error
+    return '[latex error, code follows]<pre>'.$totex.'</pre><p><b>Log file:</b><pre>'.$log.'</pre></p> '.phplatex_cleantmp($tfn,$heredir);
+  }
+
+
+  # DVI -> PostScript.   Since dvips uses lpr, which may be configured to actually print by default, force writing to a file with -o
+  exec($path_to_dvips.' '.$tfn.'.dvi -o '.$tfn.'.ps');
+  if ( !file_exists($tfn.'.ps'))  {
+    return '[dvi2ps error] '.phplatex_cleantmp($tfn,$heredir);
+  }
+
+
+  # PostScript -> image.  Also trim based on corner pixel and set transparent color.
+  $convert_cmd = $path_to_convert ." -rotate -90";
+  if ($trans) {
+    $convert_cmd .= ' -transparent-color "#'.$back.'" -transparent "#'.$back.'"';
+  }
+  $convert_cmd .= ' -colorspace RGB -density '.$dpi.' -trim +page '.$tfn.'.ps '.$tfn.'.'.$imgfmt;
+
+  exec($convert_cmd);
+  #Note: +page OR -page +0+0 OR +repage moves the image to the cropped area (kills offset)
+  #Older code tried: exec('/usr/bin/mogrify -density 90 -trim +page -format $imgfmt '.$tfn.'.ps');
+  # It seems some versions of convert may not have -trim. Old versions?
+
+  if (!file_exists($tfn.'.'.$imgfmt))  {
+    return '[image convert error] '.phplatex_cleantmp($tfn,$heredir);
+  }
+
+  # Copy result image to chache.
+  copy($tfn.'.'.$imgfmt, $CFG->dataroot.'/temp/'.$hashfn.'.'.$imgfmt);
+
+  # Clean up temporary files, and return link to just-created image
+  return phplatex_cleantmp($tfn,$heredir).'<img style="width:25px; height:auto;" title="'.$stralt.'" alt="LaTeX formula: '.$stralt.'" src="'.$CFG->dataroot.'/temp/'.$hashfn.'.'.$imgfmt.'">';
+}
Index: mod/assign/feedback/editpdf/version.php
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/mod/assign/feedback/editpdf/version.php b/mod/assign/feedback/editpdf/version.php
--- a/mod/assign/feedback/editpdf/version.php	(revision 2729694d4d56ca2c88bb180aee3f254f8be906cf)
+++ b/mod/assign/feedback/editpdf/version.php	(revision 0b9764ed79311babea3acc01b01be2b999f9ec4f)
@@ -24,6 +24,11 @@
 
 defined('MOODLE_INTERNAL') || die();
 
-$plugin->version   = 2020061500;
+$plugin->version   = 2021042100;
 $plugin->requires  = 2020060900;
 $plugin->component = 'assignfeedback_editpdf';
+$plugin->dependencies = [
+    'editor_atto' => ANY_VERSION,
+    'filter_mathjaxloader' => '2020061500',
+    'filter_tex' => '2020061500',
+];
Index: mod/assign/feedback/editpdf/yui/build/moodle-assignfeedback_editpdf-editor/moodle-assignfeedback_editpdf-editor-debug.js
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/mod/assign/feedback/editpdf/yui/build/moodle-assignfeedback_editpdf-editor/moodle-assignfeedback_editpdf-editor-debug.js b/mod/assign/feedback/editpdf/yui/build/moodle-assignfeedback_editpdf-editor/moodle-assignfeedback_editpdf-editor-debug.js
--- a/mod/assign/feedback/editpdf/yui/build/moodle-assignfeedback_editpdf-editor/moodle-assignfeedback_editpdf-editor-debug.js	(revision 2729694d4d56ca2c88bb180aee3f254f8be906cf)
+++ b/mod/assign/feedback/editpdf/yui/build/moodle-assignfeedback_editpdf-editor/moodle-assignfeedback_editpdf-editor-debug.js	(revision 0b9764ed79311babea3acc01b01be2b999f9ec4f)
@@ -41,6 +41,7 @@
         SAVE: '.savebutton',
         COMMENTCOLOURBUTTON: '.commentcolourbutton',
         COMMENTMENU: '.commentdrawable a',
+        HTMLCOMMENTMENU: '.htmlcommentdrawable a',
         ANNOTATIONCOLOURBUTTON:  '.annotationcolourbutton',
         DELETEANNOTATIONBUTTON: '.deleteannotationbutton',
         WARNINGMESSAGECONTAINER: '.warningmessages',
@@ -51,6 +52,7 @@
         USERINFOREGION: '[data-region="user-info"]',
         ROTATELEFTBUTTON: '.rotateleftbutton',
         ROTATERIGHTBUTTON: '.rotaterightbutton',
+        HTMLEDITORBUTTON: '.htmleditorbutton',
         DIALOGUE: '.' + CSS.DIALOGUE
     },
     SELECTEDBORDERCOLOUR = 'rgba(200, 200, 255, 0.9)',
@@ -82,7 +84,8 @@
         'stamp': '.stampbutton',
         'select': '.selectbutton',
         'drag': '.dragbutton',
-        'highlight': '.highlightbutton'
+        'highlight': '.highlightbutton',
+        'htmleditor': '.htmleditorbutton'
     },
     STROKEWEIGHT = 4;
 // This file is part of Moodle - http://moodle.org/
@@ -3481,6 +3484,13 @@
      */
     searchcommentswindow: null,
 
+    /**
+     * The search comments window.
+     * @property searchcommentswindow
+     * @type M.core.dialogue
+     * @protected
+     */
+    htmleditorwindow: null,
 
     /**
      * The selected stamp picture.
@@ -3508,6 +3518,16 @@
      */
     editingcomment: false,
 
+    /**
+     * Prevent new comments from appearing
+     * immediately after clicking off a current
+     * comment
+     * @property editinghtmlcomment
+     * @type Boolean
+     * @public
+     */
+    editinghtmlcomment: false,
+
     /**
      * Should inactive comments be collapsed?
      *
@@ -3893,7 +3913,7 @@
      * @method prepare_pages_for_display
      */
     prepare_pages_for_display: function(data) {
-        var i, j, comment, error, annotation, readonly;
+        var i, j, comment, htmlcomment, error, annotation, readonly;
 
         if (!data.pagecount) {
             if (this.dialogue) {
@@ -3919,6 +3939,17 @@
                                                                                  comment.colour,
                                                                                  comment.rawtext);
             }
+            for (j = 0; j < this.pages[i].htmlcomments.length; j++) {
+                htmlcomment = this.pages[i].htmlcomments[j];
+                this.pages[i].htmlcomments[j] = new M.assignfeedback_editpdf.htmlcomment(this,
+                    htmlcomment.gradeid,
+                    htmlcomment.pageno,
+                    htmlcomment.x,
+                    htmlcomment.y,
+                    htmlcomment.width,
+                    htmlcomment.colour,
+                    htmlcomment.rawtext);
+            }
             for (j = 0; j < this.pages[i].annotations.length; j++) {
                 annotation = this.pages[i].annotations[j];
                 this.pages[i].annotations[j] = this.create_annotation(annotation.type, annotation);
@@ -4086,8 +4117,14 @@
             currentstampbutton,
             stampfiles,
             picker,
-            filename;
+            filename,
+            htmleditorbutton;
 
+        htmleditorbutton = this.get_dialogue_element(SELECTOR.HTMLEDITORBUTTON);
+        if(htmleditorbutton !== null &&  htmleditorbutton !== 'unknown') {
+            htmleditorbutton.on('click', this.open_htmleditor, this);
+            htmleditorbutton.on('key', this.open_htmleditor, 'down:13', this);
+        }
         searchcommentsbutton = this.get_dialogue_element(SELECTOR.SEARCHCOMMENTSBUTTON);
         searchcommentsbutton.on('click', this.open_search_comments, this);
         searchcommentsbutton.on('key', this.open_search_comments, 'down:13', this);
@@ -4202,7 +4239,7 @@
         currenttoolnode.setAttribute('aria-pressed', 'false');
         this.currentedit.tool = tool;
 
-        if (tool !== "comment" && tool !== "select" && tool !== "drag" && tool !== "stamp") {
+        if (tool !== "htmleditor" && tool !== "comment" && tool !== "select" && tool !== "drag" && tool !== "stamp") {
             this.lastannotationtool = tool;
         }
 
@@ -4217,10 +4254,13 @@
      */
     stringify_current_page: function() {
         var comments = [],
+            htmlcomments = [],
             annotations = [],
             page,
             i = 0;
-
+        for (i = 0; i < this.pages[this.currentpage].htmlcomments.length; i++) {
+            htmlcomments[i] = this.pages[this.currentpage].htmlcomments[i].clean();
+        }
         for (i = 0; i < this.pages[this.currentpage].comments.length; i++) {
             comments[i] = this.pages[this.currentpage].comments[i].clean();
         }
@@ -4228,7 +4268,7 @@
             annotations[i] = this.pages[this.currentpage].annotations[i].clean();
         }
 
-        page = {comments: comments, annotations: annotations};
+        page = {comments: comments, annotations: annotations, htmlcomments: htmlcomments};
 
         return Y.JSON.stringify(page);
     },
@@ -4240,6 +4280,7 @@
      */
     get_current_drawable: function() {
         var comment,
+            htmlcomment,
             annotation,
             drawable = false;
 
@@ -4250,6 +4291,9 @@
         if (this.currentedit.tool === 'comment') {
             comment = new M.assignfeedback_editpdf.comment(this);
             drawable = comment.draw_current_edit(this.currentedit);
+        } else if (this.currentedit.tool === 'htmleditor') {
+                htmlcomment = new M.assignfeedback_editpdf.htmlcomment(this);
+                drawable = htmlcomment.draw_current_edit(this.currentedit);
         } else {
             annotation = this.create_annotation(this.currentedit.tool, {});
             if (annotation) {
@@ -4312,6 +4356,9 @@
         if (this.editingcomment) {
             return;
         }
+        if (this.editinghtmlcomment) {
+            return;
+        }
 
         this.currentedit.starttime = new Date().getTime();
         this.currentedit.start = point;
@@ -4423,17 +4470,32 @@
     edit_end: function() {
         var duration,
             comment,
-            annotation;
+            htmlcomment,
+            annotation,
+            needsaved;
 
         duration = new Date().getTime() - this.currentedit.start;
+        needsaved = false;
 
         if (duration < CLICKTIMEOUT || this.currentedit.start === false) {
             return;
         }
-
-        if (this.currentedit.tool === 'comment') {
+        if (this.currentedit.tool === 'htmleditor') {
+            if (this.currentdrawable) {
+                this.currentdrawable.erase();
+                needsaved = true;
+            }
+            this.currentdrawable = false;
+            htmlcomment = new M.assignfeedback_editpdf.htmlcomment(this);
+            if (htmlcomment.init_from_edit(this.currentedit)) {
+                this.pages[this.currentpage].htmlcomments.push(htmlcomment);
+                this.drawables.push(htmlcomment.draw());
+                needsaved = true;
+            }
+        } else if (this.currentedit.tool === 'comment') {
             if (this.currentdrawable) {
                 this.currentdrawable.erase();
+                needsaved = true;
             }
             this.currentdrawable = false;
             comment = new M.assignfeedback_editpdf.comment(this);
@@ -4441,23 +4503,28 @@
                 this.pages[this.currentpage].comments.push(comment);
                 this.drawables.push(comment.draw(true));
                 this.editingcomment = true;
+                needsaved = true;
             }
         } else {
             annotation = this.create_annotation(this.currentedit.tool, {});
             if (annotation) {
                 if (this.currentdrawable) {
                     this.currentdrawable.erase();
+                    needsaved = true;
                 }
                 this.currentdrawable = false;
                 if (annotation.init_from_edit(this.currentedit)) {
                     this.pages[this.currentpage].annotations.push(annotation);
                     this.drawables.push(annotation.draw());
+                    needsaved = true;
                 }
             }
         }
 
         // Save the changes.
+        if (needsaved) {
         this.save_current_page();
+        }
 
         // Reset the current edit.
         this.currentedit.starttime = 0;
@@ -4514,6 +4581,8 @@
             return new M.assignfeedback_editpdf.annotationhighlight(data);
         } else if (type === "stamp") {
             return new M.assignfeedback_editpdf.annotationstamp(data);
+        } else if (type === "htmleditor") {
+            return new M.assignfeedback_editpdf.htmlcomment(data);
         }
         return false;
     },
@@ -4582,7 +4651,24 @@
         this.searchcommentswindow.show();
         e.preventDefault();
     },
+    /**
+     * Event handler to open the comment search interface.
+     *
+     * @param Event e
+     * @protected
+     * @method open_htmleditor
+     */
+    open_htmleditor: function(e) {
+        if (!this.htmleditorwindow) {
+            this.htmleditorwindow = new M.assignfeedback_editpdf.htmleditor({
+                editor: this
+            });
+        }
 
+        this.htmleditorwindow.show();
+
+        e.preventDefault();
+    },
     /**
      * Toggle function to expand/collapse all comments on page.
      *
@@ -4624,6 +4710,9 @@
         for (i = 0; i < page.comments.length; i++) {
             this.drawables.push(page.comments[i].draw(false));
         }
+        for (i = 0; i < page.htmlcomments.length; i++) {
+            this.drawables.push(page.htmlcomments[i].draw());
+        }
     },
 
     /**
@@ -4854,6 +4943,15 @@
                         for (i = 0; i < oldcomments.length; i++) {
                             oldcomments[i].updatePosition();
                         }
+
+                        /**
+                         * Update Position of htmlcomments with relation to canvas coordinates.
+                         * Without this code, the htmlcomments will stay at their positions in windows/document coordinates.
+                         */
+                        var oldhtmlcomments = page.htmlcomments;
+                        for (i = 0; i < oldhtmlcomments.length; i++) {
+                            oldhtmlcomments[i].updatePosition();
+                        }
                         // Save Annotations.
                         return self.save_current_page();
                     } catch (e) {
@@ -4981,6 +5079,706 @@
     M.assignfeedback_editpdf.instance = new EDITOR(params);
     return M.assignfeedback_editpdf.instance;
 };
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+
+/**
+ * Provides an in browser PDF editor.
+ *
+ * @module moodle-assignfeedback_editpdf-editor
+ */
+
+/**
+ * Class representing a list of reach text.
+ *
+ * @namespace M.assignfeedback_editpdf
+ * @class htmleditor
+ * @constructor
+ * @extends M.core.dialogue
+ */
+var HTMLEDITOR = function(config) {
+    config.draggable = true;
+    config.centered = true;
+    config.width = 'auto';
+    config.visible = false;
+    config.headerContent = M.util.get_string('htmleditor', 'assignfeedback_editpdf');
+    config.footerContent = '';
+    config.closeButton = false;
+    HTMLEDITOR.superclass.constructor.apply(this, [config]);
+};
+
+var HTMLEDITORNAME = "htmleditor";
+
+
+Y.extend(HTMLEDITOR, M.core.dialogue, {
+    /**
+     * Initialise the menu.
+     *
+     * @method initializer
+     * @return void
+     */
+    editor: null,
+    initializer: function(config) {
+        var editorr,
+            container,
+            textarea,
+            bb;
+        this.editor = config.editor || null;
+        bb = this.get('boundingBox');
+        bb.addClass('assignfeedback_editpdf_htmleditor');
+        editorr = this.get('editor');
+        container = Y.Node.create('<div/>');
+        textarea = Y.one('#editorcontainer');
+        textarea.removeClass('hidden');
+        container.append(textarea);
+
+        Y.one('[name="savechanges"]').on('click', this.removeeditor);
+        Y.one('[name="saveandshownext"]').on('click', this.removeeditor);
+        // Set the body content.
+        this.set('bodyContent', container);
+        HTMLEDITOR.superclass.initializer.call(this, config);
+        this.addButton({
+            name: 'confirm',
+            label: M.util.get_string('confirm', 'moodle'),
+            action: function(e) {
+                e.preventDefault();
+                this.hide();
+            },
+            classNames: 'btn btn-primary',
+            section: Y.WidgetStdMod.FOOTER
+        });
+        this.addButton({
+            name: 'cancel',
+            label: M.util.get_string('cancel', 'moodle'),
+            action: function(e) {
+                e.preventDefault();
+                Y.one('#html_editor').set('value', ' ');
+                this.hide();
+            },
+            classNames: 'btn btn-secondary',
+            section: Y.WidgetStdMod.FOOTER
+        });
+
+    },
+    removeeditor: function () {
+        if (Y.one(".assignfeedback_editpdf_htmleditor")) {
+            Y.one(".assignfeedback_editpdf_htmleditor").remove();
+        }
+    }
+},{
+    NAME: HTMLEDITORNAME,
+    ATTRS: {
+        /**
+         * The editor this search window is attached to.
+         *
+         * @attribute editor
+         * @type M.assignfeedback_editpdf.editor
+         * @default null
+         */
+        editor: {
+            value: null
+        }
+
+    }
+});
+Y.Base.modifyAttrs(HTMLEDITOR, {
+    /**
+     * Whether the widget should be modal or not.
+     *
+     * Moodle override: We override this for commentsearch to force it always true.
+     *
+     * @attribute Modal
+     * @type Boolean
+     * @default true
+     */
+    modal: {
+        getter: function() {
+            return true;
+        }
+    }
+});
+M.assignfeedback_editpdf = M.assignfeedback_editpdf || {};
+M.assignfeedback_editpdf.htmleditor = HTMLEDITOR;
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * Provides an in browser PDF editor.
+ *
+ * @module moodle-assignfeedback_editpdf-editor
+ */
+
+/**
+ * Class representing a list of htmlcomments.
+ *
+ * @namespace M.assignfeedback_editpdf
+ * @class htmlcomment
+ * @param M.assignfeedback_editpdf.editor editor
+ * @param Int gradeid
+ * @param Int pageno
+ * @param Int x
+ * @param Int y
+ * @param Int width
+ * @param String colour
+ * @param String rawtext
+ */
+var HTMLCOMMENT = function(editor, gradeid, pageno, x, y, width, colour, rawtext) {
+
+    /**
+     * Reference to M.assignfeedback_editpdf.editor.
+     * @property editor
+     * @type M.assignfeedback_editpdf.editor
+     * @public
+     */
+    this.editor = editor;
+
+    /**
+     * Grade id
+     * @property gradeid
+     * @type Int
+     * @public
+     */
+    this.gradeid = gradeid || 0;
+
+    /**
+     * X position
+     * @property x
+     * @type Int
+     * @public
+     */
+    this.x = parseInt(x, 10) || 0;
+
+    /**
+     * Y position
+     * @property y
+     * @type Int
+     * @public
+     */
+    this.y = parseInt(y, 10) || 0;
+
+    /**
+     * Htmlcomment width
+     * @property width
+     * @type Int
+     * @public
+     */
+    this.width = parseInt(width, 10) || 0;
+
+    /**
+     * Htmlcomment rawtext
+     * @property rawtext
+     * @type String
+     * @public
+     */
+    this.rawtext = rawtext || '';
+
+    /**
+     * Htmlcomment page number
+     * @property pageno
+     * @type Int
+     * @public
+     */
+    this.pageno = pageno || 0;
+
+    /**
+     * Htmlcomment background colour.
+     * @property colour
+     * @type String
+     * @public
+     */
+    this.colour = colour || 'yellow';
+
+    /**
+     * Reference to M.assignfeedback_editpdf.drawable
+     * @property drawable
+     * @type M.assignfeedback_editpdf.drawable
+     * @public
+     */
+    this.drawable = false;
+
+    /**
+     * Boolean used by a timeout to delete empty htmlcomments after a short delay.
+     * @property deleteme
+     * @type Boolean
+     * @public
+     */
+    this.deleteme = false;
+
+    /**
+     * Reference to the link that opens the menu.
+     * @property menulink
+     * @type Y.Node
+     * @public
+     */
+    this.menulink = null;
+
+    /**
+     * Reference to the dialogue that is the context menu.
+     * @property menu
+     * @type M.assignfeedback_editpdf.dropdown
+     * @public
+     */
+    this.menu = null;
+
+    /**
+     * Clean a htmlcomment record, returning an oject with only fields that are valid.
+     * @public
+     * @method clean
+     * @return {}
+     */
+    this.clean = function() {
+        return {
+            gradeid: this.gradeid,
+            x: parseInt(this.x, 10),
+            y: parseInt(this.y, 10),
+            width: parseInt(this.width, 10),
+            rawtext: this.rawtext,
+            pageno: parseInt(this.pageno, 10),
+            colour: this.colour
+        };
+    };
+
+    /**
+     * Draw a htmlcomment.
+     * @public
+     * @method draw
+     * @return M.assignfeedback_editpdf.drawable
+     */
+    this.draw = function(editnode) {
+        var drawable = new M.assignfeedback_editpdf.drawable(this.editor),
+            drawingcanvas = this.editor.get_dialogue_element(SELECTOR.DRAWINGCANVAS),
+            container,
+            node,
+            menu,
+            position,
+            scrollheight,
+            textarea;
+        menu = Y.Node.create('<a href="#"><img src="' + M.util.image_url('t/contextmenu', 'core') + '"/></a>');
+        // // Lets add a contenteditable div.
+        node = editnode || Y.Node.create('<div/>');
+        node.addClass('htmlcomment');
+        container = Y.Node.create('<div class="htmlcommentdrawable"/>');
+        this.menulink = menu;
+        if (this.rawtext.replace(/^\s+|\s+$/g, "") === '') {
+            textarea = Y.one('#html_editor');
+            this.rawtext = textarea.get('value');
+        }
+        menu.setAttribute('tabindex', '0');
+        if (!this.editor.get('readonly')) {
+            container.append(menu);
+        } else {
+            node.setAttribute('readonly', 'readonly');
+        }
+        if (this.width < 200) {
+            this.width = 200;
+        }
+        node.set('innerHTML', this.rawtext);
+        Y.use('mathjax', function() {
+            window.MathJax.Hub.Queue(["Typeset", window.MathJax.Hub, node.getDOMNode()]);
+        });
+        scrollheight = node.get('scrollHeight');
+        node.setStyles({
+            'height': scrollheight + 'px'
+        });
+        position = this.editor.get_window_coordinates(new M.assignfeedback_editpdf.point(this.x, this.y));
+        node.setStyles({
+            width: this.width + 'px'
+        });
+        container.append(node);
+        drawingcanvas.append(container);
+        container.setStyle('position', 'absolute');
+        container.setX(position.x);
+        container.setY(position.y);
+        drawable.store_position(container, position.x, position.y);
+
+        // Bind events only when editing.
+        if (!this.editor.get('readonly')) {
+            // Pass through the event handlers on the div.
+            node.on('gesturemovestart', this.editor.edit_start, null, this.editor);
+            node.on('gesturemove', this.editor.edit_move, null, this.editor);
+            node.on('gesturemoveend', this.editor.edit_end, null, this.editor);
+        }
+        drawable.nodes.push(container);
+
+        this.attach_events(node, menu);
+        this.drawable = drawable;
+
+        node.focus();
+        this.width = parseInt(node.getStyle('width'), 10);
+
+        // Trim.
+        if (this.rawtext.replace(/^\s+|\s+$/g, "") === '') {
+            // Delete empty htmlcomments.
+            this.deleteme = true;
+            Y.later(400, this, this.delete_htmlcomment_later);
+            if (document.getElementsByClassName('dir-rtl').length !== 0) {
+                Y.one('#html_editoreditable').set('innerHTML', '<p dir="rtl" style="text-align: right;"><br></p>');
+            } else {
+                Y.one('#html_editoreditable').set('innerHTML', '<p dir="ltr" style="text-align: left;"><br></p>');
+            }
+            if (!this.editor.htmleditorwindow) {
+                this.editor.htmleditorwindow = new M.assignfeedback_editpdf.htmleditor({
+                    editor: this
+                });
+            }
+        }
+        node.active = false;
+        if (this.rawtext.replace(/^\s+|\s+$/g, "") !== '') {
+            if (editnode) {
+                this.editor.save_current_page();
+            }
+            this.drawable = drawable;
+            if (textarea) {
+                textarea.set('value', ' ');
+                if (document.getElementsByClassName('dir-rtl').length !== 0) {
+                    Y.one('#html_editoreditable').set('innerHTML', '<p dir="rtl" style="text-align: right;"><br></p>');
+                } else {
+                    Y.one('#html_editoreditable').set('innerHTML', '<p dir="ltr" style="text-align: left;"><br></p>');
+                }
+            }
+        }
+        return drawable;
+    };
+
+    /**
+     * Delete an empty htmlcomment if it's menu hasn't been opened in time.
+     * @method delete_htmlcomment_later
+     */
+    this.delete_htmlcomment_later = function() {
+        if (this.deleteme) {
+            this.remove();
+        }
+    };
+
+    /**
+     * Htmlomment nodes have a bunch of event handlers attached to them directly.
+     * This is all done here for neatness.
+     *
+     * @protected
+     * @method attach_htmlcomment_events
+     * @param node - The Y.Node representing the htmlcomment.
+     * @param menu - The Y.Node representing the menu.
+     */
+    this.attach_events = function(node, menu) {
+        var container = node.ancestor('div');
+
+        if (!this.editor.get('readonly')) {
+            // For delegated event handler.
+            menu.setData('htmlcomment', this);
+
+            node.on('gesturemovestart', function(e) {
+                if (editor.currentedit.tool === 'select') {
+                    e.preventDefault();
+                    node.setData('offsetx', e.clientX - container.getX());
+                    node.setData('offsety', e.clientY - container.getY());
+                }
+            });
+            node.on('gesturemove', function(e) {
+                if (editor.currentedit.tool === 'select') {
+                    var x = e.clientX - node.getData('offsetx'),
+                        y = e.clientY - node.getData('offsety'),
+                        newlocation,
+                        windowlocation,
+                        bounds;
+
+                    if (node.getData('clicking') !== true) {
+                        node.setData('clicking', true);
+                    }
+
+                    newlocation = this.editor.get_canvas_coordinates(new M.assignfeedback_editpdf.point(x, y));
+                    bounds = this.editor.get_canvas_bounds(true);
+                    bounds.x = 0;
+                    bounds.y = 0;
+
+                    bounds.width -= 24;
+                    bounds.height -= 24;
+                    // Clip to the window size - the comment icon size.
+                    newlocation.clip(bounds);
+
+                    this.x = newlocation.x;
+                    this.y = newlocation.y;
+
+                    windowlocation = this.editor.get_window_coordinates(newlocation);
+                    container.setX(windowlocation.x);
+                    container.setY(windowlocation.y);
+                    this.drawable.store_position(container, windowlocation.x, windowlocation.y);
+                }
+            }, null, this);
+            this.menu = new M.assignfeedback_editpdf.htmlcommentmenu({
+                buttonNode: this.menulink,
+                htmlcomment: this
+            });
+        }
+    };
+
+    /**
+     * Delete a htmlcomment.
+     * @method remove
+     */
+    this.remove = function() {
+        var i = 0;
+        var htmlcomments;
+
+        htmlcomments = this.editor.pages[this.editor.currentpage].htmlcomments;
+        for (i = 0; i < htmlcomments.length; i++) {
+            if (htmlcomments[i] === this) {
+                htmlcomments.splice(i, 1);
+                this.drawable.erase();
+                this.editor.save_current_page();
+                return;
+            }
+        }
+    };
+
+    /**
+     * Draw the in progress edit.
+     *
+     * @public
+     * @method draw_current_edit
+     * @param M.assignfeedback_editpdf.edit edit
+     */
+    this.draw_current_edit = function(edit) {
+        var bounds = new M.assignfeedback_editpdf.rect(),
+            drawable = new M.assignfeedback_editpdf.drawable(this.editor),
+            drawingregion = this.editor.get_dialogue_element(SELECTOR.DRAWINGREGION),
+            node,
+            position;
+
+        bounds.bound([edit.start, edit.end]);
+        position = this.editor.get_window_coordinates(new M.assignfeedback_editpdf.point(bounds.x, bounds.y));
+
+        node = Y.Node.create('<div/>');
+        node.setStyles({
+            'position': 'absolute',
+            'display': 'inline-block',
+            'width': bounds.width,
+            'height': bounds.height,
+            'backgroundSize': '100% 100%'
+        });
+
+        drawingregion.append(node);
+        node.setX(position.x);
+        node.setY(position.y);
+        drawable.store_position(node, position.x, position.y);
+
+        drawable.nodes.push(node);
+
+        return drawable;
+    };
+
+    /**
+     * Promote the current edit to a real htmlcomment.
+     *
+     * @public
+     * @method init_from_edit
+     * @param M.assignfeedback_editpdf.edit edit
+     * @return bool true if htmlcomment bound is more than min width/height, else false.
+     */
+    this.init_from_edit = function(edit) {
+        var bounds = new M.assignfeedback_editpdf.rect();
+        bounds.bound([edit.start, edit.end]);
+
+        if (bounds.width < 40) {
+            bounds.width = 40;
+        }
+        if (bounds.height < 40) {
+            bounds.height = 40;
+        }
+        this.gradeid = this.editor.get('gradeid');
+        this.pageno = this.editor.currentpage;
+        this.x = bounds.x;
+        this.y = bounds.y;
+        this.endx = bounds.x + bounds.width;
+        this.endy = bounds.y + bounds.height;
+        this.rawtext = '';
+
+        // Min width and height is always more than 40px.
+        return true;
+    };
+
+    /**
+     * Update htmlcomment position when rotating page.
+     * @public
+     * @method updatePosition
+     */
+    this.updatePosition = function() {
+        var node = this.drawable.nodes[0].one('div');
+        var container = node.ancestor('div');
+
+        var newlocation = new M.assignfeedback_editpdf.point(this.x, this.y);
+        var windowlocation = this.editor.get_window_coordinates(newlocation);
+
+        container.setX(windowlocation.x);
+        container.setY(windowlocation.y);
+        this.drawable.store_position(container, windowlocation.x, windowlocation.y);
+    };
+
+    /**
+     * Edit exist html comment
+     * @public
+     * @method edit_htmlcomment
+     * @param e
+     */
+    this.edit_htmlcomment = function(e) {
+        var htmleditor,
+            origtext,
+            node;
+        e.preventDefault();
+        this.menu.hide();
+        node = this.drawable.nodes[0].one('div');
+        htmleditor = Y.one('#html_editoreditable');
+        origtext = this.rawtext;
+        htmleditor.set('innerHTML', this.rawtext);
+        if (!this.editor.htmleditorwindow) {
+            this.editor.htmleditorwindow = new M.assignfeedback_editpdf.htmleditor({
+                editor: this
+            });
+        }
+        var htmleditorwindow = this.editor.htmleditorwindow;
+        var cancelbuton = htmleditorwindow.getButton('cancel', Y.WidgetStdMod.FOOTER);
+        cancelbuton.on('click', function (e) {
+            e.preventDefault();
+            this.rawtext = origtext;
+            htmleditorwindow.hide();
+        }, this);
+        var confirmbutton = htmleditorwindow.getButton('confirm', Y.WidgetStdMod.FOOTER);
+        confirmbutton.on('click', function (){
+            // Save the changes back to the comment.
+            var textarea = Y.one('#html_editor');
+            this.rawtext = textarea.get('value');
+            this.draw(node);
+            htmleditorwindow.hide();
+        }, this);
+        htmleditorwindow.show();
+    };
+
+};
+
+M.assignfeedback_editpdf = M.assignfeedback_editpdf || {};
+M.assignfeedback_editpdf.htmlcomment = HTMLCOMMENT;
+var HTMLCOMMENTMENUNAME = "Htmlcommentmenu",
+    HTMLCOMMENTMENU;
+
+/**
+ * Provides an in browser PDF editor.
+ *
+ * @module moodle-assignfeedback_editpdf-editor
+ */
+
+/**
+ * HTMLCOMMENTMENU
+ * This is a drop down list of comment context functions.
+ *
+ * @namespace M.assignfeedback_editpdf
+ * @class commentmenu
+ * @constructor
+ * @param {Object} config
+ * @extends M.assignfeedback_editpdf.dropdown
+ */
+HTMLCOMMENTMENU = function(config) {
+    HTMLCOMMENTMENU.superclass.constructor.apply(this, [config]);
+};
+
+Y.extend(HTMLCOMMENTMENU, M.assignfeedback_editpdf.dropdown, {
+
+    /**
+     * Initialise the menu.
+     *
+     * @method initializer
+     * @param {Object} config
+     */
+    initializer: function(config) {
+        var htmlcommentlinks,
+            link,
+            body,
+            htmlcomment;
+
+        htmlcomment = this.get('htmlcomment');
+        // Build the list of menu items.
+        htmlcommentlinks = Y.Node.create('<ul role="menu" class="assignfeedback_editpdf_menu"/>');
+
+        link = Y.Node.create('<li><a tabindex="-1" href="#">' +
+               M.util.get_string('edithtml', 'assignfeedback_editpdf') +
+               '</a></li>');
+        link.on('click', htmlcomment.edit_htmlcomment, htmlcomment);
+        link.on('key', htmlcomment.edit_htmlcomment, 'enter,space', htmlcomment);
+
+        htmlcommentlinks.append(link);
+
+        link = Y.Node.create('<li><a tabindex="-1" href="#">' +
+               M.util.get_string('deletecomment', 'assignfeedback_editpdf') +
+               '</a></li>');
+        link.on('click', function(e) {
+            e.preventDefault();
+            this.menu.hide();
+            this.remove();
+        }, htmlcomment);
+
+        link.on('key', function() {
+            htmlcomment.menu.hide();
+            htmlcomment.remove();
+        }, 'enter,space', htmlcomment);
+
+        htmlcommentlinks.append(link);
+
+        link = Y.Node.create('<li><hr/></li>');
+        htmlcommentlinks.append(link);
+
+        // Set the accessible header text.
+        this.set('headerText', M.util.get_string('commentcontextmenu', 'assignfeedback_editpdf'));
+
+        body = Y.Node.create('<div/>');
+
+        // Set the body content.
+        body.append(htmlcommentlinks);
+        this.set('bodyContent', body);
+
+        HTMLCOMMENTMENU.superclass.initializer.call(this, config);
+    }
+}, {
+    NAME: HTMLCOMMENTMENUNAME,
+    ATTRS: {
+        /**
+         * The comment this menu is attached to.
+         *
+         * @attribute comment
+         * @type M.assignfeedback_editpdf.comment
+         * @default null
+         */
+        htmlcomment: {
+            value: null
+        }
+
+    }
+});
+
+M.assignfeedback_editpdf = M.assignfeedback_editpdf || {};
+M.assignfeedback_editpdf.htmlcommentmenu = HTMLCOMMENTMENU;
 
 
 }, '@VERSION@', {
Index: mod/assign/feedback/editpdf/yui/build/moodle-assignfeedback_editpdf-editor/moodle-assignfeedback_editpdf-editor-min.js
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/mod/assign/feedback/editpdf/yui/build/moodle-assignfeedback_editpdf-editor/moodle-assignfeedback_editpdf-editor-min.js b/mod/assign/feedback/editpdf/yui/build/moodle-assignfeedback_editpdf-editor/moodle-assignfeedback_editpdf-editor-min.js
--- a/mod/assign/feedback/editpdf/yui/build/moodle-assignfeedback_editpdf-editor/moodle-assignfeedback_editpdf-editor-min.js	(revision 2729694d4d56ca2c88bb180aee3f254f8be906cf)
+++ b/mod/assign/feedback/editpdf/yui/build/moodle-assignfeedback_editpdf-editor/moodle-assignfeedback_editpdf-editor-min.js	(revision 0b9764ed79311babea3acc01b01be2b999f9ec4f)
@@ -1,9 +1,11 @@
-YUI.add("moodle-assignfeedback_editpdf-editor",function(u,t){var e,i,s,n,a,o,r,d,c,h,l,g,p,f,_,m,b,w,k,y,v,x,S,A,N=M.cfg.wwwroot+"/mod/assign/feedback/editpdf/ajax.php",D=M.cfg.wwwroot+"/mod/assign/feedback/editpdf/ajax_progress.php",T="assignfeedback_editpdf_widget",I=".navigate-previous-button",C=" .navigate-next-button",q=".searchcommentsbutton",z=".expcolcommentsbutton",E=".assignfeedback_editpdf_commentsearch input",Y=".assignfeedback_editpdf_commentsearch ul",R=".navigate-page-select",X=".loading",L=".progress-info.progress-striped",P=".drawingregion",j=".drawingcanvas",O=".commentcolourbutton",B=".annotationcolourbutton",H=".warningmessages",J=".infoicon",F='input[name="assignfeedback_editpdf_haschanges"]',V=".currentstampbutton",G='[data-region="user-info"]',K=".rotateleftbutton",W=".rotaterightbutton",U="rgba(200, 200, 255, 0.9)",$="rgba(200, 200, 255, 0.5)",Q="rgb(51, 51, 51)",Z={white:"rgb(255,255,255)",yellow:"rgb(255,236,174)",red:"rgb(249,181,179)",green:"rgb(214,234,178)",blue:"rgb(203,217,237)",clear:"rgba(255,255,255, 0)"},tt={white:"rgb(255,255,255)",yellow:"rgb(255,207,53)",red:"rgb(239,69,64)",green:"rgb(152,202,62)",blue:"rgb(125,159,211)",black:"rgb(51,51,51)"},et=300,it={comment:".commentbutton",pen:".penbutton",line:".linebutton",rectangle:".rectanglebutton",oval:".ovalbutton",stamp:".stampbutton",select:".selectbutton",drag:".dragbutton",highlight:".highlightbutton"},st=4,nt=function(t,e){this.x=parseInt(t,10),this.y=parseInt(e,10),this.clip=function(t){return this.x<t.x&&(this.x=t.x),this.x>t.x+t.width&&(this.x=t.x+t.width),this.y<t.y&&(this.y=t.y),this.y>t.y+t.height&&(this.y=t.y+t.height),this}};M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.point=nt,e=function(t,e,i,s){this.x=t,this.y=e,this.width=i,this.height=s,this.bound=function(t){var e,i=0,s=0,n=0,a=0,o=0;for(o=0;o<t.length;o++)((e=t[o]).x<i||0===o)&&(i=e.x),(e.x>s||0===o)&&(s=e.x),(e.y<n||0===o)&&(n=e.y),(e.y>a||0===o)&&(a=e.y);return this.x=i,this.y=n,this.width=s-i,this.height=a-n,this},this.has_min_width=function(){return 5<=this.width},this.has_min_height=function(){return 5<=this.height},this.set_min_width=function(){this.width=5},this.set_min_height=function(){this.height=5}},M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.rect=e,i=function(){this.start=!1,this.end=!1,this.starttime=0,this.annotationstart=!1,this.tool="drag",this.commentcolour="yellow",this.annotationcolour="red",this.stamp="",this.path=[]},M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.edit=i,s=function(t){this.editor=t,this.shapes=[],this.nodes=[],this.erase=function(){if(this.shapes)for(;0<this.shapes.length;)this.editor.graphic.removeShape(this.shapes.pop());if(this.nodes)for(;0<this.nodes.length;)this.nodes.pop().remove()},this.scroll_update=function(t,e){var i,s,n;for(i=0;i<this.nodes.length;i++)s=this.nodes[i].getData("x"),n=this.nodes[i].getData("y"),s!==undefined&&n!==undefined&&(this.nodes[i].setX(parseInt(s,10)-t),this.nodes[i].setY(parseInt(n,10)-e))},this.store_position=function(t,e,i){var s,n,a;s=this.editor.get_dialogue_element(P),n=parseInt(s.get("scrollLeft"),10),a=parseInt(s.get("scrollTop"),10),t.setData("x",e+n),t.setData("y",i+a)}},M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.drawable=s,(n=function(t){n.superclass.constructor.apply(this,[t])}).NAME="annotation",n.ATTRS={},u.extend(n,u.Base,{editor:null,gradeid:0,pageno:0,x:0,y:0,endx:0,endy:0,path:"",type:"rect",colour:"red",drawable:!1,initializer:function(t){this.editor=t.editor||null,this.gradeid=parseInt(t.gradeid,10)||0,this.pageno=parseInt(t.pageno,10)||0,this.x=parseInt(t.x,10)||0,this.y=parseInt(t.y,10)||0,this.endx=parseInt(t.endx,10)||0,this.endy=parseInt(t.endy,10)||0,this.path=t.path||"",this.type=t.type||"rect",this.colour=t.colour||"red",this.drawable=!1},clean:function(){return{gradeid:this.gradeid,x:parseInt(this.x,10),y:parseInt(this.y,10),endx:parseInt(this.endx,10),endy:parseInt(this.endy,10),type:this.type,path:this.path,pageno:this.pageno,colour:this.colour}},draw_highlight:function(){var t,e,i,s,n=this.editor.get_dialogue_element(P),a=this.editor.get_dialogue_element(j).getXY();return this.editor.currentannotation===this&&((t=new M.assignfeedback_editpdf.rect).bound([new M.assignfeedback_editpdf.point(this.x,this.y),new M.assignfeedback_editpdf.point(this.endx,this.endy)]),e=this.editor.graphic.addShape({type:u.Rect,width:t.width,height:t.height,stroke:{weight:st,color:U},fill:{color:$},x:t.x,y:t.y}),this.drawable.shapes.push(e),i=u.Node.create('<img src="'+M.util.image_url("trash","assignfeedback_editpdf")+'"/>'),s=u.Node.create('<a href="#" role="button"></a>'),i.setAttrs({alt:M.util.get_string("deleteannotation","assignfeedback_editpdf")}),i.setStyles({backgroundColor:"white"}),s.addClass("deleteannotationbutton"),s.append(i),n.append(s),s.setData("annotation",this),s.on("click",this.remove,this),s.on("key",this.remove,"space,enter",this),s.setX(a[0]+t.x+t.width-18),s.setY(a[1]+t.y+6),this.drawable.nodes.push(s)),this.drawable},draw:function(){return this.draw_highlight(),this.drawable},remove:function(t){var e,i;for(t.preventDefault(),e=this.editor.pages[this.editor.currentpage].annotations,i=0;i<e.length;i++)if(e[i]===this)return e.splice(i,1),this.drawable&&this.drawable.erase(),this.editor.currentannotation=!1,void this.editor.save_current_page()},move:function(t,e){var i,s,n,a,o,r=t-this.x,d=e-this.y;this.x+=r,this.y+=d,this.endx+=r,this.endy+=d,this.path&&(i=[],s=this.path.split(":"),u.each(s,function(t){n=t.split(","),a=parseInt(n[0],10),o=parseInt(n[1],10),i.push(a+r+","+(o+d))}),this.path=i.join(":")),this.drawable&&this.drawable.erase(),this.editor.drawables.push(this.draw())},draw_current_edit:function(t){return t&&!1},init_from_edit:function(t){var e=new M.assignfeedback_editpdf.rect;return e.bound([t.start,t.end]),this.gradeid=this.editor.get("gradeid"),this.pageno=this.editor.currentpage,
-this.x=e.x,this.y=e.y,this.endx=e.x+e.width,this.endy=e.y+e.height,this.colour=t.annotationcolour,this.path="",e.has_min_width()&&e.has_min_height()}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.annotation=n,(a=function(t){a.superclass.constructor.apply(this,[t])}).NAME="annotationline",a.ATTRS={},u.extend(a,M.assignfeedback_editpdf.annotation,{draw:function(){var t,e;return t=new M.assignfeedback_editpdf.drawable(this.editor),(e=this.editor.graphic.addShape({type:u.Path,fill:!1,stroke:{weight:st,color:tt[this.colour]}})).moveTo(this.x,this.y),e.lineTo(this.endx,this.endy),e.end(),t.shapes.push(e),this.drawable=t,a.superclass.draw.apply(this)},draw_current_edit:function(t){var e,i=new M.assignfeedback_editpdf.drawable(this.editor);return(e=this.editor.graphic.addShape({type:u.Path,fill:!1,stroke:{weight:st,color:tt[t.annotationcolour]}})).moveTo(t.start.x,t.start.y),e.lineTo(t.end.x,t.end.y),e.end(),i.shapes.push(e),i},init_from_edit:function(t){return this.gradeid=this.editor.get("gradeid"),this.pageno=this.editor.currentpage,this.x=t.start.x,this.y=t.start.y,this.endx=t.end.x,this.endy=t.end.y,this.colour=t.annotationcolour,this.path="",!(this.endx-this.x==0&&this.endy-this.y==0)}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.annotationline=a,(o=function(t){o.superclass.constructor.apply(this,[t])}).NAME="annotationrectangle",o.ATTRS={},u.extend(o,M.assignfeedback_editpdf.annotation,{draw:function(){var t,e,i;return t=new M.assignfeedback_editpdf.drawable(this.editor),(e=new M.assignfeedback_editpdf.rect).bound([new M.assignfeedback_editpdf.point(this.x,this.y),new M.assignfeedback_editpdf.point(this.endx,this.endy)]),i=this.editor.graphic.addShape({type:u.Rect,width:e.width,height:e.height,stroke:{weight:st,color:tt[this.colour]},x:e.x,y:e.y}),t.shapes.push(i),this.drawable=t,o.superclass.draw.apply(this)},draw_current_edit:function(t){var e,i,s=new M.assignfeedback_editpdf.drawable(this.editor);return(i=new M.assignfeedback_editpdf.rect).bound([new M.assignfeedback_editpdf.point(t.start.x,t.start.y),new M.assignfeedback_editpdf.point(t.end.x,t.end.y)]),i.has_min_width()||i.set_min_width(),i.has_min_height()||i.set_min_height(),e=this.editor.graphic.addShape({type:u.Rect,width:i.width,height:i.height,stroke:{weight:st,color:tt[t.annotationcolour]},x:i.x,y:i.y}),s.shapes.push(e),s}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.annotationrectangle=o,(r=function(t){r.superclass.constructor.apply(this,[t])}).NAME="annotationoval",r.ATTRS={},u.extend(r,M.assignfeedback_editpdf.annotation,{draw:function(){var t,e,i;return t=new M.assignfeedback_editpdf.drawable(this.editor),(e=new M.assignfeedback_editpdf.rect).bound([new M.assignfeedback_editpdf.point(this.x,this.y),new M.assignfeedback_editpdf.point(this.endx,this.endy)]),i=this.editor.graphic.addShape({type:u.Ellipse,width:e.width,height:e.height,stroke:{weight:st,color:tt[this.colour]},x:e.x,y:e.y}),t.shapes.push(i),this.drawable=t,r.superclass.draw.apply(this)},draw_current_edit:function(t){var e,i,s=new M.assignfeedback_editpdf.drawable(this.editor);return(i=new M.assignfeedback_editpdf.rect).bound([new M.assignfeedback_editpdf.point(t.start.x,t.start.y),new M.assignfeedback_editpdf.point(t.end.x,t.end.y)]),i.has_min_width()||i.set_min_width(),i.has_min_height()||i.set_min_height(),e=this.editor.graphic.addShape({type:u.Ellipse,width:i.width,height:i.height,stroke:{weight:st,color:tt[t.annotationcolour]},x:i.x,y:i.y}),s.shapes.push(e),s}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.annotationoval=r,(d=function(t){d.superclass.constructor.apply(this,[t])}).NAME="annotationpen",d.ATTRS={},u.extend(d,M.assignfeedback_editpdf.annotation,{draw:function(){var t,e,i,s,n;return t=new M.assignfeedback_editpdf.drawable(this.editor),e=this.editor.graphic.addShape({type:u.Path,fill:!1,stroke:{weight:st,color:tt[this.colour]}}),i=!0,s=this.path.split(":"),u.each(s,function(t){n=t.split(","),i?(e.moveTo(n[0],n[1]),i=!1):e.lineTo(n[0],n[1])},this),e.end(),t.shapes.push(e),this.drawable=t,d.superclass.draw.apply(this)},draw_current_edit:function(t){var e,i,s=new M.assignfeedback_editpdf.drawable(this.editor);return e=this.editor.graphic.addShape({type:u.Path,fill:!1,stroke:{weight:st,color:tt[t.annotationcolour]}}),i=!0,u.each(t.path,function(t){i?(e.moveTo(t.x,t.y),i=!1):e.lineTo(t.x,t.y)},this),e.end(),s.shapes.push(e),s},init_from_edit:function(t){var e=new M.assignfeedback_editpdf.rect,i=[],s=0;for(e.bound(t.path),s=0;s<t.path.length;s++)i.push(parseInt(t.path[s].x,10)+","+parseInt(t.path[s].y,10));return this.gradeid=this.editor.get("gradeid"),this.pageno=this.editor.currentpage,this.x=e.x,this.y=e.y,this.endx=e.x+e.width,this.endy=e.y+e.height,this.colour=t.annotationcolour,this.path=i.join(":"),e.has_min_width()||e.has_min_height()}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.annotationpen=d,(c=function(t){c.superclass.constructor.apply(this,[t])}).NAME="annotationhighlight",c.ATTRS={},u.extend(c,M.assignfeedback_editpdf.annotation,{draw:function(){var t,e,i,s;return t=new M.assignfeedback_editpdf.drawable(this.editor),(i=new M.assignfeedback_editpdf.rect).bound([new M.assignfeedback_editpdf.point(this.x,this.y),new M.assignfeedback_editpdf.point(this.endx,this.endy)]),s=(s=(s=tt[this.colour]).replace("rgb","rgba")).replace(")",",0.5)"),e=this.editor.graphic.addShape({type:u.Rect,width:i.width,height:i.height,stroke:!1,fill:{color:s},x:i.x,y:i.y}),t.shapes.push(e),this.drawable=t,c.superclass.draw.apply(this)},draw_current_edit:function(t){var e,i,s,n=new M.assignfeedback_editpdf.drawable(this.editor);return(i=new M.assignfeedback_editpdf.rect).bound([new M.assignfeedback_editpdf.point(t.start.x,t.start.y),new M.assignfeedback_editpdf.point(t.end.x,t.end.y)]),i.has_min_width()||i.set_min_width(),s=(s=(s=tt[t.annotationcolour]).replace("rgb","rgba")).replace(")",
-",0.5)"),e=this.editor.graphic.addShape({type:u.Rect,width:i.width,height:20,stroke:!1,fill:{color:s},x:i.x,y:t.start.y-10}),n.shapes.push(e),n},init_from_edit:function(t){var e=new M.assignfeedback_editpdf.rect;return e.bound([t.start,t.end]),this.gradeid=this.editor.get("gradeid"),this.pageno=this.editor.currentpage,this.x=e.x,this.y=t.start.y-10,this.endx=e.x+e.width,this.endy=t.start.y+10,this.colour=t.annotationcolour,this.page="",e.has_min_width()}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.annotationhighlight=c,(h=function(t){h.superclass.constructor.apply(this,[t])}).NAME="annotationstamp",h.ATTRS={},u.extend(h,M.assignfeedback_editpdf.annotation,{draw:function(){var t,e,i=new M.assignfeedback_editpdf.drawable(this.editor),s=this.editor.get_dialogue_element(j);return e=this.editor.get_window_coordinates(new M.assignfeedback_editpdf.point(this.x,this.y)),(t=u.Node.create("<div/>")).addClass("annotation"),t.addClass("stamp"),t.setStyles({position:"absolute",display:"inline-block",backgroundImage:"url("+this.editor.get_stamp_image_url(this.path)+")",width:this.endx-this.x,height:this.endy-this.y,backgroundSize:"100% 100%"}),s.append(t),t.setX(e.x),t.setY(e.y),i.store_position(t,e.x,e.y),this.editor.get("readonly")||(t.on("gesturemovestart",this.editor.edit_start,null,this.editor),t.on("gesturemove",this.editor.edit_move,null,this.editor),t.on("gesturemoveend",this.editor.edit_end,null,this.editor)),i.nodes.push(t),this.drawable=i,h.superclass.draw.apply(this)},draw_current_edit:function(t){var e,i,s=new M.assignfeedback_editpdf.rect,n=new M.assignfeedback_editpdf.drawable(this.editor),a=this.editor.get_dialogue_element(P);return s.bound([t.start,t.end]),i=this.editor.get_window_coordinates(new M.assignfeedback_editpdf.point(s.x,s.y)),(e=u.Node.create("<div/>")).addClass("annotation"),e.addClass("stamp"),e.setStyles({position:"absolute",display:"inline-block",backgroundImage:"url("+this.editor.get_stamp_image_url(t.stamp)+")",width:s.width,height:s.height,backgroundSize:"100% 100%"}),a.append(e),e.setX(i.x),e.setY(i.y),n.store_position(e,i.x,i.y),n.nodes.push(e),n},init_from_edit:function(t){var e=new M.assignfeedback_editpdf.rect;return e.bound([t.start,t.end]),e.width<40&&(e.width=40),e.height<40&&(e.height=40),this.gradeid=this.editor.get("gradeid"),this.pageno=this.editor.currentpage,this.x=e.x,this.y=e.y,this.endx=e.x+e.width,this.endy=e.y+e.height,this.colour=t.annotationcolour,this.path=t.stamp,!0},move:function(t,e){var i=t-this.x,s=e-this.y;this.x+=i,this.y+=s,this.endx+=i,this.endy+=s,this.drawable&&this.drawable.erase(),this.editor.drawables.push(this.draw())}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.annotationstamp=h,l="Dropdown menu",g=function(t){t.draggable=!1,t.centered=!1,t.width="auto",t.visible=!1,t.footerContent="",g.superclass.constructor.apply(this,[t])},u.extend(g,M.core.dialogue,{initializer:function(t){var e,i,s;g.superclass.initializer.call(this,t),this.get("boundingBox").addClass("assignfeedback_editpdf_dropdown"),e=this.get("buttonNode"),i=this.bodyNode,(s=u.Node.create("<h3/>")).addClass("accesshide"),s.setHTML(this.get("headerText")),i.prepend(s),i.on("clickoutside",function(t){this.get("visible")&&t.target.get("id")!==e.get("id")&&t.target.ancestor().get("id")!==e.get("id")&&(t.preventDefault(),this.hide())},this),e.on("click",function(t){t.preventDefault(),this.show()},this),e.on("key",this.show,"enter,space",this)},show:function(){var t=this.get("buttonNode"),e=g.superclass.show.call(this);return this.align(t,[u.WidgetPositionAlign.TL,u.WidgetPositionAlign.BL]),e}},{NAME:l,ATTRS:{headerText:{value:""},buttonNode:{value:null}}}),u.Base.modifyAttrs(g,{modal:{getter:function(){return!1}}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.dropdown=g,p="Colourpicker",f=function(t){f.superclass.constructor.apply(this,[t])},u.extend(f,M.assignfeedback_editpdf.dropdown,{initializer:function(t){var e,r=u.Node.create('<ul role="menu" class="assignfeedback_editpdf_menu"/>');u.each(this.get("colours"),function(t,e){var i,s,n,a,o;n=M.util.get_string(e,"assignfeedback_editpdf"),o=this.get("iconprefix")+e,a=M.util.image_url(o,"assignfeedback_editpdf"),(i=u.Node.create('<button><img alt="'+n+'" src="'+a+'"/></button>')).setAttribute("data-colour",e),i.setAttribute("data-rgb",t),i.setStyle("backgroundImage","none"),(s=u.Node.create("<li/>")).append(i),r.append(s)},this),e=u.Node.create("<div/>"),r.delegate("click",this.callback_handler,"button",this),r.delegate("key",this.callback_handler,"down:13","button",this),this.set("headerText",M.util.get_string("colourpicker","assignfeedback_editpdf")),e.append(r),this.set("bodyContent",e),f.superclass.initializer.call(this,t)},callback_handler:function(t){t.preventDefault();var e=this.get("callback"),i=this.get("context");this.hide(),u.bind(e,i,t)()}},{NAME:p,ATTRS:{colours:{value:{}},callback:{value:null},context:{value:null},iconprefix:{value:"colour_"}}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.colourpicker=f,_="Colourpicker",m=function(t){m.superclass.constructor.apply(this,[t])},u.extend(m,M.assignfeedback_editpdf.dropdown,{initializer:function(t){var n=u.Node.create('<ul role="menu" class="assignfeedback_editpdf_menu"/>');u.each(this.get("stamps"),function(t){var e,i,s;s=M.util.get_string("stamp","assignfeedback_editpdf"),(e=u.Node.create('<button><img height="16" width="16" alt="'+s+'" src="'+t+'"/></button>')).setAttribute("data-stamp",t),e.setStyle("backgroundImage","none"),(i=u.Node.create("<li/>")).append(e),n.append(i)},this),n.delegate("click",this.callback_handler,"button",this),n.delegate("key",this.callback_handler,"down:13","button",this),this.set("headerText",M.util.get_string("stamppicker","assignfeedback_editpdf")),this.set("bodyContent",n),m.superclass.initializer.call(this,t)},callback_handler:function(t){t.preventDefault();var e=this.get("callback"),
-i=this.get("context");this.hide(),u.bind(e,i,t)()}},{NAME:_,ATTRS:{stamps:{value:[]},callback:{value:null},context:{value:null}}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.stamppicker=m,b="Commentmenu",w=function(t){w.superclass.constructor.apply(this,[t])},u.extend(w,M.assignfeedback_editpdf.dropdown,{initializer:function(t){var e,i,s,n;n=this.get("comment"),e=u.Node.create('<ul role="menu" class="assignfeedback_editpdf_menu"/>'),(i=u.Node.create('<li><a tabindex="-1" href="#">'+M.util.get_string("addtoquicklist","assignfeedback_editpdf")+"</a></li>")).on("click",n.add_to_quicklist,n),i.on("key",n.add_to_quicklist,"enter,space",n),e.append(i),(i=u.Node.create('<li><a tabindex="-1" href="#">'+M.util.get_string("deletecomment","assignfeedback_editpdf")+"</a></li>")).on("click",function(t){t.preventDefault(),this.menu.hide(),this.remove()},n),i.on("key",function(){n.menu.hide(),n.remove()},"enter,space",n),e.append(i),i=u.Node.create("<li><hr/></li>"),e.append(i),this.set("headerText",M.util.get_string("commentcontextmenu","assignfeedback_editpdf")),(s=u.Node.create("<div/>")).append(e),this.set("bodyContent",s),w.superclass.initializer.call(this,t)},show:function(){var n,a=this.get("boundingBox").one("ul");a.all(".quicklist_comment").remove(!0),(n=this.get("comment")).deleteme=!1,u.each(n.editor.quicklist.comments,function(t){var e=u.Node.create('<li class="quicklist_comment"></li>'),i=u.Node.create('<a href="#" tabindex="-1">'+t.rawtext+"</a>"),s=u.Node.create('<a href="#" tabindex="-1" class="delete_quicklist_comment"><img src="'+M.util.image_url("t/delete","core")+'" alt="'+M.util.get_string("deletecomment","assignfeedback_editpdf")+'"/></a>');i.setAttribute("title",t.rawtext),e.append(i),e.append(s),a.append(e),e.on("click",n.set_from_quick_comment,n,t),e.on("key",n.set_from_quick_comment,"space,enter",n,t),s.on("click",n.remove_from_quicklist,n,t),s.on("key",n.remove_from_quicklist,"space,enter",n,t)},this),w.superclass.show.call(this)}},{NAME:b,ATTRS:{comment:{value:null}}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.commentmenu=w,k="commentsearch",y=function(t){t.draggable=!1,t.centered=!0,t.width="400px",t.visible=!1,t.headerContent=M.util.get_string("searchcomments","assignfeedback_editpdf"),t.footerContent="",y.superclass.constructor.apply(this,[t])},u.extend(y,M.core.dialogue,{initializer:function(t){var e,i,s,n;this.get("boundingBox").addClass("assignfeedback_editpdf_commentsearch"),this.get("editor"),e=u.Node.create("<div/>"),i=M.util.get_string("filter","assignfeedback_editpdf"),s=u.Node.create('<input type="text" size="20" placeholder="'+i+'"/>'),e.append(s),n=u.Node.create('<ul role="menu" class="assignfeedback_editpdf_search"/>'),e.append(n),s.on("keyup",this.filter_search_comments,this),n.delegate("click",this.focus_on_comment,"a",this),n.delegate("key",this.focus_on_comment,"enter,space","a",this),this.set("bodyContent",e),y.superclass.initializer.call(this,t)},filter_search_comments:function(){var t,e,i,s;s=this.get("id"),t=u.one("#"+s+E),e=u.one("#"+s+Y),i=t.get("value"),e.all("li").each(function(t){-1!==t.get("text").indexOf(i)?t.show():t.hide()})},focus_on_comment:function(t){t.preventDefault();var e=t.target.ancestor("li").getData("comment"),i=this.get("editor");this.hide(),e.pageno=e.clean().pageno,e.pageno!==i.currentpage&&(i.currentpage=e.pageno,i.change_page()),e.node=e.drawable.nodes[0].one("textarea"),e.node.ancestor("div").removeClass("commentcollapsed"),e.node.focus()},show:function(){var i=this.get("boundingBox").one("ul"),t=this.get("editor");i.all("li").remove(!0),u.each(t.pages,function(t){u.each(t.comments,function(t){var e=u.Node.create('<li><a href="#" tabindex="-1"><pre>'+t.rawtext+"</pre></a></li>");i.append(e),e.setData("comment",t)},this)},this),this.centerDialogue(),y.superclass.show.call(this)}},{NAME:k,ATTRS:{editor:{value:null}}}),u.Base.modifyAttrs(y,{modal:{getter:function(){return!0}}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.commentsearch=y,v=function(h,t,e,i,s,n,a,o){this.editor=h,this.gradeid=t||0,this.x=parseInt(i,10)||0,this.y=parseInt(s,10)||0,this.width=parseInt(n,10)||0,this.rawtext=o||"",this.pageno=e||0,this.colour=a||"yellow",this.drawable=!1,this.deleteme=!1,this.menulink=null,this.menu=null,this.clean=function(){return{gradeid:this.gradeid,x:parseInt(this.x,10),y:parseInt(this.y,10),width:parseInt(this.width,10),rawtext:this.rawtext,pageno:parseInt(this.pageno,10),colour:this.colour}},this.draw=function(t){var e,i,s,n,a,o,r,d=new M.assignfeedback_editpdf.drawable(this.editor),c=this.editor.get_dialogue_element(j);return e=u.Node.create("<textarea/>"),i=u.Node.create('<div class="commentdrawable"/>'),s=u.Node.create("<label/>"),n=u.Node.create('<svg xmlns="http://www.w3.org/2000/svg" viewBox="-0.5 -0.5 13 13" preserveAspectRatio="xMinYMin meet"><path d="M11 0H1C.4 0 0 .4 0 1v6c0 .6.4 1 1 1h1v4l4-4h5c.6 0 1-.4 1-1V1c0-.6-.4-1-1-1z" fill="currentColor" opacity="0.9" stroke="rgb(153, 153, 153)" stroke-width="0.5"/></svg>'),a=u.Node.create('<a href="#"><img src="'+M.util.image_url("t/contextmenu","core")+'"/></a>'),this.menulink=a,i.append(s),s.append(e),i.append(n),i.setAttribute("tabindex","-1"),s.setAttribute("tabindex","0"),e.setAttribute("tabindex","-1"),a.setAttribute("tabindex","0"),this.editor.get("readonly")?e.setAttribute("readonly","readonly"):i.append(a),this.width<100&&(this.width=100),o=this.editor.get_window_coordinates(new M.assignfeedback_editpdf.point(this.x,this.y)),e.setStyles({width:this.width+"px",backgroundColor:Z[this.colour],color:Q}),c.append(i),i.setStyle("position","absolute"),i.setX(o.x),i.setY(o.y),d.store_position(i,o.x,o.y),d.nodes.push(i),e.set("value",this.rawtext),r=e.get("scrollHeight"),e.setStyles({height:r+"px",overflow:"hidden"}),n.setStyle("color",Z[this.colour]),this.attach_events(e,a),t?e.focus():h.collapsecomments&&i.addClass("commentcollapsed"),this.drawable=d},
-this.delete_comment_later=function(){this.deleteme&&this.remove()},this.attach_events=function(o,e){var r=o.ancestor("div"),t=o.ancestor("label"),i=t.next("svg");o.collapse=function(t){o.collapse.delay=u.later(t,o,function(){h.collapsecomments&&r.addClass("commentcollapsed")})},o.expand=function(){!0!==o.getData("dragging")&&(o.collapse.delay&&o.collapse.delay.cancel(),r.removeClass("commentcollapsed"))},r.on("mouseenter",function(){"comment"!==h.currentedit.tool&&"select"!==h.currentedit.tool&&!this.editor.get("readonly")||o.expand()},this),r.on("click|tap",function(){o.expand(),o.focus()},this),o.on("keyup",function(t){9===t.keyCode&&t.shiftKey&&"0"===e.getAttribute("tabindex")&&e.focus(),e.setAttribute("tabindex","0")},this),e.on("keydown",function(t){9===t.keyCode&&t.shiftKey&&e.setAttribute("tabindex","-1")},this),t.on("focus",function(){o.active=!0,o.collapse.delay&&o.collapse.delay.cancel(),o.setAttribute("tabindex","0"),o.expand(),o.focus(),t.setAttribute("tabindex","-1")},this),e.on("focus",function(){o.active=!0,o.collapse.delay&&o.collapse.delay.cancel(),this.deleteme=!1,t.setAttribute("tabindex","0")},this),o.on("blur",function(){o.setAttribute("tabindex","-1")},this),t.on("blur",function(){t.setAttribute("tabindex","0")},this),r.on("mouseleave",function(){h.collapsecomments&&!0!==o.active&&o.collapse(400)},this),r.on("blur",function(){o.active=!1,o.collapse(800)},this),this.editor.get("readonly")||(o.on("blur",function(){this.rawtext=o.get("value"),this.width=parseInt(o.getStyle("width"),10),""===this.rawtext.replace(/^\s+|\s+$/g,"")&&(this.deleteme=!0,u.later(400,this,this.delete_comment_later)),this.editor.save_current_page(),this.editor.editingcomment=!1},this),e.setData("comment",this),o.on("keyup",function(){o.setStyle("height","auto");var t=o.get("scrollHeight");t===parseInt(o.getStyle("height"),10)+8&&(t-=8),o.setStyle("height",t+"px")}),o.on("gesturemovestart",function(t){"select"===h.currentedit.tool&&(t.preventDefault(),h.collapsecomments?(o.setData("offsetx",8),o.setData("offsety",8)):(o.setData("offsetx",t.clientX-r.getX()),o.setData("offsety",t.clientY-r.getY())))}),o.on("gesturemove",function(t){if("select"===h.currentedit.tool){var e,i,s,n=t.clientX-o.getData("offsetx"),a=t.clientY-o.getData("offsety");!0!==o.getData("dragging")&&(o.collapse(0),o.setData("dragging",!0)),e=this.editor.get_canvas_coordinates(new M.assignfeedback_editpdf.point(n,a)),(s=this.editor.get_canvas_bounds(!0)).x=0,s.y=0,s.width-=24,s.height-=24,e.clip(s),this.x=e.x,this.y=e.y,i=this.editor.get_window_coordinates(e),r.setX(i.x),r.setY(i.y),this.drawable.store_position(r,i.x,i.y)}},null,this),o.on("gesturemoveend",function(){"select"===h.currentedit.tool&&(!0===o.getData("dragging")&&o.setData("dragging",!1),this.editor.save_current_page())},null,this),i.on("gesturemovestart",function(t){"select"===h.currentedit.tool&&(t.preventDefault(),o.setData("offsetx",t.clientX-r.getX()),o.setData("offsety",t.clientY-r.getY()),o.expand())}),i.on("gesturemove",function(t){if("select"===h.currentedit.tool){var e,i,s,n=t.clientX-o.getData("offsetx"),a=t.clientY-o.getData("offsety");!0!==o.getData("dragging")&&(o.collapse(100),o.setData("dragging",!0)),e=this.editor.get_canvas_coordinates(new M.assignfeedback_editpdf.point(n,a)),(s=this.editor.get_canvas_bounds(!0)).x=0,s.y=0,s.width-=24,s.height-=24,e.clip(s),this.x=e.x,this.y=e.y,i=this.editor.get_window_coordinates(e),r.setX(i.x),r.setY(i.y),this.drawable.store_position(r,i.x,i.y)}},null,this),i.on("gesturemoveend",function(){"select"===h.currentedit.tool&&(!0===o.getData("dragging")&&o.setData("dragging",!1),this.editor.save_current_page())},null,this),this.menu=new M.assignfeedback_editpdf.commentmenu({buttonNode:this.menulink,comment:this}))},this.remove=function(){var t=0,e=this.editor.pages[this.editor.currentpage].comments;for(t=0;t<e.length;t++)if(e[t]===this)return e.splice(t,1),this.drawable.erase(),void this.editor.save_current_page()},this.remove_from_quicklist=function(t,e){t.preventDefault(),t.stopPropagation(),this.menu.hide(),this.editor.quicklist.remove(e)},this.set_from_quick_comment=function(t,e){t.preventDefault(),this.menu.hide(),this.deleteme=!1,this.rawtext=e.rawtext,this.width=e.width,this.colour=e.colour,this.editor.save_current_page(),this.editor.redraw(),this.node=this.drawable.nodes[0].one("textarea"),this.node.ancestor("div").removeClass("commentcollapsed"),this.node.focus()},this.add_to_quicklist=function(t){t.preventDefault(),this.menu.hide(),this.editor.quicklist.add(this)},this.draw_current_edit=function(t){var e,i,s=new M.assignfeedback_editpdf.drawable(this.editor);return(i=new M.assignfeedback_editpdf.rect).bound([t.start,t.end]),e=this.editor.graphic.addShape({type:u.Rect,width:i.width,height:i.height,fill:{color:Z[t.commentcolour]},x:i.x,y:i.y}),s.shapes.push(e),s},this.init_from_edit=function(t){var e=new M.assignfeedback_editpdf.rect;return e.bound([t.start,t.end]),e.width<100&&(e.width=100),this.gradeid=this.editor.get("gradeid"),this.pageno=this.editor.currentpage,this.x=e.x,this.y=e.y,this.width=e.width,this.colour=t.commentcolour,this.rawtext="",e.has_min_width()&&e.has_min_height()},this.updatePosition=function(){var t=this.drawable.nodes[0].one("textarea"),e=t.ancestor("div"),i=new M.assignfeedback_editpdf.point(this.x,this.y),s=this.editor.get_window_coordinates(i);e.setX(s.x),e.setY(s.y),this.drawable.store_position(e,s.x,s.y)}},M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.comment=v,x=function(t,e,i,s){this.rawtext=e||"",this.id=t||0,this.width=i||100,this.colour=s||"yellow"},M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.quickcomment=x,S=function(t){this.editor=t,this.comments=[],this.add=function(t){var e,i=N;""!==t.rawtext&&(e={method:"post",context:this,sync:!1,data:{sesskey:M.cfg.sesskey,action:"addtoquicklist",userid:this.editor.get("userid"),commenttext:t.rawtext,width:t.width,colour:t.colour,attemptnumber:this.editor.get(
-"attemptnumber"),assignmentid:this.editor.get("assignmentid")},on:{success:function(t,e){var i,s;try{if((i=u.JSON.parse(e.responseText)).error)return new M.core.ajaxException(i);s=new M.assignfeedback_editpdf.quickcomment(i.id,i.rawtext,i.width,i.colour),this.comments.push(s),this.comments.sort(function(t,e){return t.rawtext.localeCompare(e.rawtext)})}catch(n){return new M.core.exception(n)}},failure:function(t,e){return M.core.exception(e.responseText)}}},u.io(i,e))},this.remove=function(e){var t,i=N;e&&(t={method:"post",context:this,sync:!1,data:{sesskey:M.cfg.sesskey,action:"removefromquicklist",userid:this.editor.get("userid"),commentid:e.id,attemptnumber:this.editor.get("attemptnumber"),assignmentid:this.editor.get("assignmentid")},on:{success:function(){var t;0<=(t=this.comments.indexOf(e))&&this.comments.splice(t,1)},failure:function(t,e){return M.core.exception(e.responseText)}}},u.io(i,t))},this.load=function(){var t,e=N;t={method:"get",context:this,sync:!1,data:{sesskey:M.cfg.sesskey,action:"loadquicklist",userid:this.editor.get("userid"),attemptnumber:this.editor.get("attemptnumber"),assignmentid:this.editor.get("assignmentid")},on:{success:function(t,e){var i;try{if((i=u.JSON.parse(e.responseText)).error)return new M.core.ajaxException(i);u.each(i,function(t){var e=new M.assignfeedback_editpdf.quickcomment(t.id,t.rawtext,t.width,t.colour);this.comments.push(e)},this),this.comments.sort(function(t,e){return t.rawtext.localeCompare(e.rawtext)})}catch(s){return new M.core.exception(s)}},failure:function(t,e){return M.core.exception(e.responseText)}}},u.io(e,t)}},M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.quickcommentlist=S,(A=function(){A.superclass.constructor.apply(this,arguments)}).prototype={oldannotationcoordinates:null,dialogue:null,panel:null,pagecount:0,currentpage:0,pages:[],documentstatus:0,loadingicon:null,pageimage:null,graphic:null,currentedit:new M.assignfeedback_editpdf.edit,currentdrawable:!1,drawables:[],currentcomment:null,currentannotation:null,lastannotation:null,lastannotationtool:"pen",quicklist:null,searchcommentswindow:null,currentstamp:null,stamps:[],editingcomment:!1,collapsecomments:!0,initializer:function(){var s;(s=u.one("#"+this.get("linkid")))&&(s.on("click",this.link_handler,this),s.on("key",this.link_handler,"down:13",this),require(["mod_assign/grading_review_panel"],function(t){var e=new t,i=e.getReviewPanel("assignfeedback_editpdf");i&&((i=u.one(i)).empty(),s.ancestor(".fitem").hide(),this.open_in_panel(i)),this.currentedit.start=!1,this.currentedit.end=!1,this.get("readonly")||(this.quicklist=new M.assignfeedback_editpdf.quickcommentlist(this))}.bind(this)))},refresh_button_state:function(){var t,e,i,s,n;switch(t=this.get_dialogue_element(O),i=M.util.image_url("background_colour_"+this.currentedit.commentcolour,"assignfeedback_editpdf"),t.one("img").setAttribute("src",i),"clear"===this.currentedit.commentcolour?t.one("img").setStyle("borderStyle","dashed"):t.one("img").setStyle("borderStyle","solid"),t=this.get_dialogue_element(B),i=M.util.image_url("colour_"+this.currentedit.annotationcolour,"assignfeedback_editpdf"),t.one("img").setAttribute("src",i),(e=this.get_dialogue_element(it[this.currentedit.tool])).addClass("assignfeedback_editpdf_selectedbutton"),e.setAttribute("aria-pressed","true"),this.get_dialogue_element(P).setAttribute("data-currenttool",this.currentedit.tool),t=this.get_dialogue_element(V),s=this.get_stamp_image_url(this.currentedit.stamp),t.one("img").setAttrs({src:s,height:"16",width:"16"}),n=this.get_dialogue_element(j),this.currentedit.tool){case"drag":n.setStyle("cursor","move");break;case"highlight":n.setStyle("cursor","text");break;case"select":n.setStyle("cursor","default");break;case"stamp":n.setStyle("cursor","url("+s+"), crosshair");break;default:n.setStyle("cursor","crosshair")}},get_canvas_bounds:function(){var t=this.get_dialogue_element(j),e=t.getXY(),i=e[0],s=e[1],n=parseInt(t.getStyle("width"),10),a=parseInt(t.getStyle("height"),10);return new M.assignfeedback_editpdf.rect(i,s,n,a)},get_canvas_coordinates:function(t){var e=this.get_canvas_bounds(),i=new M.assignfeedback_editpdf.point(t.x-e.x,t.y-e.y);return e.x=e.y=0,i.clip(e),i},get_window_coordinates:function(t){var e=this.get_canvas_bounds();return new M.assignfeedback_editpdf.point(t.x+e.x,t.y+e.y)},open_in_panel:function(t){var e;(this.panel=t).append(this.get("body")),t.addClass(T),this.loadingicon=this.get_dialogue_element(X),e=this.get_dialogue_element(j),this.graphic=new u.Graphic({render:e}),this.get("readonly")||(e.on("gesturemovestart",this.edit_start,null,this),e.on("gesturemove",this.edit_move,null,this),e.on("gesturemoveend",this.edit_end,null,this),this.refresh_button_state()),this.start_generation()},link_handler:function(t){var e,i=!0;t.preventDefault(),this.dialogue||(this.dialogue=new M.core.dialogue({headerContent:this.get("header"),bodyContent:this.get("body"),footerContent:this.get("footer"),modal:!0,width:"840px",visible:!1,draggable:!0}),this.dialogue.get("boundingBox").addClass(T),this.loadingicon=this.get_dialogue_element(X),e=this.get_dialogue_element(j),this.graphic=new u.Graphic({render:e}),this.get("readonly")||(e.on("gesturemovestart",this.edit_start,null,this),e.on("gesturemove",this.edit_move,null,this),e.on("gesturemoveend",this.edit_end,null,this),this.refresh_button_state()),this.start_generation(),e.on("windowresize",this.resize,this),i=!1),this.dialogue.centerDialogue(),this.dialogue.show(),this.dialogue.dd.on("drag:end",this.redraw,this),i&&this.resize()},start_generation:function(){this.poll_document_conversion_status()},poll_document_conversion_status:function(){var o=this.get("userid");u.io(N,{method:"get",context:this,sync:!1,data:{sesskey:M.cfg.sesskey,action:"pollconversions",userid:this.get("userid"),attemptnumber:this.get("attemptnumber"),assignmentid:this.get("assignmentid"),readonly:this.get("readonly")?1:0},on:{success:function(t,e){var i,s,n,a=u.one(G);a&&(
-i=a.getAttribute("data-userid"))&&i!=o||(n=!1,(s=this.handle_response_data(e))&&(this.documentstatus=s.status,0===s.status||1===s.status||3===s.status?n=!0:2!==s.status&&-1!==s.status||(this.pagecount=s.pagecount,s.pageready==s.pagecount?this.prepare_pages_for_display(s):(this.update_page_load_progress(),this.start_document_to_image_conversion())),n&&u.later(1e3,this,this.poll_document_conversion_status)))},failure:function(t,e){return new M.core.exception(e.responseText)}}})},start_document_to_image_conversion:function(){u.io(N,{method:"get",context:this,sync:!1,data:{sesskey:M.cfg.sesskey,action:"pollconversions",userid:this.get("userid"),attemptnumber:this.get("attemptnumber"),assignmentid:this.get("assignmentid"),readonly:this.get("readonly")?1:0},on:{success:function(t,e){var i=this.handle_response_data(e);i&&(this.documentstatus=i.status,2===i.status&&this.prepare_pages_for_display(i))},failure:function(t,e){return new M.core.exception(e.responseText)}}})},warning:function(t,e){var i,s=this.get_dialogue_element(J),n=this.get_dialogue_element(H),a=15,o=1,r="assignfeedback_editpdf_warningmessages alert alert-warning";e&&(a=4,r="assignfeedback_editpdf_warningmessages alert alert-info"),(i=u.Node.create('<div class="'+r+'" role="alert"></div>')).append(s.one("*").cloneNode()),i.append(t),n.prepend(i),i.transition({duration:o,delay:a,opacity:0},function(){i.remove()})},prepare_pages_for_display:function(t){var e,i,s,n;if(!t.pagecount)return this.dialogue&&this.dialogue.hide(),void new M.core.alert({message:M.util.get_string("cannotopenpdf","assignfeedback_editpdf")}).show();for(this.pages=t.pages,e=0;e<this.pages.length;e++){for(i=0;i<this.pages[e].comments.length;i++)s=this.pages[e].comments[i],this.pages[e].comments[i]=new M.assignfeedback_editpdf.comment(this,s.gradeid,s.pageno,s.x,s.y,s.width,s.colour,s.rawtext);for(i=0;i<this.pages[e].annotations.length;i++)n=this.pages[e].annotations[i],this.pages[e].annotations[i]=this.create_annotation(n.type,n)}!this.get("readonly")&&t.partial&&this.warning(M.util.get_string("partialwarning","assignfeedback_editpdf"),!1),this.quicklist&&this.quicklist.load(),this.setup_navigation(),this.setup_toolbar(),this.change_page()},update_page_load_progress:function(){var n,a=0;this.get_dialogue_element(L+" .bar")&&(n={method:"get",context:this,sync:!1,data:{sesskey:M.cfg.sesskey,action:"conversionstatus",userid:this.get("userid"),attemptnumber:this.get("attemptnumber"),assignmentid:this.get("assignmentid")},on:{success:function(t,e){var i,s;i=a=0,(s=this.get_dialogue_element(L+" .bar"))&&(i=e.response/this.pagecount*100,s.setStyle("width",i+"%"),s.ancestor(L).setAttribute("aria-valuenow",i),i<100&&(M.util.js_pending("checkconversionstatus"),u.later(1e3,this,function(){M.util.js_complete("checkconversionstatus"),u.io(D,n)})))},failure:function(t,e){return a+=1,0===this.pagecount&&a<5&&(M.util.js_pending("checkconversionstatus"),u.later(1e3,this,function(){M.util.js_complete("checkconversionstatus"),u.io(D,n)})),new M.core.exception(e.responseText)}}},M.util.js_pending("checkconversionstatus"),u.later(1e3,this,function(){a=0,M.util.js_complete("checkconversionstatus"),u.io(D,n)}))},handle_response_data:function(t){var e;try{if(!(e=u.JSON.parse(t.responseText)).error)return e;this.dialogue&&this.dialogue.hide(),new M.core.alert({message:M.util.get_string("cannotopenpdf","assignfeedback_editpdf"),visible:!0})}catch(i){this.dialogue&&this.dialogue.hide(),new M.core.alert({title:M.util.get_string("cannotopenpdf","assignfeedback_editpdf"),visible:!0})}},get_stamp_image_url:function(e){var t=this.get("stampfiles"),i="";return u.Array.each(t,function(t){0<t.indexOf(e)&&(i=t)},this),i},setup_toolbar:function(){var i,t,e,s,n,a,o,r,d,c;(s=this.get_dialogue_element(q)).on("click",this.open_search_comments,this),s.on("key",this.open_search_comments,"down:13",this),(n=this.get_dialogue_element(z)).on("click",this.expandCollapseComments,this),n.on("key",this.expandCollapseComments,"down:13",this),this.get("readonly")||((a=this.get_dialogue_element(K)).on("click",this.rotatePDF,this,!0),a.on("key",this.rotatePDF,"down:13",this,!0),(o=this.get_dialogue_element(W)).on("click",this.rotatePDF,this,!1),o.on("key",this.rotatePDF,"down:13",this,!1),this.disable_touch_scroll(),u.each(it,function(t,e){(i=this.get_dialogue_element(t)).on("click",this.handle_tool_button,this,e),i.on("key",this.handle_tool_button,"down:13",this,e),i.setAttribute("aria-pressed","false")},this),t=this.get_dialogue_element(O),new M.assignfeedback_editpdf.colourpicker({buttonNode:t,colours:Z,iconprefix:"background_colour_",callback:function(t){var e=t.target.getAttribute("data-colour");e=e||t.target.ancestor().getAttribute("data-colour"),this.currentedit.commentcolour=e,this.handle_tool_button(t,"comment")},context:this}),e=this.get_dialogue_element(B),new M.assignfeedback_editpdf.colourpicker({buttonNode:e,iconprefix:"colour_",colours:tt,callback:function(t){var e=t.target.getAttribute("data-colour");e=e||t.target.ancestor().getAttribute("data-colour"),this.currentedit.annotationcolour=e,this.lastannotationtool?this.handle_tool_button(t,this.lastannotationtool):this.handle_tool_button(t,"pen")},context:this}),(d=this.get("stampfiles")).length<=0?this.get_dialogue_element(it.stamp).ancestor().hide():(c=d[0].substr(d[0].lastIndexOf("/")+1),this.currentedit.stamp=c,r=this.get_dialogue_element(V),new M.assignfeedback_editpdf.stamppicker({buttonNode:r,stamps:d,callback:function(t){var e,i=t.target.getAttribute("data-stamp");e=(i=i||t.target.ancestor().getAttribute("data-stamp")).substr(i.lastIndexOf("/")),this.currentedit.stamp=e,this.handle_tool_button(t,"stamp")},context:this}),this.refresh_button_state()))},handle_tool_button:function(t,e){var i;t.preventDefault(),(i=this.get_dialogue_element(it[this.currentedit.tool])).removeClass("assignfeedback_editpdf_selectedbutton"),i.setAttribute("aria-pressed","false"),"comment"!==(this.currentedit.tool=e)&&"select"!==e&&"drag"!==e&&"stamp"!==e&&(
-this.lastannotationtool=e),this.refresh_button_state()},stringify_current_page:function(){var t,e=[],i=[],s=0;for(s=0;s<this.pages[this.currentpage].comments.length;s++)e[s]=this.pages[this.currentpage].comments[s].clean();for(s=0;s<this.pages[this.currentpage].annotations.length;s++)i[s]=this.pages[this.currentpage].annotations[s].clean();return t={comments:e,annotations:i},u.JSON.stringify(t)},get_current_drawable:function(){var t,e=!1;return!(!this.currentedit.start||!this.currentedit.end)&&("comment"===this.currentedit.tool?e=new M.assignfeedback_editpdf.comment(this).draw_current_edit(this.currentedit):(t=this.create_annotation(this.currentedit.tool,{}))&&(e=t.draw_current_edit(this.currentedit)),e)},get_dialogue_element:function(t){return this.panel?this.panel.one(t):this.dialogue.get("boundingBox").one(t)},redraw_current_edit:function(){this.currentdrawable&&this.currentdrawable.erase(),this.currentdrawable=this.get_current_drawable()},edit_start:function(t){var e,i,s,n=this.get_dialogue_element(j),a=n.getXY(),o=n.get("docScrollY"),r=n.get("docScrollX"),d={x:t.clientX-a[0]+r,y:t.clientY-a[1]+o},c=!1;3!==t.button&&(this.currentedit.starttime||this.editingcomment||(this.currentedit.starttime=(new Date).getTime(),this.currentedit.start=d,this.currentedit.end={x:d.x,y:d.y},"select"===this.currentedit.tool&&(e=this.currentedit.end.x,i=this.currentedit.end.y,s=this.pages[this.currentpage].annotations,u.each(s,function(t){(e-t.x)*(e-t.endx)<=0&&(i-t.y)*(i-t.endy)<=0&&(c=t)}),c?(this.lastannotation=this.currentannotation,this.currentannotation=c,this.lastannotation&&this.lastannotation!==c&&this.lastannotation.drawable&&(this.lastannotation.drawable.erase(),this.drawables.push(this.lastannotation.draw())),this.currentannotation.drawable&&this.currentannotation.drawable.erase(),this.drawables.push(this.currentannotation.draw())):(this.lastannotation=this.currentannotation,this.currentannotation=null,this.lastannotation&&this.lastannotation.drawable&&(this.lastannotation.drawable.erase(),this.drawables.push(this.lastannotation.draw())))),this.currentannotation&&(this.currentedit.annotationstart={x:this.currentannotation.x,y:this.currentannotation.y})))},edit_move:function(t){var e,i,s=this.get_canvas_bounds(),n=this.get_dialogue_element(j),a=this.get_dialogue_element(P),o=new M.assignfeedback_editpdf.point(t.clientX+n.get("docScrollX"),t.clientY+n.get("docScrollY")),r=this.get_canvas_coordinates(o);"textarea"!==document.activeElement.type&&(t.preventDefault(),r.x<0||r.x>s.width||r.y<0||r.y>s.height||("pen"===this.currentedit.tool&&this.currentedit.path.push(r),"select"===this.currentedit.tool?this.currentannotation&&this.currentedit&&this.currentannotation.move(this.currentedit.annotationstart.x+r.x-this.currentedit.start.x,this.currentedit.annotationstart.y+r.y-this.currentedit.start.y):"drag"===this.currentedit.tool?(e=r.x-this.currentedit.start.x,i=r.y-this.currentedit.start.y,a.getDOMNode().scrollLeft-=e,a.getDOMNode().scrollTop-=i):this.currentedit.start&&(this.currentedit.end=r,this.redraw_current_edit())))},edit_end:function(){var t,e;(new Date).getTime()-this.currentedit.start<et||!1===this.currentedit.start||("comment"===this.currentedit.tool?(this.currentdrawable&&this.currentdrawable.erase(),this.currentdrawable=!1,(t=new M.assignfeedback_editpdf.comment(this)).init_from_edit(this.currentedit)&&(this.pages[this.currentpage].comments.push(t),this.drawables.push(t.draw(!0)),this.editingcomment=!0)):(e=this.create_annotation(this.currentedit.tool,{}))&&(this.currentdrawable&&this.currentdrawable.erase(),this.currentdrawable=!1,e.init_from_edit(this.currentedit)&&(this.pages[this.currentpage].annotations.push(e),this.drawables.push(e.draw()))),this.save_current_page(),this.currentedit.starttime=0,this.currentedit.start=!1,this.currentedit.end=!1,this.currentedit.path=[])},resize:function(){var t,e;if(this.dialogue){if(!this.dialogue.get("visible"))return;this.dialogue.centerDialogue()}return(e=u.one("body").get("winHeight")-120)<100&&(e=100),t=this.get_dialogue_element(P),this.dialogue&&t.setStyle("maxHeight",e+"px"),this.redraw(),!0},create_annotation:function(t,e){return e.type=t,e.editor=this,"line"===t?new M.assignfeedback_editpdf.annotationline(e):"rectangle"===t?new M.assignfeedback_editpdf.annotationrectangle(e):"oval"===t?new M.assignfeedback_editpdf.annotationoval(e):"pen"===t?new M.assignfeedback_editpdf.annotationpen(e):"highlight"===t?new M.assignfeedback_editpdf.annotationhighlight(e):"stamp"===t&&new M.assignfeedback_editpdf.annotationstamp(e)},save_current_page:function(){this.clear_warnings(!1);var t,e=N;t={method:"post",context:this,sync:!1,data:{sesskey:M.cfg.sesskey,action:"savepage",index:this.currentpage,userid:this.get("userid"),attemptnumber:this.get("attemptnumber"),assignmentid:this.get("assignmentid"),page:this.stringify_current_page()},on:{success:function(t,e){var i;try{if((i=u.JSON.parse(e.responseText)).error)return new M.core.ajaxException(i);u.one(F).set("value","true"),this.warning(M.util.get_string("draftchangessaved","assignfeedback_editpdf"),!0)}catch(s){return new M.core.exception(s)}},failure:function(t,e){return new M.core.exception(e.responseText)}}},u.io(e,t)},open_search_comments:function(t){this.searchcommentswindow||(this.searchcommentswindow=new M.assignfeedback_editpdf.commentsearch({editor:this})),this.searchcommentswindow.show(),t.preventDefault()},expandCollapseComments:function(){var t=u.all(".commentdrawable");this.collapsecomments?(this.collapsecomments=!1,t.removeClass("commentcollapsed")):(this.collapsecomments=!0,t.addClass("commentcollapsed"))},redraw:function(){var t,e;if((e=this.pages[this.currentpage])!==undefined){for(;0<this.drawables.length;)this.drawables.pop().erase();for(t=0;t<e.annotations.length;t++)this.drawables.push(e.annotations[t].draw());for(t=0;t<e.comments.length;t++)this.drawables.push(e.comments[t].draw(!1))}},clear_warnings:function(t){var e=this.get_dialogue_element(H);t?e.empty():e.all(".alert-info"
-).remove(!0)},change_page:function(){var t,e,i,s=this.get_dialogue_element(j);e=this.get_dialogue_element(I),i=this.get_dialogue_element(C),0<this.currentpage?e.removeAttribute("disabled"):e.setAttribute("disabled","true"),this.currentpage<this.pagecount-1?i.removeAttribute("disabled"):i.setAttribute("disabled","true"),t=this.pages[this.currentpage],this.loadingicon&&this.loadingicon.hide(),s.setStyle("backgroundImage",'url("'+t.url+'")'),s.setStyle("width",t.width+"px"),s.setStyle("height",t.height+"px"),s.scrollIntoView(),this.get_dialogue_element(R).set("selectedIndex",this.currentpage),this.resize()},setup_navigation:function(){var t,e,i,s,n,a=this.get_dialogue_element(R),o=a.all("option");if(o.size()<=1)for(t=0;t<this.pages.length;t++)(i=u.Node.create("<option/>")).setAttribute("value",t),e={page:t+1,total:this.pages.length},i.setHTML(M.util.get_string("pagexofy","assignfeedback_editpdf",e)),a.append(i);a.removeAttribute("disabled"),a.on("change",function(){this.currentpage=a.get("value"),this.clear_warnings(!1),this.change_page()},this),s=this.get_dialogue_element(I),n=this.get_dialogue_element(C),s.on("click",this.previous_page,this),s.on("key",this.previous_page,"down:13",this),n.on("click",this.next_page,this),n.on("key",this.next_page,"down:13",this)},previous_page:function(t){t.preventDefault(),this.currentpage--,this.currentpage<0&&(this.currentpage=0),this.clear_warnings(!1),this.change_page()},next_page:function(t){t.preventDefault(),this.currentpage++,this.currentpage>=this.pages.length&&(this.currentpage=this.pages.length-1),this.clear_warnings(!1),this.change_page()},move_canvas:function(){var t,e,i,s;for(t=this.get_dialogue_element(P),e=parseInt(t.get("scrollLeft"),10),i=parseInt(t.get("scrollTop"),10),s=0;s<this.drawables.length;s++)this.drawables[s].scroll_update(e,i)},rotatePDF:function(h,t){var l,e,i,s,n,a;if(h.preventDefault(),!this.get("destroyed")){for((l=this).oldannotationcoordinates=[],i=this.pages[this.currentpage].annotations,e=0;e<i.length;e++)s=i[e],this.oldannotationcoordinates.push([s.x,s.y]);n=N,a={method:"post",context:this,sync:!1,data:{sesskey:M.cfg.sesskey,action:"rotatepage",index:this.currentpage,userid:this.get("userid"),attemptnumber:this.get("attemptnumber"),assignmentid:this.get("assignmentid"),rotateleft:t},on:{success:function(t,e){var i,s,n,a,o,r,d,c;try{for(i=u.JSON.parse(e.responseText),(s=l.pages[l.currentpage]).url=i.page.url,s.width=i.page.width,s.height=i.page.height,l.loadingicon.hide(),(n=l.get_dialogue_element(j)).setStyle("backgroundImage",'url("'+s.url+'")'),n.setStyle("width",s.width+"px"),n.setStyle("height",s.height+"px"),o=s.annotations,a=0;a<o.length;a++)l.oldannotationcoordinates&&l.oldannotationcoordinates[a]&&(r=l.oldannotationcoordinates[a][0],d=l.oldannotationcoordinates[a][1],o[a].move(r,d));for(c=s.comments,a=0;a<c.length;a++)c[a].updatePosition();return l.save_current_page()}catch(h){return new M.core.exception(h)}},failure:function(t,e){return new M.core.exception(e.responseText)}}},u.io(n,a)}},event_listener_options_supported:function(){var t,e=!1,i="testpassiveeventoptions";try{t=Object.defineProperty({},"passive",{get:function(){e=!0}}),document.addEventListener(i,t,t),document.removeEventListener(i,t,t)}catch(s){e=!1}return e},disable_touch_scroll:function(){this.event_listener_options_supported()&&document.addEventListener("touchmove",this.stop_touch_scroll.bind(this),{passive:!1})},stop_touch_scroll:function(t){this.get_dialogue_element(P).contains(t.target)&&(t.stopPropagation(),t.preventDefault())}},u.extend(A,u.Base,A.prototype,{NAME:"moodle-assignfeedback_editpdf-editor",ATTRS:{userid:{validator:u.Lang.isInteger,value:0},assignmentid:{validator:u.Lang.isInteger,value:0},attemptnumber:{validator:u.Lang.isInteger,value:0},header:{validator:u.Lang.isString,value:""},body:{validator:u.Lang.isString,value:""},footer:{validator:u.Lang.isString,value:""},linkid:{validator:u.Lang.isString,value:""},deletelinkid:{validator:u.Lang.isString,value:""},readonly:{validator:u.Lang.isBoolean,value:!0},stampfiles:{validator:u.Lang.isArray,value:""}}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.editor=M.assignfeedback_editpdf.editor||{},M.assignfeedback_editpdf.editor.init=M.assignfeedback_editpdf.editor.init||function(t){return M.assignfeedback_editpdf.instance=new A(t),M.assignfeedback_editpdf.instance}},"@VERSION@",{requires:["base","event","node","io","graphics","json","event-move","event-resize","transition","querystring-stringify-simple","moodle-core-notification-dialog","moodle-core-notification-alert","moodle-core-notification-warning","moodle-core-notification-exception","moodle-core-notification-ajaxexception"]});
\ No newline at end of file
+YUI.add("moodle-assignfeedback_editpdf-editor",function(g,t){var e,i,n,s,a,o,r,d,h,c,l,u,p,f,_,m,b,w,y,k,v,x,S,N,A,T,D,I,C,q=M.cfg.wwwroot+"/mod/assign/feedback/editpdf/ajax.php",E=M.cfg.wwwroot+"/mod/assign/feedback/editpdf/ajax_progress.php",Y="assignfeedback_editpdf_widget",z=".navigate-previous-button",R=" .navigate-next-button",X=".searchcommentsbutton",L=".expcolcommentsbutton",O=".assignfeedback_editpdf_commentsearch input",B=".assignfeedback_editpdf_commentsearch ul",P=".navigate-page-select",j=".loading",H=".progress-info.progress-striped",F=".drawingregion",J=".drawingcanvas",W=".commentcolourbutton",$=".annotationcolourbutton",V=".warningmessages",G=".infoicon",K='input[name="assignfeedback_editpdf_haschanges"]',Q=".currentstampbutton",U='[data-region="user-info"]',Z=".rotateleftbutton",tt=".rotaterightbutton",et=".htmleditorbutton",it="rgba(200, 200, 255, 0.9)",nt="rgba(200, 200, 255, 0.5)",st="rgb(51, 51, 51)",at={white:"rgb(255,255,255)",yellow:"rgb(255,236,174)",red:"rgb(249,181,179)",green:"rgb(214,234,178)",blue:"rgb(203,217,237)",clear:"rgba(255,255,255, 0)"},ot={white:"rgb(255,255,255)",yellow:"rgb(255,207,53)",red:"rgb(239,69,64)",green:"rgb(152,202,62)",blue:"rgb(125,159,211)",black:"rgb(51,51,51)"},rt=300,dt={comment:".commentbutton",pen:".penbutton",line:".linebutton",rectangle:".rectanglebutton",oval:".ovalbutton",stamp:".stampbutton",select:".selectbutton",drag:".dragbutton",highlight:".highlightbutton",htmleditor:".htmleditorbutton"},ht=4,ct=function(t,e){this.x=parseInt(t,10),this.y=parseInt(e,10),this.clip=function(t){return this.x<t.x&&(this.x=t.x),this.x>t.x+t.width&&(this.x=t.x+t.width),this.y<t.y&&(this.y=t.y),this.y>t.y+t.height&&(this.y=t.y+t.height),this}};M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.point=ct,e=function(t,e,i,n){this.x=t,this.y=e,this.width=i,this.height=n,this.bound=function(t){var e,i=0,n=0,s=0,a=0,o=0;for(o=0;o<t.length;o++)((e=t[o]).x<i||0===o)&&(i=e.x),(e.x>n||0===o)&&(n=e.x),(e.y<s||0===o)&&(s=e.y),(e.y>a||0===o)&&(a=e.y);return this.x=i,this.y=s,this.width=n-i,this.height=a-s,this},this.has_min_width=function(){return 5<=this.width},this.has_min_height=function(){return 5<=this.height},this.set_min_width=function(){this.width=5},this.set_min_height=function(){this.height=5}},M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.rect=e,i=function(){this.start=!1,this.end=!1,this.starttime=0,this.annotationstart=!1,this.tool="drag",this.commentcolour="yellow",this.annotationcolour="red",this.stamp="",this.path=[]},M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.edit=i,n=function(t){this.editor=t,this.shapes=[],this.nodes=[],this.erase=function(){if(this.shapes)for(;0<this.shapes.length;)this.editor.graphic.removeShape(this.shapes.pop());if(this.nodes)for(;0<this.nodes.length;)this.nodes.pop().remove()},this.scroll_update=function(t,e){var i,n,s;for(i=0;i<this.nodes.length;i++)n=this.nodes[i].getData("x"),s=this.nodes[i].getData("y"),n!==undefined&&s!==undefined&&(this.nodes[i].setX(parseInt(n,10)-t),this.nodes[i].setY(parseInt(s,10)-e))},this.store_position=function(t,e,i){var n,s,a;n=this.editor.get_dialogue_element(F),s=parseInt(n.get("scrollLeft"),10),a=parseInt(n.get("scrollTop"),10),t.setData("x",e+s),t.setData("y",i+a)}},M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.drawable=n,(s=function(t){s.superclass.constructor.apply(this,[t])}).NAME="annotation",s.ATTRS={},g.extend(s,g.Base,{editor:null,gradeid:0,pageno:0,x:0,y:0,endx:0,endy:0,path:"",type:"rect",colour:"red",drawable:!1,initializer:function(t){this.editor=t.editor||null,this.gradeid=parseInt(t.gradeid,10)||0,this.pageno=parseInt(t.pageno,10)||0,this.x=parseInt(t.x,10)||0,this.y=parseInt(t.y,10)||0,this.endx=parseInt(t.endx,10)||0,this.endy=parseInt(t.endy,10)||0,this.path=t.path||"",this.type=t.type||"rect",this.colour=t.colour||"red",this.drawable=!1},clean:function(){return{gradeid:this.gradeid,x:parseInt(this.x,10),y:parseInt(this.y,10),endx:parseInt(this.endx,10),endy:parseInt(this.endy,10),type:this.type,path:this.path,pageno:this.pageno,colour:this.colour}},draw_highlight:function(){var t,e,i,n,s=this.editor.get_dialogue_element(F),a=this.editor.get_dialogue_element(J).getXY();return this.editor.currentannotation===this&&((t=new M.assignfeedback_editpdf.rect).bound([new M.assignfeedback_editpdf.point(this.x,this.y),new M.assignfeedback_editpdf.point(this.endx,this.endy)]),e=this.editor.graphic.addShape({type:g.Rect,width:t.width,height:t.height,stroke:{weight:ht,color:it},fill:{color:nt},x:t.x,y:t.y}),this.drawable.shapes.push(e),i=g.Node.create('<img src="'+M.util.image_url("trash","assignfeedback_editpdf")+'"/>'),n=g.Node.create('<a href="#" role="button"></a>'),i.setAttrs({alt:M.util.get_string("deleteannotation","assignfeedback_editpdf")}),i.setStyles({backgroundColor:"white"}),n.addClass("deleteannotationbutton"),n.append(i),s.append(n),n.setData("annotation",this),n.on("click",this.remove,this),n.on("key",this.remove,"space,enter",this),n.setX(a[0]+t.x+t.width-18),n.setY(a[1]+t.y+6),this.drawable.nodes.push(n)),this.drawable},draw:function(){return this.draw_highlight(),this.drawable},remove:function(t){var e,i;for(t.preventDefault(),e=this.editor.pages[this.editor.currentpage].annotations,i=0;i<e.length;i++)if(e[i]===this)return e.splice(i,1),this.drawable&&this.drawable.erase(),this.editor.currentannotation=!1,void this.editor.save_current_page()},move:function(t,e){var i,n,s,a,o,r=t-this.x,d=e-this.y;this.x+=r,this.y+=d,this.endx+=r,this.endy+=d,this.path&&(i=[],n=this.path.split(":"),g.each(n,function(t){s=t.split(","),a=parseInt(s[0],10),o=parseInt(s[1],10),i.push(a+r+","+(o+d))}),this.path=i.join(":")),this.drawable&&this.drawable.erase(),this.editor.drawables.push(this.draw())},draw_current_edit:function(t){return t&&!1},init_from_edit:function(t){var e=new M.assignfeedback_editpdf.rect;return e.bound([t.start,t.end]),
+this.gradeid=this.editor.get("gradeid"),this.pageno=this.editor.currentpage,this.x=e.x,this.y=e.y,this.endx=e.x+e.width,this.endy=e.y+e.height,this.colour=t.annotationcolour,this.path="",e.has_min_width()&&e.has_min_height()}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.annotation=s,(a=function(t){a.superclass.constructor.apply(this,[t])}).NAME="annotationline",a.ATTRS={},g.extend(a,M.assignfeedback_editpdf.annotation,{draw:function(){var t,e;return t=new M.assignfeedback_editpdf.drawable(this.editor),(e=this.editor.graphic.addShape({type:g.Path,fill:!1,stroke:{weight:ht,color:ot[this.colour]}})).moveTo(this.x,this.y),e.lineTo(this.endx,this.endy),e.end(),t.shapes.push(e),this.drawable=t,a.superclass.draw.apply(this)},draw_current_edit:function(t){var e,i=new M.assignfeedback_editpdf.drawable(this.editor);return(e=this.editor.graphic.addShape({type:g.Path,fill:!1,stroke:{weight:ht,color:ot[t.annotationcolour]}})).moveTo(t.start.x,t.start.y),e.lineTo(t.end.x,t.end.y),e.end(),i.shapes.push(e),i},init_from_edit:function(t){return this.gradeid=this.editor.get("gradeid"),this.pageno=this.editor.currentpage,this.x=t.start.x,this.y=t.start.y,this.endx=t.end.x,this.endy=t.end.y,this.colour=t.annotationcolour,this.path="",!(this.endx-this.x==0&&this.endy-this.y==0)}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.annotationline=a,(o=function(t){o.superclass.constructor.apply(this,[t])}).NAME="annotationrectangle",o.ATTRS={},g.extend(o,M.assignfeedback_editpdf.annotation,{draw:function(){var t,e,i;return t=new M.assignfeedback_editpdf.drawable(this.editor),(e=new M.assignfeedback_editpdf.rect).bound([new M.assignfeedback_editpdf.point(this.x,this.y),new M.assignfeedback_editpdf.point(this.endx,this.endy)]),i=this.editor.graphic.addShape({type:g.Rect,width:e.width,height:e.height,stroke:{weight:ht,color:ot[this.colour]},x:e.x,y:e.y}),t.shapes.push(i),this.drawable=t,o.superclass.draw.apply(this)},draw_current_edit:function(t){var e,i,n=new M.assignfeedback_editpdf.drawable(this.editor);return(i=new M.assignfeedback_editpdf.rect).bound([new M.assignfeedback_editpdf.point(t.start.x,t.start.y),new M.assignfeedback_editpdf.point(t.end.x,t.end.y)]),i.has_min_width()||i.set_min_width(),i.has_min_height()||i.set_min_height(),e=this.editor.graphic.addShape({type:g.Rect,width:i.width,height:i.height,stroke:{weight:ht,color:ot[t.annotationcolour]},x:i.x,y:i.y}),n.shapes.push(e),n}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.annotationrectangle=o,(r=function(t){r.superclass.constructor.apply(this,[t])}).NAME="annotationoval",r.ATTRS={},g.extend(r,M.assignfeedback_editpdf.annotation,{draw:function(){var t,e,i;return t=new M.assignfeedback_editpdf.drawable(this.editor),(e=new M.assignfeedback_editpdf.rect).bound([new M.assignfeedback_editpdf.point(this.x,this.y),new M.assignfeedback_editpdf.point(this.endx,this.endy)]),i=this.editor.graphic.addShape({type:g.Ellipse,width:e.width,height:e.height,stroke:{weight:ht,color:ot[this.colour]},x:e.x,y:e.y}),t.shapes.push(i),this.drawable=t,r.superclass.draw.apply(this)},draw_current_edit:function(t){var e,i,n=new M.assignfeedback_editpdf.drawable(this.editor);return(i=new M.assignfeedback_editpdf.rect).bound([new M.assignfeedback_editpdf.point(t.start.x,t.start.y),new M.assignfeedback_editpdf.point(t.end.x,t.end.y)]),i.has_min_width()||i.set_min_width(),i.has_min_height()||i.set_min_height(),e=this.editor.graphic.addShape({type:g.Ellipse,width:i.width,height:i.height,stroke:{weight:ht,color:ot[t.annotationcolour]},x:i.x,y:i.y}),n.shapes.push(e),n}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.annotationoval=r,(d=function(t){d.superclass.constructor.apply(this,[t])}).NAME="annotationpen",d.ATTRS={},g.extend(d,M.assignfeedback_editpdf.annotation,{draw:function(){var t,e,i,n,s;return t=new M.assignfeedback_editpdf.drawable(this.editor),e=this.editor.graphic.addShape({type:g.Path,fill:!1,stroke:{weight:ht,color:ot[this.colour]}}),i=!0,n=this.path.split(":"),g.each(n,function(t){s=t.split(","),i?(e.moveTo(s[0],s[1]),i=!1):e.lineTo(s[0],s[1])},this),e.end(),t.shapes.push(e),this.drawable=t,d.superclass.draw.apply(this)},draw_current_edit:function(t){var e,i,n=new M.assignfeedback_editpdf.drawable(this.editor);return e=this.editor.graphic.addShape({type:g.Path,fill:!1,stroke:{weight:ht,color:ot[t.annotationcolour]}}),i=!0,g.each(t.path,function(t){i?(e.moveTo(t.x,t.y),i=!1):e.lineTo(t.x,t.y)},this),e.end(),n.shapes.push(e),n},init_from_edit:function(t){var e=new M.assignfeedback_editpdf.rect,i=[],n=0;for(e.bound(t.path),n=0;n<t.path.length;n++)i.push(parseInt(t.path[n].x,10)+","+parseInt(t.path[n].y,10));return this.gradeid=this.editor.get("gradeid"),this.pageno=this.editor.currentpage,this.x=e.x,this.y=e.y,this.endx=e.x+e.width,this.endy=e.y+e.height,this.colour=t.annotationcolour,this.path=i.join(":"),e.has_min_width()||e.has_min_height()}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.annotationpen=d,(h=function(t){h.superclass.constructor.apply(this,[t])}).NAME="annotationhighlight",h.ATTRS={},g.extend(h,M.assignfeedback_editpdf.annotation,{draw:function(){var t,e,i,n;return t=new M.assignfeedback_editpdf.drawable(this.editor),(i=new M.assignfeedback_editpdf.rect).bound([new M.assignfeedback_editpdf.point(this.x,this.y),new M.assignfeedback_editpdf.point(this.endx,this.endy)]),n=(n=(n=ot[this.colour]).replace("rgb","rgba")).replace(")",",0.5)"),e=this.editor.graphic.addShape({type:g.Rect,width:i.width,height:i.height,stroke:!1,fill:{color:n},x:i.x,y:i.y}),t.shapes.push(e),this.drawable=t,h.superclass.draw.apply(this)},draw_current_edit:function(t){var e,i,n,s=new M.assignfeedback_editpdf.drawable(this.editor);return(i=new M.assignfeedback_editpdf.rect).bound([new M.assignfeedback_editpdf.point(t.start.x,t.start.y),new M.assignfeedback_editpdf.point(t.end.x,t.end.y)]),i.has_min_width(
+)||i.set_min_width(),n=(n=(n=ot[t.annotationcolour]).replace("rgb","rgba")).replace(")",",0.5)"),e=this.editor.graphic.addShape({type:g.Rect,width:i.width,height:20,stroke:!1,fill:{color:n},x:i.x,y:t.start.y-10}),s.shapes.push(e),s},init_from_edit:function(t){var e=new M.assignfeedback_editpdf.rect;return e.bound([t.start,t.end]),this.gradeid=this.editor.get("gradeid"),this.pageno=this.editor.currentpage,this.x=e.x,this.y=t.start.y-10,this.endx=e.x+e.width,this.endy=t.start.y+10,this.colour=t.annotationcolour,this.page="",e.has_min_width()}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.annotationhighlight=h,(c=function(t){c.superclass.constructor.apply(this,[t])}).NAME="annotationstamp",c.ATTRS={},g.extend(c,M.assignfeedback_editpdf.annotation,{draw:function(){var t,e,i=new M.assignfeedback_editpdf.drawable(this.editor),n=this.editor.get_dialogue_element(J);return e=this.editor.get_window_coordinates(new M.assignfeedback_editpdf.point(this.x,this.y)),(t=g.Node.create("<div/>")).addClass("annotation"),t.addClass("stamp"),t.setStyles({position:"absolute",display:"inline-block",backgroundImage:"url("+this.editor.get_stamp_image_url(this.path)+")",width:this.endx-this.x,height:this.endy-this.y,backgroundSize:"100% 100%"}),n.append(t),t.setX(e.x),t.setY(e.y),i.store_position(t,e.x,e.y),this.editor.get("readonly")||(t.on("gesturemovestart",this.editor.edit_start,null,this.editor),t.on("gesturemove",this.editor.edit_move,null,this.editor),t.on("gesturemoveend",this.editor.edit_end,null,this.editor)),i.nodes.push(t),this.drawable=i,c.superclass.draw.apply(this)},draw_current_edit:function(t){var e,i,n=new M.assignfeedback_editpdf.rect,s=new M.assignfeedback_editpdf.drawable(this.editor),a=this.editor.get_dialogue_element(F);return n.bound([t.start,t.end]),i=this.editor.get_window_coordinates(new M.assignfeedback_editpdf.point(n.x,n.y)),(e=g.Node.create("<div/>")).addClass("annotation"),e.addClass("stamp"),e.setStyles({position:"absolute",display:"inline-block",backgroundImage:"url("+this.editor.get_stamp_image_url(t.stamp)+")",width:n.width,height:n.height,backgroundSize:"100% 100%"}),a.append(e),e.setX(i.x),e.setY(i.y),s.store_position(e,i.x,i.y),s.nodes.push(e),s},init_from_edit:function(t){var e=new M.assignfeedback_editpdf.rect;return e.bound([t.start,t.end]),e.width<40&&(e.width=40),e.height<40&&(e.height=40),this.gradeid=this.editor.get("gradeid"),this.pageno=this.editor.currentpage,this.x=e.x,this.y=e.y,this.endx=e.x+e.width,this.endy=e.y+e.height,this.colour=t.annotationcolour,this.path=t.stamp,!0},move:function(t,e){var i=t-this.x,n=e-this.y;this.x+=i,this.y+=n,this.endx+=i,this.endy+=n,this.drawable&&this.drawable.erase(),this.editor.drawables.push(this.draw())}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.annotationstamp=c,l="Dropdown menu",u=function(t){t.draggable=!1,t.centered=!1,t.width="auto",t.visible=!1,t.footerContent="",u.superclass.constructor.apply(this,[t])},g.extend(u,M.core.dialogue,{initializer:function(t){var e,i,n;u.superclass.initializer.call(this,t),this.get("boundingBox").addClass("assignfeedback_editpdf_dropdown"),e=this.get("buttonNode"),i=this.bodyNode,(n=g.Node.create("<h3/>")).addClass("accesshide"),n.setHTML(this.get("headerText")),i.prepend(n),i.on("clickoutside",function(t){this.get("visible")&&t.target.get("id")!==e.get("id")&&t.target.ancestor().get("id")!==e.get("id")&&(t.preventDefault(),this.hide())},this),e.on("click",function(t){t.preventDefault(),this.show()},this),e.on("key",this.show,"enter,space",this)},show:function(){var t=this.get("buttonNode"),e=u.superclass.show.call(this);return this.align(t,[g.WidgetPositionAlign.TL,g.WidgetPositionAlign.BL]),e}},{NAME:l,ATTRS:{headerText:{value:""},buttonNode:{value:null}}}),g.Base.modifyAttrs(u,{modal:{getter:function(){return!1}}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.dropdown=u,p="Colourpicker",f=function(t){f.superclass.constructor.apply(this,[t])},g.extend(f,M.assignfeedback_editpdf.dropdown,{initializer:function(t){var e,r=g.Node.create('<ul role="menu" class="assignfeedback_editpdf_menu"/>');g.each(this.get("colours"),function(t,e){var i,n,s,a,o;s=M.util.get_string(e,"assignfeedback_editpdf"),o=this.get("iconprefix")+e,a=M.util.image_url(o,"assignfeedback_editpdf"),(i=g.Node.create('<button><img alt="'+s+'" src="'+a+'"/></button>')).setAttribute("data-colour",e),i.setAttribute("data-rgb",t),i.setStyle("backgroundImage","none"),(n=g.Node.create("<li/>")).append(i),r.append(n)},this),e=g.Node.create("<div/>"),r.delegate("click",this.callback_handler,"button",this),r.delegate("key",this.callback_handler,"down:13","button",this),this.set("headerText",M.util.get_string("colourpicker","assignfeedback_editpdf")),e.append(r),this.set("bodyContent",e),f.superclass.initializer.call(this,t)},callback_handler:function(t){t.preventDefault();var e=this.get("callback"),i=this.get("context");this.hide(),g.bind(e,i,t)()}},{NAME:p,ATTRS:{colours:{value:{}},callback:{value:null},context:{value:null},iconprefix:{value:"colour_"}}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.colourpicker=f,_="Colourpicker",m=function(t){m.superclass.constructor.apply(this,[t])},g.extend(m,M.assignfeedback_editpdf.dropdown,{initializer:function(t){var s=g.Node.create('<ul role="menu" class="assignfeedback_editpdf_menu"/>');g.each(this.get("stamps"),function(t){var e,i,n;n=M.util.get_string("stamp","assignfeedback_editpdf"),(e=g.Node.create('<button><img height="16" width="16" alt="'+n+'" src="'+t+'"/></button>')).setAttribute("data-stamp",t),e.setStyle("backgroundImage","none"),(i=g.Node.create("<li/>")).append(e),s.append(i)},this),s.delegate("click",this.callback_handler,"button",this),s.delegate("key",this.callback_handler,"down:13","button",this),this.set("headerText",M.util.get_string("stamppicker","assignfeedback_editpdf")),this.set("bodyContent",s),m.superclass.initializer.call(this,
+t)},callback_handler:function(t){t.preventDefault();var e=this.get("callback"),i=this.get("context");this.hide(),g.bind(e,i,t)()}},{NAME:_,ATTRS:{stamps:{value:[]},callback:{value:null},context:{value:null}}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.stamppicker=m,b="Commentmenu",w=function(t){w.superclass.constructor.apply(this,[t])},g.extend(w,M.assignfeedback_editpdf.dropdown,{initializer:function(t){var e,i,n,s;s=this.get("comment"),e=g.Node.create('<ul role="menu" class="assignfeedback_editpdf_menu"/>'),(i=g.Node.create('<li><a tabindex="-1" href="#">'+M.util.get_string("addtoquicklist","assignfeedback_editpdf")+"</a></li>")).on("click",s.add_to_quicklist,s),i.on("key",s.add_to_quicklist,"enter,space",s),e.append(i),(i=g.Node.create('<li><a tabindex="-1" href="#">'+M.util.get_string("deletecomment","assignfeedback_editpdf")+"</a></li>")).on("click",function(t){t.preventDefault(),this.menu.hide(),this.remove()},s),i.on("key",function(){s.menu.hide(),s.remove()},"enter,space",s),e.append(i),i=g.Node.create("<li><hr/></li>"),e.append(i),this.set("headerText",M.util.get_string("commentcontextmenu","assignfeedback_editpdf")),(n=g.Node.create("<div/>")).append(e),this.set("bodyContent",n),w.superclass.initializer.call(this,t)},show:function(){var s,a=this.get("boundingBox").one("ul");a.all(".quicklist_comment").remove(!0),(s=this.get("comment")).deleteme=!1,g.each(s.editor.quicklist.comments,function(t){var e=g.Node.create('<li class="quicklist_comment"></li>'),i=g.Node.create('<a href="#" tabindex="-1">'+t.rawtext+"</a>"),n=g.Node.create('<a href="#" tabindex="-1" class="delete_quicklist_comment"><img src="'+M.util.image_url("t/delete","core")+'" alt="'+M.util.get_string("deletecomment","assignfeedback_editpdf")+'"/></a>');i.setAttribute("title",t.rawtext),e.append(i),e.append(n),a.append(e),e.on("click",s.set_from_quick_comment,s,t),e.on("key",s.set_from_quick_comment,"space,enter",s,t),n.on("click",s.remove_from_quicklist,s,t),n.on("key",s.remove_from_quicklist,"space,enter",s,t)},this),w.superclass.show.call(this)}},{NAME:b,ATTRS:{comment:{value:null}}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.commentmenu=w,y="commentsearch",k=function(t){t.draggable=!1,t.centered=!0,t.width="400px",t.visible=!1,t.headerContent=M.util.get_string("searchcomments","assignfeedback_editpdf"),t.footerContent="",k.superclass.constructor.apply(this,[t])},g.extend(k,M.core.dialogue,{initializer:function(t){var e,i,n,s;this.get("boundingBox").addClass("assignfeedback_editpdf_commentsearch"),this.get("editor"),e=g.Node.create("<div/>"),i=M.util.get_string("filter","assignfeedback_editpdf"),n=g.Node.create('<input type="text" size="20" placeholder="'+i+'"/>'),e.append(n),s=g.Node.create('<ul role="menu" class="assignfeedback_editpdf_search"/>'),e.append(s),n.on("keyup",this.filter_search_comments,this),s.delegate("click",this.focus_on_comment,"a",this),s.delegate("key",this.focus_on_comment,"enter,space","a",this),this.set("bodyContent",e),k.superclass.initializer.call(this,t)},filter_search_comments:function(){var t,e,i,n;n=this.get("id"),t=g.one("#"+n+O),e=g.one("#"+n+B),i=t.get("value"),e.all("li").each(function(t){-1!==t.get("text").indexOf(i)?t.show():t.hide()})},focus_on_comment:function(t){t.preventDefault();var e=t.target.ancestor("li").getData("comment"),i=this.get("editor");this.hide(),e.pageno=e.clean().pageno,e.pageno!==i.currentpage&&(i.currentpage=e.pageno,i.change_page()),e.node=e.drawable.nodes[0].one("textarea"),e.node.ancestor("div").removeClass("commentcollapsed"),e.node.focus()},show:function(){var i=this.get("boundingBox").one("ul"),t=this.get("editor");i.all("li").remove(!0),g.each(t.pages,function(t){g.each(t.comments,function(t){var e=g.Node.create('<li><a href="#" tabindex="-1"><pre>'+t.rawtext+"</pre></a></li>");i.append(e),e.setData("comment",t)},this)},this),this.centerDialogue(),k.superclass.show.call(this)}},{NAME:y,ATTRS:{editor:{value:null}}}),g.Base.modifyAttrs(k,{modal:{getter:function(){return!0}}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.commentsearch=k,v=function(c,t,e,i,n,s,a,o){this.editor=c,this.gradeid=t||0,this.x=parseInt(i,10)||0,this.y=parseInt(n,10)||0,this.width=parseInt(s,10)||0,this.rawtext=o||"",this.pageno=e||0,this.colour=a||"yellow",this.drawable=!1,this.deleteme=!1,this.menulink=null,this.menu=null,this.clean=function(){return{gradeid:this.gradeid,x:parseInt(this.x,10),y:parseInt(this.y,10),width:parseInt(this.width,10),rawtext:this.rawtext,pageno:parseInt(this.pageno,10),colour:this.colour}},this.draw=function(t){var e,i,n,s,a,o,r,d=new M.assignfeedback_editpdf.drawable(this.editor),h=this.editor.get_dialogue_element(J);return e=g.Node.create("<textarea/>"),i=g.Node.create('<div class="commentdrawable"/>'),n=g.Node.create("<label/>"),s=g.Node.create('<svg xmlns="http://www.w3.org/2000/svg" viewBox="-0.5 -0.5 13 13" preserveAspectRatio="xMinYMin meet"><path d="M11 0H1C.4 0 0 .4 0 1v6c0 .6.4 1 1 1h1v4l4-4h5c.6 0 1-.4 1-1V1c0-.6-.4-1-1-1z" fill="currentColor" opacity="0.9" stroke="rgb(153, 153, 153)" stroke-width="0.5"/></svg>'),a=g.Node.create('<a href="#"><img src="'+M.util.image_url("t/contextmenu","core")+'"/></a>'),this.menulink=a,i.append(n),n.append(e),i.append(s),i.setAttribute("tabindex","-1"),n.setAttribute("tabindex","0"),e.setAttribute("tabindex","-1"),a.setAttribute("tabindex","0"),this.editor.get("readonly")?e.setAttribute("readonly","readonly"):i.append(a),this.width<100&&(this.width=100),o=this.editor.get_window_coordinates(new M.assignfeedback_editpdf.point(this.x,this.y)),e.setStyles({width:this.width+"px",backgroundColor:at[this.colour],color:st}),h.append(i),i.setStyle("position","absolute"),i.setX(o.x),i.setY(o.y),d.store_position(i,o.x,o.y),d.nodes.push(i),e.set("value",this.rawtext),r=e.get("scrollHeight"),e.setStyles({height:r+"px",overflow:"hidden"}),s.setStyle("color",at[this.colour]),this.attach_events(e,a),t?e.focus(
+):c.collapsecomments&&i.addClass("commentcollapsed"),this.drawable=d},this.delete_comment_later=function(){this.deleteme&&this.remove()},this.attach_events=function(o,e){var r=o.ancestor("div"),t=o.ancestor("label"),i=t.next("svg");o.collapse=function(t){o.collapse.delay=g.later(t,o,function(){c.collapsecomments&&r.addClass("commentcollapsed")})},o.expand=function(){!0!==o.getData("dragging")&&(o.collapse.delay&&o.collapse.delay.cancel(),r.removeClass("commentcollapsed"))},r.on("mouseenter",function(){"comment"!==c.currentedit.tool&&"select"!==c.currentedit.tool&&!this.editor.get("readonly")||o.expand()},this),r.on("click|tap",function(){o.expand(),o.focus()},this),o.on("keyup",function(t){9===t.keyCode&&t.shiftKey&&"0"===e.getAttribute("tabindex")&&e.focus(),e.setAttribute("tabindex","0")},this),e.on("keydown",function(t){9===t.keyCode&&t.shiftKey&&e.setAttribute("tabindex","-1")},this),t.on("focus",function(){o.active=!0,o.collapse.delay&&o.collapse.delay.cancel(),o.setAttribute("tabindex","0"),o.expand(),o.focus(),t.setAttribute("tabindex","-1")},this),e.on("focus",function(){o.active=!0,o.collapse.delay&&o.collapse.delay.cancel(),this.deleteme=!1,t.setAttribute("tabindex","0")},this),o.on("blur",function(){o.setAttribute("tabindex","-1")},this),t.on("blur",function(){t.setAttribute("tabindex","0")},this),r.on("mouseleave",function(){c.collapsecomments&&!0!==o.active&&o.collapse(400)},this),r.on("blur",function(){o.active=!1,o.collapse(800)},this),this.editor.get("readonly")||(o.on("blur",function(){this.rawtext=o.get("value"),this.width=parseInt(o.getStyle("width"),10),""===this.rawtext.replace(/^\s+|\s+$/g,"")&&(this.deleteme=!0,g.later(400,this,this.delete_comment_later)),this.editor.save_current_page(),this.editor.editingcomment=!1},this),e.setData("comment",this),o.on("keyup",function(){o.setStyle("height","auto");var t=o.get("scrollHeight");t===parseInt(o.getStyle("height"),10)+8&&(t-=8),o.setStyle("height",t+"px")}),o.on("gesturemovestart",function(t){"select"===c.currentedit.tool&&(t.preventDefault(),c.collapsecomments?(o.setData("offsetx",8),o.setData("offsety",8)):(o.setData("offsetx",t.clientX-r.getX()),o.setData("offsety",t.clientY-r.getY())))}),o.on("gesturemove",function(t){if("select"===c.currentedit.tool){var e,i,n,s=t.clientX-o.getData("offsetx"),a=t.clientY-o.getData("offsety");!0!==o.getData("dragging")&&(o.collapse(0),o.setData("dragging",!0)),e=this.editor.get_canvas_coordinates(new M.assignfeedback_editpdf.point(s,a)),(n=this.editor.get_canvas_bounds(!0)).x=0,n.y=0,n.width-=24,n.height-=24,e.clip(n),this.x=e.x,this.y=e.y,i=this.editor.get_window_coordinates(e),r.setX(i.x),r.setY(i.y),this.drawable.store_position(r,i.x,i.y)}},null,this),o.on("gesturemoveend",function(){"select"===c.currentedit.tool&&(!0===o.getData("dragging")&&o.setData("dragging",!1),this.editor.save_current_page())},null,this),i.on("gesturemovestart",function(t){"select"===c.currentedit.tool&&(t.preventDefault(),o.setData("offsetx",t.clientX-r.getX()),o.setData("offsety",t.clientY-r.getY()),o.expand())}),i.on("gesturemove",function(t){if("select"===c.currentedit.tool){var e,i,n,s=t.clientX-o.getData("offsetx"),a=t.clientY-o.getData("offsety");!0!==o.getData("dragging")&&(o.collapse(100),o.setData("dragging",!0)),e=this.editor.get_canvas_coordinates(new M.assignfeedback_editpdf.point(s,a)),(n=this.editor.get_canvas_bounds(!0)).x=0,n.y=0,n.width-=24,n.height-=24,e.clip(n),this.x=e.x,this.y=e.y,i=this.editor.get_window_coordinates(e),r.setX(i.x),r.setY(i.y),this.drawable.store_position(r,i.x,i.y)}},null,this),i.on("gesturemoveend",function(){"select"===c.currentedit.tool&&(!0===o.getData("dragging")&&o.setData("dragging",!1),this.editor.save_current_page())},null,this),this.menu=new M.assignfeedback_editpdf.commentmenu({buttonNode:this.menulink,comment:this}))},this.remove=function(){var t=0,e=this.editor.pages[this.editor.currentpage].comments;for(t=0;t<e.length;t++)if(e[t]===this)return e.splice(t,1),this.drawable.erase(),void this.editor.save_current_page()},this.remove_from_quicklist=function(t,e){t.preventDefault(),t.stopPropagation(),this.menu.hide(),this.editor.quicklist.remove(e)},this.set_from_quick_comment=function(t,e){t.preventDefault(),this.menu.hide(),this.deleteme=!1,this.rawtext=e.rawtext,this.width=e.width,this.colour=e.colour,this.editor.save_current_page(),this.editor.redraw(),this.node=this.drawable.nodes[0].one("textarea"),this.node.ancestor("div").removeClass("commentcollapsed"),this.node.focus()},this.add_to_quicklist=function(t){t.preventDefault(),this.menu.hide(),this.editor.quicklist.add(this)},this.draw_current_edit=function(t){var e,i,n=new M.assignfeedback_editpdf.drawable(this.editor);return(i=new M.assignfeedback_editpdf.rect).bound([t.start,t.end]),e=this.editor.graphic.addShape({type:g.Rect,width:i.width,height:i.height,fill:{color:at[t.commentcolour]},x:i.x,y:i.y}),n.shapes.push(e),n},this.init_from_edit=function(t){var e=new M.assignfeedback_editpdf.rect;return e.bound([t.start,t.end]),e.width<100&&(e.width=100),this.gradeid=this.editor.get("gradeid"),this.pageno=this.editor.currentpage,this.x=e.x,this.y=e.y,this.width=e.width,this.colour=t.commentcolour,this.rawtext="",e.has_min_width()&&e.has_min_height()},this.updatePosition=function(){var t=this.drawable.nodes[0].one("textarea"),e=t.ancestor("div"),i=new M.assignfeedback_editpdf.point(this.x,this.y),n=this.editor.get_window_coordinates(i);e.setX(n.x),e.setY(n.y),this.drawable.store_position(e,n.x,n.y)}},M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.comment=v,x=function(t,e,i,n){this.rawtext=e||"",this.id=t||0,this.width=i||100,this.colour=n||"yellow"},M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.quickcomment=x,S=function(t){this.editor=t,this.comments=[],this.add=function(t){var e,i=q;""!==t.rawtext&&(e={method:"post",context:this,sync:!1,data:{sesskey:M.cfg.sesskey,action:"addtoquicklist",userid:this.editor.get("userid"),
+commenttext:t.rawtext,width:t.width,colour:t.colour,attemptnumber:this.editor.get("attemptnumber"),assignmentid:this.editor.get("assignmentid")},on:{success:function(t,e){var i,n;try{if((i=g.JSON.parse(e.responseText)).error)return new M.core.ajaxException(i);n=new M.assignfeedback_editpdf.quickcomment(i.id,i.rawtext,i.width,i.colour),this.comments.push(n),this.comments.sort(function(t,e){return t.rawtext.localeCompare(e.rawtext)})}catch(s){return new M.core.exception(s)}},failure:function(t,e){return M.core.exception(e.responseText)}}},g.io(i,e))},this.remove=function(e){var t,i=q;e&&(t={method:"post",context:this,sync:!1,data:{sesskey:M.cfg.sesskey,action:"removefromquicklist",userid:this.editor.get("userid"),commentid:e.id,attemptnumber:this.editor.get("attemptnumber"),assignmentid:this.editor.get("assignmentid")},on:{success:function(){var t;0<=(t=this.comments.indexOf(e))&&this.comments.splice(t,1)},failure:function(t,e){return M.core.exception(e.responseText)}}},g.io(i,t))},this.load=function(){var t,e=q;t={method:"get",context:this,sync:!1,data:{sesskey:M.cfg.sesskey,action:"loadquicklist",userid:this.editor.get("userid"),attemptnumber:this.editor.get("attemptnumber"),assignmentid:this.editor.get("assignmentid")},on:{success:function(t,e){var i;try{if((i=g.JSON.parse(e.responseText)).error)return new M.core.ajaxException(i);g.each(i,function(t){var e=new M.assignfeedback_editpdf.quickcomment(t.id,t.rawtext,t.width,t.colour);this.comments.push(e)},this),this.comments.sort(function(t,e){return t.rawtext.localeCompare(e.rawtext)})}catch(n){return new M.core.exception(n)}},failure:function(t,e){return M.core.exception(e.responseText)}}},g.io(e,t)}},M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.quickcommentlist=S,(N=function(){N.superclass.constructor.apply(this,arguments)}).prototype={oldannotationcoordinates:null,dialogue:null,panel:null,pagecount:0,currentpage:0,pages:[],documentstatus:0,loadingicon:null,pageimage:null,graphic:null,currentedit:new M.assignfeedback_editpdf.edit,currentdrawable:!1,drawables:[],currentcomment:null,currentannotation:null,lastannotation:null,lastannotationtool:"pen",quicklist:null,searchcommentswindow:null,htmleditorwindow:null,currentstamp:null,stamps:[],editingcomment:!1,editinghtmlcomment:!1,collapsecomments:!0,initializer:function(){var n;(n=g.one("#"+this.get("linkid")))&&(n.on("click",this.link_handler,this),n.on("key",this.link_handler,"down:13",this),require(["mod_assign/grading_review_panel"],function(t){var e=new t,i=e.getReviewPanel("assignfeedback_editpdf");i&&((i=g.one(i)).empty(),n.ancestor(".fitem").hide(),this.open_in_panel(i)),this.currentedit.start=!1,this.currentedit.end=!1,this.get("readonly")||(this.quicklist=new M.assignfeedback_editpdf.quickcommentlist(this))}.bind(this)))},refresh_button_state:function(){var t,e,i,n,s;switch(t=this.get_dialogue_element(W),i=M.util.image_url("background_colour_"+this.currentedit.commentcolour,"assignfeedback_editpdf"),t.one("img").setAttribute("src",i),"clear"===this.currentedit.commentcolour?t.one("img").setStyle("borderStyle","dashed"):t.one("img").setStyle("borderStyle","solid"),t=this.get_dialogue_element($),i=M.util.image_url("colour_"+this.currentedit.annotationcolour,"assignfeedback_editpdf"),t.one("img").setAttribute("src",i),(e=this.get_dialogue_element(dt[this.currentedit.tool])).addClass("assignfeedback_editpdf_selectedbutton"),e.setAttribute("aria-pressed","true"),this.get_dialogue_element(F).setAttribute("data-currenttool",this.currentedit.tool),t=this.get_dialogue_element(Q),n=this.get_stamp_image_url(this.currentedit.stamp),t.one("img").setAttrs({src:n,height:"16",width:"16"}),s=this.get_dialogue_element(J),this.currentedit.tool){case"drag":s.setStyle("cursor","move");break;case"highlight":s.setStyle("cursor","text");break;case"select":s.setStyle("cursor","default");break;case"stamp":s.setStyle("cursor","url("+n+"), crosshair");break;default:s.setStyle("cursor","crosshair")}},get_canvas_bounds:function(){var t=this.get_dialogue_element(J),e=t.getXY(),i=e[0],n=e[1],s=parseInt(t.getStyle("width"),10),a=parseInt(t.getStyle("height"),10);return new M.assignfeedback_editpdf.rect(i,n,s,a)},get_canvas_coordinates:function(t){var e=this.get_canvas_bounds(),i=new M.assignfeedback_editpdf.point(t.x-e.x,t.y-e.y);return e.x=e.y=0,i.clip(e),i},get_window_coordinates:function(t){var e=this.get_canvas_bounds();return new M.assignfeedback_editpdf.point(t.x+e.x,t.y+e.y)},open_in_panel:function(t){var e;(this.panel=t).append(this.get("body")),t.addClass(Y),this.loadingicon=this.get_dialogue_element(j),e=this.get_dialogue_element(J),this.graphic=new g.Graphic({render:e}),this.get("readonly")||(e.on("gesturemovestart",this.edit_start,null,this),e.on("gesturemove",this.edit_move,null,this),e.on("gesturemoveend",this.edit_end,null,this),this.refresh_button_state()),this.start_generation()},link_handler:function(t){var e,i=!0;t.preventDefault(),this.dialogue||(this.dialogue=new M.core.dialogue({headerContent:this.get("header"),bodyContent:this.get("body"),footerContent:this.get("footer"),modal:!0,width:"840px",visible:!1,draggable:!0}),this.dialogue.get("boundingBox").addClass(Y),this.loadingicon=this.get_dialogue_element(j),e=this.get_dialogue_element(J),this.graphic=new g.Graphic({render:e}),this.get("readonly")||(e.on("gesturemovestart",this.edit_start,null,this),e.on("gesturemove",this.edit_move,null,this),e.on("gesturemoveend",this.edit_end,null,this),this.refresh_button_state()),this.start_generation(),e.on("windowresize",this.resize,this),i=!1),this.dialogue.centerDialogue(),this.dialogue.show(),this.dialogue.dd.on("drag:end",this.redraw,this),i&&this.resize()},start_generation:function(){this.poll_document_conversion_status()},poll_document_conversion_status:function(){var o=this.get("userid");g.io(q,{method:"get",context:this,sync:!1,data:{sesskey:M.cfg.sesskey,action:"pollconversions",userid:this.get("userid"),attemptnumber:this.get("attemptnumber"),
+assignmentid:this.get("assignmentid"),readonly:this.get("readonly")?1:0},on:{success:function(t,e){var i,n,s,a=g.one(U);a&&(i=a.getAttribute("data-userid"))&&i!=o||(s=!1,(n=this.handle_response_data(e))&&(this.documentstatus=n.status,0===n.status||1===n.status||3===n.status?s=!0:2!==n.status&&-1!==n.status||(this.pagecount=n.pagecount,n.pageready==n.pagecount?this.prepare_pages_for_display(n):(this.update_page_load_progress(),this.start_document_to_image_conversion())),s&&g.later(1e3,this,this.poll_document_conversion_status)))},failure:function(t,e){return new M.core.exception(e.responseText)}}})},start_document_to_image_conversion:function(){g.io(q,{method:"get",context:this,sync:!1,data:{sesskey:M.cfg.sesskey,action:"pollconversions",userid:this.get("userid"),attemptnumber:this.get("attemptnumber"),assignmentid:this.get("assignmentid"),readonly:this.get("readonly")?1:0},on:{success:function(t,e){var i=this.handle_response_data(e);i&&(this.documentstatus=i.status,2===i.status&&this.prepare_pages_for_display(i))},failure:function(t,e){return new M.core.exception(e.responseText)}}})},warning:function(t,e){var i,n=this.get_dialogue_element(G),s=this.get_dialogue_element(V),a=15,o=1,r="assignfeedback_editpdf_warningmessages alert alert-warning";e&&(a=4,r="assignfeedback_editpdf_warningmessages alert alert-info"),(i=g.Node.create('<div class="'+r+'" role="alert"></div>')).append(n.one("*").cloneNode()),i.append(t),s.prepend(i),i.transition({duration:o,delay:a,opacity:0},function(){i.remove()})},prepare_pages_for_display:function(t){var e,i,n,s,a;if(!t.pagecount)return this.dialogue&&this.dialogue.hide(),void new M.core.alert({message:M.util.get_string("cannotopenpdf","assignfeedback_editpdf")}).show();for(this.pages=t.pages,e=0;e<this.pages.length;e++){for(i=0;i<this.pages[e].comments.length;i++)n=this.pages[e].comments[i],this.pages[e].comments[i]=new M.assignfeedback_editpdf.comment(this,n.gradeid,n.pageno,n.x,n.y,n.width,n.colour,n.rawtext);for(i=0;i<this.pages[e].htmlcomments.length;i++)s=this.pages[e].htmlcomments[i],this.pages[e].htmlcomments[i]=new M.assignfeedback_editpdf.htmlcomment(this,s.gradeid,s.pageno,s.x,s.y,s.width,s.colour,s.rawtext);for(i=0;i<this.pages[e].annotations.length;i++)a=this.pages[e].annotations[i],this.pages[e].annotations[i]=this.create_annotation(a.type,a)}!this.get("readonly")&&t.partial&&this.warning(M.util.get_string("partialwarning","assignfeedback_editpdf"),!1),this.quicklist&&this.quicklist.load(),this.setup_navigation(),this.setup_toolbar(),this.change_page()},update_page_load_progress:function(){var s,a=0;this.get_dialogue_element(H+" .bar")&&(s={method:"get",context:this,sync:!1,data:{sesskey:M.cfg.sesskey,action:"conversionstatus",userid:this.get("userid"),attemptnumber:this.get("attemptnumber"),assignmentid:this.get("assignmentid")},on:{success:function(t,e){var i,n;i=a=0,(n=this.get_dialogue_element(H+" .bar"))&&(i=e.response/this.pagecount*100,n.setStyle("width",i+"%"),n.ancestor(H).setAttribute("aria-valuenow",i),i<100&&(M.util.js_pending("checkconversionstatus"),g.later(1e3,this,function(){M.util.js_complete("checkconversionstatus"),g.io(E,s)})))},failure:function(t,e){return a+=1,0===this.pagecount&&a<5&&(M.util.js_pending("checkconversionstatus"),g.later(1e3,this,function(){M.util.js_complete("checkconversionstatus"),g.io(E,s)})),new M.core.exception(e.responseText)}}},M.util.js_pending("checkconversionstatus"),g.later(1e3,this,function(){a=0,M.util.js_complete("checkconversionstatus"),g.io(E,s)}))},handle_response_data:function(t){var e;try{if(!(e=g.JSON.parse(t.responseText)).error)return e;this.dialogue&&this.dialogue.hide(),new M.core.alert({message:M.util.get_string("cannotopenpdf","assignfeedback_editpdf"),visible:!0})}catch(i){this.dialogue&&this.dialogue.hide(),new M.core.alert({title:M.util.get_string("cannotopenpdf","assignfeedback_editpdf"),visible:!0})}},get_stamp_image_url:function(e){var t=this.get("stampfiles"),i="";return g.Array.each(t,function(t){0<t.indexOf(e)&&(i=t)},this),i},setup_toolbar:function(){var i,t,e,n,s,a,o,r,d,h,c;null!==(c=this.get_dialogue_element(et))&&"unknown"!==c&&(c.on("click",this.open_htmleditor,this),c.on("key",this.open_htmleditor,"down:13",this)),(n=this.get_dialogue_element(X)).on("click",this.open_search_comments,this),n.on("key",this.open_search_comments,"down:13",this),(s=this.get_dialogue_element(L)).on("click",this.expandCollapseComments,this),s.on("key",this.expandCollapseComments,"down:13",this),this.get("readonly")||((a=this.get_dialogue_element(Z)).on("click",this.rotatePDF,this,!0),a.on("key",this.rotatePDF,"down:13",this,!0),(o=this.get_dialogue_element(tt)).on("click",this.rotatePDF,this,!1),o.on("key",this.rotatePDF,"down:13",this,!1),this.disable_touch_scroll(),g.each(dt,function(t,e){(i=this.get_dialogue_element(t)).on("click",this.handle_tool_button,this,e),i.on("key",this.handle_tool_button,"down:13",this,e),i.setAttribute("aria-pressed","false")},this),t=this.get_dialogue_element(W),new M.assignfeedback_editpdf.colourpicker({buttonNode:t,colours:at,iconprefix:"background_colour_",callback:function(t){var e=t.target.getAttribute("data-colour");e=e||t.target.ancestor().getAttribute("data-colour"),this.currentedit.commentcolour=e,this.handle_tool_button(t,"comment")},context:this}),e=this.get_dialogue_element($),new M.assignfeedback_editpdf.colourpicker({buttonNode:e,iconprefix:"colour_",colours:ot,callback:function(t){var e=t.target.getAttribute("data-colour");e=e||t.target.ancestor().getAttribute("data-colour"),this.currentedit.annotationcolour=e,this.lastannotationtool?this.handle_tool_button(t,this.lastannotationtool):this.handle_tool_button(t,"pen")},context:this}),(d=this.get("stampfiles")).length<=0?this.get_dialogue_element(dt.stamp).ancestor().hide():(h=d[0].substr(d[0].lastIndexOf("/")+1),this.currentedit.stamp=h,r=this.get_dialogue_element(Q),new M.assignfeedback_editpdf.stamppicker({buttonNode:r,stamps:d,callback:function(t){var e,i=t.target.getAttribute("data-stamp");e=(
+i=i||t.target.ancestor().getAttribute("data-stamp")).substr(i.lastIndexOf("/")),this.currentedit.stamp=e,this.handle_tool_button(t,"stamp")},context:this}),this.refresh_button_state()))},handle_tool_button:function(t,e){var i;t.preventDefault(),(i=this.get_dialogue_element(dt[this.currentedit.tool])).removeClass("assignfeedback_editpdf_selectedbutton"),i.setAttribute("aria-pressed","false"),"htmleditor"!==(this.currentedit.tool=e)&&"comment"!==e&&"select"!==e&&"drag"!==e&&"stamp"!==e&&(this.lastannotationtool=e),this.refresh_button_state()},stringify_current_page:function(){var t,e=[],i=[],n=[],s=0;for(s=0;s<this.pages[this.currentpage].htmlcomments.length;s++)i[s]=this.pages[this.currentpage].htmlcomments[s].clean();for(s=0;s<this.pages[this.currentpage].comments.length;s++)e[s]=this.pages[this.currentpage].comments[s].clean();for(s=0;s<this.pages[this.currentpage].annotations.length;s++)n[s]=this.pages[this.currentpage].annotations[s].clean();return t={comments:e,annotations:n,htmlcomments:i},g.JSON.stringify(t)},get_current_drawable:function(){var t,e=!1;return!(!this.currentedit.start||!this.currentedit.end)&&("comment"===this.currentedit.tool?e=new M.assignfeedback_editpdf.comment(this).draw_current_edit(this.currentedit):"htmleditor"===this.currentedit.tool?e=new M.assignfeedback_editpdf.htmlcomment(this).draw_current_edit(this.currentedit):(t=this.create_annotation(this.currentedit.tool,{}))&&(e=t.draw_current_edit(this.currentedit)),e)},get_dialogue_element:function(t){return this.panel?this.panel.one(t):this.dialogue.get("boundingBox").one(t)},redraw_current_edit:function(){this.currentdrawable&&this.currentdrawable.erase(),this.currentdrawable=this.get_current_drawable()},edit_start:function(t){var e,i,n,s=this.get_dialogue_element(J),a=s.getXY(),o=s.get("docScrollY"),r=s.get("docScrollX"),d={x:t.clientX-a[0]+r,y:t.clientY-a[1]+o},h=!1;3!==t.button&&(this.currentedit.starttime||this.editingcomment||this.editinghtmlcomment||(this.currentedit.starttime=(new Date).getTime(),this.currentedit.start=d,this.currentedit.end={x:d.x,y:d.y},"select"===this.currentedit.tool&&(e=this.currentedit.end.x,i=this.currentedit.end.y,n=this.pages[this.currentpage].annotations,g.each(n,function(t){(e-t.x)*(e-t.endx)<=0&&(i-t.y)*(i-t.endy)<=0&&(h=t)}),h?(this.lastannotation=this.currentannotation,this.currentannotation=h,this.lastannotation&&this.lastannotation!==h&&this.lastannotation.drawable&&(this.lastannotation.drawable.erase(),this.drawables.push(this.lastannotation.draw())),this.currentannotation.drawable&&this.currentannotation.drawable.erase(),this.drawables.push(this.currentannotation.draw())):(this.lastannotation=this.currentannotation,this.currentannotation=null,this.lastannotation&&this.lastannotation.drawable&&(this.lastannotation.drawable.erase(),this.drawables.push(this.lastannotation.draw())))),this.currentannotation&&(this.currentedit.annotationstart={x:this.currentannotation.x,y:this.currentannotation.y})))},edit_move:function(t){var e,i,n=this.get_canvas_bounds(),s=this.get_dialogue_element(J),a=this.get_dialogue_element(F),o=new M.assignfeedback_editpdf.point(t.clientX+s.get("docScrollX"),t.clientY+s.get("docScrollY")),r=this.get_canvas_coordinates(o);"textarea"!==document.activeElement.type&&(t.preventDefault(),r.x<0||r.x>n.width||r.y<0||r.y>n.height||("pen"===this.currentedit.tool&&this.currentedit.path.push(r),"select"===this.currentedit.tool?this.currentannotation&&this.currentedit&&this.currentannotation.move(this.currentedit.annotationstart.x+r.x-this.currentedit.start.x,this.currentedit.annotationstart.y+r.y-this.currentedit.start.y):"drag"===this.currentedit.tool?(e=r.x-this.currentedit.start.x,i=r.y-this.currentedit.start.y,a.getDOMNode().scrollLeft-=e,a.getDOMNode().scrollTop-=i):this.currentedit.start&&(this.currentedit.end=r,this.redraw_current_edit())))},edit_end:function(){var t,e,i,n;n=!1,(new Date).getTime()-this.currentedit.start<rt||!1===this.currentedit.start||("htmleditor"===this.currentedit.tool?(this.currentdrawable&&(this.currentdrawable.erase(),n=!0),this.currentdrawable=!1,(e=new M.assignfeedback_editpdf.htmlcomment(this)).init_from_edit(this.currentedit)&&(this.pages[this.currentpage].htmlcomments.push(e),this.drawables.push(e.draw()),n=!0)):"comment"===this.currentedit.tool?(this.currentdrawable&&(this.currentdrawable.erase(),n=!0),this.currentdrawable=!1,(t=new M.assignfeedback_editpdf.comment(this)).init_from_edit(this.currentedit)&&(this.pages[this.currentpage].comments.push(t),this.drawables.push(t.draw(!0)),n=this.editingcomment=!0)):(i=this.create_annotation(this.currentedit.tool,{}))&&(this.currentdrawable&&(this.currentdrawable.erase(),n=!0),this.currentdrawable=!1,i.init_from_edit(this.currentedit)&&(this.pages[this.currentpage].annotations.push(i),this.drawables.push(i.draw()),n=!0)),n&&this.save_current_page(),this.currentedit.starttime=0,this.currentedit.start=!1,this.currentedit.end=!1,this.currentedit.path=[])},resize:function(){var t,e;if(this.dialogue){if(!this.dialogue.get("visible"))return;this.dialogue.centerDialogue()}return(e=g.one("body").get("winHeight")-120)<100&&(e=100),t=this.get_dialogue_element(F),this.dialogue&&t.setStyle("maxHeight",e+"px"),this.redraw(),!0},create_annotation:function(t,e){return e.type=t,e.editor=this,"line"===t?new M.assignfeedback_editpdf.annotationline(e):"rectangle"===t?new M.assignfeedback_editpdf.annotationrectangle(e):"oval"===t?new M.assignfeedback_editpdf.annotationoval(e):"pen"===t?new M.assignfeedback_editpdf.annotationpen(e):"highlight"===t?new M.assignfeedback_editpdf.annotationhighlight(e):"stamp"===t?new M.assignfeedback_editpdf.annotationstamp(e):"htmleditor"===t&&new M.assignfeedback_editpdf.htmlcomment(e)},save_current_page:function(){this.clear_warnings(!1);var t,e=q;t={method:"post",context:this,sync:!1,data:{sesskey:M.cfg.sesskey,action:"savepage",index:this.currentpage,userid:this.get("userid"),attemptnumber:this.get("attemptnumber"),assignmentid:this.get("assignmentid"),
+page:this.stringify_current_page()},on:{success:function(t,e){var i;try{if((i=g.JSON.parse(e.responseText)).error)return new M.core.ajaxException(i);g.one(K).set("value","true"),this.warning(M.util.get_string("draftchangessaved","assignfeedback_editpdf"),!0)}catch(n){return new M.core.exception(n)}},failure:function(t,e){return new M.core.exception(e.responseText)}}},g.io(e,t)},open_search_comments:function(t){this.searchcommentswindow||(this.searchcommentswindow=new M.assignfeedback_editpdf.commentsearch({editor:this})),this.searchcommentswindow.show(),t.preventDefault()},open_htmleditor:function(t){this.htmleditorwindow||(this.htmleditorwindow=new M.assignfeedback_editpdf.htmleditor({editor:this})),this.htmleditorwindow.show(),t.preventDefault()},expandCollapseComments:function(){var t=g.all(".commentdrawable");this.collapsecomments?(this.collapsecomments=!1,t.removeClass("commentcollapsed")):(this.collapsecomments=!0,t.addClass("commentcollapsed"))},redraw:function(){var t,e;if((e=this.pages[this.currentpage])!==undefined){for(;0<this.drawables.length;)this.drawables.pop().erase();for(t=0;t<e.annotations.length;t++)this.drawables.push(e.annotations[t].draw());for(t=0;t<e.comments.length;t++)this.drawables.push(e.comments[t].draw(!1));for(t=0;t<e.htmlcomments.length;t++)this.drawables.push(e.htmlcomments[t].draw())}},clear_warnings:function(t){var e=this.get_dialogue_element(V);t?e.empty():e.all(".alert-info").remove(!0)},change_page:function(){var t,e,i,n=this.get_dialogue_element(J);e=this.get_dialogue_element(z),i=this.get_dialogue_element(R),0<this.currentpage?e.removeAttribute("disabled"):e.setAttribute("disabled","true"),this.currentpage<this.pagecount-1?i.removeAttribute("disabled"):i.setAttribute("disabled","true"),t=this.pages[this.currentpage],this.loadingicon&&this.loadingicon.hide(),n.setStyle("backgroundImage",'url("'+t.url+'")'),n.setStyle("width",t.width+"px"),n.setStyle("height",t.height+"px"),n.scrollIntoView(),this.get_dialogue_element(P).set("selectedIndex",this.currentpage),this.resize()},setup_navigation:function(){var t,e,i,n,s,a=this.get_dialogue_element(P),o=a.all("option");if(o.size()<=1)for(t=0;t<this.pages.length;t++)(i=g.Node.create("<option/>")).setAttribute("value",t),e={page:t+1,total:this.pages.length},i.setHTML(M.util.get_string("pagexofy","assignfeedback_editpdf",e)),a.append(i);a.removeAttribute("disabled"),a.on("change",function(){this.currentpage=a.get("value"),this.clear_warnings(!1),this.change_page()},this),n=this.get_dialogue_element(z),s=this.get_dialogue_element(R),n.on("click",this.previous_page,this),n.on("key",this.previous_page,"down:13",this),s.on("click",this.next_page,this),s.on("key",this.next_page,"down:13",this)},previous_page:function(t){t.preventDefault(),this.currentpage--,this.currentpage<0&&(this.currentpage=0),this.clear_warnings(!1),this.change_page()},next_page:function(t){t.preventDefault(),this.currentpage++,this.currentpage>=this.pages.length&&(this.currentpage=this.pages.length-1),this.clear_warnings(!1),this.change_page()},move_canvas:function(){var t,e,i,n;for(t=this.get_dialogue_element(F),e=parseInt(t.get("scrollLeft"),10),i=parseInt(t.get("scrollTop"),10),n=0;n<this.drawables.length;n++)this.drawables[n].scroll_update(e,i)},rotatePDF:function(l,t){var u,e,i,n,s,a;if(l.preventDefault(),!this.get("destroyed")){for((u=this).oldannotationcoordinates=[],i=this.pages[this.currentpage].annotations,e=0;e<i.length;e++)n=i[e],this.oldannotationcoordinates.push([n.x,n.y]);s=q,a={method:"post",context:this,sync:!1,data:{sesskey:M.cfg.sesskey,action:"rotatepage",index:this.currentpage,userid:this.get("userid"),attemptnumber:this.get("attemptnumber"),assignmentid:this.get("assignmentid"),rotateleft:t},on:{success:function(t,e){var i,n,s,a,o,r,d,h,c;try{for(i=g.JSON.parse(e.responseText),(n=u.pages[u.currentpage]).url=i.page.url,n.width=i.page.width,n.height=i.page.height,u.loadingicon.hide(),(s=u.get_dialogue_element(J)).setStyle("backgroundImage",'url("'+n.url+'")'),s.setStyle("width",n.width+"px"),s.setStyle("height",n.height+"px"),o=n.annotations,a=0;a<o.length;a++)u.oldannotationcoordinates&&u.oldannotationcoordinates[a]&&(r=u.oldannotationcoordinates[a][0],d=u.oldannotationcoordinates[a][1],o[a].move(r,d));for(h=n.comments,a=0;a<h.length;a++)h[a].updatePosition();for(c=n.htmlcomments,a=0;a<c.length;a++)c[a].updatePosition();return u.save_current_page()}catch(l){return new M.core.exception(l)}},failure:function(t,e){return new M.core.exception(e.responseText)}}},g.io(s,a)}},event_listener_options_supported:function(){var t,e=!1,i="testpassiveeventoptions";try{t=Object.defineProperty({},"passive",{get:function(){e=!0}}),document.addEventListener(i,t,t),document.removeEventListener(i,t,t)}catch(n){e=!1}return e},disable_touch_scroll:function(){this.event_listener_options_supported()&&document.addEventListener("touchmove",this.stop_touch_scroll.bind(this),{passive:!1})},stop_touch_scroll:function(t){this.get_dialogue_element(F).contains(t.target)&&(t.stopPropagation(),t.preventDefault())}},g.extend(N,g.Base,N.prototype,{NAME:"moodle-assignfeedback_editpdf-editor",ATTRS:{userid:{validator:g.Lang.isInteger,value:0},assignmentid:{validator:g.Lang.isInteger,value:0},attemptnumber:{validator:g.Lang.isInteger,value:0},header:{validator:g.Lang.isString,value:""},body:{validator:g.Lang.isString,value:""},footer:{validator:g.Lang.isString,value:""},linkid:{validator:g.Lang.isString,value:""},deletelinkid:{validator:g.Lang.isString,value:""},readonly:{validator:g.Lang.isBoolean,value:!0},stampfiles:{validator:g.Lang.isArray,value:""}}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.editor=M.assignfeedback_editpdf.editor||{},M.assignfeedback_editpdf.editor.init=M.assignfeedback_editpdf.editor.init||function(t){return M.assignfeedback_editpdf.instance=new N(t),M.assignfeedback_editpdf.instance},A=function(t){t.draggable=!0,t.centered=!0,t.width="auto",t.visible=!1,t.headerContent=M.util.get_string(
+"htmleditor","assignfeedback_editpdf"),t.footerContent="",t.closeButton=!1,A.superclass.constructor.apply(this,[t])},T="htmleditor",g.extend(A,M.core.dialogue,{editor:null,initializer:function(t){var e,i;this.editor=t.editor||null,this.get("boundingBox").addClass("assignfeedback_editpdf_htmleditor"),this.get("editor"),e=g.Node.create("<div/>"),(i=g.one("#editorcontainer")).removeClass("hidden"),e.append(i),g.one('[name="savechanges"]').on("click",this.removeeditor),g.one('[name="saveandshownext"]').on("click",this.removeeditor),this.set("bodyContent",e),A.superclass.initializer.call(this,t),this.addButton({name:"confirm",label:M.util.get_string("confirm","moodle"),action:function(t){t.preventDefault(),this.hide()},classNames:"btn btn-primary",section:g.WidgetStdMod.FOOTER}),this.addButton({name:"cancel",label:M.util.get_string("cancel","moodle"),action:function(t){t.preventDefault(),g.one("#html_editor").set("value"," "),this.hide()},classNames:"btn btn-secondary",section:g.WidgetStdMod.FOOTER})},removeeditor:function(){g.one(".assignfeedback_editpdf_htmleditor")&&g.one(".assignfeedback_editpdf_htmleditor").remove()}},{NAME:T,ATTRS:{editor:{value:null}}}),g.Base.modifyAttrs(A,{modal:{getter:function(){return!0}}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.htmleditor=A,D=function(d,t,e,i,n,s,a,o){this.editor=d,this.gradeid=t||0,this.x=parseInt(i,10)||0,this.y=parseInt(n,10)||0,this.width=parseInt(s,10)||0,this.rawtext=o||"",this.pageno=e||0,this.colour=a||"yellow",this.drawable=!1,this.deleteme=!1,this.menulink=null,this.menu=null,this.clean=function(){return{gradeid:this.gradeid,x:parseInt(this.x,10),y:parseInt(this.y,10),width:parseInt(this.width,10),rawtext:this.rawtext,pageno:parseInt(this.pageno,10),colour:this.colour}},this.draw=function(t){var e,i,n,s,a,o,r=new M.assignfeedback_editpdf.drawable(this.editor),d=this.editor.get_dialogue_element(J);return n=g.Node.create('<a href="#"><img src="'+M.util.image_url("t/contextmenu","core")+'"/></a>'),(i=t||g.Node.create("<div/>")).addClass("htmlcomment"),e=g.Node.create('<div class="htmlcommentdrawable"/>'),this.menulink=n,""===this.rawtext.replace(/^\s+|\s+$/g,"")&&(o=g.one("#html_editor"),this.rawtext=o.get("value")),n.setAttribute("tabindex","0"),this.editor.get("readonly")?i.setAttribute("readonly","readonly"):e.append(n),this.width<200&&(this.width=200),i.set("innerHTML",this.rawtext),g.use("mathjax",function(){window.MathJax.Hub.Queue(["Typeset",window.MathJax.Hub,i.getDOMNode()])}),a=i.get("scrollHeight"),i.setStyles({height:a+"px"}),s=this.editor.get_window_coordinates(new M.assignfeedback_editpdf.point(this.x,this.y)),i.setStyles({width:this.width+"px"}),e.append(i),d.append(e),e.setStyle("position","absolute"),e.setX(s.x),e.setY(s.y),r.store_position(e,s.x,s.y),this.editor.get("readonly")||(i.on("gesturemovestart",this.editor.edit_start,null,this.editor),i.on("gesturemove",this.editor.edit_move,null,this.editor),i.on("gesturemoveend",this.editor.edit_end,null,this.editor)),r.nodes.push(e),this.attach_events(i,n),this.drawable=r,i.focus(),this.width=parseInt(i.getStyle("width"),10),""===this.rawtext.replace(/^\s+|\s+$/g,"")&&(this.deleteme=!0,g.later(400,this,this.delete_htmlcomment_later),0!==document.getElementsByClassName("dir-rtl").length?g.one("#html_editoreditable").set("innerHTML",'<p dir="rtl" style="text-align: right;"><br></p>'):g.one("#html_editoreditable").set("innerHTML",'<p dir="ltr" style="text-align: left;"><br></p>'),this.editor.htmleditorwindow||(this.editor.htmleditorwindow=new M.assignfeedback_editpdf.htmleditor({editor:this}))),i.active=!1,""!==this.rawtext.replace(/^\s+|\s+$/g,"")&&(t&&this.editor.save_current_page(),this.drawable=r,o&&(o.set("value"," "),0!==document.getElementsByClassName("dir-rtl").length?g.one("#html_editoreditable").set("innerHTML",'<p dir="rtl" style="text-align: right;"><br></p>'):g.one("#html_editoreditable").set("innerHTML",'<p dir="ltr" style="text-align: left;"><br></p>'))),r},this.delete_htmlcomment_later=function(){this.deleteme&&this.remove()},this.attach_events=function(o,t){var r=o.ancestor("div");this.editor.get("readonly")||(t.setData("htmlcomment",this),o.on("gesturemovestart",function(t){"select"===d.currentedit.tool&&(t.preventDefault(),o.setData("offsetx",t.clientX-r.getX()),o.setData("offsety",t.clientY-r.getY()))}),o.on("gesturemove",function(t){if("select"===d.currentedit.tool){var e,i,n,s=t.clientX-o.getData("offsetx"),a=t.clientY-o.getData("offsety");!0!==o.getData("clicking")&&o.setData("clicking",!0),e=this.editor.get_canvas_coordinates(new M.assignfeedback_editpdf.point(s,a)),(n=this.editor.get_canvas_bounds(!0)).x=0,n.y=0,n.width-=24,n.height-=24,e.clip(n),this.x=e.x,this.y=e.y,i=this.editor.get_window_coordinates(e),r.setX(i.x),r.setY(i.y),this.drawable.store_position(r,i.x,i.y)}},null,this),this.menu=new M.assignfeedback_editpdf.htmlcommentmenu({buttonNode:this.menulink,htmlcomment:this}))},this.remove=function(){var t=0,e=this.editor.pages[this.editor.currentpage].htmlcomments;for(t=0;t<e.length;t++)if(e[t]===this)return e.splice(t,1),this.drawable.erase(),void this.editor.save_current_page()},this.draw_current_edit=function(t){var e,i,n=new M.assignfeedback_editpdf.rect,s=new M.assignfeedback_editpdf.drawable(this.editor),a=this.editor.get_dialogue_element(F);return n.bound([t.start,t.end]),i=this.editor.get_window_coordinates(new M.assignfeedback_editpdf.point(n.x,n.y)),(e=g.Node.create("<div/>")).setStyles({position:"absolute",display:"inline-block",width:n.width,height:n.height,backgroundSize:"100% 100%"}),a.append(e),e.setX(i.x),e.setY(i.y),s.store_position(e,i.x,i.y),s.nodes.push(e),s},this.init_from_edit=function(t){var e=new M.assignfeedback_editpdf.rect;return e.bound([t.start,t.end]),e.width<40&&(e.width=40),e.height<40&&(e.height=40),this.gradeid=this.editor.get("gradeid"),this.pageno=this.editor.currentpage,this.x=e.x,this.y=e.y,this.endx=e.x+e.width,this.endy=e.y+e.height,!(this.rawtext="")},
+this.updatePosition=function(){var t=this.drawable.nodes[0].one("div"),e=t.ancestor("div"),i=new M.assignfeedback_editpdf.point(this.x,this.y),n=this.editor.get_window_coordinates(i);e.setX(n.x),e.setY(n.y),this.drawable.store_position(e,n.x,n.y)},this.edit_htmlcomment=function(t){var e,i,n,s;t.preventDefault(),this.menu.hide(),n=this.drawable.nodes[0].one("div"),e=g.one("#html_editoreditable"),i=this.rawtext,e.set("innerHTML",this.rawtext),this.editor.htmleditorwindow||(this.editor.htmleditorwindow=new M.assignfeedback_editpdf.htmleditor({editor:this})),(s=this.editor.htmleditorwindow).getButton("cancel",g.WidgetStdMod.FOOTER).on("click",function(t){t.preventDefault(),this.rawtext=i,s.hide()},this),s.getButton("confirm",g.WidgetStdMod.FOOTER).on("click",function(){var t=g.one("#html_editor");this.rawtext=t.get("value"),this.draw(n),s.hide()},this),s.show()}},M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.htmlcomment=D,I="Htmlcommentmenu",C=function(t){C.superclass.constructor.apply(this,[t])},g.extend(C,M.assignfeedback_editpdf.dropdown,{initializer:function(t){var e,i,n,s;s=this.get("htmlcomment"),e=g.Node.create('<ul role="menu" class="assignfeedback_editpdf_menu"/>'),(i=g.Node.create('<li><a tabindex="-1" href="#">'+M.util.get_string("edithtml","assignfeedback_editpdf")+"</a></li>")).on("click",s.edit_htmlcomment,s),i.on("key",s.edit_htmlcomment,"enter,space",s),e.append(i),(i=g.Node.create('<li><a tabindex="-1" href="#">'+M.util.get_string("deletecomment","assignfeedback_editpdf")+"</a></li>")).on("click",function(t){t.preventDefault(),this.menu.hide(),this.remove()},s),i.on("key",function(){s.menu.hide(),s.remove()},"enter,space",s),e.append(i),i=g.Node.create("<li><hr/></li>"),e.append(i),this.set("headerText",M.util.get_string("commentcontextmenu","assignfeedback_editpdf")),(n=g.Node.create("<div/>")).append(e),this.set("bodyContent",n),C.superclass.initializer.call(this,t)}},{NAME:I,ATTRS:{htmlcomment:{value:null}}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.htmlcommentmenu=C},"@VERSION@",{requires:["base","event","node","io","graphics","json","event-move","event-resize","transition","querystring-stringify-simple","moodle-core-notification-dialog","moodle-core-notification-alert","moodle-core-notification-warning","moodle-core-notification-exception","moodle-core-notification-ajaxexception"]});
\ No newline at end of file
Index: mod/assign/feedback/editpdf/yui/build/moodle-assignfeedback_editpdf-editor/moodle-assignfeedback_editpdf-editor.js
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/mod/assign/feedback/editpdf/yui/build/moodle-assignfeedback_editpdf-editor/moodle-assignfeedback_editpdf-editor.js b/mod/assign/feedback/editpdf/yui/build/moodle-assignfeedback_editpdf-editor/moodle-assignfeedback_editpdf-editor.js
--- a/mod/assign/feedback/editpdf/yui/build/moodle-assignfeedback_editpdf-editor/moodle-assignfeedback_editpdf-editor.js	(revision 2729694d4d56ca2c88bb180aee3f254f8be906cf)
+++ b/mod/assign/feedback/editpdf/yui/build/moodle-assignfeedback_editpdf-editor/moodle-assignfeedback_editpdf-editor.js	(revision 0b9764ed79311babea3acc01b01be2b999f9ec4f)
@@ -41,6 +41,7 @@
         SAVE: '.savebutton',
         COMMENTCOLOURBUTTON: '.commentcolourbutton',
         COMMENTMENU: '.commentdrawable a',
+        HTMLCOMMENTMENU: '.htmlcommentdrawable a',
         ANNOTATIONCOLOURBUTTON:  '.annotationcolourbutton',
         DELETEANNOTATIONBUTTON: '.deleteannotationbutton',
         WARNINGMESSAGECONTAINER: '.warningmessages',
@@ -51,6 +52,7 @@
         USERINFOREGION: '[data-region="user-info"]',
         ROTATELEFTBUTTON: '.rotateleftbutton',
         ROTATERIGHTBUTTON: '.rotaterightbutton',
+        HTMLEDITORBUTTON: '.htmleditorbutton',
         DIALOGUE: '.' + CSS.DIALOGUE
     },
     SELECTEDBORDERCOLOUR = 'rgba(200, 200, 255, 0.9)',
@@ -82,7 +84,8 @@
         'stamp': '.stampbutton',
         'select': '.selectbutton',
         'drag': '.dragbutton',
-        'highlight': '.highlightbutton'
+        'highlight': '.highlightbutton',
+        'htmleditor': '.htmleditorbutton'
     },
     STROKEWEIGHT = 4;
 // This file is part of Moodle - http://moodle.org/
@@ -3481,6 +3484,13 @@
      */
     searchcommentswindow: null,
 
+    /**
+     * The search comments window.
+     * @property searchcommentswindow
+     * @type M.core.dialogue
+     * @protected
+     */
+    htmleditorwindow: null,
 
     /**
      * The selected stamp picture.
@@ -3508,6 +3518,16 @@
      */
     editingcomment: false,
 
+    /**
+     * Prevent new comments from appearing
+     * immediately after clicking off a current
+     * comment
+     * @property editinghtmlcomment
+     * @type Boolean
+     * @public
+     */
+    editinghtmlcomment: false,
+
     /**
      * Should inactive comments be collapsed?
      *
@@ -3893,7 +3913,7 @@
      * @method prepare_pages_for_display
      */
     prepare_pages_for_display: function(data) {
-        var i, j, comment, error, annotation, readonly;
+        var i, j, comment, htmlcomment, error, annotation, readonly;
 
         if (!data.pagecount) {
             if (this.dialogue) {
@@ -3919,6 +3939,17 @@
                                                                                  comment.colour,
                                                                                  comment.rawtext);
             }
+            for (j = 0; j < this.pages[i].htmlcomments.length; j++) {
+                htmlcomment = this.pages[i].htmlcomments[j];
+                this.pages[i].htmlcomments[j] = new M.assignfeedback_editpdf.htmlcomment(this,
+                    htmlcomment.gradeid,
+                    htmlcomment.pageno,
+                    htmlcomment.x,
+                    htmlcomment.y,
+                    htmlcomment.width,
+                    htmlcomment.colour,
+                    htmlcomment.rawtext);
+            }
             for (j = 0; j < this.pages[i].annotations.length; j++) {
                 annotation = this.pages[i].annotations[j];
                 this.pages[i].annotations[j] = this.create_annotation(annotation.type, annotation);
@@ -4086,8 +4117,14 @@
             currentstampbutton,
             stampfiles,
             picker,
-            filename;
+            filename,
+            htmleditorbutton;
 
+        htmleditorbutton = this.get_dialogue_element(SELECTOR.HTMLEDITORBUTTON);
+        if(htmleditorbutton !== null &&  htmleditorbutton !== 'unknown') {
+            htmleditorbutton.on('click', this.open_htmleditor, this);
+            htmleditorbutton.on('key', this.open_htmleditor, 'down:13', this);
+        }
         searchcommentsbutton = this.get_dialogue_element(SELECTOR.SEARCHCOMMENTSBUTTON);
         searchcommentsbutton.on('click', this.open_search_comments, this);
         searchcommentsbutton.on('key', this.open_search_comments, 'down:13', this);
@@ -4202,7 +4239,7 @@
         currenttoolnode.setAttribute('aria-pressed', 'false');
         this.currentedit.tool = tool;
 
-        if (tool !== "comment" && tool !== "select" && tool !== "drag" && tool !== "stamp") {
+        if (tool !== "htmleditor" && tool !== "comment" && tool !== "select" && tool !== "drag" && tool !== "stamp") {
             this.lastannotationtool = tool;
         }
 
@@ -4217,10 +4254,13 @@
      */
     stringify_current_page: function() {
         var comments = [],
+            htmlcomments = [],
             annotations = [],
             page,
             i = 0;
-
+        for (i = 0; i < this.pages[this.currentpage].htmlcomments.length; i++) {
+            htmlcomments[i] = this.pages[this.currentpage].htmlcomments[i].clean();
+        }
         for (i = 0; i < this.pages[this.currentpage].comments.length; i++) {
             comments[i] = this.pages[this.currentpage].comments[i].clean();
         }
@@ -4228,7 +4268,7 @@
             annotations[i] = this.pages[this.currentpage].annotations[i].clean();
         }
 
-        page = {comments: comments, annotations: annotations};
+        page = {comments: comments, annotations: annotations, htmlcomments: htmlcomments};
 
         return Y.JSON.stringify(page);
     },
@@ -4240,6 +4280,7 @@
      */
     get_current_drawable: function() {
         var comment,
+            htmlcomment,
             annotation,
             drawable = false;
 
@@ -4250,6 +4291,9 @@
         if (this.currentedit.tool === 'comment') {
             comment = new M.assignfeedback_editpdf.comment(this);
             drawable = comment.draw_current_edit(this.currentedit);
+        } else if (this.currentedit.tool === 'htmleditor') {
+                htmlcomment = new M.assignfeedback_editpdf.htmlcomment(this);
+                drawable = htmlcomment.draw_current_edit(this.currentedit);
         } else {
             annotation = this.create_annotation(this.currentedit.tool, {});
             if (annotation) {
@@ -4312,6 +4356,9 @@
         if (this.editingcomment) {
             return;
         }
+        if (this.editinghtmlcomment) {
+            return;
+        }
 
         this.currentedit.starttime = new Date().getTime();
         this.currentedit.start = point;
@@ -4423,17 +4470,32 @@
     edit_end: function() {
         var duration,
             comment,
-            annotation;
+            htmlcomment,
+            annotation,
+            needsaved;
 
         duration = new Date().getTime() - this.currentedit.start;
+        needsaved = false;
 
         if (duration < CLICKTIMEOUT || this.currentedit.start === false) {
             return;
         }
-
-        if (this.currentedit.tool === 'comment') {
+        if (this.currentedit.tool === 'htmleditor') {
+            if (this.currentdrawable) {
+                this.currentdrawable.erase();
+                needsaved = true;
+            }
+            this.currentdrawable = false;
+            htmlcomment = new M.assignfeedback_editpdf.htmlcomment(this);
+            if (htmlcomment.init_from_edit(this.currentedit)) {
+                this.pages[this.currentpage].htmlcomments.push(htmlcomment);
+                this.drawables.push(htmlcomment.draw());
+                needsaved = true;
+            }
+        } else if (this.currentedit.tool === 'comment') {
             if (this.currentdrawable) {
                 this.currentdrawable.erase();
+                needsaved = true;
             }
             this.currentdrawable = false;
             comment = new M.assignfeedback_editpdf.comment(this);
@@ -4441,23 +4503,28 @@
                 this.pages[this.currentpage].comments.push(comment);
                 this.drawables.push(comment.draw(true));
                 this.editingcomment = true;
+                needsaved = true;
             }
         } else {
             annotation = this.create_annotation(this.currentedit.tool, {});
             if (annotation) {
                 if (this.currentdrawable) {
                     this.currentdrawable.erase();
+                    needsaved = true;
                 }
                 this.currentdrawable = false;
                 if (annotation.init_from_edit(this.currentedit)) {
                     this.pages[this.currentpage].annotations.push(annotation);
                     this.drawables.push(annotation.draw());
+                    needsaved = true;
                 }
             }
         }
 
         // Save the changes.
+        if (needsaved) {
         this.save_current_page();
+        }
 
         // Reset the current edit.
         this.currentedit.starttime = 0;
@@ -4514,6 +4581,8 @@
             return new M.assignfeedback_editpdf.annotationhighlight(data);
         } else if (type === "stamp") {
             return new M.assignfeedback_editpdf.annotationstamp(data);
+        } else if (type === "htmleditor") {
+            return new M.assignfeedback_editpdf.htmlcomment(data);
         }
         return false;
     },
@@ -4582,7 +4651,24 @@
         this.searchcommentswindow.show();
         e.preventDefault();
     },
+    /**
+     * Event handler to open the comment search interface.
+     *
+     * @param Event e
+     * @protected
+     * @method open_htmleditor
+     */
+    open_htmleditor: function(e) {
+        if (!this.htmleditorwindow) {
+            this.htmleditorwindow = new M.assignfeedback_editpdf.htmleditor({
+                editor: this
+            });
+        }
 
+        this.htmleditorwindow.show();
+
+        e.preventDefault();
+    },
     /**
      * Toggle function to expand/collapse all comments on page.
      *
@@ -4624,6 +4710,9 @@
         for (i = 0; i < page.comments.length; i++) {
             this.drawables.push(page.comments[i].draw(false));
         }
+        for (i = 0; i < page.htmlcomments.length; i++) {
+            this.drawables.push(page.htmlcomments[i].draw());
+        }
     },
 
     /**
@@ -4854,6 +4943,15 @@
                         for (i = 0; i < oldcomments.length; i++) {
                             oldcomments[i].updatePosition();
                         }
+
+                        /**
+                         * Update Position of htmlcomments with relation to canvas coordinates.
+                         * Without this code, the htmlcomments will stay at their positions in windows/document coordinates.
+                         */
+                        var oldhtmlcomments = page.htmlcomments;
+                        for (i = 0; i < oldhtmlcomments.length; i++) {
+                            oldhtmlcomments[i].updatePosition();
+                        }
                         // Save Annotations.
                         return self.save_current_page();
                     } catch (e) {
@@ -4981,6 +5079,706 @@
     M.assignfeedback_editpdf.instance = new EDITOR(params);
     return M.assignfeedback_editpdf.instance;
 };
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+
+/**
+ * Provides an in browser PDF editor.
+ *
+ * @module moodle-assignfeedback_editpdf-editor
+ */
+
+/**
+ * Class representing a list of reach text.
+ *
+ * @namespace M.assignfeedback_editpdf
+ * @class htmleditor
+ * @constructor
+ * @extends M.core.dialogue
+ */
+var HTMLEDITOR = function(config) {
+    config.draggable = true;
+    config.centered = true;
+    config.width = 'auto';
+    config.visible = false;
+    config.headerContent = M.util.get_string('htmleditor', 'assignfeedback_editpdf');
+    config.footerContent = '';
+    config.closeButton = false;
+    HTMLEDITOR.superclass.constructor.apply(this, [config]);
+};
+
+var HTMLEDITORNAME = "htmleditor";
+
+
+Y.extend(HTMLEDITOR, M.core.dialogue, {
+    /**
+     * Initialise the menu.
+     *
+     * @method initializer
+     * @return void
+     */
+    editor: null,
+    initializer: function(config) {
+        var editorr,
+            container,
+            textarea,
+            bb;
+        this.editor = config.editor || null;
+        bb = this.get('boundingBox');
+        bb.addClass('assignfeedback_editpdf_htmleditor');
+        editorr = this.get('editor');
+        container = Y.Node.create('<div/>');
+        textarea = Y.one('#editorcontainer');
+        textarea.removeClass('hidden');
+        container.append(textarea);
+
+        Y.one('[name="savechanges"]').on('click', this.removeeditor);
+        Y.one('[name="saveandshownext"]').on('click', this.removeeditor);
+        // Set the body content.
+        this.set('bodyContent', container);
+        HTMLEDITOR.superclass.initializer.call(this, config);
+        this.addButton({
+            name: 'confirm',
+            label: M.util.get_string('confirm', 'moodle'),
+            action: function(e) {
+                e.preventDefault();
+                this.hide();
+            },
+            classNames: 'btn btn-primary',
+            section: Y.WidgetStdMod.FOOTER
+        });
+        this.addButton({
+            name: 'cancel',
+            label: M.util.get_string('cancel', 'moodle'),
+            action: function(e) {
+                e.preventDefault();
+                Y.one('#html_editor').set('value', ' ');
+                this.hide();
+            },
+            classNames: 'btn btn-secondary',
+            section: Y.WidgetStdMod.FOOTER
+        });
+
+    },
+    removeeditor: function () {
+        if (Y.one(".assignfeedback_editpdf_htmleditor")) {
+            Y.one(".assignfeedback_editpdf_htmleditor").remove();
+        }
+    }
+},{
+    NAME: HTMLEDITORNAME,
+    ATTRS: {
+        /**
+         * The editor this search window is attached to.
+         *
+         * @attribute editor
+         * @type M.assignfeedback_editpdf.editor
+         * @default null
+         */
+        editor: {
+            value: null
+        }
+
+    }
+});
+Y.Base.modifyAttrs(HTMLEDITOR, {
+    /**
+     * Whether the widget should be modal or not.
+     *
+     * Moodle override: We override this for commentsearch to force it always true.
+     *
+     * @attribute Modal
+     * @type Boolean
+     * @default true
+     */
+    modal: {
+        getter: function() {
+            return true;
+        }
+    }
+});
+M.assignfeedback_editpdf = M.assignfeedback_editpdf || {};
+M.assignfeedback_editpdf.htmleditor = HTMLEDITOR;
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * Provides an in browser PDF editor.
+ *
+ * @module moodle-assignfeedback_editpdf-editor
+ */
+
+/**
+ * Class representing a list of htmlcomments.
+ *
+ * @namespace M.assignfeedback_editpdf
+ * @class htmlcomment
+ * @param M.assignfeedback_editpdf.editor editor
+ * @param Int gradeid
+ * @param Int pageno
+ * @param Int x
+ * @param Int y
+ * @param Int width
+ * @param String colour
+ * @param String rawtext
+ */
+var HTMLCOMMENT = function(editor, gradeid, pageno, x, y, width, colour, rawtext) {
+
+    /**
+     * Reference to M.assignfeedback_editpdf.editor.
+     * @property editor
+     * @type M.assignfeedback_editpdf.editor
+     * @public
+     */
+    this.editor = editor;
+
+    /**
+     * Grade id
+     * @property gradeid
+     * @type Int
+     * @public
+     */
+    this.gradeid = gradeid || 0;
+
+    /**
+     * X position
+     * @property x
+     * @type Int
+     * @public
+     */
+    this.x = parseInt(x, 10) || 0;
+
+    /**
+     * Y position
+     * @property y
+     * @type Int
+     * @public
+     */
+    this.y = parseInt(y, 10) || 0;
+
+    /**
+     * Htmlcomment width
+     * @property width
+     * @type Int
+     * @public
+     */
+    this.width = parseInt(width, 10) || 0;
+
+    /**
+     * Htmlcomment rawtext
+     * @property rawtext
+     * @type String
+     * @public
+     */
+    this.rawtext = rawtext || '';
+
+    /**
+     * Htmlcomment page number
+     * @property pageno
+     * @type Int
+     * @public
+     */
+    this.pageno = pageno || 0;
+
+    /**
+     * Htmlcomment background colour.
+     * @property colour
+     * @type String
+     * @public
+     */
+    this.colour = colour || 'yellow';
+
+    /**
+     * Reference to M.assignfeedback_editpdf.drawable
+     * @property drawable
+     * @type M.assignfeedback_editpdf.drawable
+     * @public
+     */
+    this.drawable = false;
+
+    /**
+     * Boolean used by a timeout to delete empty htmlcomments after a short delay.
+     * @property deleteme
+     * @type Boolean
+     * @public
+     */
+    this.deleteme = false;
+
+    /**
+     * Reference to the link that opens the menu.
+     * @property menulink
+     * @type Y.Node
+     * @public
+     */
+    this.menulink = null;
+
+    /**
+     * Reference to the dialogue that is the context menu.
+     * @property menu
+     * @type M.assignfeedback_editpdf.dropdown
+     * @public
+     */
+    this.menu = null;
+
+    /**
+     * Clean a htmlcomment record, returning an oject with only fields that are valid.
+     * @public
+     * @method clean
+     * @return {}
+     */
+    this.clean = function() {
+        return {
+            gradeid: this.gradeid,
+            x: parseInt(this.x, 10),
+            y: parseInt(this.y, 10),
+            width: parseInt(this.width, 10),
+            rawtext: this.rawtext,
+            pageno: parseInt(this.pageno, 10),
+            colour: this.colour
+        };
+    };
+
+    /**
+     * Draw a htmlcomment.
+     * @public
+     * @method draw
+     * @return M.assignfeedback_editpdf.drawable
+     */
+    this.draw = function(editnode) {
+        var drawable = new M.assignfeedback_editpdf.drawable(this.editor),
+            drawingcanvas = this.editor.get_dialogue_element(SELECTOR.DRAWINGCANVAS),
+            container,
+            node,
+            menu,
+            position,
+            scrollheight,
+            textarea;
+        menu = Y.Node.create('<a href="#"><img src="' + M.util.image_url('t/contextmenu', 'core') + '"/></a>');
+        // // Lets add a contenteditable div.
+        node = editnode || Y.Node.create('<div/>');
+        node.addClass('htmlcomment');
+        container = Y.Node.create('<div class="htmlcommentdrawable"/>');
+        this.menulink = menu;
+        if (this.rawtext.replace(/^\s+|\s+$/g, "") === '') {
+            textarea = Y.one('#html_editor');
+            this.rawtext = textarea.get('value');
+        }
+        menu.setAttribute('tabindex', '0');
+        if (!this.editor.get('readonly')) {
+            container.append(menu);
+        } else {
+            node.setAttribute('readonly', 'readonly');
+        }
+        if (this.width < 200) {
+            this.width = 200;
+        }
+        node.set('innerHTML', this.rawtext);
+        Y.use('mathjax', function() {
+            window.MathJax.Hub.Queue(["Typeset", window.MathJax.Hub, node.getDOMNode()]);
+        });
+        scrollheight = node.get('scrollHeight');
+        node.setStyles({
+            'height': scrollheight + 'px'
+        });
+        position = this.editor.get_window_coordinates(new M.assignfeedback_editpdf.point(this.x, this.y));
+        node.setStyles({
+            width: this.width + 'px'
+        });
+        container.append(node);
+        drawingcanvas.append(container);
+        container.setStyle('position', 'absolute');
+        container.setX(position.x);
+        container.setY(position.y);
+        drawable.store_position(container, position.x, position.y);
+
+        // Bind events only when editing.
+        if (!this.editor.get('readonly')) {
+            // Pass through the event handlers on the div.
+            node.on('gesturemovestart', this.editor.edit_start, null, this.editor);
+            node.on('gesturemove', this.editor.edit_move, null, this.editor);
+            node.on('gesturemoveend', this.editor.edit_end, null, this.editor);
+        }
+        drawable.nodes.push(container);
+
+        this.attach_events(node, menu);
+        this.drawable = drawable;
+
+        node.focus();
+        this.width = parseInt(node.getStyle('width'), 10);
+
+        // Trim.
+        if (this.rawtext.replace(/^\s+|\s+$/g, "") === '') {
+            // Delete empty htmlcomments.
+            this.deleteme = true;
+            Y.later(400, this, this.delete_htmlcomment_later);
+            if (document.getElementsByClassName('dir-rtl').length !== 0) {
+                Y.one('#html_editoreditable').set('innerHTML', '<p dir="rtl" style="text-align: right;"><br></p>');
+            } else {
+                Y.one('#html_editoreditable').set('innerHTML', '<p dir="ltr" style="text-align: left;"><br></p>');
+            }
+            if (!this.editor.htmleditorwindow) {
+                this.editor.htmleditorwindow = new M.assignfeedback_editpdf.htmleditor({
+                    editor: this
+                });
+            }
+        }
+        node.active = false;
+        if (this.rawtext.replace(/^\s+|\s+$/g, "") !== '') {
+            if (editnode) {
+                this.editor.save_current_page();
+            }
+            this.drawable = drawable;
+            if (textarea) {
+                textarea.set('value', ' ');
+                if (document.getElementsByClassName('dir-rtl').length !== 0) {
+                    Y.one('#html_editoreditable').set('innerHTML', '<p dir="rtl" style="text-align: right;"><br></p>');
+                } else {
+                    Y.one('#html_editoreditable').set('innerHTML', '<p dir="ltr" style="text-align: left;"><br></p>');
+                }
+            }
+        }
+        return drawable;
+    };
+
+    /**
+     * Delete an empty htmlcomment if it's menu hasn't been opened in time.
+     * @method delete_htmlcomment_later
+     */
+    this.delete_htmlcomment_later = function() {
+        if (this.deleteme) {
+            this.remove();
+        }
+    };
+
+    /**
+     * Htmlomment nodes have a bunch of event handlers attached to them directly.
+     * This is all done here for neatness.
+     *
+     * @protected
+     * @method attach_htmlcomment_events
+     * @param node - The Y.Node representing the htmlcomment.
+     * @param menu - The Y.Node representing the menu.
+     */
+    this.attach_events = function(node, menu) {
+        var container = node.ancestor('div');
+
+        if (!this.editor.get('readonly')) {
+            // For delegated event handler.
+            menu.setData('htmlcomment', this);
+
+            node.on('gesturemovestart', function(e) {
+                if (editor.currentedit.tool === 'select') {
+                    e.preventDefault();
+                    node.setData('offsetx', e.clientX - container.getX());
+                    node.setData('offsety', e.clientY - container.getY());
+                }
+            });
+            node.on('gesturemove', function(e) {
+                if (editor.currentedit.tool === 'select') {
+                    var x = e.clientX - node.getData('offsetx'),
+                        y = e.clientY - node.getData('offsety'),
+                        newlocation,
+                        windowlocation,
+                        bounds;
+
+                    if (node.getData('clicking') !== true) {
+                        node.setData('clicking', true);
+                    }
+
+                    newlocation = this.editor.get_canvas_coordinates(new M.assignfeedback_editpdf.point(x, y));
+                    bounds = this.editor.get_canvas_bounds(true);
+                    bounds.x = 0;
+                    bounds.y = 0;
+
+                    bounds.width -= 24;
+                    bounds.height -= 24;
+                    // Clip to the window size - the comment icon size.
+                    newlocation.clip(bounds);
+
+                    this.x = newlocation.x;
+                    this.y = newlocation.y;
+
+                    windowlocation = this.editor.get_window_coordinates(newlocation);
+                    container.setX(windowlocation.x);
+                    container.setY(windowlocation.y);
+                    this.drawable.store_position(container, windowlocation.x, windowlocation.y);
+                }
+            }, null, this);
+            this.menu = new M.assignfeedback_editpdf.htmlcommentmenu({
+                buttonNode: this.menulink,
+                htmlcomment: this
+            });
+        }
+    };
+
+    /**
+     * Delete a htmlcomment.
+     * @method remove
+     */
+    this.remove = function() {
+        var i = 0;
+        var htmlcomments;
+
+        htmlcomments = this.editor.pages[this.editor.currentpage].htmlcomments;
+        for (i = 0; i < htmlcomments.length; i++) {
+            if (htmlcomments[i] === this) {
+                htmlcomments.splice(i, 1);
+                this.drawable.erase();
+                this.editor.save_current_page();
+                return;
+            }
+        }
+    };
+
+    /**
+     * Draw the in progress edit.
+     *
+     * @public
+     * @method draw_current_edit
+     * @param M.assignfeedback_editpdf.edit edit
+     */
+    this.draw_current_edit = function(edit) {
+        var bounds = new M.assignfeedback_editpdf.rect(),
+            drawable = new M.assignfeedback_editpdf.drawable(this.editor),
+            drawingregion = this.editor.get_dialogue_element(SELECTOR.DRAWINGREGION),
+            node,
+            position;
+
+        bounds.bound([edit.start, edit.end]);
+        position = this.editor.get_window_coordinates(new M.assignfeedback_editpdf.point(bounds.x, bounds.y));
+
+        node = Y.Node.create('<div/>');
+        node.setStyles({
+            'position': 'absolute',
+            'display': 'inline-block',
+            'width': bounds.width,
+            'height': bounds.height,
+            'backgroundSize': '100% 100%'
+        });
+
+        drawingregion.append(node);
+        node.setX(position.x);
+        node.setY(position.y);
+        drawable.store_position(node, position.x, position.y);
+
+        drawable.nodes.push(node);
+
+        return drawable;
+    };
+
+    /**
+     * Promote the current edit to a real htmlcomment.
+     *
+     * @public
+     * @method init_from_edit
+     * @param M.assignfeedback_editpdf.edit edit
+     * @return bool true if htmlcomment bound is more than min width/height, else false.
+     */
+    this.init_from_edit = function(edit) {
+        var bounds = new M.assignfeedback_editpdf.rect();
+        bounds.bound([edit.start, edit.end]);
+
+        if (bounds.width < 40) {
+            bounds.width = 40;
+        }
+        if (bounds.height < 40) {
+            bounds.height = 40;
+        }
+        this.gradeid = this.editor.get('gradeid');
+        this.pageno = this.editor.currentpage;
+        this.x = bounds.x;
+        this.y = bounds.y;
+        this.endx = bounds.x + bounds.width;
+        this.endy = bounds.y + bounds.height;
+        this.rawtext = '';
+
+        // Min width and height is always more than 40px.
+        return true;
+    };
+
+    /**
+     * Update htmlcomment position when rotating page.
+     * @public
+     * @method updatePosition
+     */
+    this.updatePosition = function() {
+        var node = this.drawable.nodes[0].one('div');
+        var container = node.ancestor('div');
+
+        var newlocation = new M.assignfeedback_editpdf.point(this.x, this.y);
+        var windowlocation = this.editor.get_window_coordinates(newlocation);
+
+        container.setX(windowlocation.x);
+        container.setY(windowlocation.y);
+        this.drawable.store_position(container, windowlocation.x, windowlocation.y);
+    };
+
+    /**
+     * Edit exist html comment
+     * @public
+     * @method edit_htmlcomment
+     * @param e
+     */
+    this.edit_htmlcomment = function(e) {
+        var htmleditor,
+            origtext,
+            node;
+        e.preventDefault();
+        this.menu.hide();
+        node = this.drawable.nodes[0].one('div');
+        htmleditor = Y.one('#html_editoreditable');
+        origtext = this.rawtext;
+        htmleditor.set('innerHTML', this.rawtext);
+        if (!this.editor.htmleditorwindow) {
+            this.editor.htmleditorwindow = new M.assignfeedback_editpdf.htmleditor({
+                editor: this
+            });
+        }
+        var htmleditorwindow = this.editor.htmleditorwindow;
+        var cancelbuton = htmleditorwindow.getButton('cancel', Y.WidgetStdMod.FOOTER);
+        cancelbuton.on('click', function (e) {
+            e.preventDefault();
+            this.rawtext = origtext;
+            htmleditorwindow.hide();
+        }, this);
+        var confirmbutton = htmleditorwindow.getButton('confirm', Y.WidgetStdMod.FOOTER);
+        confirmbutton.on('click', function (){
+            // Save the changes back to the comment.
+            var textarea = Y.one('#html_editor');
+            this.rawtext = textarea.get('value');
+            this.draw(node);
+            htmleditorwindow.hide();
+        }, this);
+        htmleditorwindow.show();
+    };
+
+};
+
+M.assignfeedback_editpdf = M.assignfeedback_editpdf || {};
+M.assignfeedback_editpdf.htmlcomment = HTMLCOMMENT;
+var HTMLCOMMENTMENUNAME = "Htmlcommentmenu",
+    HTMLCOMMENTMENU;
+
+/**
+ * Provides an in browser PDF editor.
+ *
+ * @module moodle-assignfeedback_editpdf-editor
+ */
+
+/**
+ * HTMLCOMMENTMENU
+ * This is a drop down list of comment context functions.
+ *
+ * @namespace M.assignfeedback_editpdf
+ * @class commentmenu
+ * @constructor
+ * @param {Object} config
+ * @extends M.assignfeedback_editpdf.dropdown
+ */
+HTMLCOMMENTMENU = function(config) {
+    HTMLCOMMENTMENU.superclass.constructor.apply(this, [config]);
+};
+
+Y.extend(HTMLCOMMENTMENU, M.assignfeedback_editpdf.dropdown, {
+
+    /**
+     * Initialise the menu.
+     *
+     * @method initializer
+     * @param {Object} config
+     */
+    initializer: function(config) {
+        var htmlcommentlinks,
+            link,
+            body,
+            htmlcomment;
+
+        htmlcomment = this.get('htmlcomment');
+        // Build the list of menu items.
+        htmlcommentlinks = Y.Node.create('<ul role="menu" class="assignfeedback_editpdf_menu"/>');
+
+        link = Y.Node.create('<li><a tabindex="-1" href="#">' +
+               M.util.get_string('edithtml', 'assignfeedback_editpdf') +
+               '</a></li>');
+        link.on('click', htmlcomment.edit_htmlcomment, htmlcomment);
+        link.on('key', htmlcomment.edit_htmlcomment, 'enter,space', htmlcomment);
+
+        htmlcommentlinks.append(link);
+
+        link = Y.Node.create('<li><a tabindex="-1" href="#">' +
+               M.util.get_string('deletecomment', 'assignfeedback_editpdf') +
+               '</a></li>');
+        link.on('click', function(e) {
+            e.preventDefault();
+            this.menu.hide();
+            this.remove();
+        }, htmlcomment);
+
+        link.on('key', function() {
+            htmlcomment.menu.hide();
+            htmlcomment.remove();
+        }, 'enter,space', htmlcomment);
+
+        htmlcommentlinks.append(link);
+
+        link = Y.Node.create('<li><hr/></li>');
+        htmlcommentlinks.append(link);
+
+        // Set the accessible header text.
+        this.set('headerText', M.util.get_string('commentcontextmenu', 'assignfeedback_editpdf'));
+
+        body = Y.Node.create('<div/>');
+
+        // Set the body content.
+        body.append(htmlcommentlinks);
+        this.set('bodyContent', body);
+
+        HTMLCOMMENTMENU.superclass.initializer.call(this, config);
+    }
+}, {
+    NAME: HTMLCOMMENTMENUNAME,
+    ATTRS: {
+        /**
+         * The comment this menu is attached to.
+         *
+         * @attribute comment
+         * @type M.assignfeedback_editpdf.comment
+         * @default null
+         */
+        htmlcomment: {
+            value: null
+        }
+
+    }
+});
+
+M.assignfeedback_editpdf = M.assignfeedback_editpdf || {};
+M.assignfeedback_editpdf.htmlcommentmenu = HTMLCOMMENTMENU;
 
 
 }, '@VERSION@', {
Index: mod/assign/feedback/editpdf/yui/src/editor/build.json
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/mod/assign/feedback/editpdf/yui/src/editor/build.json b/mod/assign/feedback/editpdf/yui/src/editor/build.json
--- a/mod/assign/feedback/editpdf/yui/src/editor/build.json	(revision 2729694d4d56ca2c88bb180aee3f254f8be906cf)
+++ b/mod/assign/feedback/editpdf/yui/src/editor/build.json	(revision 0b9764ed79311babea3acc01b01be2b999f9ec4f)
@@ -23,7 +23,10 @@
         "comment.js",
         "quickcomment.js",
         "quickcommentlist.js",
-        "editor.js"
+        "editor.js",
+        "htmleditor.js",
+        "htmlcomment.js",
+        "htmlcommentmenu.js"
       ]
     }
   }
Index: mod/assign/feedback/editpdf/yui/src/editor/js/editor.js
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/mod/assign/feedback/editpdf/yui/src/editor/js/editor.js b/mod/assign/feedback/editpdf/yui/src/editor/js/editor.js
--- a/mod/assign/feedback/editpdf/yui/src/editor/js/editor.js	(revision 2729694d4d56ca2c88bb180aee3f254f8be906cf)
+++ b/mod/assign/feedback/editpdf/yui/src/editor/js/editor.js	(revision 0b9764ed79311babea3acc01b01be2b999f9ec4f)
@@ -195,6 +195,13 @@
      */
     searchcommentswindow: null,
 
+    /**
+     * The search comments window.
+     * @property searchcommentswindow
+     * @type M.core.dialogue
+     * @protected
+     */
+    htmleditorwindow: null,
 
     /**
      * The selected stamp picture.
@@ -222,6 +229,16 @@
      */
     editingcomment: false,
 
+    /**
+     * Prevent new comments from appearing
+     * immediately after clicking off a current
+     * comment
+     * @property editinghtmlcomment
+     * @type Boolean
+     * @public
+     */
+    editinghtmlcomment: false,
+
     /**
      * Should inactive comments be collapsed?
      *
@@ -607,7 +624,7 @@
      * @method prepare_pages_for_display
      */
     prepare_pages_for_display: function(data) {
-        var i, j, comment, error, annotation, readonly;
+        var i, j, comment, htmlcomment, error, annotation, readonly;
 
         if (!data.pagecount) {
             if (this.dialogue) {
@@ -633,6 +650,17 @@
                                                                                  comment.colour,
                                                                                  comment.rawtext);
             }
+            for (j = 0; j < this.pages[i].htmlcomments.length; j++) {
+                htmlcomment = this.pages[i].htmlcomments[j];
+                this.pages[i].htmlcomments[j] = new M.assignfeedback_editpdf.htmlcomment(this,
+                    htmlcomment.gradeid,
+                    htmlcomment.pageno,
+                    htmlcomment.x,
+                    htmlcomment.y,
+                    htmlcomment.width,
+                    htmlcomment.colour,
+                    htmlcomment.rawtext);
+            }
             for (j = 0; j < this.pages[i].annotations.length; j++) {
                 annotation = this.pages[i].annotations[j];
                 this.pages[i].annotations[j] = this.create_annotation(annotation.type, annotation);
@@ -800,8 +828,14 @@
             currentstampbutton,
             stampfiles,
             picker,
-            filename;
+            filename,
+            htmleditorbutton;
 
+        htmleditorbutton = this.get_dialogue_element(SELECTOR.HTMLEDITORBUTTON);
+        if(htmleditorbutton !== null &&  htmleditorbutton !== 'unknown') {
+            htmleditorbutton.on('click', this.open_htmleditor, this);
+            htmleditorbutton.on('key', this.open_htmleditor, 'down:13', this);
+        }
         searchcommentsbutton = this.get_dialogue_element(SELECTOR.SEARCHCOMMENTSBUTTON);
         searchcommentsbutton.on('click', this.open_search_comments, this);
         searchcommentsbutton.on('key', this.open_search_comments, 'down:13', this);
@@ -916,7 +950,7 @@
         currenttoolnode.setAttribute('aria-pressed', 'false');
         this.currentedit.tool = tool;
 
-        if (tool !== "comment" && tool !== "select" && tool !== "drag" && tool !== "stamp") {
+        if (tool !== "htmleditor" && tool !== "comment" && tool !== "select" && tool !== "drag" && tool !== "stamp") {
             this.lastannotationtool = tool;
         }
 
@@ -931,10 +965,13 @@
      */
     stringify_current_page: function() {
         var comments = [],
+            htmlcomments = [],
             annotations = [],
             page,
             i = 0;
-
+        for (i = 0; i < this.pages[this.currentpage].htmlcomments.length; i++) {
+            htmlcomments[i] = this.pages[this.currentpage].htmlcomments[i].clean();
+        }
         for (i = 0; i < this.pages[this.currentpage].comments.length; i++) {
             comments[i] = this.pages[this.currentpage].comments[i].clean();
         }
@@ -942,7 +979,7 @@
             annotations[i] = this.pages[this.currentpage].annotations[i].clean();
         }
 
-        page = {comments: comments, annotations: annotations};
+        page = {comments: comments, annotations: annotations, htmlcomments: htmlcomments};
 
         return Y.JSON.stringify(page);
     },
@@ -954,6 +991,7 @@
      */
     get_current_drawable: function() {
         var comment,
+            htmlcomment,
             annotation,
             drawable = false;
 
@@ -964,6 +1002,9 @@
         if (this.currentedit.tool === 'comment') {
             comment = new M.assignfeedback_editpdf.comment(this);
             drawable = comment.draw_current_edit(this.currentedit);
+        } else if (this.currentedit.tool === 'htmleditor') {
+                htmlcomment = new M.assignfeedback_editpdf.htmlcomment(this);
+                drawable = htmlcomment.draw_current_edit(this.currentedit);
         } else {
             annotation = this.create_annotation(this.currentedit.tool, {});
             if (annotation) {
@@ -1026,6 +1067,9 @@
         if (this.editingcomment) {
             return;
         }
+        if (this.editinghtmlcomment) {
+            return;
+        }
 
         this.currentedit.starttime = new Date().getTime();
         this.currentedit.start = point;
@@ -1137,17 +1181,32 @@
     edit_end: function() {
         var duration,
             comment,
-            annotation;
+            htmlcomment,
+            annotation,
+            needsaved;
 
         duration = new Date().getTime() - this.currentedit.start;
+        needsaved = false;
 
         if (duration < CLICKTIMEOUT || this.currentedit.start === false) {
             return;
         }
-
-        if (this.currentedit.tool === 'comment') {
+        if (this.currentedit.tool === 'htmleditor') {
+            if (this.currentdrawable) {
+                this.currentdrawable.erase();
+                needsaved = true;
+            }
+            this.currentdrawable = false;
+            htmlcomment = new M.assignfeedback_editpdf.htmlcomment(this);
+            if (htmlcomment.init_from_edit(this.currentedit)) {
+                this.pages[this.currentpage].htmlcomments.push(htmlcomment);
+                this.drawables.push(htmlcomment.draw());
+                needsaved = true;
+            }
+        } else if (this.currentedit.tool === 'comment') {
             if (this.currentdrawable) {
                 this.currentdrawable.erase();
+                needsaved = true;
             }
             this.currentdrawable = false;
             comment = new M.assignfeedback_editpdf.comment(this);
@@ -1155,23 +1214,28 @@
                 this.pages[this.currentpage].comments.push(comment);
                 this.drawables.push(comment.draw(true));
                 this.editingcomment = true;
+                needsaved = true;
             }
         } else {
             annotation = this.create_annotation(this.currentedit.tool, {});
             if (annotation) {
                 if (this.currentdrawable) {
                     this.currentdrawable.erase();
+                    needsaved = true;
                 }
                 this.currentdrawable = false;
                 if (annotation.init_from_edit(this.currentedit)) {
                     this.pages[this.currentpage].annotations.push(annotation);
                     this.drawables.push(annotation.draw());
+                    needsaved = true;
                 }
             }
         }
 
         // Save the changes.
+        if (needsaved) {
         this.save_current_page();
+        }
 
         // Reset the current edit.
         this.currentedit.starttime = 0;
@@ -1228,6 +1292,8 @@
             return new M.assignfeedback_editpdf.annotationhighlight(data);
         } else if (type === "stamp") {
             return new M.assignfeedback_editpdf.annotationstamp(data);
+        } else if (type === "htmleditor") {
+            return new M.assignfeedback_editpdf.htmlcomment(data);
         }
         return false;
     },
@@ -1296,7 +1362,24 @@
         this.searchcommentswindow.show();
         e.preventDefault();
     },
+    /**
+     * Event handler to open the comment search interface.
+     *
+     * @param Event e
+     * @protected
+     * @method open_htmleditor
+     */
+    open_htmleditor: function(e) {
+        if (!this.htmleditorwindow) {
+            this.htmleditorwindow = new M.assignfeedback_editpdf.htmleditor({
+                editor: this
+            });
+        }
 
+        this.htmleditorwindow.show();
+
+        e.preventDefault();
+    },
     /**
      * Toggle function to expand/collapse all comments on page.
      *
@@ -1338,6 +1421,9 @@
         for (i = 0; i < page.comments.length; i++) {
             this.drawables.push(page.comments[i].draw(false));
         }
+        for (i = 0; i < page.htmlcomments.length; i++) {
+            this.drawables.push(page.htmlcomments[i].draw());
+        }
     },
 
     /**
@@ -1568,6 +1654,15 @@
                         for (i = 0; i < oldcomments.length; i++) {
                             oldcomments[i].updatePosition();
                         }
+
+                        /**
+                         * Update Position of htmlcomments with relation to canvas coordinates.
+                         * Without this code, the htmlcomments will stay at their positions in windows/document coordinates.
+                         */
+                        var oldhtmlcomments = page.htmlcomments;
+                        for (i = 0; i < oldhtmlcomments.length; i++) {
+                            oldhtmlcomments[i].updatePosition();
+                        }
                         // Save Annotations.
                         return self.save_current_page();
                     } catch (e) {
Index: mod/assign/feedback/editpdf/yui/src/editor/js/globals.js
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/mod/assign/feedback/editpdf/yui/src/editor/js/globals.js b/mod/assign/feedback/editpdf/yui/src/editor/js/globals.js
--- a/mod/assign/feedback/editpdf/yui/src/editor/js/globals.js	(revision 2729694d4d56ca2c88bb180aee3f254f8be906cf)
+++ b/mod/assign/feedback/editpdf/yui/src/editor/js/globals.js	(revision 0b9764ed79311babea3acc01b01be2b999f9ec4f)
@@ -39,6 +39,7 @@
         SAVE: '.savebutton',
         COMMENTCOLOURBUTTON: '.commentcolourbutton',
         COMMENTMENU: '.commentdrawable a',
+        HTMLCOMMENTMENU: '.htmlcommentdrawable a',
         ANNOTATIONCOLOURBUTTON:  '.annotationcolourbutton',
         DELETEANNOTATIONBUTTON: '.deleteannotationbutton',
         WARNINGMESSAGECONTAINER: '.warningmessages',
@@ -49,6 +50,7 @@
         USERINFOREGION: '[data-region="user-info"]',
         ROTATELEFTBUTTON: '.rotateleftbutton',
         ROTATERIGHTBUTTON: '.rotaterightbutton',
+        HTMLEDITORBUTTON: '.htmleditorbutton',
         DIALOGUE: '.' + CSS.DIALOGUE
     },
     SELECTEDBORDERCOLOUR = 'rgba(200, 200, 255, 0.9)',
@@ -80,6 +82,7 @@
         'stamp': '.stampbutton',
         'select': '.selectbutton',
         'drag': '.dragbutton',
-        'highlight': '.highlightbutton'
+        'highlight': '.highlightbutton',
+        'htmleditor': '.htmleditorbutton'
     },
     STROKEWEIGHT = 4;
Index: mod/assign/feedback/editpdf/yui/src/editor/js/htmlcomment.js
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/mod/assign/feedback/editpdf/yui/src/editor/js/htmlcomment.js b/mod/assign/feedback/editpdf/yui/src/editor/js/htmlcomment.js
new file mode 100644
--- /dev/null	(revision 0b9764ed79311babea3acc01b01be2b999f9ec4f)
+++ b/mod/assign/feedback/editpdf/yui/src/editor/js/htmlcomment.js	(revision 0b9764ed79311babea3acc01b01be2b999f9ec4f)
@@ -0,0 +1,469 @@
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+/**
+ * Provides an in browser PDF editor.
+ *
+ * @module moodle-assignfeedback_editpdf-editor
+ */
+
+/**
+ * Class representing a list of htmlcomments.
+ *
+ * @namespace M.assignfeedback_editpdf
+ * @class htmlcomment
+ * @param M.assignfeedback_editpdf.editor editor
+ * @param Int gradeid
+ * @param Int pageno
+ * @param Int x
+ * @param Int y
+ * @param Int width
+ * @param String colour
+ * @param String rawtext
+ */
+var HTMLCOMMENT = function(editor, gradeid, pageno, x, y, width, colour, rawtext) {
+
+    /**
+     * Reference to M.assignfeedback_editpdf.editor.
+     * @property editor
+     * @type M.assignfeedback_editpdf.editor
+     * @public
+     */
+    this.editor = editor;
+
+    /**
+     * Grade id
+     * @property gradeid
+     * @type Int
+     * @public
+     */
+    this.gradeid = gradeid || 0;
+
+    /**
+     * X position
+     * @property x
+     * @type Int
+     * @public
+     */
+    this.x = parseInt(x, 10) || 0;
+
+    /**
+     * Y position
+     * @property y
+     * @type Int
+     * @public
+     */
+    this.y = parseInt(y, 10) || 0;
+
+    /**
+     * Htmlcomment width
+     * @property width
+     * @type Int
+     * @public
+     */
+    this.width = parseInt(width, 10) || 0;
+
+    /**
+     * Htmlcomment rawtext
+     * @property rawtext
+     * @type String
+     * @public
+     */
+    this.rawtext = rawtext || '';
+
+    /**
+     * Htmlcomment page number
+     * @property pageno
+     * @type Int
+     * @public
+     */
+    this.pageno = pageno || 0;
+
+    /**
+     * Htmlcomment background colour.
+     * @property colour
+     * @type String
+     * @public
+     */
+    this.colour = colour || 'yellow';
+
+    /**
+     * Reference to M.assignfeedback_editpdf.drawable
+     * @property drawable
+     * @type M.assignfeedback_editpdf.drawable
+     * @public
+     */
+    this.drawable = false;
+
+    /**
+     * Boolean used by a timeout to delete empty htmlcomments after a short delay.
+     * @property deleteme
+     * @type Boolean
+     * @public
+     */
+    this.deleteme = false;
+
+    /**
+     * Reference to the link that opens the menu.
+     * @property menulink
+     * @type Y.Node
+     * @public
+     */
+    this.menulink = null;
+
+    /**
+     * Reference to the dialogue that is the context menu.
+     * @property menu
+     * @type M.assignfeedback_editpdf.dropdown
+     * @public
+     */
+    this.menu = null;
+
+    /**
+     * Clean a htmlcomment record, returning an oject with only fields that are valid.
+     * @public
+     * @method clean
+     * @return {}
+     */
+    this.clean = function() {
+        return {
+            gradeid: this.gradeid,
+            x: parseInt(this.x, 10),
+            y: parseInt(this.y, 10),
+            width: parseInt(this.width, 10),
+            rawtext: this.rawtext,
+            pageno: parseInt(this.pageno, 10),
+            colour: this.colour
+        };
+    };
+
+    /**
+     * Draw a htmlcomment.
+     * @public
+     * @method draw
+     * @return M.assignfeedback_editpdf.drawable
+     */
+    this.draw = function(editnode) {
+        var drawable = new M.assignfeedback_editpdf.drawable(this.editor),
+            drawingcanvas = this.editor.get_dialogue_element(SELECTOR.DRAWINGCANVAS),
+            container,
+            node,
+            menu,
+            position,
+            scrollheight,
+            textarea;
+        menu = Y.Node.create('<a href="#"><img src="' + M.util.image_url('t/contextmenu', 'core') + '"/></a>');
+        // // Lets add a contenteditable div.
+        node = editnode || Y.Node.create('<div/>');
+        node.addClass('htmlcomment');
+        container = Y.Node.create('<div class="htmlcommentdrawable"/>');
+        this.menulink = menu;
+        if (this.rawtext.replace(/^\s+|\s+$/g, "") === '') {
+            textarea = Y.one('#html_editor');
+            this.rawtext = textarea.get('value');
+        }
+        menu.setAttribute('tabindex', '0');
+        if (!this.editor.get('readonly')) {
+            container.append(menu);
+        } else {
+            node.setAttribute('readonly', 'readonly');
+        }
+        if (this.width < 200) {
+            this.width = 200;
+        }
+        node.set('innerHTML', this.rawtext);
+        Y.use('mathjax', function() {
+            window.MathJax.Hub.Queue(["Typeset", window.MathJax.Hub, node.getDOMNode()]);
+        });
+        scrollheight = node.get('scrollHeight');
+        node.setStyles({
+            'height': scrollheight + 'px'
+        });
+        position = this.editor.get_window_coordinates(new M.assignfeedback_editpdf.point(this.x, this.y));
+        node.setStyles({
+            width: this.width + 'px'
+        });
+        container.append(node);
+        drawingcanvas.append(container);
+        container.setStyle('position', 'absolute');
+        container.setX(position.x);
+        container.setY(position.y);
+        drawable.store_position(container, position.x, position.y);
+
+        // Bind events only when editing.
+        if (!this.editor.get('readonly')) {
+            // Pass through the event handlers on the div.
+            node.on('gesturemovestart', this.editor.edit_start, null, this.editor);
+            node.on('gesturemove', this.editor.edit_move, null, this.editor);
+            node.on('gesturemoveend', this.editor.edit_end, null, this.editor);
+        }
+        drawable.nodes.push(container);
+
+        this.attach_events(node, menu);
+        this.drawable = drawable;
+
+        node.focus();
+        this.width = parseInt(node.getStyle('width'), 10);
+
+        // Trim.
+        if (this.rawtext.replace(/^\s+|\s+$/g, "") === '') {
+            // Delete empty htmlcomments.
+            this.deleteme = true;
+            Y.later(400, this, this.delete_htmlcomment_later);
+            if (document.getElementsByClassName('dir-rtl').length !== 0) {
+                Y.one('#html_editoreditable').set('innerHTML', '<p dir="rtl" style="text-align: right;"><br></p>');
+            } else {
+                Y.one('#html_editoreditable').set('innerHTML', '<p dir="ltr" style="text-align: left;"><br></p>');
+            }
+            if (!this.editor.htmleditorwindow) {
+                this.editor.htmleditorwindow = new M.assignfeedback_editpdf.htmleditor({
+                    editor: this
+                });
+            }
+        }
+        node.active = false;
+        if (this.rawtext.replace(/^\s+|\s+$/g, "") !== '') {
+            if (editnode) {
+                this.editor.save_current_page();
+            }
+            this.drawable = drawable;
+            if (textarea) {
+                textarea.set('value', ' ');
+                if (document.getElementsByClassName('dir-rtl').length !== 0) {
+                    Y.one('#html_editoreditable').set('innerHTML', '<p dir="rtl" style="text-align: right;"><br></p>');
+                } else {
+                    Y.one('#html_editoreditable').set('innerHTML', '<p dir="ltr" style="text-align: left;"><br></p>');
+                }
+            }
+        }
+        return drawable;
+    };
+
+    /**
+     * Delete an empty htmlcomment if it's menu hasn't been opened in time.
+     * @method delete_htmlcomment_later
+     */
+    this.delete_htmlcomment_later = function() {
+        if (this.deleteme) {
+            this.remove();
+        }
+    };
+
+    /**
+     * Htmlomment nodes have a bunch of event handlers attached to them directly.
+     * This is all done here for neatness.
+     *
+     * @protected
+     * @method attach_htmlcomment_events
+     * @param node - The Y.Node representing the htmlcomment.
+     * @param menu - The Y.Node representing the menu.
+     */
+    this.attach_events = function(node, menu) {
+        var container = node.ancestor('div');
+
+        if (!this.editor.get('readonly')) {
+            // For delegated event handler.
+            menu.setData('htmlcomment', this);
+
+            node.on('gesturemovestart', function(e) {
+                if (editor.currentedit.tool === 'select') {
+                    e.preventDefault();
+                    node.setData('offsetx', e.clientX - container.getX());
+                    node.setData('offsety', e.clientY - container.getY());
+                }
+            });
+            node.on('gesturemove', function(e) {
+                if (editor.currentedit.tool === 'select') {
+                    var x = e.clientX - node.getData('offsetx'),
+                        y = e.clientY - node.getData('offsety'),
+                        newlocation,
+                        windowlocation,
+                        bounds;
+
+                    if (node.getData('clicking') !== true) {
+                        node.setData('clicking', true);
+                    }
+
+                    newlocation = this.editor.get_canvas_coordinates(new M.assignfeedback_editpdf.point(x, y));
+                    bounds = this.editor.get_canvas_bounds(true);
+                    bounds.x = 0;
+                    bounds.y = 0;
+
+                    bounds.width -= 24;
+                    bounds.height -= 24;
+                    // Clip to the window size - the comment icon size.
+                    newlocation.clip(bounds);
+
+                    this.x = newlocation.x;
+                    this.y = newlocation.y;
+
+                    windowlocation = this.editor.get_window_coordinates(newlocation);
+                    container.setX(windowlocation.x);
+                    container.setY(windowlocation.y);
+                    this.drawable.store_position(container, windowlocation.x, windowlocation.y);
+                }
+            }, null, this);
+            this.menu = new M.assignfeedback_editpdf.htmlcommentmenu({
+                buttonNode: this.menulink,
+                htmlcomment: this
+            });
+        }
+    };
+
+    /**
+     * Delete a htmlcomment.
+     * @method remove
+     */
+    this.remove = function() {
+        var i = 0;
+        var htmlcomments;
+
+        htmlcomments = this.editor.pages[this.editor.currentpage].htmlcomments;
+        for (i = 0; i < htmlcomments.length; i++) {
+            if (htmlcomments[i] === this) {
+                htmlcomments.splice(i, 1);
+                this.drawable.erase();
+                this.editor.save_current_page();
+                return;
+            }
+        }
+    };
+
+    /**
+     * Draw the in progress edit.
+     *
+     * @public
+     * @method draw_current_edit
+     * @param M.assignfeedback_editpdf.edit edit
+     */
+    this.draw_current_edit = function(edit) {
+        var bounds = new M.assignfeedback_editpdf.rect(),
+            drawable = new M.assignfeedback_editpdf.drawable(this.editor),
+            drawingregion = this.editor.get_dialogue_element(SELECTOR.DRAWINGREGION),
+            node,
+            position;
+
+        bounds.bound([edit.start, edit.end]);
+        position = this.editor.get_window_coordinates(new M.assignfeedback_editpdf.point(bounds.x, bounds.y));
+
+        node = Y.Node.create('<div/>');
+        node.setStyles({
+            'position': 'absolute',
+            'display': 'inline-block',
+            'width': bounds.width,
+            'height': bounds.height,
+            'backgroundSize': '100% 100%'
+        });
+
+        drawingregion.append(node);
+        node.setX(position.x);
+        node.setY(position.y);
+        drawable.store_position(node, position.x, position.y);
+
+        drawable.nodes.push(node);
+
+        return drawable;
+    };
+
+    /**
+     * Promote the current edit to a real htmlcomment.
+     *
+     * @public
+     * @method init_from_edit
+     * @param M.assignfeedback_editpdf.edit edit
+     * @return bool true if htmlcomment bound is more than min width/height, else false.
+     */
+    this.init_from_edit = function(edit) {
+        var bounds = new M.assignfeedback_editpdf.rect();
+        bounds.bound([edit.start, edit.end]);
+
+        if (bounds.width < 40) {
+            bounds.width = 40;
+        }
+        if (bounds.height < 40) {
+            bounds.height = 40;
+        }
+        this.gradeid = this.editor.get('gradeid');
+        this.pageno = this.editor.currentpage;
+        this.x = bounds.x;
+        this.y = bounds.y;
+        this.endx = bounds.x + bounds.width;
+        this.endy = bounds.y + bounds.height;
+        this.rawtext = '';
+
+        // Min width and height is always more than 40px.
+        return true;
+    };
+
+    /**
+     * Update htmlcomment position when rotating page.
+     * @public
+     * @method updatePosition
+     */
+    this.updatePosition = function() {
+        var node = this.drawable.nodes[0].one('div');
+        var container = node.ancestor('div');
+
+        var newlocation = new M.assignfeedback_editpdf.point(this.x, this.y);
+        var windowlocation = this.editor.get_window_coordinates(newlocation);
+
+        container.setX(windowlocation.x);
+        container.setY(windowlocation.y);
+        this.drawable.store_position(container, windowlocation.x, windowlocation.y);
+    };
+
+    /**
+     * Edit exist html comment
+     * @public
+     * @method edit_htmlcomment
+     * @param e
+     */
+    this.edit_htmlcomment = function(e) {
+        var htmleditor,
+            origtext,
+            node;
+        e.preventDefault();
+        this.menu.hide();
+        node = this.drawable.nodes[0].one('div');
+        htmleditor = Y.one('#html_editoreditable');
+        origtext = this.rawtext;
+        htmleditor.set('innerHTML', this.rawtext);
+        if (!this.editor.htmleditorwindow) {
+            this.editor.htmleditorwindow = new M.assignfeedback_editpdf.htmleditor({
+                editor: this
+            });
+        }
+        var htmleditorwindow = this.editor.htmleditorwindow;
+        var cancelbuton = htmleditorwindow.getButton('cancel', Y.WidgetStdMod.FOOTER);
+        cancelbuton.on('click', function (e) {
+            e.preventDefault();
+            this.rawtext = origtext;
+            htmleditorwindow.hide();
+        }, this);
+        var confirmbutton = htmleditorwindow.getButton('confirm', Y.WidgetStdMod.FOOTER);
+        confirmbutton.on('click', function (){
+            // Save the changes back to the comment.
+            var textarea = Y.one('#html_editor');
+            this.rawtext = textarea.get('value');
+            this.draw(node);
+            htmleditorwindow.hide();
+        }, this);
+        htmleditorwindow.show();
+    };
+
+};
+
+M.assignfeedback_editpdf = M.assignfeedback_editpdf || {};
+M.assignfeedback_editpdf.htmlcomment = HTMLCOMMENT;
Index: mod/assign/feedback/editpdf/yui/src/editor/js/htmlcommentmenu.js
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/mod/assign/feedback/editpdf/yui/src/editor/js/htmlcommentmenu.js b/mod/assign/feedback/editpdf/yui/src/editor/js/htmlcommentmenu.js
new file mode 100644
--- /dev/null	(revision 0b9764ed79311babea3acc01b01be2b999f9ec4f)
+++ b/mod/assign/feedback/editpdf/yui/src/editor/js/htmlcommentmenu.js	(revision 0b9764ed79311babea3acc01b01be2b999f9ec4f)
@@ -0,0 +1,98 @@
+var HTMLCOMMENTMENUNAME = "Htmlcommentmenu",
+    HTMLCOMMENTMENU;
+
+/**
+ * Provides an in browser PDF editor.
+ *
+ * @module moodle-assignfeedback_editpdf-editor
+ */
+
+/**
+ * HTMLCOMMENTMENU
+ * This is a drop down list of comment context functions.
+ *
+ * @namespace M.assignfeedback_editpdf
+ * @class commentmenu
+ * @constructor
+ * @param {Object} config
+ * @extends M.assignfeedback_editpdf.dropdown
+ */
+HTMLCOMMENTMENU = function(config) {
+    HTMLCOMMENTMENU.superclass.constructor.apply(this, [config]);
+};
+
+Y.extend(HTMLCOMMENTMENU, M.assignfeedback_editpdf.dropdown, {
+
+    /**
+     * Initialise the menu.
+     *
+     * @method initializer
+     * @param {Object} config
+     */
+    initializer: function(config) {
+        var htmlcommentlinks,
+            link,
+            body,
+            htmlcomment;
+
+        htmlcomment = this.get('htmlcomment');
+        // Build the list of menu items.
+        htmlcommentlinks = Y.Node.create('<ul role="menu" class="assignfeedback_editpdf_menu"/>');
+
+        link = Y.Node.create('<li><a tabindex="-1" href="#">' +
+               M.util.get_string('edithtml', 'assignfeedback_editpdf') +
+               '</a></li>');
+        link.on('click', htmlcomment.edit_htmlcomment, htmlcomment);
+        link.on('key', htmlcomment.edit_htmlcomment, 'enter,space', htmlcomment);
+
+        htmlcommentlinks.append(link);
+
+        link = Y.Node.create('<li><a tabindex="-1" href="#">' +
+               M.util.get_string('deletecomment', 'assignfeedback_editpdf') +
+               '</a></li>');
+        link.on('click', function(e) {
+            e.preventDefault();
+            this.menu.hide();
+            this.remove();
+        }, htmlcomment);
+
+        link.on('key', function() {
+            htmlcomment.menu.hide();
+            htmlcomment.remove();
+        }, 'enter,space', htmlcomment);
+
+        htmlcommentlinks.append(link);
+
+        link = Y.Node.create('<li><hr/></li>');
+        htmlcommentlinks.append(link);
+
+        // Set the accessible header text.
+        this.set('headerText', M.util.get_string('commentcontextmenu', 'assignfeedback_editpdf'));
+
+        body = Y.Node.create('<div/>');
+
+        // Set the body content.
+        body.append(htmlcommentlinks);
+        this.set('bodyContent', body);
+
+        HTMLCOMMENTMENU.superclass.initializer.call(this, config);
+    }
+}, {
+    NAME: HTMLCOMMENTMENUNAME,
+    ATTRS: {
+        /**
+         * The comment this menu is attached to.
+         *
+         * @attribute comment
+         * @type M.assignfeedback_editpdf.comment
+         * @default null
+         */
+        htmlcomment: {
+            value: null
+        }
+
+    }
+});
+
+M.assignfeedback_editpdf = M.assignfeedback_editpdf || {};
+M.assignfeedback_editpdf.htmlcommentmenu = HTMLCOMMENTMENU;
Index: mod/assign/feedback/editpdf/yui/src/editor/js/htmleditor.js
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/mod/assign/feedback/editpdf/yui/src/editor/js/htmleditor.js b/mod/assign/feedback/editpdf/yui/src/editor/js/htmleditor.js
new file mode 100644
--- /dev/null	(revision 0b9764ed79311babea3acc01b01be2b999f9ec4f)
+++ b/mod/assign/feedback/editpdf/yui/src/editor/js/htmleditor.js	(revision 0b9764ed79311babea3acc01b01be2b999f9ec4f)
@@ -0,0 +1,133 @@
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
+
+
+/**
+ * Provides an in browser PDF editor.
+ *
+ * @module moodle-assignfeedback_editpdf-editor
+ */
+
+/**
+ * Class representing a list of reach text.
+ *
+ * @namespace M.assignfeedback_editpdf
+ * @class htmleditor
+ * @constructor
+ * @extends M.core.dialogue
+ */
+var HTMLEDITOR = function(config) {
+    config.draggable = true;
+    config.centered = true;
+    config.width = 'auto';
+    config.visible = false;
+    config.headerContent = M.util.get_string('htmleditor', 'assignfeedback_editpdf');
+    config.footerContent = '';
+    config.closeButton = false;
+    HTMLEDITOR.superclass.constructor.apply(this, [config]);
+};
+
+var HTMLEDITORNAME = "htmleditor";
+
+
+Y.extend(HTMLEDITOR, M.core.dialogue, {
+    /**
+     * Initialise the menu.
+     *
+     * @method initializer
+     * @return void
+     */
+    editor: null,
+    initializer: function(config) {
+        var editorr,
+            container,
+            textarea,
+            bb;
+        this.editor = config.editor || null;
+        bb = this.get('boundingBox');
+        bb.addClass('assignfeedback_editpdf_htmleditor');
+        editorr = this.get('editor');
+        container = Y.Node.create('<div/>');
+        textarea = Y.one('#editorcontainer');
+        textarea.removeClass('hidden');
+        container.append(textarea);
+
+        Y.one('[name="savechanges"]').on('click', this.removeeditor);
+        Y.one('[name="saveandshownext"]').on('click', this.removeeditor);
+        // Set the body content.
+        this.set('bodyContent', container);
+        HTMLEDITOR.superclass.initializer.call(this, config);
+        this.addButton({
+            name: 'confirm',
+            label: M.util.get_string('confirm', 'moodle'),
+            action: function(e) {
+                e.preventDefault();
+                this.hide();
+            },
+            classNames: 'btn btn-primary',
+            section: Y.WidgetStdMod.FOOTER
+        });
+        this.addButton({
+            name: 'cancel',
+            label: M.util.get_string('cancel', 'moodle'),
+            action: function(e) {
+                e.preventDefault();
+                Y.one('#html_editor').set('value', ' ');
+                this.hide();
+            },
+            classNames: 'btn btn-secondary',
+            section: Y.WidgetStdMod.FOOTER
+        });
+
+    },
+    removeeditor: function () {
+        if (Y.one(".assignfeedback_editpdf_htmleditor")) {
+            Y.one(".assignfeedback_editpdf_htmleditor").remove();
+        }
+    }
+},{
+    NAME: HTMLEDITORNAME,
+    ATTRS: {
+        /**
+         * The editor this search window is attached to.
+         *
+         * @attribute editor
+         * @type M.assignfeedback_editpdf.editor
+         * @default null
+         */
+        editor: {
+            value: null
+        }
+
+    }
+});
+Y.Base.modifyAttrs(HTMLEDITOR, {
+    /**
+     * Whether the widget should be modal or not.
+     *
+     * Moodle override: We override this for commentsearch to force it always true.
+     *
+     * @attribute Modal
+     * @type Boolean
+     * @default true
+     */
+    modal: {
+        getter: function() {
+            return true;
+        }
+    }
+});
+M.assignfeedback_editpdf = M.assignfeedback_editpdf || {};
+M.assignfeedback_editpdf.htmleditor = HTMLEDITOR;
